<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>农业大数据研究与管理平台</title>
    <link rel="stylesheet" href="../theme/default/easyui.css" />
    <link rel="stylesheet" type="text/css" href="../css/app.css" />
    <link rel="stylesheet" type="text/css" href="../css/main.css" />
    <link type="text/css" href="../css/dev.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="../cesium/Widgets/widgets.css" />
    <script type="text/javascript" src="../js/jquery.min.js"></script>
    <script type="text/javascript" src="../js/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../js/dev.ui.js"></script>
    <script type="text/javascript" src="../js/data.util.js"></script>
    <script type="text/javascript" src="../js/ol.min.3.2.1.js"></script>
    <script type="text/javascript" src="js/show.gis.js"></script>
    <script type="text/javascript" src="../js/linq.min.js"></script>
    <script type="text/javascript" src="../js/guid.js"></script>
    <script type="text/javascript" src="../js/jquery.dev.js"></script>
    <script type="text/javascript" src="../cesium/Cesium.js"></script>
    <script type="text/javascript" src="../js/measure3D.js"></script>
    <script type="text/javascript" src="../cesium/viewerNavigation.js"></script>
    <script type="text/javascript" src="js/highcharts.js"></script>
    <script type="text/javascript" src="js/variable-pie.js"></script>
    <script type="text/javascript" src="../streetview/three.min.js"></script>
    <script type="text/javascript" src="../streetview/tpanorama.js"></script>
    <link rel="icon" type="image/x-icon" href="../image/logo.ico" />
    <style>
        .content {
            width: 100%;
            height: calc(100% - 33px);
            background: url(showimg/logo.png) no-repeat top,-webkit-radial-gradient(#000c09 30%,#000c09 70%);
            background: url(showimg/logo.png) no-repeat top,-o-radial-gradient(#000c09 30%,#000c09 70%);
            background: url(showimg/logo.png) no-repeat top,-moz-radial-gradient(#000c09 30%,#000c09 70%);
            background: url(showimg/logo.png) no-repeat top,radial-gradient(#000c09 30%,#000c09 70%);
            /*position: relative;*/
        }

        .fillpanel {
            width: 100%;
            height: 100%;
            display: none;
            position: absolute;
            top: 0;
        }

        .content > div {
            float: left;
            width: 58%;
            height: calc(60% - 62px);
            background: url(showimg/topl.png),url(showimg/topr.png),url(showimg/bottoml.png),url(showimg/bottomr.png),url(showimg/divbg.png) no-repeat center/100% 100%;
            background-repeat: no-repeat,no-repeat,no-repeat,no-repeat;
            background-position: top left,top right,bottom left,bottom right;
            margin-left: 2%;
        }

        .title {
            float: left;
            width: 97%;
            height: 30px;
            background: url(showimg/t-bg.png) no-repeat center/100% 100%;
            margin-left: 1%;
            margin-top: 1%;
            color: white;
            padding-left: 6px;
            line-height: 30px;
            font-size: 14px;
        }

        .leftpanel > .mappanel {
            float: left;
            margin-left: 3px;
            width: calc(100% - 6px);
            height: calc(100% - 44px);
            background-color: transparent;
            position: relative;
        }

        .mappaneldom {
            float: left;
            width: 100%;
            height: 100%;
            display: inline-block;
        }

        .mappanel3d {
            width: 100%;
            height: 100%;
            display: none;
        }

        .street {
            width: 100%;
            height: 100%;
            display: none;
        }

        .piediv1 {
            width: 30%;
            height: calc(100% - 44px);
            background-color: transparent;
            float: left;
            margin-left: 1%;
        }

        .columdiv1 {
            width: 65%;
            height: calc(100% - 44px);
            background: url(showimg/Statistic.png) no-repeat center/100% 100%,url(showimg/stbg.png) no-repeat top/100%;
            float: left;
            margin-top: 0.5%;
        }

        .attribute {
            width: 30%;
            height: calc(100% - 44px);
            background-color: transparent;
            float: left;
            margin-left: 3%;
        }

        .attribute1 {
            width: 90%;
            height: 25%;
            background: url(showimg/titelbg.png) no-repeat center/100% 100%;
            float: left;
            margin-top: 5%;
            text-align: center;
        }

        .ol-default-popup {
            position: absolute;
            background-color: white;
            -webkit-filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
            filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
            padding: 5px;
            border-radius: 10px;
            border: 1px solid #cccccc;
            bottom: 12px;
            left: -50px;
        }

            .ol-default-popup:after, .ol-popup:before {
                top: 100%;
                border: solid transparent;
                content: " ";
                height: 0;
                width: 0;
                position: absolute;
                pointer-events: none;
            }

            .ol-default-popup:after {
                border-top-color: white;
                border-width: 10px;
                left: 70px;
                margin-left: -10px;
            }

        #infobtn {
            float: left;
            width: 140px;
            height: 62px;
            cursor: pointer;
            background: url(showimg/hoveback.png) no-repeat center/100% 100%;
        }

            #infobtn:hover {
                background: url(showimg/backindex.png) no-repeat center/100% 100%;
            }

        #help {
            float: right;
            width: 108px;
            height: 62px;
            cursor: pointer;
            background: url(showimg/help.png) no-repeat center/100% 100%;
        }

            #help:hover {
                background: url(showimg/help-h.png) no-repeat center/100% 100%;
            }

        #query {
            float: right;
            width: 108px;
            height: 62px;
            cursor: pointer;
            background: url(showimg/query.png) no-repeat center/100% 100%;
        }

            #query:hover {
                background: url(showimg/query-h.png) no-repeat center/100% 100%;
            }

        #realtime {
            float: right;
            width: 108px;
            height: 63px;
            cursor: pointer;
            background: url(showimg/machposition.png) no-repeat center/100% 100%;
        }

            #realtime:hover {
                background: url(showimg/machposition-h.png) no-repeat center/100% 100%;
            }
        /* 底部样式 */
        footer {
            background-color: #363636;
            font-size: 14px;
            color: #fff;
            line-height: 33px;
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            height: 33px;
            text-align: center;
        }

        .icon-maptool-arrow {
            background-position: -464px -36px;
            background-image: url(../image/l1.png);
        }
    </style>
    <script type="text/javascript">
        var Config, pestsMap, streetview, layer, cropl, newcropl;
        var Interval1, Interval2;
        var indexl = 1;
        var alllayer;
        var region;
        var layerconfig;
        $(window).ready(function () {
            dev.App.MapPanel = $(".mappanel");
            dev.App.MapPanel.Target = $(".mappanel");
            dev.App.FillPanel = new dev.FillPanel($(".fillpanel"));
            dev.App.MapPanel.MapDOM = $(".mappaneldom");
            dev.App.MapPanel.MapDOM3D = $(".mappanel3d");
            dev.App.MapPanel.MapStreet = $(".content");
            if (dev.IsNull(Config)) {
                var config = null;
                $.ajax({
                    url: "../config/app.xml",
                    dataType: 'xml',
                    type: 'GET',
                    cache: false,
                    timeout: 2000,
                    async: false,
                    error: function (xml) {
                        alert("加载系统配置文件出错！");
                        return;
                    },
                    success: function (xml) {
                        config = $.xml2json(xml);
                    }
                });
                dev.App.Config = Config = config;
                layerconfig = Config.Extend.LayerForTree.LayerRoot[1].Child;
            }
            //layer = Enumerable.From(Config.Extend.LayerForTree.LayerRoot[1].Child).Where('s=>s.Type!=undefined && s.Type!=null && s.Type.indexOf("fine")>=0').ToArray();
            layer = getlayertreebyType("fine");
            initMap();
            dev.App.Map = pestsMap;
            dev.InitSMap3D(Config);
            initlayer();
            dev.App.Root = GetRootPath();
            dev.App.TempStyle = dev.CreateTempStyle();
            dev.App.InitMapMenu();
            dev.App.EventObject = $(dev);
            //initCropLegend(cropl);
            dev.projTransf();
            dev.MapLoad.InitMapSwitch(Config, $(".mappanel"));
            //二三维切换
            dev.App.MapSwitch.Target.bind("onSwitchClick", function (sender, opt) {
                if (dev.IsNull(opt)) return;
                featureclear();
                if (!dev.IsNull(streetview)) streetview.Clear();
                if (opt.type == "StreetView") {
                    dev.App.MapPanel.MapDOM3D.css("display", "none");
                    $('.mappaneldom').css({ "width": "100%", "display": "block" });
                    streetview = new dev.ShowStreetView();
                    streetview.LoadStreet();
                }
                else if (opt.type == "PotreeMap") {
                    $('.fillpanel').css({ "display": "block" });
                    dev.App.FillPanel.Add(GetRootPath() + "html/potreeview.html", null, "potreeviewframe");
                }
                else if (opt.type == "MonitorMap") {
                    $.ajax({
                        url: dev.MapLoad.GetUrlByRelID("Service") + "amstation/getall",
                        type: "Get",
                        contentType: 'application/json',
                        success: function (result) {
                            if (result.statusCode != 200 || result.data.length == 0) return;
                            showmonitor(result.data);
                        }
                    });
                }
                else {
                    if (opt.type == "3D") {
                        $('.mappaneldom').css({ "width": "100%", "display": "none" });
                        dev.App.MapPanel.MapDOM3D.css({ "width": "100%", "display": "block" });
                    }
                    else if (opt.type == "2D") {
                        $('.mappaneldom').css({ "width": "100%", "display": "block" });
                        dev.App.MapPanel.MapDOM3D.css("display", "none");
                    }
                    else if (opt.type == "Unit") {
                        $('.mappaneldom').css({ "width": "50%", "display": "block" });
                        dev.App.MapPanel.MapDOM3D.css({ "width": "50%", "display": "block", "float": "left" });
                    }
                }
                pestsMap.updateSize();
            });
            mapclick = pestsMap.on('click', function (evt) {
                var pixel = this.getPixelFromCoordinate(evt.coordinate);
                var ft;
                pestsMap.forEachFeatureAtPixel(pixel, function (feature) {
                    if (dev.IsNull(feature) || dev.IsNull(feature.getProperties().indepeid) || (!dev.IsNull(feature.f) && feature.f.indexOf("streeview") >= 0)) return;
                    var indepeid = feature.getProperties().indepeid;
                    var serialnumber = feature.getProperties().serialnumber;
                    window.open(GetRootPath() + "show/metedata.html?indepeid=" + indepeid + "&serialnumber=" + serialnumber, "_self");
                    ft = true;
                });
                if (ft) return;
                var mapproj = dev.App.Map.getView().getProjection();
                var newsrc = mapproj.getCode();
                var result = dev.SPointerQuery({
                    Url: dev.MapLoad.GetUrlByRelID(cropl.WFSUrl),
                    TypeName: cropl.TypeName,
                    Point: evt.coordinate,
                    SrsName: cropl.EPSG,
                    GeometryName: cropl.GeomField,
                    Map: pestsMap,
                    PX: 2
                });
                if (dev.IsNull(result) || result.length == 0) return;
                var prop = result[0].getProperties();
                window.open(GetRootPath() + "show/exhibition.html?prodata=" + prop.MASSIFID + "&index=" + indexl + "&newsrc=" + newsrc, "_self");
            });
            resize();
            newestcrop();
            //初始化土壤数据
            soilHistory();
            //初始化产量数据
            yieldHistory();
            //施肥数据
            fertilityHistory();
            //病虫害数据
            pestsHistory();
            //长势数据
            growthHistory();
            $(".moreclick").click(function (e) {
                var t = $(this).attr("tag");
                var id = $(this).attr("id");
                var text = $("p", this).text();
                window.open(GetRootPath() + "show/hiscropplay.html?prodata=" + t + "&layerdata=" + id + "&name=" + text + "&index=" + indexl, "_self");
            });
            $('#infobtn').click(function () {
                window.open(GetRootPath() + "guidpage.html", "_self");
            });
            $('#query').click(function () {
                window.open(GetRootPath() + "show/massdataquery.html", "_self");
            });
            $('#realtime').click(function () {
                window.open(GetRootPath() + "show/machineposition.html", "_self");
            });
        });
        $(window).resize(function () {
            resize();
        });
        $(window).unload(function () {
            $(this).remove();
        });
        function resize() {
            if ($('.content').height() <= 870) {
                $('#flow').css("overflow-y", "auto");
            }
            if ($('.content').width() <= 1300) {
                $('#flow').css("overflow-x", "auto");
            }
            $('footer').css("width", $('.content').width());
        }
        //初始化地图
        function initMap() {
            var initconfig = Config.SystemMap;
            var resolutions;
            if (!dev.IsNull(initconfig.LevelInfo) && !dev.IsNull(initconfig.LevelInfo.IsVisibleLevel)
                && initconfig.LevelInfo.IsVisibleLevel == "true") {
                resolutions = [];
                if (dev.IsNull(initconfig.DisplayEPSG)) initconfig.DisplayEPSG = "EPSG:4326";
                for (var i = 0; i < initconfig.LevelInfo.Levels.length; i++)
                    if (dev.IsNull(initconfig.DisplayEPSG) || initconfig.DisplayEPSG == "EPSG:4326") resolutions.push(parseFloat(initconfig.LevelInfo.Levels[i].Resolution));
                    else resolutions.push(parseFloat(initconfig.LevelInfo.Levels[i].Resolution3857));
            }

            pestsMap = new ol.Map({
                controls: new ol.control.defaults({ zoom: false, rotate: false, attribution: false }),
                interactions: ol.interaction.defaults().extend([new ol.interaction.DragRotateAndZoom()]),
                target: $(".mappaneldom")[0],
                logo: false
            });
            var minZoom = parseInt(initconfig.LevelInfo.MinZoom);
            var proj = ol.proj.get(initconfig.DisplayEPSG);
            pestsMap.setView(new ol.View({
                projection: proj,
                resolutions: resolutions,
                minZoom: minZoom,
                minResolution: resolutions[resolutions.length - 1],
                maxZoom: resolutions.length + minZoom - 1,
                maxResolution: resolutions[0]
            }));
            dev.App.Map = pestsMap;
            dev.MapLoad.InitMap($.extend({ Map: pestsMap }, initconfig));
        }
        function initlayer() {
            for (var i = 0; i < layer.length; i++) {
                var province1 = $("<div class='pro' id='" + i + "pro' style='position: absolute;width:130px;height:48px;background: url(showimg/nocheck.png) no-repeat;top: calc(" + 12 * (i) + "% + 5px);left: 10px;font-size: 15px; color: white; border-radius: 4px;background-size: 100% 100%;cursor: pointer;padding-left:8px;line-height: 46px;'>" + layer[i].Text + "</div>").appendTo($('.mappanel'));
                province1.mouseover(function () {
                    var id = $(this).attr("id");
                    $("#" + id).css({ "opacity": "0.8", "filter": "alpha(opacity:80)" });
                }).mouseleave(function () {
                    var id = $(this).attr("id");
                    $("#" + id).css({ "opacity": "1", "filter": "alpha(opacity:100)" });
                }).click(function () {
                    $(".pro").css({ "background": "url(showimg/nocheck.png) no-repeat", "background-size": "100% 100%" });
                    var id = $(this).attr("id");
                    selectlayer(id);
                    $(".attribute1").html("");
                    newestcrop();
                    //初始化土壤数据
                    soilHistory();
                    //初始化产量数据
                    yieldHistory();
                    //施肥数据
                    fertilityHistory();
                    //病虫害数据
                    pestsHistory();
                    //长势数据
                    growthHistory();
                });
            }
            selectlayer("0pro");
        }
        function selectlayer(id) {
            $("#" + id).css({ "background": "url(showimg/check.png) no-repeat", "background-size": "100% 100%" });
            $(".title", $(".leftpanel")).text($("#" + id)[0].innerText);
            indexl = parseInt(id.replace('pro', ''));
            var mcropl;
            if (!dev.IsNull(layer[indexl].Child[0].Child[0]) && !dev.IsNull(layer[indexl].Child[0].Child[0].Child)) {
                alllayer = layer[indexl].Child[0].Child[0].Child;
                mcropl = Enumerable.From(alllayer).Where('s=>s.Type.indexOf("massif")>=0').ToArray();
                var hcropl = Enumerable.From(alllayer).Where('s=>s.Type.indexOf("newcropl")>=0').ToArray();
            }
            else {
                mcropl = null;
                hcropl = null;
            }
            if (!dev.IsNull(mcropl) && mcropl.length > 0) {
                cropl = mcropl[0];
                region = cropl.CountyCode;
                AddWMS(cropl, true);
            } else {
                dev.MapUtils.RemoveLayer(cropl.Value, dev.App.Map);
                cropl = layer[indexl].Child;
                region = cropl.ID;
            }

            if (!dev.IsNull(hcropl) && hcropl.length > 0 && !dev.IsNull(hcropl[0].Child)) {
                if (hcropl[0].Child.length > 0)
                    newcropl = hcropl[0].Child[hcropl[0].Child.length - 1];
                else
                    newcropl = hcropl[0].Child;
            } else
                newcropl = null;
            var threemodel = Enumerable.From(alllayer).Where('s=>s.Type.indexOf("threemodel")>=0').ToArray();
            if (!dev.IsNull(threemodel) && threemodel.length > 0 && !dev.IsNull(threemodel[0].Child)) {
                var l3d = threemodel[0].Child;
                if (!dev.IsNull(l3d) && l3d.length > 0) {
                    for (var i = 0; i < l3d.length; i++) {
                        dev.Map3DUtils.Remove3DTileLayer(l3d[i].Value);
                        var tempdata = dev.ObjClone(l3d[i]);
                        tempdata.Url = dev.MapLoad.GetUrlByRelID(tempdata.Url);
                        dev.Map3DUtils.Add3DTileLayer(tempdata);
                    }
                }
            }
        }
        //初始化种植作物图例
        function initCropLegend(layerinfo) {
            if (dev.IsNull(croplegendcontrol)) {
                croplegendcontrol = $('<div class="croplegends" style="border:3px solid #6495ED;background:#87CEFA;opacity:0.6"></div>').appendTo(dev.App.MapPanel.MapDOM);
            }
            croplegendcontrol.empty();
            croplegend_filter = null;
            croptypes.unshift({ ID: "ALL", IconCss: "icon-nzw", Text: "全部" });
            for (var i = 0; i < croptypes.length; i++) {
                var cropItem = $('<div class="item" tag="' + croptypes[i].ID + '"><div class="icon ' + croptypes[i].IconCss + '"></div><div class="text">' + croptypes[i].Text + '</div></div>').appendTo(croplegendcontrol);
                cropItem.prop("data", croptypes[i]);
                cropItem.click(function () {
                    //显示数据
                    if ($(this).attr("tag") == "ALL") {
                        if ($(this).hasClass("itemselect")) {
                            $(this).removeClass("itemselect")
                            var selectnodes = $(".item[isoldcheck=true]", croplegendcontrol);
                            for (var j = 0; j < selectnodes.length; j++) {
                                $(selectnodes[j]).addClass("itemselect");
                                $(selectnodes[j]).removeAttr("isoldcheck");
                            }
                        }
                        else {
                            var selectnodes = $(".itemselect", croplegendcontrol);
                            for (var j = 0; j < selectnodes.length; j++) {
                                $(selectnodes[j]).attr("isoldcheck", true);
                                $(selectnodes[j]).removeClass("itemselect");
                            }
                            $(this).addClass("itemselect");

                        }
                        //将所有有select的移除
                    }
                    else {
                        //首先移除All 对应的相关设置
                        var allnode = $(".item[tag='ALL']", croplegendcontrol);
                        if (allnode.hasClass("itemselect")) {
                            allnode.removeClass("itemselect");
                            var selectnodes = $(".item[isoldcheck=true]", croplegendcontrol);
                            for (var j = 0; j < selectnodes.length; j++) {
                                $(selectnodes[j]).removeAttr("isoldcheck");
                            }
                        }
                        if ($(this).hasClass("itemselect")) $(this).removeClass("itemselect");
                        else $(this).addClass("itemselect");
                    }
                    //刷新WMS
                    getWMSFilter();
                    AddWMS(cropl, true);
                });
            }

        }
        //添加WMS
        function AddWMS(layerinfo, visible) {
            //判断该图层是否存在
            dev.MapUtils.RemoveLayer(layerinfo.Value, dev.App.Map);
            var param = {
                Map: dev.App.Map,
                ID: layerinfo.Value,
                Url: dev.MapLoad.GetUrlByRelID(layerinfo.Url),
                Layers: layerinfo.TypeName,
                Visible: dev.IsNull(visible) ? false : visible,
                ServerType: layerinfo.ServerType,
                EPSG: dev.App.Map.getView().getProjection().getCode()
            };
            if (!dev.IsNull(layerinfo.SldLegend)) {
                if (dev.IsNull(layerinfo.SldLegend.length)) layerinfo.SldLegend = [layerinfo.SldLegend];
                param.Sldbody = dev.MapLoad.GetSLDString(layerinfo.TypeName, dev.LegendToRule(layerinfo.SldLegend));
            }
            if (!dev.IsNull(layerinfo.Envelop)) {
                var arry = layerinfo.Envelop.split(',');
                param.Extent = [parseFloat(arry[0]), parseFloat(arry[1]), parseFloat(arry[2]), parseFloat(arry[3])];
            }
            dev.MapLoad.AddWMSLayer(param);
            var initExtent = param.Extent;
            if (dev.App.Config.SystemMap.DataEPSG != dev.App.Config.SystemMap.DisplayEPSG) initExtent = ol.proj.transformExtent(initExtent, dev.App.Config.SystemMap.DataEPSG, dev.App.Config.SystemMap.DisplayEPSG);
            dev.App.Map.getView().fit(initExtent, dev.App.Map.getSize());
            dev.App.Map.getView().setZoom(parseInt(layerinfo.Zoom));
        }
        function getWMSFilter() {
            //获取对应的查询条件
            if (dev.IsNull(croplegendcontrol)) return;
            var allnode = $(".item[tag='ALL']", croplegendcontrol);
            if (allnode.hasClass("itemselect")) croplegend_filter = null;
            else {
                var selectnodes = $(".itemselect", croplegendcontrol);
                if (selectnodes.length == 0) { croplegend_filter = null; return; }
                var tempfilter = "(";
                for (var i = 0; i < selectnodes.length; i++) {
                    var cdata = $(selectnodes[i]).prop("data");
                    if (dev.IsNull(cdata) || dev.IsNull(cdata.Filter)) continue;
                    tempfilter += "(" + cdata.Filter + ") OR ";
                }
                tempfilter = tempfilter.substr(0, tempfilter.length - 4);
                tempfilter += ")";
                croplegend_filter = tempfilter;
            }
        }
        function newestcrop() {
            if (!dev.IsNull($('#pie1').highcharts())) {
                $('#pie1').highcharts().destroy();
            }
            var tabname;
            if (!dev.IsNull(newcropl) && !dev.IsNull(newcropl.TypeName))
                tabname = newcropl.TypeName.split(':')[1];
            $.ajax({
                type: "POST",
                data: { tableName: tabname },
                url: dev.MapLoad.GetUrlByRelID("Service") + "crop/findCropInfoByType",
                success: function (response) {
                    if (dev.IsNull(response.data)) {
                        return;
                    }
                    corpchart(response.data);
                },
                error: function (e) {
                }
            })
        }
        function soilHistory() {
            if (!dev.IsNull($('#colum1').highcharts())) {
                $('#colum1').highcharts().destroy();
            }
            $.ajax({
                type: "POST",
                data: { region: region },
                url: dev.MapLoad.GetUrlByRelID("Service") + "soil/findHistoryArea",
                success: function (response) {
                    if (dev.IsNull(response.data)) {
                        return;
                    }
                    totalChart(response.data);
                },
                error: function (e) {
                    //flashDialog.Alert("请求失败", "error");
                }
            })
        }
        function totalChart(sdata) {
            var series1 = [{ name: "过多", data: [], type: "column", color: '#00FFFF' },
                { name: "适宜", data: [], type: 'column', color: "#00FF00" },
                { name: "不足", data: [], type: 'column', color: "#0000ff" },
                { name: "轻旱", data: [], type: 'column', color: "#FFFF00" },
            { name: "中旱", data: [], type: 'column', color: "#E27000" },
            { name: "重旱", data: [], type: 'column', color: "#7D4000" },
            { name: "极旱", data: [], type: 'column', color: "#FF0000" }
            ];
            $("#title1", $(".rightpane1")).text("历年土壤墒情等级面积(亩)");
            var series2 = [];
            var monitordate = [];
            var m = Enumerable.From(sdata).OrderBy('s=>s.CROPDATE').GroupBy('s=>s.CROPDATE').ToArray();
            for (var i = 0; i < m.length; i++) {
                monitordate.push(m[i].source[0].CROPDATE);
            }
            var griddata = Enumerable.From(sdata).OrderBy('s=>s.GRIDCODE').GroupBy('s=>s.GRIDCODE').ToArray();
            for (var i = 0; i < griddata.length; i++) {
                var currseries = { name: series1[griddata[i].source[0].GRIDCODE - 1].name, data: [], color: series1[griddata[i].source[0].GRIDCODE - 1].color };
                var mdata = Enumerable.From(griddata[i].source).OrderBy('s=>s.CROPDATE').GroupBy('s=>s.CROPDATE').ToArray();
                for (var j = 0; j < monitordate.length; j++) {
                    var soilname = Enumerable.From(mdata).Where('s=>s.source[0].CROPDATE=="' + monitordate[j] + '"').ToArray();
                    if (soilname.length > 0) {
                        var soilnum = Enumerable.From(soilname).Sum('s=>s.source[0].AREA');
                        currseries.data[j] = { y: parseFloat(dev.SqrtMetersToMu(soilnum * 1000000, 1)) };
                    }
                    else {
                        currseries.data[j] = { y: 0 };
                    }
                }
                series2.push(currseries);
            }
            hchart = {
                chart: {
                    borderWidth: 0,
                    backgroundColor: 'rgba(4,155,199,0)',
                    type: 'column',
                    style: {
                        color: "#FFFFFF"
                    }
                },
                title: {
                    text: ''
                },
                xAxis: [{
                    type: 'category',
                    labels: {
                        style: {
                            color: '#FFFFFF'
                        }
                    },
                    lineColor: '#000000',
                    categories: monitordate,
                    tickLength: 0,
                    crosshair: true
                }],
                yAxis: [{
                    min: 0,
                    title: {
                        text: '面积（亩）',
                        style: {
                            color: "#000000",
                        }
                    },
                    labels: {
                        style: {
                            color: '#FFFFFF'
                        }
                    },
                    gridLineWidth: 0,
                    gridLineColor: '#000000',
                    lineColor: '#000000',
                    lineWidth: 0.8,
                    tickAmount: 5
                }],
                legend: { itemStyle: { color: '#FFFFFF' }, padding: 2, margin: 1, itemMarginBottom: 0 },
                tooltip: {
                    headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                    pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                    '<td style="padding:0"><b>{point.y:.1f} 亩</b></td></tr>',
                    footerFormat: '</table>',
                    shared: true,
                    useHTML: true
                },
                plotOptions: {
                    column: {
                        borderWidth: 0,
                        cursor: 'pointer'
                    }

                },
                series: series2,
                credits: { enabled: false }
            };
            $('#colum1').highcharts(hchart);
        }
        function corpchart(data) {
            var series3 = [{ name: "农作物面积百分比", type: 'pie', data: [], minPointSize: 10, innerSize: '40%', zMin: 0 }];
            for (var i = 0; i < data.length; i++) {
                series3[0].data[i] = { name: data[i].CROPTYPE, y: parseFloat(dev.SqrtMetersToMu(data[i].CROPAREA, 1)) };
            }
            $('#pie1').highcharts({
                chart: {
                    borderWidth: 1,
                    backgroundColor: 'rgba(4,155,199,0)',
                    type: 'pie',
                    zoomType: 'xy',
                    style: {
                        color: "#ffffff"
                    },
                    borderColor: 'rgba(0,0,0,0)',
                    borderWidth: 0
                },
                title: {
                    text: newcropl.Value.replace("CropLayer", "") + "农作物面积",
                    style: { "color": "#FFF5EE", "fontSize": "12px" },
                    verticalAlign: "bottom"
                },
                tooltip: {
                    headerFormat: '',
                    pointFormat: '<b>{point.name}</b>: {point.y}亩,占比{point.percentage:.1f} %'
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            distance: 5,
                            enabled: true,
                            format: '{point.name}',
                            color: (Highcharts.theme && Highcharts.theme.dataLabelsColor) || 'white',
                        },
                        size: '70%'
                    }
                },
                series: series3,
                credits: { enabled: false },
            });
        }
        function yieldHistory() {
            if (!dev.IsNull($('#pie2').highcharts())) {
                $('#pie2').highcharts().destroy();
            }
            if (!dev.IsNull($('#pie3').highcharts())) {
                $('#pie3').highcharts().destroy();
            }
            if (!dev.IsNull($('#pie4').highcharts())) {
                $('#pie4').highcharts().destroy();
            }
            $.ajax({
                type: "POST",
                data: { region: region },
                url: dev.MapLoad.GetUrlByRelID("Service") + "yield/findHistoryArea",
                success: function (response) {
                    if (!dev.IsNull(response.data)) {
                        yieldChart(response.data);
                    }
                },
                error: function (e) {
                    //flashDialog.Alert("请求失败", "error");
                }
            })
        }
        function yieldChart(sdata) {
            var series4 = [{ name: "丰年", data: [], type: "column", color: '#00FF00' },
                { name: "偏丰年", data: [], type: 'column', color: "#7CC623" },
                { name: "持平略增", data: [], type: 'column', color: "#22F1E0" },
                { name: "持平略减", data: [], type: 'column', color: "#FFFF00" },
                { name: "偏欠年", data: [], type: 'column', color: "#EA6B48" },
                { name: "欠年", data: [], type: 'column', color: "#FF0000" }
            ];
            $("#title3", $(".rightpane2")).text("历年农作物产量面积(亩)");
            var gridpie = Enumerable.From(sdata).OrderBy('s=>s.CROPDATE').GroupBy('s=>s.CROPDATE').ToArray();
            var hchart = {
                chart: {
                    borderWidth: 1,
                    backgroundColor: 'rgba(4,155,199,0)',
                    type: 'pie',
                    zoomType: 'xy',
                    style: {
                        color: "#ffffff"
                    },
                    borderColor: 'rgba(0,0,0,0)',
                    borderWidth: 0
                },
                title: {
                    style: { "color": "#FFF5EE", "fontSize": "12px" },
                    verticalAlign: "bottom",
                    y: -1
                },
                tooltip: {
                    headerFormat: '',
                    pointFormat: '<b>{point.name}</b>: {point.percentage:.1f} %'
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            distance: 5,
                            enabled: true,
                            format: '{point.percentage:.1f} %',
                            color: (Highcharts.theme && Highcharts.theme.dataLabelsColor) || 'white',
                        },
                        size: '70%'
                    }
                },
                credits: { enabled: false },
            }
            for (var i = 0; i < gridpie.length; i++) {
                var series5 = [{ type: 'pie', data: [], minPointSize: 10, innerSize: '40%', zMin: 0 }];
                var sdata = gridpie[i].source;
                for (var j = 0; j < sdata.length; j++) {
                    series5[0].data[j] = { name: series4[sdata[j].GRIDCODE - 1].name, y: parseFloat(dev.SqrtMetersToMu(sdata[j].AREA * 1000000, 1)), z: sdata[j].GRIDCODE, color: series4[sdata[j].GRIDCODE - 1].color };
                }
                hchart.title.text = sdata[0].CROPDATE + "产量";
                hchart.series = series5;
                $('#pie' + (i + 2)).highcharts(hchart);
            }
        }
        function fertilityHistory() {
            if (!dev.IsNull($('#colum2').highcharts())) {
                $('#colum2').highcharts().destroy();
            }
            $.ajax({
                type: "POST",
                data: { region: region },
                url: dev.MapLoad.GetUrlByRelID("Service") + "fertility/findHistoryArea",
                success: function (response) {
                    if (dev.IsNull(response.data)) {
                        return;
                    }
                    fertilityChart(response.data);
                },
                error: function (e) {
                    //flashDialog.Alert("请求失败", "error");
                }
            })
        }
        function fertilityChart(sdata) {
            var series6 = [{ name: "极高", data: [], type: "column", color: '#00FF00' },
                { name: "高", data: [], type: 'column', color: "#00A884" },
                { name: "中", data: [], type: 'column', color: "#22F1E0" },
                { name: "低", data: [], type: 'column', color: "#FFAA01" },
                { name: "极低", data: [], type: 'column', color: "#FF0000" }
            ];
            $("#title9", $(".rightpane3")).text("历年农作物施肥等级面积(亩)");
            var series7 = [];
            var fertilitydate = [];
            var m = Enumerable.From(sdata).OrderBy('s=>s.CROPDATE').GroupBy('s=>s.CROPDATE').ToArray();
            for (var i = 0; i < m.length; i++) {
                fertilitydate.push(m[i].source[0].CROPDATE);
                if (i < 3) {
                    var grid = Enumerable.From(m[i]).Where('s=>s.GRIDCODE==1').ToArray();
                    if (!dev.IsNull(grid) && grid.length > 0) {
                        var sum = grid[0].AREA;
                        var sumfer = parseFloat(dev.SqrtMetersToMu(sum * 1000000, 1))
                        $("#attr" + (i + 1), $(".rightpane3")).html("<span style='font-size:15px;line-height: calc(250% - 10px);color:#7B68EE'>极高：" + sumfer + "</span></br><span style='font-size:12px;color:#FFFFFF'>" + m[i].source[0].CROPDATE + "</span>");
                    }
                }
            }

            var griddata = Enumerable.From(sdata).OrderBy('s=>s.GRIDCODE').GroupBy('s=>s.GRIDCODE').ToArray();
            for (var i = 0; i < griddata.length; i++) {
                var currseries = { name: series6[griddata[i].source[0].GRIDCODE - 1].name, data: [], color: series6[griddata[i].source[0].GRIDCODE - 1].color };
                var mdata = Enumerable.From(griddata[i].source).OrderBy('s=>s.CROPDATE').GroupBy('s=>s.CROPDATE').ToArray();
                for (var j = 0; j < fertilitydate.length; j++) {
                    var fertilityname = Enumerable.From(mdata).Where('s=>s.source[0].CROPDATE=="' + fertilitydate[j] + '"').ToArray();
                    if (fertilityname.length > 0) {
                        var fertilitynum = Enumerable.From(fertilityname).Sum('s=>s.source[0].AREA');
                        currseries.data[j] = { y: parseFloat(dev.SqrtMetersToMu(fertilitynum * 1000000, 1)) };
                    }
                    else {
                        currseries.data[j] = { y: 0 };
                    }
                }
                series7.push(currseries);
            }
            hchart = {
                chart: {
                    borderWidth: 0,
                    backgroundColor: 'rgba(4,155,199,0)',
                    type: 'column',
                    style: {
                        color: "#FFFFFF"
                    }
                },
                title: {
                    text: ''
                },
                xAxis: [{
                    type: 'category',
                    labels: {
                        style: {
                            color: '#FFFFFF'
                        }
                    },
                    lineColor: '#000000',
                    categories: fertilitydate,
                    tickLength: 0,
                    crosshair: true
                }],
                yAxis: [{
                    min: 0,
                    title: {
                        text: '面积（亩）',
                        style: {
                            color: "#000000",
                        }
                    },
                    labels: {
                        style: {
                            color: '#FFFFFF'
                        }
                    },
                    gridLineWidth: 0,
                    gridLineColor: '#000000',
                    lineColor: '#000000',
                    lineWidth: 0.8,
                    tickAmount: 5
                }],
                legend: { itemStyle: { color: '#FFFFFF' }, padding: 2, margin: 1, itemMarginBottom: 0 },
                tooltip: {
                    headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                    pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                    '<td style="padding:0"><b>{point.y:.1f} 亩</b></td></tr>',
                    footerFormat: '</table>',
                    shared: true,
                    useHTML: true
                },
                plotOptions: {
                    column: {
                        borderWidth: 0,
                        cursor: 'pointer'
                    }

                },
                series: series7,
                credits: { enabled: false }
            };
            $('#colum2').highcharts(hchart);

        }
        function pestsHistory() {
            if (!dev.IsNull($('#colum3').highcharts())) {
                $('#colum3').highcharts().destroy();
            }
            $.ajax({
                type: "POST",
                data: { region: region },
                url: dev.MapLoad.GetUrlByRelID("Service") + "pests/findHistoryArea",
                success: function (response) {
                    if (dev.IsNull(response.data)) {
                        return;
                    }
                    pestsChart(response.data);
                },
                error: function (e) {
                    //flashDialog.Alert("请求失败", "error");
                }
            })
        }
        function pestsChart(sdata) {
            var series8 = [{ name: "健康", data: [], type: "column", color: '#00FF00' },
                { name: "轻微", data: [], type: 'column', color: "#FAF402" },
                { name: "中等", data: [], type: 'column', color: "#FF7F02" },
                { name: "严重", data: [], type: 'column', color: "#FF0000" }
            ];
            $("#title5", $(".leftpanel2")).text("历年农作物病虫害等级面积(亩)");
            var series9 = [];
            var pestsdate = [];
            var m = Enumerable.From(sdata).OrderBy('s=>s.CROPDATE').GroupBy('s=>s.CROPDATE').ToArray();
            for (var i = 0; i < m.length; i++) {
                pestsdate.push(m[i].source[0].CROPDATE);
                if (i < 3) {
                    var grid = Enumerable.From(m[i]).Where('s=>s.GRIDCODE==1').ToArray();
                    if (!dev.IsNull(grid) && grid.length > 0) {
                        var sum = grid[0].AREA;
                        var sumfer = parseFloat(dev.SqrtMetersToMu(sum * 1000000, 1))
                        $("#attr" + (i + 4), $(".leftpanel2")).html("<span style='font-size:15px;line-height: calc(250% - 10px);color:#7B68EE'>健康：" + sumfer + "</span></br><span style='font-size:12px;color:#FFFFFF'>" + m[i].source[0].CROPDATE + "</span>");
                    }
                }
            }

            var griddata = Enumerable.From(sdata).OrderBy('s=>s.GRIDCODE').GroupBy('s=>s.GRIDCODE').ToArray();
            for (var i = 0; i < griddata.length; i++) {
                var currseries = { name: series8[griddata[i].source[0].GRIDCODE - 1].name, data: [], color: series8[griddata[i].source[0].GRIDCODE - 1].color };
                var mdata = Enumerable.From(griddata[i].source).OrderBy('s=>s.CROPDATE').GroupBy('s=>s.CROPDATE').ToArray();
                for (var j = 0; j < pestsdate.length; j++) {
                    var pestsname = Enumerable.From(mdata).Where('s=>s.source[0].CROPDATE=="' + pestsdate[j] + '"').ToArray();
                    if (pestsname.length > 0) {
                        var pestsnum = Enumerable.From(pestsname).Sum('s=>s.source[0].AREA');
                        currseries.data[j] = { y: parseFloat(dev.SqrtMetersToMu(pestsnum * 1000000, 1)) };
                    }
                    else {
                        currseries.data[j] = { y: 0 };
                    }
                }
                series9.push(currseries);
            }
            hchart = {
                chart: {
                    borderWidth: 0,
                    backgroundColor: 'rgba(4,155,199,0)',
                    type: 'column',
                    style: {
                        color: "#FFFFFF"
                    }
                },
                title: {
                    text: ''
                },
                xAxis: [{
                    type: 'category',
                    labels: {
                        style: {
                            color: '#FFFFFF'
                        }
                    },
                    gridLineWidth: 0,
                    gridLineColor: 'rgba(70,130,180,0.8)',
                    lineColor: '#00008B',
                    categories: pestsdate,
                    tickLength: 0,
                    crosshair: true
                }],
                yAxis: [{
                    min: 0,
                    title: {
                        text: '面积（亩）',
                        style: {
                            color: "#000000",
                        }
                    },
                    labels: {
                        style: {
                            color: '#FFFFFF'
                        }
                    },
                    gridLineWidth: 0,
                    gridLineColor: 'rgba(70,130,180,0.8)',
                    lineColor: '#00008B',
                    lineWidth: 0.8,
                    tickAmount: 5
                }],
                legend: { itemStyle: { color: '#FFFFFF' }, padding: 2, margin: 1, itemMarginBottom: 0 },
                tooltip: {
                    headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                    pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                    '<td style="padding:0"><b>{point.y:.1f} 亩</b></td></tr>',
                    footerFormat: '</table>',
                    shared: true,
                    useHTML: true
                },
                plotOptions: {
                    column: {
                        borderWidth: 0,
                        cursor: 'pointer'
                    }

                },
                series: series9,
                credits: { enabled: false }
            };
            $('#colum3').highcharts(hchart);
        }
        function growthHistory() {
            if (!dev.IsNull(Interval2)) { clearInterval(Interval2); Interval2 = null; }
            if (!dev.IsNull(Interval1)) { clearInterval(Interval1); Interval1 = null; }
            if (!dev.IsNull($('#colum5').highcharts())) {
                $('#colum5').highcharts().destroy();
                $('#colum4').highcharts().destroy();
            }
            $.ajax({
                type: "POST",
                data: { region: region },
                url: dev.MapLoad.GetUrlByRelID("Service") + "growth/findHistoryArea",
                success: function (response) {
                    if (dev.IsNull(response.data)) {
                        return;
                    }
                    growthChart(response.data);
                },
                error: function (e) {
                    //flashDialog.Alert("请求失败", "error");
                }
            })
        }
        function growthChart(sdata) {
            var series10 = [{ name: "长势好", data: [], type: "column", color: '#0000ff' },
                { name: "长势持平", data: [], type: 'column', color: "#00ff00" },
                { name: "长势差", data: [], type: 'column', color: "#ff0000" }
            ];
            $("#title7", $(".leftpanel3")).text("历年农作物长势等级面积(亩)");
            var series11 = [];
            var growthdate = [];
            var m = Enumerable.From(sdata).GroupBy('s=>s.CROPDATE').OrderBy('s=>s.CROPDATE').ToArray();
            for (var i = 0; i < m.length; i++) {
                growthdate.push(m[i].source[0].CROPDATE);
            }
            var newdata = m[m.length - 1];
            var sum = 0;
            var sum_data = Enumerable.From(newdata).Where('s=>s.GRIDCODE==1').ToArray()[0];
            if (!dev.IsNull(sum_data)) sum = sum_data.AREA;
            var sumfer = parseFloat(dev.SqrtMetersToMu(sum * 1000000, 1))
            $("#attr7", $(".leftpanel3")).html("<span style='font-size:15px;line-height: calc(250% - 10px);color:#7B68EE'>长势好：" + sumfer + "</span></br><span style='font-size:12px;color:#FFFFFF'>" + newdata.source[0].CROPDATE + "农作物长势等级</span>");
            var griddata = Enumerable.From(sdata).GroupBy('s=>s.GRIDCODE').OrderBy('s=>s.GRIDCODE').ToArray();
            for (var i = 0; i < griddata.length; i++) {
                var currseries = { name: series10[griddata[i].source[0].GRIDCODE - 1].name, data: [], color: series10[griddata[i].source[0].GRIDCODE - 1].color };
                var mdata = Enumerable.From(griddata[i].source).GroupBy('s=>s.CROPDATE').OrderBy('s=>s.CROPDATE').ToArray();
                for (var j = 0; j < growthdate.length; j++) {
                    var growthname = Enumerable.From(mdata).Where('s=>s.source[0].CROPDATE=="' + growthdate[j] + '"').ToArray();
                    if (growthname.length > 0) {
                        var growthnum = Enumerable.From(growthname).Sum('s=>s.source[0].AREA');
                        currseries.data[j] = { y: parseFloat(dev.SqrtMetersToMu(growthnum * 1000000, 1)) };
                    }
                    else {
                        currseries.data[j] = { y: 0 };
                    }
                }
                series11.push(currseries);
            }
            var series12 = [];
            var gridnewdata = Enumerable.From(newdata).GroupBy('s=>s.GRIDCODE').OrderBy('s=>s.GRIDCODE').ToArray();
            for (var i = 0; i < gridnewdata.length; i++) {
                var growthnum = Enumerable.From(gridnewdata[i]).Sum('s=>s.AREA');
                var currseries = { name: series10[gridnewdata[i].source[0].GRIDCODE - 1].name, y: parseFloat(dev.SqrtMetersToMu(growthnum * 1000000, 1)), color: series10[gridnewdata[i].source[0].GRIDCODE - 1].color };
                series12.push(currseries);
            }
            hchart = {
                chart: {
                    borderWidth: 0,
                    backgroundColor: 'rgba(4,155,199,0)',
                    type: 'spline',
                    style: {
                        color: "#FFFFFF"
                    }
                },
                title: {
                    text: ''
                },
                xAxis: [{
                    type: 'category',
                    labels: {
                        style: {
                            color: '#FFFFFF',
                            fontSize: '8px'
                        }
                    },
                    lineColor: '#000000',
                    categories: growthdate,
                    tickLength: 0,
                    crosshair: true
                }],
                yAxis: [{
                    min: 0,
                    title: {
                        text: '',
                        style: {
                            color: "#000000",
                        }
                    },
                    labels: {
                        style: {
                            color: '#FFFFFF'
                        }
                    },
                    gridLineWidth: 0,
                    gridLineColor: '#000000',
                    lineColor: '#000000',
                    lineWidth: 0.8,
                    tickAmount: 5
                }],
                legend: { itemStyle: { color: '#FFFFFF' }, padding: 2, margin: 1, itemMarginBottom: 0 },
                tooltip: {
                    borderColor: '#FFFFFF',
                    backgroundColor: 'rgba(135,206,250,0.8)',
                    borderRadius: 20,
                    borderWidth: 0,
                    headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                    pointFormat: '<tr><td style="color:#FFFFFF;padding:0">{series.name}: </td>' +
                    '<td style="padding:0"><b>{point.y:.1f} 亩</b></td></tr>',
                    footerFormat: '</table>',
                    shared: true,
                    useHTML: true
                },
                plotOptions: {
                    spline: {
                        borderWidth: 0,
                        cursor: 'pointer'
                    }

                },
                series: series11,
                credits: { enabled: false }
            };
            //$('#colum5').highcharts(hchart);
            var ht5 = Highcharts.chart('colum5', hchart);
            var j = 0;
            if (!dev.IsNull(Interval2)) { clearInterval(Interval2); Interval2 = null; }
            Interval2 = setInterval(function () {
                if (j === ht5.series[0].data.length) {
                    j = 0;
                }
                ht5.series[0].data[j].select();
                j += 1;
            }, 1000);
            var growht = {
                chart: {
                    borderWidth: 0,
                    backgroundColor: 'rgba(4,155,199,0)',
                    type: 'column',
                    style: {
                        color: "#FFFFFF"
                    }
                },
                title: {
                    text: ''
                },
                xAxis: [{
                    type: 'category',
                    labels: {
                        style: {
                            color: '#FFFFFF',
                            fontSize: '10px'
                        }
                    },
                    lineColor: '#6495ED',
                    tickLength: 0,
                    crosshair: true
                }],
                yAxis: [{
                    min: 0,
                    title: {
                        text: '',
                        style: {
                            color: "#000000",
                        }
                    },
                    labels: {
                        style: {
                            color: '#FFFFFF'
                        }
                    },
                    gridLineWidth: 0,
                    gridLineColor: '#000000',
                    lineColor: '#000000',
                    lineWidth: 0,
                }],
                legend: {
                    enabled: false
                },
                plotOptions: {
                    series: {
                        borderWidth: 0,
                        dataLabels: {
                            enabled: true,
                            format: '{point.y:.1f}',
                            color: '#FFFFFF'
                        }
                    }
                },
                tooltip: {
                    headerFormat: '',
                    pointFormat: '<span style="color:{point.color}">{point.name}</span>: <b>{point.y:.2f}亩</b>'
                },
                series: [{
                    data: series12
                }],
                credits: { enabled: false }
            };
            var ht = Highcharts.chart('colum4', growht);
            var i = 0;
            if (!dev.IsNull(Interval1)) { clearInterval(Interval1); Interval1 = null; }
            Interval1 = setInterval(function () {
                if (i === growht.series[0].data.length) {
                    i = 0;
                }
                //ht.series[0].data[i].select();
                var points = ht.series[0].data[i];
                ht.tooltip.refresh(points);
                i += 1;
            }, 3000);
        }
        //获取组织下所有监测站点
        function showmonitor(data) {
            if (dev.IsNull(data) || data.length == 0) return;
            var features = [];
            for (var i = 0; i < data.length; i++) {
                var x = data[i].longitude;
                var y = data[i].latitude;
                var currfeature = new ol.Feature(new ol.geom.Point([parseFloat(x), parseFloat(y)]));
                currfeature.set("serialnumber", data[i].serialnumber);
                currfeature.set("indepeid", data[i].indepeid);
                currfeature.setStyle(new ol.style.Style({
                    image: new ol.style.Icon({ src: GetRootPath() + "show/showimg/mpoint.png" }),
                    text: new ol.style.Text({ text: data[i].no, font: "15px serif", offsetX: 5, offsetY: -20, fill: new ol.style.Fill({ color: [255, 255, 255, 1] }) }),
                    //fill: new ol.style.Fill({ color: [0, 0, 0, 1] }),
                }));
                features.push(currfeature);
            }
            dev.MapUtils.ClearAndAddFeatures(features, "tempGraphicLayer", null, pestsMap);
        }
        //辅助函数
        function featureclear() {
            dev.MapUtils.ClearFeature("tempGraphicLayer", pestsMap);
        }
        function getlayertreebyType(type) {
            var layertree = [];
            if (dev.IsNull(layerconfig)) return null;
            if (dev.IsNull(layerconfig.length)) layertree = [dev.ObjClone(layerconfig)];
            else layertree = layerconfig.clone();
            //首先找到根级节点为该类型的
            layertree = Enumerable.From(layertree).Where('s=>s.Type.indexOf("' + type + '")>=0').ToArray();
            getnodebytype(layertree, type);
            return layertree;
        }
        function getnodebytype(nodes, type) {
            if (dev.IsNull(nodes) || dev.IsNull(type)) return;
            for (var i = 0; i < nodes.length; i++) {
                if (dev.IsNull(nodes[i].Child)) continue;
                if (dev.IsNull(nodes[i].Child.length)) nodes[i].Child = [nodes[i].Child];
                if (!dev.IsNull(nodes[i].Child) && nodes[i].Child.length > 0) getnodebytype(nodes[i].Child, type);
            }
        }
    </script>
</head>
<body id="flow">
    <div class="content" style="min-height: 870px; min-width: 1300px;">
        <div class="headqury" style="position: relative; width: 96%; height: 62px; background: none; margin-top: 60px">
            <div id="infobtn"></div>
            <div id="help"></div>
            <div id="query"></div>
            <div id="realtime"></div>
        </div>
        <div class="leftpanel">
            <div class="title"></div>
            <div class="mappanel">
                <div class="mappaneldom"></div>
                <div class="mappanel3d"></div>
                <div class="street"></div>
            </div>
        </div>
        <div class="rightpane2" style="width: 12%; height: calc(30% - 40px);">
            <div class="title" style="width: 94%; margin: 5px 5px 0px 5px">
                <div id="Div1" style="float: left;">农作物种植历史</div>
                <div id="230104crops" class="moreclick" tag="crop" style="float: right; margin-right: 10px; cursor: pointer">
                    <p style="display: none">农作物种植</p>
                    更多
                </div>
            </div>
            <div id="pie1" class="piediv1" style="width: 100%"></div>
        </div>
        <div class="rightpane1" style="width: 23.5%; margin-left: 0.5%; height: calc(30% - 40px);">
            <div class="title">
                <div id="title1" style="float: left;"></div>
                <div id="moisture" class="moreclick" tag="soil" style="float: right; margin-right: 10px; cursor: pointer">
                    <p style="display: none">土壤墒情等级</p>
                    更多
                </div>
            </div>
            <div id="colum1" class="columdiv1" style="width: 96%; margin-left: 2%"></div>
        </div>
        <div class="rightpane2" style="width: 36%; height: calc(30% - 40px); margin-top: 19px">
            <div class="title">
                <div id="title3" style="float: left;"></div>
                <div id="produce" class="moreclick" tag="yield" style="float: right; margin-right: 10px; cursor: pointer">
                    <p style="display: none">农作物产量等级</p>
                    更多
                </div>
            </div>
            <div id="pie2" class="piediv1"></div>
            <div id="pie3" class="piediv1"></div>
            <div id="pie4" class="piediv1"></div>
        </div>
        <div class="leftpanel2" style="width: 28%; height: calc(33% - 40px); margin-top: 19px">
            <div class="title">
                <div id="title5" style="float: left;"></div>
                <div id="bch" class="moreclick" tag="pests" style="float: right; margin-right: 10px; cursor: pointer">
                    <p style="display: none">农作物病虫害等级</p>
                    更多
                </div>
            </div>
            <div class="attribute">
                <div id="attr4" class="attribute1"></div>
                <div id="attr5" class="attribute1"></div>
                <div id="attr6" class="attribute1"></div>
            </div>
            <div id="colum3" class="columdiv1"></div>
        </div>
        <div class="leftpanel3" style="width: 28%; height: calc(33% - 40px); margin-top: 19px">
            <div class="title">
                <div id="title7" style="float: left;"></div>
                <div id="decision" class="moreclick" tag="growth" style="float: right; margin-right: 10px; cursor: pointer">
                    <p style="display: none">农作物长势等级</p>
                    更多
                </div>
            </div>
            <div class="attribute" style="width: 42%">
                <div id="attr7" class="attribute1"></div>
                <div id="colum4" class="piediv1" style="width: 100%; height: 70%; margin-left: -10px"></div>
            </div>
            <div id="colum5" style="width: 53%" class="columdiv1"></div>
        </div>
        <div class="rightpane3" style="width: 36%; height: calc(33% - 40px); margin-top: 19px">
            <div class="title">
                <div id="title9" style="float: left;"></div>
                <div id="fertilizer" class="moreclick" tag="fertility" style="float: right; margin-right: 10px; cursor: pointer">
                    <p style="display: none">农作物施肥等级</p>
                    更多
                </div>
            </div>
            <div class="attribute">
                <div id="attr1" class="attribute1"></div>
                <div id="attr2" class="attribute1"></div>
                <div id="attr3" class="attribute1"></div>
            </div>
            <div id="colum2" class="columdiv1"></div>
        </div>
    </div>
    <div class="fillpanel"></div>
    <footer>
        Copyright&nbsp;©&nbsp;2017-2020&nbsp;&nbsp;北京禾壮慧农科技发展有限公司&nbsp;&nbsp;版权所有
    </footer>
</body>
</html>
