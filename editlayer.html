<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">

    <link href="css/app.css" rel="stylesheet" />
    <link href="css/ol.css" rel="stylesheet" />
    <script src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/data.util.js"></script>
    <script type="text/javascript" src="js/ol.min.3.2.1.js"></script>
    <script type="text/javascript" src="js/polyfill.min.js"></script>
    <script type="text/javascript" src="js/guid.js"></script>
    <script type="text/javascript" src="js/spin.js"></script>
    <script type="text/javascript" src="js/jsts.min.js"></script>
    <script type="text/javascript" src="js/linq.min.js"></script>
    <script src="js/spin.js"></script>
    <style type="text/css">
        .content {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .item {
            height: 35px;
            /*border-bottom: 1px solid #ddd;*/
            width: 100%;
        }

            .item:hover {
                background-color: #ddd;
            }

            .item .check {
                height: 16px;
                width: 16px;
                display: inline-block;
                margin-top: 10px;
                float: right;
                margin-right: 10px;
            }

            .item .edit {
                display: none;
                float: left;
                height: 35px;
                width: 30px;
            }

                .item .edit .icon {
                    height: 16px;
                    width: 16px;
                    margin-top: 8px;
                    margin-left: 5px;
                    background-image: url(image/agri/trackedit.png);
                }

                    .item .edit .icon:hover {
                        background-color: #0099cc;
                    }

        .layeritem {
            margin-left: 30px;
            width: 170px;
            height: 35px;
            position: relative;
        }

        .edittool {
            height: 68px;
            width: 295px;
            position: absolute;
            top: 50px;
            left: 200px;
            border: 1px solid #0099cc;
        }

            .edittool .head {
                height: 30px;
                width: 100%;
                color: #fcfcfc;
                background: #0099cc;
                line-height: 30px;
            }

            .edittool .layeredit {
                height: 35px;
                width: 100%;
                position: relative;
            }

                .edittool .layeredit .Button {
                    height: 26px;
                    width: 30px;
                    background-color: #0099cc;
                    display: inline-block;
                    margin-left: 15px;
                    margin-top: 5px;
                }

                .edittool .layeredit .DisableButton {
                    height: 26px;
                    width: 30px;
                    background-color: #ddd;
                    display: inline-block;
                    margin-left: 15px;
                    margin-top: 5px;
                }

                .edittool .layeredit .Button:nth-child(1) {
                    margin-left: 20px;
                }

                .edittool .layeredit .Button:hover {
                    background-color: #95B8E7;
                }


                .edittool .layeredit .icon-featureadd {
                    background-image: url('image/agri/f_add.png');
                    background-position: center;
                    background-size: 16px;
                    background-repeat: no-repeat;
                }

                .edittool .layeredit .icon-featureselect {
                    background-image: url('image/agri/f_select.png');
                    background-position: center;
                    background-size: 16px;
                    background-repeat: no-repeat;
                }

                .edittool .layeredit .icon-featureupdate {
                    background-image: url('image/agri/f_update.png');
                    background-position: center;
                    background-size: 16px;
                    background-repeat: no-repeat;
                }

                .edittool .layeredit .icon-featuresave {
                    background-image: url('image/agri/f_save.png');
                    background-position: center;
                    background-size: 16px;
                    background-repeat: no-repeat;
                }

                .edittool .layeredit .icon-featurecancel {
                    background-image: url('image/agri/f_cancel.png');
                    background-position: center;
                    background-size: 16px;
                    background-repeat: no-repeat;
                }

                .edittool .layeredit .icon-maptool-clearmap {
                    background-image: url(image/maptool/clearmap.png);
                    background-position: center;
                    background-repeat: no-repeat;
                }
    </style>
    <script type="text/javascript">
        var _zoom = 13, _countycode = "411728";
        var _extent = [113.616441430967, 32.986567988137, 114.316819848935, 33.313678173733];
        var _levelinfo = {
            ID: "navLevel", MinZoom: 1, Levels: [
                { ID: 100001, Sacle: "1:3亿", Resolution: 0.703125, TipInfo: "" },
                { ID: 100002, Sacle: "1:1.5亿", Resolution: 0.3515625, TipInfo: "" },
                { ID: 100003, Sacle: "1:7500万", Resolution: 0.175781249999999998, TipInfo: "" },
                { ID: 100004, Sacle: "1:3700万", Resolution: 0.087890625000000148, TipInfo: "" },
                { ID: 100005, Sacle: "1:1850万", Resolution: 0.043945312500000074, TipInfo: "国" },
                { ID: 100006, Sacle: "1:925万", Resolution: 0.021972656250000007, TipInfo: "" },
                { ID: 100007, Sacle: "1:460万", Resolution: 0.010986328125000018, TipInfo: "" },
                { ID: 100008, Sacle: "1:230万", Resolution: 0.005493164062500009, TipInfo: "" },
                { ID: 100009, Sacle: "1:115万", Resolution: 0.002746582031250001, TipInfo: "" },
                { ID: 100010, Sacle: "1:57万", Resolution: 0.001373291015625000, TipInfo: "" },
                { ID: 100011, Sacle: "1:29万", Resolution: 0.000686645507812498, TipInfo: "" },
                { ID: 100012, Sacle: "1:14万", Resolution: 0.000343322753906249, TipInfo: "" },
                { ID: 100013, Sacle: "1:72224", Resolution: 0.000171661376953125, TipInfo: "" },
                { ID: 100014, Sacle: "1:36112", Resolution: 0.000085830688476562, TipInfo: "" },
                { ID: 100015, Sacle: "1:18056", Resolution: 0.000042915344238281, TipInfo: "" },
                { ID: 100016, Sacle: "1:9028", Resolution: 0.000021457672119140, TipInfo: "" },
                { ID: 100017, Sacle: "1:4514", Resolution: 0.000010728836059570, TipInfo: "" },
                { ID: 100018, Sacle: "1:2257", Resolution: 0.000005364418029785, TipInfo: "" },
                { ID: 100019, Sacle: "1:1128", Resolution: 0.000002682209014892, TipInfo: "" },
                { ID: 100020, Sacle: "1:564", Resolution: 0.000001341104507446, TipInfo: "" }
            ]
        };
        var blocksldlegends = [
            { ID: 0, Text: "耕地", Fill: { Color: "#10bc18", Opacity: 0.3 }, Border: { Width: 2, Color: "#10bc18" }, TextSymbol: { LabelField: "CLASSNAME", FontSize: 10, Fill: "#ffffff" } },
            { ID: 1, Text: "障碍物", Fill: { Color: "#FDCDB7", Opacity: 0.3 }, Border: { Width: 1, Color: "#FF0000" }, TextSymbol: { LabelField: "CLASSNAME", FontSize: 10, Fill: "#ffffff" }, Filter: "CLASSNAME='障碍物'" }
        ];
        var cropsldlegends = [
        { ID: 0, Text: "小麦", Fill: { Color: "#BF682A", Opacity: 0.5 }, Border: { Width: 2, Color: "#BF682A" }, TextSymbol: { LabelField: "CROPTYPE", FontSize: 10, Fill: "#ffffff" }, Filter: "CROPTYPE='小麦'" },
        { ID: 1, Text: "水稻", Fill: { Color: "#2F3685", Opacity: 0.5 }, Border: { Width: 2, Color: "#2F3685" }, TextSymbol: { LabelField: "CROPTYPE", FontSize: 10, Fill: "#ffffff" }, Filter: "CROPTYPE='水稻'" },
        { ID: 2, Text: "玉米", Fill: { Color: "#2ec938", Opacity: 0.5 }, Border: { Width: 2, Color: "#2ec938" }, TextSymbol: { LabelField: "CROPTYPE", FontSize: 10, Fill: "#ffffff" }, Filter: "CROPTYPE='玉米'" },
        { ID: 3, Text: "高粱", Fill: { Color: "#a1713d", Opacity: 0.5 }, Border: { Width: 2, Color: "#a1713d" }, TextSymbol: { LabelField: "CROPTYPE", FontSize: 10, Fill: "#ffffff" }, Filter: "CROPTYPE='高粱'" },
        { ID: 4, Text: "大豆", Fill: { Color: "#bf3bab", Opacity: 0.5 }, Border: { Width: 2, Color: "#bf3bab" }, TextSymbol: { LabelField: "CROPTYPE", FontSize: 10, Fill: "#ffffff" }, Filter: "CROPTYPE='大豆'" },
        { ID: 5, Text: "绿豆", Fill: { Color: "#30a5b8", Opacity: 0.5 }, Border: { Width: 2, Color: "#30a5b8" }, TextSymbol: { LabelField: "CROPTYPE", FontSize: 10, Fill: "#ffffff" }, Filter: "CROPTYPE='绿豆'" },
        { ID: 6, Text: "杂豆", Fill: { Color: "#3f7bbf", Opacity: 0.5 }, Border: { Width: 2, Color: "#3f7bbf" }, TextSymbol: { LabelField: "CROPTYPE", FontSize: 10, Fill: "#ffffff" }, Filter: "CROPTYPE='杂豆'" },
        { ID: 7, Text: "豆角", Fill: { Color: "#c22b71", Opacity: 0.5 }, Border: { Width: 2, Color: "#c22b71" }, TextSymbol: { LabelField: "CROPTYPE", FontSize: 10, Fill: "#ffffff" }, Filter: "CROPTYPE='豆角'" },
        { ID: 8, Text: "花生", Fill: { Color: "#c29d36", Opacity: 0.5 }, Border: { Width: 2, Color: "#c29d36" }, TextSymbol: { LabelField: "CROPTYPE", FontSize: 10, Fill: "#ffffff" }, Filter: "CROPTYPE='花生'" },
        { ID: 9, Text: "蔬菜", Fill: { Color: "#49a641", Opacity: 0.5 }, Border: { Width: 2, Color: "#49a641" }, TextSymbol: { LabelField: "CROPTYPE", FontSize: 10, Fill: "#ffffff" }, Filter: "CROPTYPE='蔬菜'" },
        { ID: 10, Text: "果树", Fill: { Color: "#9aba2f", Opacity: 0.5 }, Border: { Width: 2, Color: "#9aba2f" }, TextSymbol: { LabelField: "CROPTYPE", FontSize: 10, Fill: "#ffffff" }, Filter: "CROPTYPE='果树'" },
        { ID: 11, Text: "马铃薯", Fill: { Color: "#7f40a8", Opacity: 0.5 }, Border: { Width: 2, Color: "#7f40a8" }, TextSymbol: { LabelField: "CROPTYPE", FontSize: 10, Fill: "#ffffff" }, Filter: "CROPTYPE='马铃薯'" },
        { ID: 12, Text: "温室大棚", Fill: { Color: "#a82c41", Opacity: 0.5 }, Border: { Width: 2, Color: "#a82c41" }, TextSymbol: { LabelField: "CROPTYPE", FontSize: 10, Fill: "#ffffff" }, Filter: "CROPTYPE='温室大棚'" },
        { ID: 13, Text: "育秧大棚", Fill: { Color: "#394799", Opacity: 0.5 }, Border: { Width: 2, Color: "#394799" }, TextSymbol: { LabelField: "CROPTYPE", FontSize: 10, Fill: "#ffffff" }, Filter: "CROPTYPE='育秧大棚'" },
        { ID: 14, Text: "道路", Fill: { Color: "#c72a2a", Opacity: 0.5 }, Border: { Width: 2, Color: "#c72a2a" }, TextSymbol: { LabelField: "CROPTYPE", FontSize: 10, Fill: "#ffffff" }, Filter: "CROPTYPE='道路'" },
        { ID: 15, Text: "其它", Fill: { Color: "#24ad7d", Opacity: 0.5 }, Border: { Width: 2, Color: "#24ad7d" }, TextSymbol: { LabelField: "CROPTYPE", FontSize: 10, Fill: "#ffffff" }, Filter: "CROPTYPE='其它'" }
        ];
        var _layers = [
            {
                ID: "blocklayer1",
                Text: "遂平县地块",
                Value: "blocklayer1",
                Type: "WMS",
                Url: "http://58.49.122.250:8005/geoserver/cite/wms",
                WFSUrl: "http://58.49.122.250:8005/geoserver/cite/wfs",
                OWSUrl: "http://58.49.122.250:8005/geoserver/cite/ows",
                TypeName: "cite:AGRI_MASSIF_411728",
                CountyCode: '411728',
                GeomField: "geom",
                Envelop: [113.819282531738, 33.0573654174805, 113.984756469727, 33.2561950683594],
                SldLegend: blocksldlegends,
                IsEdit: true
            },
            {
                ID: "411728crop0",
                Text: "遂平县20170127",
                Value: "20170127CropLayer",
                Type: "WMS",
                Url: "http://58.49.122.250:8005/geoserver/cite/wms",
                WFSUrl: "http://58.49.122.250:8005/geoserver/cite/wfs",
                OWSUrl: "http://58.49.122.250:8005/geoserver/cite/ows",
                TypeName: "cite:AGRI_CROP_41172820170127",
                GeomField: "geom",
                Envelop: [113.819282531738, 33.0573654174805, 113.984756469727, 33.2561950683594],
                SldLegend: cropsldlegends
            },
            {
                ID: "411728crop1",
                Text: "遂平县20171107",
                Value: "20171107CropLayer",
                Type: "WMS",
                Url: "http://58.49.122.250:8005/geoserver/cite/wms",
                WFSUrl: "http://58.49.122.250:8005/geoserver/cite/wfs",
                OWSUrl: "http://58.49.122.250:8005/geoserver/cite/ows",
                TypeName: "cite:AGRI_CROP_41172820171107",
                GeomField: "geom",
                Envelop: [113.819282531738, 33.0573654174805, 113.984756469727, 33.2561950683594],
                SldLegend: cropsldlegends
            },
            {
                ID: "411728image0",
                Text: "2017年无人机影像",
                Value: "411728image0",
                Envelop: [113.819282531738, 33.0573654174805, 113.984756469727, 33.2561950683594],
                Url: "http://58.49.122.250:8005/geoserver/gwc/service/wmts",
                TypeName: "zmd",
                GeomField: "geom",
                Zoom: 12,
                Resolution: "0.703125",
                Level: 20,
                Type: "Tile"
            },
            {
                ID: "411728image1",
                Text: "2017年高分影像",
                Value: "411728image1",
                Envelop: [113.75923708791754, 33.023788230092016, 114.02518191173313, 33.360267321552],
                Type: "Tile",
                Url: "http://58.49.122.250:8005/geoserver/gwc/service/wmts",
                TypeName: "gfzmd",
                GeomField: "geom",
                Zoom: 12,
                Resolution: "0.703125",
                Level: 20
            }
        ];
        var xzq_layers = [
            { ID: 0, Text: "省", Value: "PROVINCE", Url: "http://58.49.122.250:8005/geoserver/cite/wms", WFSUrl: "http://58.49.122.250:8005/geoserver/cite/wfs", TypeName: "cite:AGRI_PROVINCE", GeomField: "geom" },
           { ID: 0, Text: "市", Value: "CITY", Url: "http://58.49.122.250:8005/geoserver/cite/wms", WFSUrl: "http://58.49.122.250:8005/geoserver/cite/wfs", TypeName: "cite:AGRI_CITY", GeomField: "geom" },
           { ID: 0, Text: "县", Value: "COUNTY", Url: "http://58.49.122.250:8005/geoserver/cite/wms", WFSUrl: "http://58.49.122.250:8005/geoserver/cite/wfs", TypeName: "cite:AGRI_COUNTY", GeomField: "geom" },
           { ID: 0, Text: "乡", Value: "TOWN", Url: "http://58.49.122.250:8005/geoserver/cite/wms", WFSUrl: "http://58.49.122.250:8005/geoserver/cite/wfs", TypeName: "cite:AGRI_TOWN", GeomField: "geom" }
        ];
        var serverurl = "http://192.168.19.200:8006/devframe-server/";
        var featurens = "http://www.opengeospatial.net/cite";
        //初始化
        var _map, _view, _layers;
        var _editlayer, edittools;
        $(function () {
            initmap();
            //添加县和乡
            addwms({
                Url: "http://58.49.122.250:8005/geoserver/cite/wms",
                WFSUrl: "http://58.49.122.250:8005/geoserver/cite/wfs",
                OWSUrl: "http://58.49.122.250:8005/geoserver/cite/ows",
                Value: "COUNTY",
                GeomField: "geom",
                Layers: "cite:AGRI_COUNTY",
                Sldsrc:"config/county.sld",
                ID: "county"
            })
            addwms({
                Url: "http://58.49.122.250:8005/geoserver/cite/wms",
                WFSUrl: "http://58.49.122.250:8005/geoserver/cite/wfs",
                OWSUrl: "http://58.49.122.250:8005/geoserver/cite/ows",
                Value: "town",
                GeomField: "geom",
                Layers: "cite:AGRI_TOWN",
                Sldsrc: "config/town.sld",
                ID: "town"
            })
            //添加图层
            $("input[type='checkbox']").click(function (s, e) {
                var ischecked = $(this)[0].checked;
                var layerid = $(this).attr("tag");
                var c_layerinfo = Enumerable.From(_layers).Where('s=>s.Value=="' + layerid + '"').FirstOrDefault();
                if (ischecked) {
                    //添加图层
                    if (IsNull(c_layerinfo)) return;
                    //判断是否可以编辑
                    if (c_layerinfo.IsEdit) {
                        var editinfo = $(".edit", $(this).parent().parent());
                        if (IsNull(editinfo)) return;
                        editinfo.css("display", "inline-block");
                    }
                    if (c_layerinfo.Type == "WMS") {
                        var param = {
                            ID: c_layerinfo.Value,
                            Url: c_layerinfo.Url,
                            Layers: c_layerinfo.TypeName,
                            Sldbody: getsldstring(c_layerinfo.TypeName, legendtorule(c_layerinfo.SldLegend)),
                            Extent: c_layerinfo.Envelop
                        }
                        addwms(param);
                    }
                    if (c_layerinfo.Type == "Tile") {
                        var param = {
                            ID: c_layerinfo.Value,
                            Url: c_layerinfo.Url,
                            Layers: c_layerinfo.TypeName,
                            Resolution: c_layerinfo.Resolution,
                            Level: c_layerinfo.Level,
                            Extent: c_layerinfo.Envelop
                        }
                        addwmts(param);
                    }
                }
                else {
                    if (IsNull(c_layerinfo)) return;
                    if (c_layerinfo.IsEdit) {
                        var editinfo = $(".edit", $(this).parent().parent());
                        if (IsNull(editinfo)) return;
                        editinfo.css("display", "none");
                    }
                    removelayer(layerid);
                }

            });
            $(".edit").click(function () {
                var tag = $(this).attr("tag");
                if (IsNull(tag)) return;
                _editlayer = Enumerable.From(_layers).Where('s=>s.Value=="' + tag + '"').FirstOrDefault();
                if (IsNull(_editlayer)) return;
                //弹出界面
                if (IsNull(edittools)) {
                    edittools = $('<div class="edittool"><div class="head"><span style="margin-left:10px;">图层编辑</span></div></div>').appendTo(".content");
                    var content = $('<div class="layeredit"></div>').appendTo(edittools);
                    var addbtn = $('<div class="ebtn Button icon-featureadd" title="新增" tag="add"></div>').appendTo(content);
                    var selectbtn = $('<div class="ebtn Button icon-featureselect" title="选择" tag="select"></div>').appendTo(content);
                    var updatebtn = $('<div class="ebtn DisableButton icon-featureupdate" title="属性修改" tag="attriupdate"></div>').appendTo(content);
                    var deletebtn = $('<div class="ebtn DisableButton icon-maptool-clearmap" title="删除" tag="delete"></div>').appendTo(content);
                    var savebtn = $('<div class="ebtn DisableButton icon-featuresave" title="保存" tag="save"></div>').appendTo(content);
                    var canclebtn = $('<div class="ebtn DisableButton icon-featurecancel" title="取消" tag="cancel"></div>').appendTo(content);
                    $(".ebtn", edittools).click(function () {
                        if ($(this).hasClass("DisableButton")) return;
                        var tag = $(this).attr("tag");
                        if (tag == "add") editadd();
                        if (tag == "select") editselect();
                        if (tag == "attriupdate") attriupdate();
                        if (tag == "delete") editdelete();
                        if (tag == "save") editsave();
                        if (tag == "cancel") {

                        }
                    });
                }
                else {
                    edittools.css("display", "block");
                }

            });
            //添加临时图层
            addtemplayer("tempGraphicLayer");
            //添加绘制临时图层
            addtemplayer("tempDrawLayer");
        });

        function initmap() {
            _map = new ol.Map({
                controls: new ol.control.defaults({ zoom: false, rotate: false, attribution: false }),
                interactions: ol.interaction.defaults().extend([new ol.interaction.DragRotateAndZoom()]),
                target: mapdiv,
                logo: false
            });
            var resolutions = [];
            for (var i = 0; i < _levelinfo.Levels.length; i++) resolutions.push(parseFloat(_levelinfo.Levels[i].Resolution));
            var minZoom = parseInt(_levelinfo.MinZoom);
            var proj = ol.proj.get("EPSG:4326");
            _map.setView(new ol.View({
                projection: proj,
                resolutions: resolutions,
                minZoom: minZoom,
                minResolution: resolutions[resolutions.length - 1],
                maxZoom: resolutions.length + minZoom - 1,
                maxResolution: resolutions[0]
            }));
            _map.getView().fit(_extent, _map.getSize());
            _map.getView().setZoom(parseInt(_zoom));
        }//初始化地图
        function addwms(layerinfo) {
            var oldlayer = getlayerbyid(layerinfo.ID);
            if (oldlayer == undefined || oldlayer == null) {
                var layerparam = {
                    VERSION: '1.3.0',
                    FORMAT: "image/png",
                    LAYERS: layerinfo.Layers,

                };
                if (layerinfo.CQLFilter != undefined || layerinfo.CQLFilter != null) layerparam.CQL_FILTER = layerinfo.CQLFilter.replace(/1=1\s*AND|1=1\s*and|1=1\s*OR|1=1\s*or|1=1\s*/, "");
                if (layerparam.CQL_FILTER == undefined || layerparam.CQL_FILTER == null) layerparam.CQL_FILTER = undefined;
                layerparam.CRS = (layerinfo.EPSG == undefined || layerinfo.EPSG == null) ? "EPSG:4326" : layerinfo.EPSG;
                if (layerinfo.Sldbody != undefined && layerinfo.Sldbody != null) layerparam.SLD_BODY = layerinfo.Sldbody;
                else if (layerinfo.Sldsrc != undefined && layerinfo.Sldsrc != null) {
                    layerparam.SLD_BODY = loadsld(layerinfo.Sldsrc);
                    layerparam.SLD_BODY = layerparam.SLD_BODY.replace("%NAME%", layerinfo.Layers);
                }
                //if (layerparam.SLD_BODY != undefined && layerparam.SLD_BODY != null) layerparam.SLD_BODY = layerparam.SLD_BODY.replace(/\#/g, "%23");
                var c_layer = new ol.layer.Image({
                    id: layerinfo.ID,
                    tag: layerinfo.Tag,
                    extent: undefined,
                    zIndex: (layerinfo.ZIndex == undefined || layerinfo.ZIndex == null) ? 0 : layerinfo.ZIndex,
                    opacity: (layerinfo.Opacity == undefined || layerinfo.Opacity == null) ? 1.0 : layerinfo.Opacity,
                    visible: (layerinfo.Visible == undefined || layerinfo.Visible == null) ? true : layerinfo.Visible,
                    source: new ol.source.ImageWMS({
                        ratio: 1,
                        url: layerinfo.Url,
                        params: layerparam,
                        imageLoadFunction: function (image, src) {
                            imagePostFunction(image, src);
                        },
                        serverType: "geoserver"
                    })
                });
                _map.addLayer(c_layer);
            }
            else {
                var osource = oldlayer.getSource();
                var param = osource.getParams();
                if (layerinfo.Sldbody != undefined && layerinfo.Sldbody != null) {
                    param.SLD_BODY = layerinfo.Sldbody; param.STYLES = '';
                }
                else if (layerinfo.Sldsrc != undefined && layerinfo.Sldsrc != null) {
                    param.SLD_BODY = loadsld(layerinfo.Sldsrc);
                    param.STYLES = '';
                }
                //  param.SLD_BODY = param.SLD_BODY.replace(/\#/g, "%23");
                if (layerinfo.CQLFilter != undefined && layerinfo.CQLFilter != null) param.CQL_FILTER = layerinfo.CQLFilter.replace(/1=1\s*AND|1=1\s*and|1=1\s*OR|1=1\s*or|1=1\s*/, "");
                if (layerinfo.CQLFilter == undefined || layerinfo.CQLFilter == null) param.CQL_FILTER = undefined;
                osource.imageLoadFunction = function (image, src) { imagePostFunction(image, src); };
                osource.updateParams(param);
            }
        }//添加WMS图层
        function imagePostFunction(image, src) {
            var img = image.getImage();
            if (!window.btoa) window.btoa = base64.encode;
            if (!window.atob) window.atob = base64.decode;
            if (typeof window.btoa === 'function') {
                var xhr = new XMLHttpRequest();
                var dataEntries = src.split("&");
                var url, params = "";
                for (var i = 0 ; i < dataEntries.length ; i++) {
                    if (i === 0) url = dataEntries[i];
                    else params = params + "&" + dataEntries[i];
                }
                xhr.open('POST', url, true);
                xhr.responseType = 'arraybuffer';
                xhr.onload = function (e) {
                    if (this.status === 200) {
                        var uInt8Array = new Uint8Array(this.response);
                        var i = uInt8Array.length;
                        var binaryString = new Array(i);
                        while (i--) {
                            binaryString[i] = String.fromCharCode(uInt8Array[i]);
                        }
                        var data = binaryString.join('');
                        var type = xhr.getResponseHeader('content-type');
                        if (type.indexOf('image') === 0) {
                            img.src = 'data:' + type + ';base64,' + window.btoa(data);
                        }
                    }
                };
                xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                xhr.setRequestHeader("Content-length", params.length);
                xhr.setRequestHeader("Connection", "close");
                xhr.send(params);
            }
            else img.src = src;
        }
        function addwmts(layerinfo) {
            if (!layerinfo || !_map || !layerinfo.Url || !layerinfo.Resolution || !layerinfo.Layers || !layerinfo.Level) return;
            var layerparam = {};
            layerparam.EPSG = (layerinfo.EPSG == undefined || layerinfo.EPSG == null) ? "EPSG:4326" : layerinfo.EPSG;
            layerparam.Level = parseInt(layerinfo.Level);
            var projection = ol.proj.get(layerparam.EPSG);
            var projectionExtent = projection.getExtent();
            var size = ol.extent.getWidth(projectionExtent) / 256;
            var resolutions = [parseFloat(layerinfo.Resolution)];
            for (var z = 0; z < layerinfo.Level - 1; z++) resolutions.push(resolutions[z] / 2);
            var matrixIds = new Array(layerinfo.Level);
            for (var z = 0; z < layerinfo.Level; z++) matrixIds[z] = layerparam.EPSG + ":" + z;
            var c_layer = new ol.layer.Tile({
                id: layerinfo.ID,
                opacity: (layerinfo.Opacity == undefined || layerinfo.Opacity == null) ? 1.0 : layerinfo.Opacity,
                zIndex: (layerinfo.ZIndex == undefined || layerinfo.ZIndex == null) ? 0 : layerinfo.ZIndex,
                extent: layerinfo.Extent,
                visible: (layerinfo.Visible == undefined || layerinfo.Visible == null) ? layerinfo.Visible : true,
                source: new ol.source.WMTS({
                    url: layerinfo.Url,
                    layer: layerinfo.Layers,
                    matrixSet: layerparam.EPSG,
                    format: 'image/png',
                    projection: projection,
                    tileGrid: new ol.tilegrid.WMTS({
                        origin: ol.extent.getTopLeft(projectionExtent),
                        resolutions: resolutions,
                        matrixIds: matrixIds
                    }),
                    style: (layerinfo.Style == undefined || layerinfo.Style == null) ? '' : layerinfo.Style,
                    wrapX: false
                }),
                minResolution: (layerinfo.MinResolution == undefined || layerinfo.MinResolution == null) ? resolutions[resolutions.length - 1] : parseFloat(layerinfo.MinResolution),
                maxResolution: (layerinfo.MaxResolution == undefined || layerinfo.MinResolution == null) ? resolutions[0] : parseFloat(layerinfo.MaxResolution)
            });
            _map.addLayer(c_layer);
            if (layerinfo.Extent != undefined && layerinfo.Extent != null) _map.getView().fit(layerinfo.Extent, _map.getSize());
        }//添加WMTS图层
        function addtemplayer(layerid) {
            var tempstyle = new ol.style.Style({
                stroke: new ol.style.Stroke({ width: 3, color: 'rgba(237, 117, 65, 1)' }),
                fill: new ol.style.Fill({ color: [236, 179, 73, 0.2] }),
                image: new ol.style.Circle({ radius: 2, fill: new ol.style.Fill({ color: '#f00' }) })
            });
            var clayer = new ol.layer.Vector({
                id: layerid,
                opacity: 1.0,
                zIndex: 9999,
                visible: true,
                source: new ol.source.Vector({}),
                style: tempstyle
            });
            _map.addLayer(clayer);
        }
        //编辑图层
        var isupdate = false;
        var addfeature, editfeature, layer_draw, editmapclick;
        var tempselectlayer, modifyInteraction;
        var dialog;
        function editadd() {
            isupdate = false;
            editclear();
            if (!IsNull(layer_draw)) drawclear();
            else initdraw();
        }//编辑新增
        function editselect() {
            editclear();
            isupdate = true;
            if (IsNull(editmapclick)) {
                editmapclick = _map.on("singleclick", function (e) {
                    if (!isupdate) return;
                    var pointresult = ol.wfspointquery({
                        Point: e.coordinate,
                        PX: 2,
                        GeometryName: _editlayer.GeomField,
                        Url: _editlayer.WFSUrl,
                        TypeName: _editlayer.TypeName
                    });
                    if (IsNull(pointresult) || pointresult.length == 0) return;
                    var temp = pointresult[0].clone();
                    var queryfeature = new ol.Feature(new ol.geom.Polygon(temp.getGeometry().getCoordinates()));
                    queryfeature.setProperties(temp.getProperties());
                    var selectSource = new ol.Collection();
                    selectSource.push(queryfeature);
                    loadvectorlayer(selectSource);
                    if (!IsNull(modifyInteraction)) {
                        _map.removeInteraction(modifyInteraction);
                        modifyInteraction = null;
                    }
                    modifyInteraction = new ol.interaction.Modify({ features: tempselectlayer.getSource().getFeaturesCollection() });
                    _map.addInteraction(modifyInteraction);
                    $("div[tag='delete']", $(".content")).removeClass("DisableButton").addClass("Button");
                    $("div[tag='attriupdate']", $(".content")).removeClass("DisableButton").addClass("Button");
                    $("div[tag='save']", $(".content")).removeClass("DisableButton").addClass("Button");
                    $("div[tag='cancel']", $(".content")).removeClass("DisableButton").addClass("Button");
                    editfeature = tempselectlayer.getSource().getFeatures()[0];
                });
            }
        }//编辑选中
        function attriupdate() {
            var feature;
            if (!IsNull(addfeature)) feature = addfeature;
            if (!IsNull(editfeature)) feature = editfeature;
            if (IsNull(feature)) return;
            //添加要素
            if (!IsNull(addfeature)) {
                var xzqcode = addfeature.getProperties().REGIONSID;
                var blockid = getblockidByadcode(xzqcode);
                if (IsNull(blockid)) return;
                feature.set("MASSIFID", blockid);
            }
            //初始化图层信息
            showeditattrinfo(feature);
        }//图层元素属性编辑
        function editdelete() {
            isupdate = false;
            if (IsNull(editfeature)) return;
            //提示问题
            if (confirm("确定删除所选要素吗?")) {
                var deletefeature = editfeature;
                deletefeature.setId(deletefeature.getProperties().gid);
                wfstoperat(deletefeature, "delete");
            }
            else {
                editclear();
                return;
            }
        }//图层元素删除
        function editsave() {
            if (IsNull(addfeature) && IsNull(editfeature)) return;
            var newf;
            var tempp;
            if (!isupdate) {
                if (IsNull) tempp = {};
                var points = addfeature.getGeometry().getCoordinates();
                //判断是否有地块编号
                if (IsNull(addfeature.getProperties().MASSIFID)) {
                    var massifid = getblockidByadcode(addfeature.getProperties().REGIONSID);
                    addfeature.set("MASSIFID", massifid);
                }
                newf = new ol.Feature(new ol.geom.MultiPolygon([points]));
                $.each(addfeature.getProperties(), function (s, e) { if (s != "geometry") tempp[s] = e; });
                tempp.ID = Guid.NewGuid().ToString("N");
            }
            else {
                newf = editfeature.clone();
                newf.setId(newf.getProperties().gid);
            }
            //判断是否有属性结果
            var tag = $("#editattrinfo").attr("tag");
            if (tag == "canuse") {
                var inputs = $("input", $("#editattrinfo"));
                if (IsNull(inputs) || inputs.length == 0) return;
                if (IsNull(tempp)) tempp = {};
                for (var i = 0; i < inputs.length; i++) {
                    var c_input = $(inputs[i]);
                    tempp[c_input.attr("name")] = c_input.val();
                }
            }
            newf.setProperties(tempp);
            wfstoperat(transformCoor(newf), isupdate ? "update" : "insert");
        }
        function wfstoperat(feature, operat) {
            if (IsNull(feature) || IsNull(_editlayer)) return;
            var featuretype = _editlayer.TypeName.substr(_editlayer.TypeName.indexOf(":") + 1);
            var formatwfs = new ol.format.WFS();
            var kml = { featureType: featuretype, featureNS: featurens, srsName: 'EPSG:4326' };
            var node;
            if (operat == "insert") node = formatwfs.writeTransaction([feature], null, null, kml);
            if (operat == "update") node = formatwfs.writeTransaction(null, [feature], null, kml);
            if (operat == "delete") node = formatwfs.writeTransaction(null, null, [feature], kml);
            var xmls = new XMLSerializer();
            var str = xmls.serializeToString(node);
            str = str.replace(/geometry/g, _editlayer.GeomField);
            $.ajax({
                type: "POST",
                url: _editlayer.WFSUrl + "?service=wfs",
                dataType: 'xml',
                processData: false,
                contentType: 'text/xml',
                data: str,
                success: function (s, e) {
                    editclear();
                    editfeature = null;
                    addfeature = null;
                    isupdate = false;
                }
            });
        }
        function editclear() {
            if (!IsNull(layer_draw)) drawclear();
            clearfeature("tempDrawLayer");
            addfeature = null;
            editfeature = null;
            if (!IsNull(editmapclick)) {
                _map.unByKey(editmapclick);
                editmapclick = null;
            }
            if (!IsNull(modifyInteraction)) {
                _map.removeInteraction(modifyInteraction);
                modifyInteraction = null;
            }
            if (!IsNull(tempselectlayer)) {
                tempselectlayer.getSource().clear();
                _map.removeLayer(tempselectlayer);
                tempselectlayer = null;
            }
            $("div[tag='delete']", $(".content")).removeClass("Button").addClass("DisableButton");
            $("div[tag='attriupdate']", $(".content")).removeClass("Button").addClass("DisableButton");
            $("div[tag='save']", $(".content")).removeClass("Button").addClass("DisableButton");
            $("div[tag='cancel']", $(".content")).removeClass("Button").addClass("DisableButton");
            //属性清空
            hiddenattrinfo(true);
        }//编辑清空
        function loadvectorlayer(features) {
            if (!IsNull(tempselectlayer)) _map.removeLayer(tempselectlayer);
            tempselectlayer = new ol.layer.Vector({
                source: new ol.source.Vector({ features: features }),
                zIndex: 10010,
                style: function (feature, resolution) {
                    return new ol.style.Style({ stroke: new ol.style.Stroke({ color: 'red', width: 2 }) });
                }
            });
            _map.addLayer(tempselectlayer);
        }//添加图层编辑临时图层
        function initdraw() {
            var tempdrawlayer = getlayerbyid("tempDrawLayer");  //获取绘制图层
            layer_draw = new ol.interaction.Draw({
                type: "Polygon",
                source: tempdrawlayer.getSource(),
                style: new ol.style.Style({
                    stroke: new ol.style.Stroke({ width: 1, color: 'rgba(237, 117, 65, 1)' }),
                    fill: new ol.style.Fill({ color: [236, 179, 73, 0.2] }),
                    image: new ol.style.Circle({ radius: 5, fill: new ol.style.Fill({ color: [236, 179, 73, 0.5] }), stroke: new ol.style.Stroke({ color: 'red', width: 1 }) })
                })
            });
            _map.addInteraction(layer_draw);
            layer_draw.on("drawend", function (e) {
                //绘制完成事件
                drawclear();
                //判断是否在指定行政区划
                var iscontain = IsContainCounty(_editlayer.CountyCode, e.feature);
                if (!iscontain) alert("请在该图层所在行政区划县绘制图形！");
                else {
                    //
                    var towns = getTownbyFeature(e.feature);
                    if (IsNull(towns) || towns.length == 0) return;
                    addfeature = e.feature;
                    if (towns.length == 1) {
                        //显示对应的行政区信息
                        var info = {};
                        if (!IsNull(towns[0].getProperties().PROVINCE)) info.PROVINCE = towns[0].getProperties().PROVINCE;
                        if (!IsNull(towns[0].getProperties().CITY)) info.CITY = towns[0].getProperties().CITY;
                        if (!IsNull(towns[0].getProperties().COUNTY)) info.COUNTY = towns[0].getProperties().COUNTY;
                        if (!IsNull(towns[0].getProperties().TOWN)) info.TOWN = towns[0].getProperties().TOWN;
                        if (!IsNull(towns[0].getProperties().VILLAGE)) info.VILLAGE = towns[0].getProperties().VILLAGE;
                        if (!IsNull(towns[0].getProperties().ADCODE)) info.REGIONSID = towns[0].getProperties().ADCODE;
                        addfeature.setProperties(info);
                    }
                    else {
                        var towndatas = [];
                        for (var n = 0; n < towns.length; n++) towndatas.push(towns[n].getProperties());
                        selecttown(towndatas);
                    }
                    $("div[tag='attriupdate']", $(".content")).removeClass("DisableButton").addClass("Button");
                    $("div[tag='save']", $(".content")).removeClass("DisableButton").addClass("Button");
                    $("div[tag='cancel']", $(".content")).removeClass("DisableButton").addClass("Button");
                }

            });
        }//绘制图形
        function drawclear() {
            if (!IsNull(layer_draw)) {
                layer_draw.un("drawend");
                layer_draw.setActive(false);
                _map.removeInteraction(layer_draw);
                layer_draw = null;
            }
        }//清除绘制
        function IsContainCounty(countycode, feature) {
            //查询
            var county = Enumerable.From(xzq_layers).Where('s=>s.Value=="COUNTY"').FirstOrDefault();
            if (IsNull(county)) return false;
            var condition = "ADCODE='" + countycode + "'";
            var wkt = getwktbyfeature(feature, true);
            condition += " AND " + getcql_contains(wkt, county.GeomField);
            var iscontain = false;
            var param = {
                ID: county.Value,
                Url: county.WFSUrl,
                TypeName: county.TypeName,
                CqlFilter: condition,
                Async: false
            };
            var query = new ol.wfsquery();
            query.Target.bind("onQueryCompleted", function (s, e) {
                if (e.statusCode == 200 && !IsNull(e.data) && e.data.length > 0) iscontain = true;
            });
            query.Query(param);
            return iscontain;
        } //是否在行政区内
        function getTownbyFeature(feature) {
            if (IsNull(feature)) return null;
            var town = Enumerable.From(xzq_layers).Where('s=>s.Value=="TOWN"').FirstOrDefault();
            if (IsNull(town)) return null;
            var wkt = getwktbyfeature(feature, true);
            var condition = getcql_intersects(wkt, town.GeomField);
            var data;
            var param = {
                ID: town.Value,
                Url: town.WFSUrl,
                TypeName: town.TypeName,
                CqlFilter: condition,
                Async: false
            };
            var query = new ol.wfsquery();
            query.Target.bind("onQueryCompleted", function (s, e) {
                if (e.statusCode == 200 && !IsNull(e.data) && e.data.length > 0) data = e.data;
            });
            query.Query(param);
            return data;
        } //查找对应的乡镇
        function selecttown(towndatas) {
            var modal = $('<div style="position:absolute; width:' + $(window).width() + 'px;height:' + $(window).height() + 'px;background:rgba(255,255,255,0.5);z-index:10000;left:0px;top:0px;"></div>');
            $(".content").append(modal);
            var contentleft = parseInt($(window).width() / 2) - 147;
            var contenttop = parseInt($(window).height() / 2) - 76;
            var content = $('<div style="height:112px;width:295px;position:absolute;left:' + contentleft + 'px;top:' + contenttop + 'px;z-index:10001;border:1px solid #0099cc;"></div>').appendTo($(".content"));
            var contenttitle = $('<div style="height:30px;width:295px;background-color:#0099cc;"><div style="width:200px;height:30px;line-height:30px;display:inline-block;float:left;margin-left:15px;color:#fcfcfc;">所属乡镇</div></div>').appendTo(content);
            var contentnr = $('<div style="height:82px;width:295px;background-color:#fcfcfc;"></div>').appendTo(content);
            var townrow = $('<div style="width:295px;height:35px;border-bottom:1px dashed #ddd;"></div>').appendTo(contentnr);
            var towntitle = $('<div style="width:75px;height:35px;line-height:35px;padding-right:5px;display:inline-block;text-align:right;float:left;">选择乡镇</div>').appendTo(townrow);
            var towndiv = $('<div style="width:215px;height:35px;display:inline-block;"></div>').appendTo(townrow);
            ////添加下拉框
            var select = $('<select style="width:195px;height:24px;border:1px solid #0099cc;margin-top:5px;margin-left:10px;"></select>').appendTo(towndiv);
            for (var i = 0; i < towndatas.length; i++) {
                var c_option = $('<option value="' + towndatas[i].ADCODE + '">' + towndatas[i].TOWN + '</option>');
                c_option.prop("towninfo", towndatas[i]);
                select.append(c_option);
            }
            var btnrow = $('<div style="height:45px;width:295px;"></div>').appendTo(contentnr);
            var btn = $('<div style="height:26px;width:70px;text-align:center;color:#fff;background-color:#0099cc;line-height:26px;margin-left:112px;margin-top:10px;">确&nbsp;定</div>').appendTo(btnrow);
            btn.click(function () {
                var selecttown = $("option[value='" + $("select").val() + "']").prop("towninfo");
                if (IsNull(selecttown)) return;
                var info = {};
                if (!IsNull(selecttown.PROVINCE)) info.PROVINCE = selecttown.PROVINCE;
                if (!IsNull(selecttown.CITY)) info.CITY = selecttown.CITY;
                if (!IsNull(selecttown.COUNTY)) info.COUNTY = selecttown.COUNTY;
                if (!IsNull(selecttown.TOWN)) info.TOWN = selecttown.TOWN;
                if (!IsNull(selecttown.VILLAGE)) info.VILLAGE = selecttown.VILLAGE;
                if (!IsNull(selecttown.ADCODE)) info.REGIONSID = selecttown.ADCODE;
                addfeature.setProperties(info);
                modal.remove();
                content.remove();
            });
        }//行政区乡镇选择
        function getblockidByadcode(adcode) {
            if (IsNull(adcode)) return;
            var blockid;
            $.ajax({
                url: serverurl + "massif/getnextid/" + adcode,
                type: "GET",
                contentType: 'application/json',
                dataType: 'json',
                async: false,
                success: function (result) {
                    blockid = result.data
                }
            });
            return blockid;
        }
        function showeditattrinfo(feature) {
            if (IsNull(feature)) return;
            //设置地块编号，不能修改
            $("#editattrinfo").css("display", "block");
            $("#editattrinfo").attr("tag", "canuse");
            //设置地块数据
            $("input[name='MASSIFID']", $("#editattrinfo")).val(feature.getProperties().MASSIFID);
            if (isupdate) { //加载数据
                $.each(feature.getProperties(), function (s, o) {
                    if (s != "MASSIFID" && s != "geometry") {
                        var c_input = $("input[name='" + s + "']", $("#editattrinfo"));
                        if (!IsNull(c_input) && c_input.length > 0) c_input.val(o);
                    }
                });
            }
        } //显示属性编辑界面
        function hiddenattrinfo(isclear) {
            $("#editattrinfo").css("display", "none");
            if (isclear) {
                var inputs = $("input", $("#editattrinfo"));
                if (IsNull(inputs) || inputs.length == 0) return;
                for (var i = 0; i < inputs.length; i++) $(inputs[i]).val("");
                $("#editattrinfo").attr("tag", "nouse");
            }
        }//清空属性编辑界面
        //辅助函数
        function getrootpath() {
            var pathName = window.document.location.pathname;
            var localhost = window.location.host;
            var projectName = pathName.substring(0, pathName.substr(1).indexOf('/') + 1);
            return ("http://" + localhost + projectName + "/");
        }//获取地址
        /*条件转换*/
        function filter(strWhere, spatialParam, version, isPR) {
            var strfilter = "";
            var prefix = isPR ? "ogc:" : "";
            var condition = '<' + prefix + 'Filter xmlns:ogc="http://www.opengis.net/ogc">';
            if (!IsNull(spatialParam) && !IsNull(spatialParam.bbox)) {
                if (!IsNull(strWhere)) condition += '<ogc:And>';
                condition += bbox(spatialParam.bbox, spatialParam.geometryName, version);
            }
            if (!IsNull(spatialParam) && !IsNull(spatialParam.geometry)) {
                if (!dev.IsNull(strWhere)) condition += '<ogc:And>';
                condition += geomf(spatialParam, version);
            }
            if (!IsNull(strWhere)) {
                strWhere = strWhere.replace(/1=1\s*AND|1=1\s*and|1=1\s*OR|1=1\s*or|1=1\s*/, "");
                var arrCondition = strWhere.split(/\) AND \(|\) AND|AND \(|\)AND\(|\)AND|AND\(/);
                var orCondition = [];
                if (!IsNull(strWhere)) {
                    if (arrCondition.length == 1) condition += filterorquote(arrCondition[0]);
                    else if (arrCondition.length > 1) {
                        var andstr = '<ogc:And>';
                        $.each($(arrCondition), function (i, o) { if (o) andstr += filterorquote(o); });
                        andstr += "</ogc:And>";
                        condition += andstr;
                    }
                }
            }
            strfilter += condition;
            if (((!IsNull(spatialParam) && !IsNull(spatialParam.bbox)) || (!IsNull(spatialParam) && !IsNull(spatialParam.geometry))) && !IsNull(strWhere)) strfilter += '</ogc:And>';
            strfilter += '</' + prefix + 'Filter>';
            return strfilter;
        }
        function filterorquote(con) {
            var arrCon = con.split(/\) OR \(|\) OR|OR \(|\)OR\(|\)OR|OR\(/);
            var orstr = "";
            if (arrCon.length > 1) {
                var orstr = '<ogc:Or>';
                $.each($(arrCon), function (j, item) {
                    orstr += filterand(item);
                });
                orstr += '</ogc:Or>';
            }
            else orstr += filterand(con);
            return orstr;
        }
        function filterand(con) {
            var arrCon = con.split(/ AND /);
            var condition = "", andstr = "";
            if (arrCon.length == 1) andstr += filteror(arrCon[0]);
            else if (arrCon.length > 1) {
                var andstr = '<ogc:And>';
                $.each($(arrCon), function (i, o) { if (o) andstr += filteror(o); });
                andstr += "</ogc:And>";
            }
            condition = andstr;
            return condition;
        }
        function filteror(con) {
            var arrCon = con.split(/ OR /);
            var orstr = "";
            if (arrCon.length > 1) {
                var orstr = '<ogc:Or>'
                $.each($(arrCon), function (j, item) { orstr += propertyfilter(item); });
                orstr += '</ogc:Or>'
            }
            else orstr += propertyfilter(con);
            return orstr;
        };
        function propertyfilter(arr) {
            var strFilter = "";
            if (!arr) return strFilter;
            arr = arr.replace(/\(/g, "");
            arr = arr.replace(/\)/g, "");
            var arr1 = arr.trim().split(/=|>|<|>=|<=|<>| in | IN | IS | is | LIKE | like /);
            arr1[0] = arr1[0].trim();
            arr1[arr1.length - 1] = arr1[arr1.length - 1].replace(/\'/g, "").trim();
            if (arr1[0] === "1") return "";
            if (arr.toUpperCase().indexOf("<>") >= 0) strFilter = '<ogc:PropertyIsNotEqualTo><ogc:PropertyName>' + arr1[0] + '</ogc:PropertyName><ogc:Literal>' + arr1[arr1.length - 1] + '</ogc:Literal></ogc:PropertyIsNotEqualTo>';
            else if (arr.toUpperCase().indexOf("<=") >= 0) strFilter = '<ogc:PropertyIsLessThanOrEqualTo><ogc:PropertyName>' + arr1[0] + '</ogc:PropertyName><ogc:Literal>' + arr1[arr1.length - 1] + '</ogc:Literal></ogc:PropertyIsLessThanOrEqualTo>';
            else if (arr.toUpperCase().indexOf(">=") >= 0) strFilter = '<ogc:PropertyIsGreaterThanOrEqualTo><ogc:PropertyName>' + arr1[0] + '</ogc:PropertyName><ogc:Literal>' + arr1[arr1.length - 1] + '</ogc:Literal></ogc:PropertyIsGreaterThanOrEqualTo>';
            else if (arr.toUpperCase().indexOf("<") >= 0) strFilter = '<ogc:PropertyIsLessThan><ogc:PropertyName>' + arr1[0] + '</ogc:PropertyName><ogc:Literal>' + arr1[arr1.length - 1] + '</ogc:Literal></ogc:PropertyIsLessThan>';
            else if (arr.toUpperCase().indexOf(">") >= 0) strFilter = '<ogc:PropertyIsGreaterThan><ogc:PropertyName>' + arr1[0] + '</ogc:PropertyName><ogc:Literal>' + arr1[arr1.length - 1] + '</ogc:Literal></ogc:PropertyIsGreaterThan>';
            else if (arr.toUpperCase().indexOf("=") >= 0) {
                if (arr1[arr1.length] === "") strFilter = '<ogc:PropertyIsNull><ogc:PropertyName>' + arr1[0] + '</ogc:PropertyName></ogc:PropertyIsNull>';
                else strFilter = '<ogc:PropertyIsEqualTo><ogc:PropertyName>' + arr1[0] + '</ogc:PropertyName><ogc:Literal>' + arr1[arr1.length - 1] + '</ogc:Literal></ogc:PropertyIsEqualTo>';
            }
            else if (arr.toUpperCase().indexOf(" LIKE ") >= 0) strFilter = '<ogc:PropertyIsLike wildCard="*" singleChar="_" escapeChar="!"><ogc:PropertyName>' + arr1[0] + '</ogc:PropertyName><ogc:Literal>' + arr1[arr1.length - 1].replace(/\%/g, "*") + '</ogc:Literal></ogc:PropertyIsLike>';
            else if (arr.toUpperCase().indexOf(" IS ") >= 0) strFilter = '<ogc:PropertyIsNull><ogc:PropertyName>' + arr1[0] + '</ogc:PropertyName></ogc:PropertyIsNull>';
            else if (arr.toUpperCase().indexOf(" IN ") >= 0) strFilter = propertywithinfilter(arr1);
            return strFilter.trim();
        }
        function propertywithinfilter(condition) {
            var values = condition[condition.length - 1].trim();
            values = values.replace(/\(/g, "");
            values = values.replace(/\)/g, "");
            values = values.split(',');
            var orstr = '<ogc:Or>';
            $.each(values, function (i, o) {
                if (o) orstr += '<ogc:PropertyIsEqualTo><ogc:PropertyName>' + condition[0].trim() + '</ogc:PropertyName><ogc:Literal>' + o.replace(/\'/g, "").trim() + '</ogc:Literal></ogc:PropertyIsEqualTo>';
            });
            orstr += '</ogc:Or>';
            return orstr;
        }
        function bbox(box, field, version) {
            if (IsNull(box) || IsNull(field)) return "";
            var strbbox = "";
            if (IsNull(version)) version = "1.0.0";
            if (version === "1.0.0")
                strbbox = '<ogc:BBOX><ogc:PropertyName>' + field + '</ogc:PropertyName>'
                + '<gml:Box srsName="http://www.opengis.net/gml/srs/epsg.xml#4326">'
                + '<gml:coordinates decimal="." cs="," ts=" ">' + box[0] + ',' + box[1] + ' ' + box[2] + ',' + box[3] + '</gml:coordinates>'
                + '</gml:Box></ogc:BBOX>';
            else if (version === "1.1.0")
                strbbox += '<ogc:BBOX><ogc:PropertyName>' + field + '</ogc:PropertyName>'
                + '<gml:Envelope srsName="http://www.opengis.net/gml/srs/epsg.xml#4326">'
                + '<gml:lowerCorner>' + box[0] + ' ' + box[1] + '</gml:lowerCorner>'
                + '<gml:upperCorner>' + box[2] + ' ' + box[3] + '</gml:upperCorner>'
                + '</gml:Envelope></ogc:BBOX>';
            return strbbox;
        }
        function geomf(param, version) {
            var strgeometry = '<ogc:PropertyName>' + param.geometryName + '</ogc:PropertyName>';
            var type = param.geometry.getType().toLowerCase();
            if (type === "point" || type === "circle") {//点
                var point;
                if (type === "circle") {
                    point = param.geometry.getCenter().toString();
                    param.distance = param.geometry.getRadius();
                    param.relation = dev.Relations.DWITHIN;
                }
                else point = param.geometry.getCoordinates().toString();
                strgeometry += '<gml:Point srsName="http://www.opengis.net/gml/srs/epsg.xml#4326" xmlns:gml="http://www.opengis.net/gml">';
                if (version === "1.1.0")
                    strgeometry += '<gml:pos>' + point.replace(/,/g, " ") + '</gml:pos>';
                else if (version === "1.0.0")
                    strgeometry += '<gml:coordinates decimal="." cs="," ts=" ">' + point.toString() + '</gml:coordinates>';
                strgeometry += '</gml:Point>';
            }
            else if (type === "polygon") {
                strgeometry += '<gml:Polygon srsName="http://www.opengis.net/gml/srs/epsg.xml#4326" xmlns:gml="http://www.opengis.net/gml">';
                var linearRings = param.geometry.getLinearRings();
                $.each(linearRings, function (i, o) {
                    if (version === "1.1.0") {
                        var linearRing = '<gml:LinearRing><gml:posList>' + o.getCoordinates().toString().replace(/,/g, " ") + '</gml:posList></gml:LinearRing>';
                        if (i === 0) strgeometry += '<gml:exterior>' + linearRing + '</gml:exterior>';
                        else strgeometry += linearRing;
                    }
                    else if (version === "1.0.0") {
                        var linearRing = '<gml:LinearRing><gml:coordinates decimal="." cs="," ts=" ">' + o.getCoordinates().toString().replace(/,/g, " ") + '</gml:coordinates></gml:LinearRing>';
                        if (i === 0) strgeometry += '<gml:outerBoundaryIs>' + linearRing + '</gml:outerBoundaryIs>';
                        else strgeometry += '<gml:innerBoundaryIs>' + linearRing + '</gml:innerBoundaryIs>';
                    }
                });
                strgeometry += '</gml:Polygon>';
            }
            else if (type === "linestring") {
                strgeometry += '<gml:LineString srsName="http://www.opengis.net/gml/srs/epsg.xml#4326" xmlns:gml="http://www.opengis.net/gml">'
                if (version === "1.1.0")
                    strgeometry += '<gml:posList>' + param.geometry.getCoordinates().toString().replace(/,/g, " ") + '</gml:posList>';
                else if (version === "1.0.0")
                    strgeometry += '<gml:coordinates decimal="." cs="," ts=" ">' + param.geometry.getCoordinates().toString() + '</gml:coordinates>';
                strgeometry += '</gml:LineString>';
                param.distance = 0.0006;
                param.relation = dev.Relations.DWITHIN;
            }
            var isbuffer = param.relation.toLowerCase() != dev.Relations.DWITHIN.toLowerCase() || dev.IsNull(param.distance) || param.distance <= 0;
            strgeometry = '<ogc:' + param.relation + '>' + strgeometry
                + (isbuffer ? "" : '<ogc:Distance units="' + (dev.IsNull(param.unit) ? "degrees" : param.unit) + '">' + param.distance + '</ogc:Distance>')
                + '</ogc:' + param.relation + '>';
            return strgeometry;
        }
        /*end 条件转换*/
        function toJSON(obj) {
            return $.toJSON(obj);
        };//对象转换成为Json串
        function getextentmapclick(point, px) {
            if (IsNull(point)) return;
            var clientSize = _map.getSize();
            if (IsNull(px) || !IsNumber(px)) px = 2;
            var extent = _map.getView().calculateExtent(clientSize);
            var clientWidth = clientSize[0], clientHeight = clientSize[1];
            var latdistance = extent[2] - extent[0], londistance = extent[3] - extent[1];
            var pixwR = (latdistance / clientWidth) * px, pixhR = (londistance / clientHeight) * px;
            var radius = Math.sqrt(Math.pow(pixwR, 2) + Math.pow(pixhR, 2));
            var xMin = point[0] - radius, yMin = point[1] - radius, xMax = point[0] + radius, yMax = point[1] + radius;
            return ol.geom.Polygon.fromExtent([xMin, yMin, xMax, yMax]);
        } //获取点的缓冲矩形
        //数据转换
        function getwktbyfeature(feature, isconvert) {
            var optfeature = feature;
            var radius;
            if (feature.getGeometry().getType() == "Circle") {
                optfeature = new ol.Feature(new ol.geom.Point(feature.getGeometry().getCenter()));
                radius = feature.getGeometry().getRadius();
            }
            var strwkt = new ol.format.WKT().writeFeature(optfeature);
            if (isconvert === true) strwkt = convertwkt(strwkt);
            if (!IsNull(radius) && radius > 0) return [strwkt, radius];
            return strwkt;
        }//获取feature的wkt串
        function convertwkt(strWKT) {
            var arrWKT = strWKT.split(",");
            var newWKT = "";
            $.each(arrWKT, function (i, o) {
                var point = o.split(" ");
                var x = point[0].trim();
                var y = point[1].trim();
                var newx;
                var endchars = "";
                if (x.lastIndexOf("(") >= 0) {
                    newWKT += x.substr(0, x.lastIndexOf("(") + 1).trim();
                    newx = x.substr(x.lastIndexOf("(") + 1, x.length - x.lastIndexOf("(") - 1).trim();
                }
                else newx = x.trim();
                if (y.lastIndexOf(")") >= 0) {
                    newWKT += y.substr(0, y.indexOf(")")).trim();
                    endchars = y.substr(y.indexOf(")"), y.lastIndexOf(")") + 1 - y.indexOf(")")).trim();
                }
                else newWKT += y.trim();
                newWKT += " " + newx + (endchars === "" ? "," : endchars);
            });
            return newWKT;
        } //wkt串转换拼接
        function getcql_contains(wkt, field) {
            if (IsNull(field)) field = "the_geom";
            return "CONTAINS(" + field + "," + wkt + ")";
        }//获取图形包含条件
        function getcql_intersects(wkt, field) {
            if (IsNull(field)) return "INTERSECTS(the_geom," + wkt + ")";
            else return "INTERSECTS(" + field + "," + wkt + ")";
        }//获取图形相交条件
        /*openlayer 公共方法*/
        function getlayerbyid(layerid) {
            var map_layers = _map.getLayers();
            var c_layer = null;
            map_layers.forEach(function (o, i) {
                if (o.getProperties().id === layerid) c_layer = o;
            });
            return c_layer;
        }
        function loadsld(url) {
            var strXml = null;
            $.ajax({
                url: url,
                dataType: 'text',
                type: 'GET',
                timeout: 2000,
                async: false,
                error: function (xml) { alert("加载XML文件出错！"); },
                success: function (xml) { strXml = xml.replace(/\r\n\s*/g, ""); }
            });
            return strXml;
        } //加载sld
        function legendtorule(legends) {
            var strRules = "";
            $.each($(legends), function (i, o) {
                strRules += "<Rule>";
                if (!IsNull(o.Text)) strRules += "<Name>" + o.Text + "</Name>";
                if (!IsNull(o.Filter)) strRules += filter(o.Filter, "", "", true);
                if (!IsNull(o.TextSymbol)) {
                    strRules += "<TextSymbolizer>";
                    if (!IsNull(o.TextSymbol.LabelField)) strRules += "<Label><ogc:PropertyName>" + o.TextSymbol.LabelField + "</ogc:PropertyName></Label>";
                    strRules += "<Font><CssParameter name=\"font-family\">微软雅黑</CssParameter>";
                    if (!IsNull(o.TextSymbol.FontSize)) strRules += " <CssParameter name=\"font-size\">" + o.TextSymbol.FontSize + "</CssParameter>";
                    strRules += "<CssParameter name=\"font-style\">normal</CssParameter>";
                    strRules += "</Font>";
                    strRules += "<LabelPlacement><PointPlacement><AnchorPoint><AnchorPointX>0.5</AnchorPointX><AnchorPointY>0.5</AnchorPointY></AnchorPoint></PointPlacement></LabelPlacement>";
                    if (!IsNull(o.TextSymbol.Fill)) strRules += "<Fill><CssParameter name=\"fill\">" + o.TextSymbol.Fill + "</CssParameter></Fill>";
                    strRules += " <VendorOption name=\"followLine\">true</VendorOption>";
                    strRules += "</TextSymbolizer>";
                }
                strRules += "<PolygonSymbolizer>";
                if (!IsNull(o.Fill)) {
                    strRules += "<Fill><CssParameter name=\"fill\">" + o.Fill.Color + "</CssParameter>";
                    strRules += "<CssParameter name=\"fill-opacity\">" + (IsNull(o.Fill.Opacity) ? 1 : o.Fill.Opacity) + "</CssParameter>";
                    strRules += "</Fill>";
                }
                if (!IsNull(o.Border)) {
                    strRules += "<Stroke><CssParameter name=\"stroke\">" + o.Border.Color + "</CssParameter>";
                    strRules += "<CssParameter name=\"stroke-opacity\">" + (IsNull(o.Border.Opacity) ? 1 : o.Border.Opacity) + "</CssParameter>";
                    strRules += "<CssParameter name=\"stroke-width\">" + (IsNull(o.Border.Width) ? 1 : o.Border.Width) + "</CssParameter>";
                    strRules += "</Stroke>";
                }
                strRules += "</PolygonSymbolizer></Rule>";
            });
            return strRules;
        }//将图例转换成为rule
        function getsldstring(typeName, strrule, IsFeatureStyle) {
            if (IsNull(typeName) || IsNull(strrule)) return "";
            var strsld = loadsld(getrootpath() + "config/templet.sld");
            strsld = strsld.replace("%LayerName%", typeName);
            if (IsFeatureStyle == true) strsld = strsld.replace("%FeatureTypeStyle%", strrule);
            else strsld = strsld.replace("%FeatureTypeStyle%", "<FeatureTypeStyle>" + strrule + "</FeatureTypeStyle>");
            return strsld;
        };
        function removelayer(layerid) {
            var maplayers = _map.getLayers();
            maplayers.forEach(function (sublayer, i) { if (sublayer.getProperties().id == layerid) maplayers.removeAt(i); });
        }
        function removefeature(feature, templayerid) {
            if (IsNull(_map) || IsNull(feature)) return;
            var templayer = getlayerbyid(templayerid);
            if (IsNull(templayer)) return;
            var features = templayer.getSource();
            var tmpfeature = getfeaturebyid(feature.getProperties().id, templayerid);
            if (!IsNull(tmpfeature)) features.removeFeature(tmpfeature);
        }
        function getfeaturebyid(featureid, templayerid) {
            if (IsNull(_map) || IsNull(featureid) || IsNull(templayerid)) return;
            var returnfeature;
            var templayer = getlayerbyid(templayerid);
            var features = templayer.getSource();
            var source = features.getFeatures();
            for (var i = 0; i < source.length; i++) {
                if (source[i].getProperties().id === featureid || source[i].getId() === featureid) {
                    returnfeature = source[i]; break;
                }
            }
            return returnfeature;
        }
        function clearfeature(templayerid) {
            var tmplayer = getlayerbyid(templayerid);
            if (IsNull(tmplayer)) return;
            var features = tmplayer.getSource();
            features.clear();
        }
        function transformCoor(feature) {
            var newf = feature.clone();
            newf.setId(feature.getId());
            newf.getGeometry().applyTransform(function (flatCoordinates, flatCoordinates2, stride) {
                for (var j = 0; j < flatCoordinates.length; j += stride) {
                    var y = flatCoordinates[j];
                    var x = flatCoordinates[j + 1];
                    flatCoordinates[j] = x;
                    flatCoordinates[j + 1] = y;
                }
            });
            return newf;
        }
        /*end openlayer 公共方法*/
        function IsNull(item) {
            return item === undefined || item === null || item === "";
        }
        function IsBoolean(item) {
            return !IsNull(item) && typeof item === "boolean";
        }
        function IsNumber(item) {
            return !IsNull(item) && typeof item === "number" && !isNaN(item) && isFinite(item);
        };
        /*WFS封装 */
        ; (function ($) {
            function resultformat(result) {
                var features = [];
                $.each(result, function (i, o) {
                    var geoJson = new ol.format.GeoJSON();
                    var feature = geoJson.readFeature(toJSON(o));
                    feature.setId(feature.getProperties().gid);
                    features.push(feature);
                });
                return features;
            };
            function propertyformat(result, property) {
                var properties = [];
                var fields = property.split(",");
                $.each(result, function (i, o) {
                    var data = {};
                    for (var i = 0; i < fields.length; i++) {
                        data[fields[i]] = o.properties[fields[i]];
                    }
                    properties.push(data);
                });
                return properties;
            };
            //查询
            ol.wfsquery = function (opt) {
                if (IsNull(opt)) opt = {};
                this.Target = $({ id: "wfs" + new Date().getTime() });
                this.Url = opt.Url, this.TypeName = opt.TypeName;
                this.Token = IsNull(opt.Token) ? null : opt.Token;
                this.SrsName = IsNull(opt.SrsName) ? "EPSG:4326" : opt.SrsName;
                this.OutputFormat = IsNull(opt.OutputFormat) ? "json" : opt.OutputFormat;
                this.PageIndex = IsNumber(opt.PageIndex) ? opt.PageIndex : null;
                this.PageSize = IsNumber(opt.PageSize) ? opt.PageSize : null;
                this.SortBy = IsNull(opt.OrderBy) ? null : opt.OrderBy;
                this.CqlFilter = IsNull(opt.CqlFilter) ? null : opt.CqlFilter;
                this.PropertyName = IsNull(opt.PropertyName) ? null : opt.PropertyName;
                this.MaxFeatures = IsNumber(opt.MaxFeatures) ? opt.MaxFeatures : null;
                this.RequestType = IsNull(opt.RequestType) ? "get" : opt.RequestType.toLowerCase();
                this.IsProperty = IsBoolean(opt.IsProperty) ? opt.IsProperty : false;
                this.Version = IsNull(opt.Version) ? "2.0.0" : opt.Version;
                this.Async = IsBoolean(opt.Async) ? opt.Async : true;
                this.Query = function (param) {
                    var $this = this;
                    if (!IsNull(param)) {
                        if (!IsNull(param.Url)) this.Url = param.Url;
                        if (!IsNull(param.TypeName)) this.TypeName = param.TypeName;
                        if (!IsNull(param.FeatureNS)) this.FeatureNS = param.FeatureNS;
                        if (IsNumber(param.PageIndex)) this.PageIndex = param.PageIndex;
                        if (IsNumber(param.PageSize)) this.PageSize = param.PageSize;
                        if (!IsNull(param.SrsName)) this.SrsName = param.SrsName;
                        if (!IsNull(param.CqlFilter)) this.CqlFilter = param.CqlFilter;
                        if (!IsNull(param.PropertyName)) this.PropertyName = param.PropertyName;
                        if (!IsNull(param.OrderBy)) this.SortBy = param.OrderBy;
                        if (!IsNull(param.OutputFormat)) this.OutputFormat = param.OutputFormat;
                        if (!IsNull(param.RequestType)) this.RequestType = param.RequestType.toLowerCase();
                        if (IsNumber(param.MaxFeatures)) this.MaxFeatures = param.MaxFeatures;
                        if (IsBoolean(param.IsProperty)) this.IsProperty = param.IsProperty;
                        if (!IsNull(param.Token)) this.Token = param.Token;
                        if (!IsNull(param.Version)) this.Version = param.Version;
                        if (IsBoolean(param.Async)) this.Async = param.Async;
                    }
                    var requestParam = {
                        cache: false,
                        url: this.Url,
                        dataType: 'json',
                        type: this.RequestType,
                        async: this.Async,
                        contentType: "application/json;charset=utf-8",
                        success: function (result) {//返回状态码，结果集, 分页信息，成功消息
                            var resultdata = $this.IsProperty ? propertyformat(result.features, $this.PropertyName) : resultformat(result.features);
                            var data = { data: resultdata, message: "查询成功！", statusCode: 200 }
                            if (!IsNull($this.Token)) data.Token = $this.Token;
                            if (!IsNull($this.PageIndex)) {
                                if (!IsNull($this.PageIndex) && !IsNull($this.PageSize)) data.pageInfo = { totalCount: result.totalFeatures, pageIndex: $this.PageIndex, pageSize: $this.PageSize };
                                if (!IsNull(data.data) && data.data.length < $this.PageSize) data.pageInfo.totalCount = ($this.PageIndex - 1) * $this.PageSize + data.data.length;
                            }
                            $this.Target.trigger("onQueryCompleted", data);
                        },
                        error: function (error, status, message) {//返回状态码，结果集, 分页信息，失败消息
                            var data = { data: null, message: message.message, statusCode: 400 }
                            if (!dev.IsNull($this.Token)) data.Token = $this.Token
                            if (!dev.IsNull($this.PageIndex) && !dev.IsNull($this.PageSize)) data.pageInfo = { totalCount: 0, pageIndex: $this.PageIndex, pageSize: $this.PageSize };
                            $this.Target.trigger("onQueryCompleted", data);
                        }
                    };
                    if (IsNull(this.Url) || IsNull(this.TypeName)) {
                        var data = { data: null, message: "请检查传入参数！", statusCode: 500 };
                        $this.Target.trigger("onQueryCompleted", data); return;
                    }
                    requestParam.url = this.Url.split("?")[0] + "?service=wfs&request=GetFeature&typename=" + this.TypeName
                        + "&srsname=" + this.SrsName + "&outputFormat=" + this.OutputFormat + "&version=" + this.Version;
                    if (this.SortBy != null) requestParam.url += "&sortBy=" + this.SortBy;//排序字段
                    if (this.PageIndex != null) requestParam.url += "&startIndex=" + ((this.PageIndex - 1) * this.PageSize);
                    if (this.PageSize != null) requestParam.url += "&count=" + this.PageSize;//返回最大记录总数
                    if (this.PropertyName != null) requestParam.url += "&propertyName=" + this.PropertyName;//返回的属性字段
                    if (this.MaxFeatures != null) requestParam.url += "&maxFeatures=" + this.MaxFeatures;//返回最大记录总数
                    if (this.CqlFilter != null) {
                        this.CqlFilter = this.CqlFilter.replace(/and\s*1=1|AND\s*1=1|1=1\s*AND|1=1\s*and|1=1\s*OR|1=1\s*or|1=1\s*/, "");
                        requestParam.url += "&cql_filter=" + encodeURI(this.CqlFilter.trim());
                    }//将查询条件进行转码
                    $.ajax(requestParam);
                };
            };
            //查询多个图层
            ol.wfsquerys = function (opt) {
                this.Params = opt;
                this.Target = $({ id: "querys" + new Date().getTime() });
                this.Query = function (param) {
                    if (!dev.IsNull(param)) this.Params = param;
                    if (dev.IsNull(this.Params) || this.Params.length == 0) return;
                    var $this = this, result = [], index = 0;
                    var wfs = new ol.wfsquery($this.Params[index]);
                    wfs.Target.bind("onQueryCompleted", function (s, e) {
                        var key = $this.Params[index].ID
                        if (dev.IsNull(key)) key = $this.Params[index].TypeName
                        result.push({ key: key, data: e });
                        if (index === $this.Params.length - 1) {
                            wfs.Target.unbind("onQueryCompleted")
                            $this.Target.trigger("onQuerysCompleted", { data: result });
                        }
                        else { index++; wfs.Query($this.Params[index]); }
                    });
                    wfs.Query($this.Params[index]);
                };
            };
            //点查询
            ol.wfspointquery = function (opt) {
                opt.Async = false;
                this.IsConvert = IsBoolean(opt.IsConvert) ? opt.IsConvert : true;
                $.extend(this, new ol.wfsquery(opt));
                var $this = this;
                var features;
                (function (point, px) {
                    if (IsNull(px)) px = 0;
                    var ext = getextentmapclick(point, px);
                    if (IsNull(ext)) return;
                    var condition = IsNull(opt.CqlFilter) ? "" : "(" + opt.CqlFilter + ")" + " AND ";
                    var wkt = getwktbyfeature(new ol.Feature(ext), $this.IsConvert);
                    condition += getcql_intersects(wkt, opt.GeometryName);
                    $this.Target.one("onQueryCompleted", function (s, e) { features = e.data; });
                    $this.Query({ CqlFilter: condition });
                })(opt.Point, opt.PX);
                return features;
            };


        })(jQuery);
    </script>
</head>
<body>
    <div class="content">
        <div id="mapdiv" style="height: 100%; width: 100%;"></div>
        <div style="height: 450px; width: 200px; position: absolute; top: 30px; right: 50px; border: 1px solid #ddd;">
            <div style="height: 24px; width: 100%; background-color: #f7f7f7; color: #6e6e6e; line-height: 24px;"><span style="margin-left: 8px;">选择行政区划</span></div>
            <div style="height: 28px; width: 200px; line-height: 28px;">
                <div style="height: 24px; width: 172px; margin-left: 8px; background-color: #fff; margin-top: 4px; padding-left: 5px;">河南省 驻马店市 遂平县</div>
            </div>
            <div style="height: 60px; width: 200px;">
                <div style="background-color: #f7f7f7; color: #6e6e6e; line-height: 24px; height: 24px;"><span style="margin-left: 8px;">地块</span></div>
                <div class="item">
                    <div class="layeritem">
                        <div style="height: 24px; width: 24px; background-color: green; border-radius: 12px; margin-top: 5px; display: inline-block; float: left;"></div>
                        <div style="height: 35px; width: 90px; color: #000; display: inline-block; line-height: 35px; float: left;"><span style="margin-left: 6px;">遂平县地块</span></div>
                        <div class="edit" tag="blocklayer1">
                            <div class="icon"></div>
                        </div>
                        <div class="check">
                            <input type="checkbox" tag="blocklayer1" />
                        </div>

                    </div>
                </div>
                <div style="background-color: #f7f7f7; color: #6e6e6e; line-height: 24px; height: 24px;"><span style="margin-left: 8px;">历史种植</span></div>
                <div class="item">
                    <div class="layeritem">
                        <div style="height: 24px; width: 24px; background-color: green; border-radius: 12px; margin-top: 5px; display: inline-block; float: left;"></div>
                        <div style="height: 35px; width: 120px; color: #000; display: inline-block; line-height: 35px; float: left;"><span style="margin-left: 6px;">遂平县20170127</span></div>
                        <div class="check">
                            <input type="checkbox" tag="20170127CropLayer" />
                        </div>
                    </div>
                </div>
                <div class="item">
                    <div class="layeritem">
                        <div style="height: 24px; width: 24px; background-color: green; border-radius: 12px; margin-top: 5px; display: inline-block; float: left;"></div>
                        <div style="height: 35px; width: 120px; color: #000; display: inline-block; line-height: 35px; float: left;"><span style="margin-left: 6px;">遂平县20171107</span></div>
                        <div class="check">
                            <input type="checkbox" tag="20171107CropLayer" />
                        </div>
                    </div>
                </div>
                <div style="background-color: #f7f7f7; color: #6e6e6e; line-height: 24px; height: 24px;"><span style="margin-left: 8px;">影像数据</span></div>
                <div class="item">
                    <div class="layeritem">
                        <div style="height: 24px; width: 24px; background-color: green; border-radius: 12px; margin-top: 5px; display: inline-block; float: left;"></div>
                        <div style="height: 35px; width: 120px; color: #000; display: inline-block; line-height: 35px; float: left;"><span style="margin-left: 6px;">2017年无人机影像</span></div>
                        <div class="check">
                            <input type="checkbox" tag="411728image0" />
                        </div>
                    </div>
                </div>
                <div class="item">
                    <div class="layeritem">
                        <div style="height: 24px; width: 24px; background-color: green; border-radius: 12px; margin-top: 5px; display: inline-block; float: left;"></div>
                        <div style="height: 35px; width: 120px; color: #000; display: inline-block; line-height: 35px; float: left;"><span style="margin-left: 6px;">2017年高分影像</span></div>
                        <div class="check">
                            <input type="checkbox" tag="411728image1" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="editattrinfo" style="position: absolute; left: 50%; top: 50%; width: 260px; height: 240px; border: 1px solid #0099cc; display: none" tag="nouse">
            <div style="height: 30px; width: 100%; background-color: #0099cc; color: #fcfcfc;"><span style="margin-left: 10px; line-height: 30px;">元素编辑</span></div>
            <div style="height: 29px; width: 100%; border-bottom: 1px solid #ddd;">
                <div style="width: 75px; padding-right: 5px; height: 29px; border-right: 1px solid #ddd; display: inline-block; float: left; text-align: right; line-height: 29px;">地块编号</div>
                <div style="width: 177px; height: 29px; display: inline-block;">
                    <input type="text" style="height: 24px; border: 1px solid #95b8e7; width: 167px; margin-top: 2px; margin-left: 5px;" name="MASSIFID" disabled="disabled" />
                </div>
            </div>
            <div style="height: 29px; width: 100%; border-bottom: 1px solid #ddd;">
                <div style="width: 75px; padding-right: 5px; height: 29px; border-right: 1px solid #ddd; display: inline-block; float: left; text-align: right; line-height: 29px;">地类名称</div>
                <div style="width: 177px; height: 29px; display: inline-block;">
                    <input type="text" style="height: 24px; border: 1px solid #95b8e7; width: 167px; margin-top: 2px; margin-left: 5px;" name="CLASSNAME" />
                </div>
            </div>
            <div style="height: 29px; width: 100%; border-bottom: 1px solid #ddd;">
                <div style="width: 75px; padding-right: 5px; height: 29px; border-right: 1px solid #ddd; display: inline-block; float: left; text-align: right; line-height: 29px;">权属性质</div>
                <div style="width: 177px; height: 29px; display: inline-block;">
                    <input type="text" style="height: 24px; border: 1px solid #95b8e7; width: 167px; margin-top: 2px; margin-left: 5px;" name="OWNERSHIP" />
                </div>
            </div>
            <div style="height: 29px; width: 100%; border-bottom: 1px solid #ddd;">
                <div style="width: 75px; padding-right: 5px; height: 29px; border-right: 1px solid #ddd; display: inline-block; float: left; text-align: right; line-height: 29px;">权属单位名称</div>
                <div style="width: 177px; height: 29px; display: inline-block;">
                    <input type="text" style="height: 24px; border: 1px solid #95b8e7; width: 167px; margin-top: 2px; margin-left: 5px;" name="OWNERNAME" />
                </div>
            </div>
            <div style="height: 29px; width: 100%; border-bottom: 1px solid #ddd;">
                <div style="width: 75px; padding-right: 5px; height: 29px; border-right: 1px solid #ddd; display: inline-block; float: left; text-align: right; line-height: 29px;">耕地类型</div>
                <div style="width: 177px; height: 29px; display: inline-block;">
                    <input type="text" style="height: 24px; border: 1px solid #95b8e7; width: 167px; margin-top: 2px; margin-left: 5px;" name="LANDTYPE" />
                </div>
            </div>
            <div style="height: 29px; width: 100%; border-bottom: 1px solid #ddd;">
                <div style="width: 75px; padding-right: 5px; height: 29px; border-right: 1px solid #ddd; display: inline-block; float: left; text-align: right; line-height: 29px;">基本农田类型</div>
                <div style="width: 177px; height: 29px; display: inline-block;">
                    <input type="text" style="height: 24px; border: 1px solid #95b8e7; width: 167px; margin-top: 2px; margin-left: 5px;" name="FARMTYPE" />
                </div>
            </div>
            <div style="height: 29px; width: 100%; border-bottom: 1px solid #ddd;">
                <div style="width: 75px; padding-right: 5px; height: 29px; border-right: 1px solid #ddd; display: inline-block; float: left; text-align: right; line-height: 29px;">基本农田类型</div>
                <div style="width: 177px; height: 29px; display: inline-block;">
                    <input type="text" style="height: 24px; border: 1px solid #95b8e7; width: 167px; margin-top: 2px; margin-left: 5px;" name="FARMAREA" />
                </div>
            </div>
        </div>
    </div>
</body>
</html>
