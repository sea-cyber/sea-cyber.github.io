<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>农业大数据研究与管理平台</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <meta name="renderer" content="webkit">
    <link rel="stylesheet" href="theme/default/easyui.css" />
    <link rel="stylesheet" type="text/css" href="theme/icon.css" />
    <link rel="stylesheet" type="text/css" href="css/app.css" />
    <link rel="stylesheet" type="text/css" href="css/ol.css" />
    <link rel="stylesheet" type="text/css" href="css/index.css" />
    <link rel="stylesheet" type="text/css" href="css/main.css" />
    <link rel="stylesheet" type="text/css" href="css/icon.css" />
    <link rel="stylesheet" type="text/css" href="css/dev.css" />
    <link rel="stylesheet" type="text/css" href="cesium/Widgets/widgets.css" />
    <link href="js/viewer.min.css" rel="stylesheet" />
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="js/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="js/linq.min.js"></script>
    <script type="text/javascript" src="js/data.util.js"></script>
    <!--<script src="js/ol-debug.js"></script>-->
    <script type="text/javascript" src="js/ol.min.3.2.1.js"></script>
    <script type="text/javascript" src="js/polyfill.min.js"></script>
    <script type="text/javascript" src="js/spin.js"></script>
    <script type="text/javascript" src="js/dev.ui.js"></script>
    <script type="text/javascript" src="js/md5.js"></script>
    <script type="text/javascript" src="js/guid.js"></script>
    <script type="text/javascript" src="js/jquery.cookie.js"></script>
    <script type="text/javascript" src="js/jquery.form.js"></script>
    <script type="text/javascript" src="js/dev.gis.js"></script>
    <script type="text/javascript" src="js/highcharts.js"></script>
    <script type="text/javascript" src="js/highcharts-3d.js"></script>
    <script type="text/javascript" src="js/jsts.min.js"></script>
    <script type="text/javascript" src="js/jquery.dev.js"></script>
    <script type="text/javascript" src="cesium/Cesium.js"></script>
    <script type="text/javascript" src="js/measure3D.js"></script>
    <script type="text/javascript" src="cesium/viewerNavigation.js"></script>
    <script type="text/javascript" src="streetview/three.min.js"></script>
    <script type="text/javascript" src="streetview/tpanorama.js"></script>
    <link rel="icon" type="image/x-icon" href="image/logo.ico" />
    <script src="js/jquery.dev.control.js"></script>
    <script src="js/orchard.js"></script>
    <script src="js/viewer.js"></script>
    <script src="http://pv.sohu.com/cityjson?ie=utf-8"></script>
    <style>
        .ol-default-popup {
            position: absolute;
            background-color: white;
            -webkit-filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
            filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
            padding: 5px;
            border-radius: 10px;
            border: 1px solid #cccccc;
            bottom: 12px;
            left: -50px;
        }

            .ol-default-popup:after, .ol-popup:before {
                top: 100%;
                border: solid transparent;
                content: " ";
                height: 0;
                width: 0;
                position: absolute;
                pointer-events: none;
            }

            .ol-default-popup:after {
                border-top-color: white;
                border-width: 10px;
                left: 70px;
                margin-left: -10px;
            }
    </style>
    <script type="text/javascript">
        var type = dev.GetQueryString("param");
        dev.App.XmlType = type;
        function initUserInfo() {
            dev.App.TopPanel.RightBox.append(dev.cookie.getIndex());//返回首页
            dev.App.TopPanel.RightBox.append(dev.cookie.getFace());//用户头像
            dev.cookie.getUserTip();//显示用户详细信息
            //  dev.cookie.returnhost();//返回首页按钮事件绑定
            $('body').append(dev.cookie.addEditDlg());
            $('body').append(dev.cookie.getEditImgDialog());
            $('#dlg').dialog({ content: dev.cookie.getEditDlg() });
            $('#editImage').dialog({ content: dev.cookie.getEditImg() });
            dev.UserInfo = dev.cookie.user;
        }
        dev.cookie.validateUser();
        if (dev.cookie.config.SimpleMenu == "true" && dev.IsNull(dev.App.XmlType)) dev.App.XmlType = dev.cookie.config.SimpleXml;
        if (dev.cookie.config.SimpleMenu != "true" && dev.IsNull(dev.App.XmlType)) location.href = dev.cookie.rootPath + "login.html";
        $(window).ready(function () {
            //判断用户是否登录
            var u = $.cookie("usertoken");
            if (u == undefined || u == null) {
                this.user = null;
                if (dev.cookie.rootPath == undefined || dev.cookie.rootPath == null) dev.cookie.rootPath = dev.cookie.getRootPath();
                location.href = dev.cookie.rootPath + "login.html";
            }
            dev.App.Init();
            initUserInfo();
            dev.initmaptool();//初始化地图工具

            //根据IP定位
            //var location_ip = returnCitySN["cip"];
            //if (!dev.IsNull(location_ip)) {
            //    $.ajax({
            //        url: dev.GetSystemUrlByRelID("Service") + "common/getAddressInfoByIp?ip=" + location_ip,
            //        type: "GET",
            //        contentType: "application/json",
            //        success: function (s) {
            //            if (s.statusCode != 200 && s.data == null) return;
            //            var loction_address = s.data.content.address_detail;
            //            var cityname = loction_address.city;
            //            var city_f = dev.getxzqbyname(cityname, "city");
            //            if (dev.IsNull(city_f)) return;
            //            var locatin_extent = city_f.getGeometry().getExtent();
            //            dev.App.Map.getView().setCenter([(locatin_extent[0] + locatin_extent[2]) / 2, (locatin_extent[1] + locatin_extent[3]) / 2], dev.App.Map.getSize());
            //            dev.App.Map.getView().setZoom(12);
            //            //设置区域名称
            //            $(".selecttext", $(".xzqposition", dev.App.MapPanel.MapDOM)).html(city_f.getProperties().CITY);
            //            $(".selecttext", $(".xzqposition", dev.App.MapPanel.MapDOM)).attr("tag", city_f.getProperties().ADCODE);
            //        }
            //    });
            //}
            //全局查询
            var globalsearch = new dev.GlobalSearch();
            globalsearch.Layout();
            dev.App.globalquery = globalsearch;
            dev.App.exportform = $("#export-form");
            var currtheme = Enumerable.From(dev.App.Config.SystemTheme).Where('s=>s.Type=="' + dev.App.XmlType + '"').FirstOrDefault();
            if (!dev.IsNull(globalsearch) && currtheme.GlobalQuery == "false") globalsearch.SetVisible(false);//对全局查询是否显示进行设置
            if (dev.App.XmlType == "10") {
                dev.settoolvisible(false);//不显示工具按钮
                //添加合作社图层
                var param = {
                    Map: dev.App.Map,
                    ID: "cooplayer",
                    Url: dev.GetSystemUrlByRelID("GeoServiceWMS"),
                    Layers: "cite:AGRI_COOPERATIVE",
                    Visible: true,
                    ServerType: "geoserver",
                    EPSG: 'EPSG:4326'
                };
                dev.MapLoad.AddWMSLayer(param);
                //添加果园
                var param = {
                    Map: dev.App.Map,
                    ID: "orchardlayer",
                    Url: dev.GetSystemUrlByRelID("GeoServiceWMS"),
                    Layers: "cite:AGRI_ORCHARD",
                    Visible: true,
                    ServerType: "geoserver",
                    EPSG: 'EPSG:4326'
                };
                dev.MapLoad.AddWMSLayer(param);
                dev.App.Map.getView().fit([107.135237, 35.235242, 107.136661, 35.236352], dev.App.Map.getSize());
                dev.App.Map.on("singleclick", function (evt) {
                    var quearylayer = [];
                    var cooperative_layer = dev.MapUtils.GetLayer("cooplayer", dev.App.Map); //获取合作社图层
                    var orchard_layer = dev.MapUtils.GetLayer("orchardlayer", dev.App.Map);//获取果园图层
                    if (!dev.IsNull(orchard_layer) && orchard_layer.getVisible()) quearylayer.push({
                        GeometryName: "geom",
                        PX: 5,
                        Point: evt.coordinate,
                        Url: dev.GetSystemUrlByRelID("GeoServiceWFS"),
                        TypeName: "cite:AGRI_ORCHARD",
                        Map: dev.App.Map
                    });
                    if (!dev.IsNull(cooperative_layer) && cooperative_layer.getVisible()) quearylayer.push({
                        GeometryName: "geom",
                        PX: 5,
                        Point: evt.coordinate,
                        Url: dev.GetSystemUrlByRelID("GeoServiceWFS"),
                        TypeName: "cite:AGRI_COOPERATIVE",
                        Map: dev.App.Map
                    });
                    if (quearylayer.length == 0) return;
                    var result;
                    var isorchard = true;
                    for (var i = 0; i < quearylayer.length; i++) {
                        result = dev.PointerQuery(quearylayer[i]);
                        if (!dev.IsNull(result) && result.length > 0) break;
                        isorchard = false;
                    }
                    if (!dev.IsNull(result)) {
                        dev.InitOrchardTip(result[0], isorchard);
                    }
                });
            }
        });
        $(window).resize(function () { dev.App.Resize(); });
    </script>
</head>
<body style="background-color: #EFEFF2;">
    <form id="export-form" style="display: none;" method="post">
        <input name="condition" />
    </form>
</body>
</html>
