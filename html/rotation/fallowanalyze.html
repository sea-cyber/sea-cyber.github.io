<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>轮作休耕统计</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <link rel="stylesheet" href="../../theme/default/easyui.css" />
    <link rel="stylesheet" type="text/css" href="../../theme/icon.css" />
    <link rel="stylesheet" type="text/css" href="../../css/app.css" />
    <link rel="stylesheet" type="text/css" href="../../css/main.css" />
    <link rel="stylesheet" type="text/css" href="../../css/icon.css" />
    <link rel="stylesheet" type="text/css" href="../../css/dev.css" />
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../js/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="../../js/linq.min.js"></script>
    <script type="text/javascript" src="../../js/data.util.js"></script>
    <script type="text/javascript" src="../../js/highcharts.js"></script>
    <script type="text/javascript" src="../../js/highcharts-more.js"></script>
    <script type="text/javascript" src="../../js/solid-gauge.js"></script>
    <script type="text/javascript" src="../../js/dev.ui.js"></script>
    <script type="text/javascript" src="../../js/drilldown.js"></script>
    <script type="text/javascript" src="../../js/highcharts-zh_CN.js"></script>
    <script type="text/javascript" src="../../js/guid.js"></script>
<!--    <script type="text/javascript" src="../../js/excellentexport.js"></script>-->
    <style type="text/css">
        .content {
            height: 100%;
            width: 100%;
            position: relative;
        }

            .content .row {
                width: 100%;
                height: 28px;
                margin-top: 5px;
            }

                .content .row .title {
                    width: 70px;
                    height: 28px;
                    line-height: 28px;
                    display: inline-block;
                    float: left;
                    text-align: right;
                    padding-right: 5px;
                }

                .content .row .control {
                    width: 210px;
                    padding-left: 5px;
                    display: inline-block;
                    height: 28px;
                    min-width: 60px;
                }

                .content .row .Button {
                    width: 60px;
                    height: 26px;
                    margin-top: 7px;
                    background-color: #16dbbb;
                    /*border-radius: 5px;*/
                    text-align: center;
                    border: 1px solid #16dbbb;
                    display: inline-block;
                    margin-left: 5px;
                }

                    .content .row .Button:hover {
                        background-color: #5227de;
                        border: 1px solid #5227de;
                        cursor: pointer;
                    }
                       .content .row .Button:active {
                background-color: #210097;
                border: 1px solid #210097;
                cursor: pointer;
            }
    </style>
    <script type="text/javascript">
        var Dev = window.top.window.dev, orgId = Dev.cookie.user.orgid;
        var parent;
        var dialog;
        var statData, statWin;
        var baseUrl = Dev.GetSystemUrlByRelID("Service");
        var left = Dev.App.LeftPanel, bottom = Dev.App.BottomPanel;
        var region = {}, filter, selectRegionNode;
        var plantType, time1, time2, min, max;          //查询条件
        var box;
        var nodeType = {
            province: '省',
            city: '市',
            county: '县',
            town: '乡'
        };

        function WidgetCommunication(s) {//部件通讯
            parent = s.parent;
            initComboTree();
            $(".Button").click(function () {
                $("#errorMsg").html("");
                var tag = $(this).attr("tag");
                if (tag === "statistics") statistics();
                else if (tag === "cancel") clearSearch();
            });
            left.SetIconCls("icon-statwork");
            left.Header.css("background-color", "#5AB4D6");
            left.bind("onResize", function () {
                var width = left.Target.outerWidth();
                $(".control").css("width", (width - 90) + "px");
            });
            bottom.bind("onResize", function () {
                resize();
            });
            bottom.bind("onToolClick", function (s, e) {
                var id = e.ToolItem.ID;
                if (id === "btnStatist") {
                    initStatisWin();
                }
                else if (id === "btnExport") {
                    Dev.exportExcelByUrl(baseUrl + "rotationfallow/export/" + orgId, getCondition());
                }
            });
            parent.one("onClosing", function () {
                left.unbind("onResize");
                bottom.unbind("onResize");
                bottom.unbind("onToolClick");
                bottom.ClearTool();
                bottom.Content.empty();
                bottom.SetVisible(false);
            });
            init_yearMonth("time1");
            init_yearMonth("time2");
            $("#time1,#time2").datebox({
                    editable:false,
                    width: 94,
                    heigth: 24
                });
        }

        function init_yearMonth(id) {
            var db = $('#' + id);
            db.datebox({
                editable: false,
                prompt: '选择年月',
                validType: [],
                onShowPanel: function () {//显示日趋选择对象后再触发弹出月份层的事件，初始化时没有生成月份层
                    span.trigger('click'); //触发click事件弹出月份层
                    if (!tds) setTimeout(function () {//延时触发获取月份对象，因为上面的事件触发和对象生成有时间间隔
                        tds = p.find('div.calendar-menu-month-inner td');
                        tds.click(function (e) {
                            e.stopPropagation(); //禁止冒泡执行easyui给月份绑定的事件
                            var year = /\d{4}/.exec(span.html())[0]//得到年份
                            , month = parseInt($(this).attr('abbr'), 10); //月份，这里不需要+1
                            db.datebox('hidePanel')//隐藏日期对象
                            .datebox('setValue', year + '-' + month); //设置日期的值
                        });
                    }, 0);
                    yearIpt.unbind();//解绑年份输入框中任何事件
                    $(yearIpt).attr('readonly', true);//年份只读
                    $(yearIpt).css('border-color', 'white');//边框去掉
                },
                parser: function (s) {
                    if (!s) return new Date();
                    var arr = s.split('-');
                    return new Date(parseInt(arr[0], 10), parseInt(arr[1], 10) - 1, 1);
                },
                formatter: function (d) { return d.getFullYear() + '-' + (d.getMonth() + 1);/*getMonth返回的是0开始的，忘记了。。已修正*/ }
            });
            var p = db.datebox('panel'), //日期选择对象
                tds = false, //日期选择对象中月份
                aToday = p.find('a.datebox-current'),
                yearIpt = p.find('input.calendar-menu-year'),//年份输入框
                //显示月份层的触发控件
                span = aToday.length ? p.find('div.calendar-title span') ://1.3.x版本
                p.find('span.calendar-text'); //1.4.x版本
            if (aToday.length) {//1.3.x版本，取消Today按钮的click事件，重新绑定新事件设置日期框为今天，防止弹出日期选择面板
                aToday.unbind('click').click(function () {
                    var now = new Date();
                    db.datebox('hidePanel').datebox('setValue', now.getFullYear() + '-' + (now.getMonth() + 1));
                });
            }
        }
        function statistics() {
            if (Dev.IsNull($("#treecomboDiv").combotree('getValue'))) {
                $("#errorMsg").html("请选择行政区！");
                return;
            }
            $.ajax({
                type: "post",
                url: baseUrl + "rotationfallow/findByParams/" + orgId,
                data: getCondition(),
                contentType: "application/json",
                success: function (response) {
                    if (Dev.IsNull(response) || response.statusCode != 200) {
                        return dialog.Alert("网络超时，请稍后再试！", "error");
                    }
                    statData = response.data;
                    if (Dev.IsNull(statData) || statData.length === 0) {
                        clearBottomPanel();
                        return $("#errorMsg").html("暂时没有统计数据!");
                    }
                    bottom.Content.empty();
                    bindResultData(statData);
                    resize();
                }
            });
        }
        // 初始化统计图的 Win
        function initStatisWin() {
            //统计图
            if (Dev.IsNull(statData)) return;
            //弹出窗体
            if (Dev.IsNull(statWin)) {
                statWin = new Dev.Window({
                    ID: "workstat",
                    IconCls: 'icon-statgraph',
                    Title: "轮作休耕统计图",
                    Parent: Dev.App.FillPanel.Target,
                    Maximizable: true,
                    Modal: true,
                    Draggable: true,
                    HAlign: 'center',
                    VAlign: 'center',
                    Resizable: false,
                    Content: initChartData(),
                    Height: 450,
                    Width: 600
                });
                statWin.bind("onResize", function (s, e) {
                    //改变统计图大小
                    var winheight = statWin.Height;
                    var winwidth = statWin.Width;
                    var chartdiv = $(".chartDiv", statWin.Target);
                    chartdiv.css({ "width": (winwidth - 2) + "px", "height": (winheight - 32) + "px" });
                    var chart = $("#chart", chartdiv);
                    if (Dev.IsNull(chart) || chart.length === 0) return;
                    if (!Dev.IsNull($(chart[0]).highcharts())) $(chart[0]).highcharts().setSize(winwidth - 2, winheight - 32, false);
                });
            }
            else {
                statWin.SetContent(initChartData());
                statWin.Open();
            }
        }

        var drilldown;
        function initChartData() {
            var chartdiv = $('<div class="chartDiv"></div>');
            drilldown = [];
            var chart = $('<div id="chart"></div>').appendTo(chartdiv);
            var seriesdata = Enumerable.From(statData).GroupBy('s=>s.province').ToArray();
            var series = [
                { name: "总面积", data: [], type: "column",  title: "省", color: "#4169E1", tooltip: { valueSuffix: ' 亩' } },
                { name: "违种面积", data: [], type: "column", color: "#DC143C", tooltip: { valueSuffix: ' 亩' } },
                { name: "补贴金额", data: [], type: 'spline', yAxis: 1,  color: "#95c471", tooltip: { valueSuffix: ' 元' } }];
            for (var i = 0; i < seriesdata.length; i++) {
                var totalArae = Enumerable.From(seriesdata[i]).Sum('s=>s.massifarea');
                var temp = Enumerable.From(seriesdata[i]).Where("s=>s.state == '3'").ToArray();
                var subArea = Enumerable.From(temp).Sum('s=>s.massifarea');
                var totalTime = Enumerable.From(seriesdata[i]).Sum('s=>s.subsidy');
                var drilldownName = Guid.NewGuid().ToString("N");
                series[0].data.push({ name: seriesdata[i].source[0].province, y: parseFloat(totalArae.toFixed(3)), drilldown: drilldownName });
                series[1].data.push({ name: seriesdata[i].source[0].province, y: parseFloat(subArea.toFixed(3)), drilldown: drilldownName });
                series[2].data.push({ name: seriesdata[i].source[0].province, y: parseFloat(totalTime.toFixed(3)), drilldwon: drilldownName });
                getdrilldown(seriesdata[i].source, "province", drilldownName);
            }
            chart.highcharts({
                lang: {
                    drillUpText: "<返回 {series.title}"
                },
                chart: {
                    events: {
                        drilldown: function (e) {
                            var c = this;
                            var drilldownid = e.point.drilldown;
                            var newseries = Enumerable.From(drilldown).Where('s=>s.id=="' + drilldownid + '"').ToArray();
                            for (var i = 0; i < newseries.length; i++) c.addSingleSeriesAsDrilldown(e.point, newseries[i]);
                            c.applyDrilldown();
                            return false;
                        }
                    }
                },
                title: null,
                xAxis: {
                    type: 'category'
                },
                yAxis: [
                    {
                        title: { text: '面积(亩)' }
                    },
                    {
                        title: { text: '补贴金额(元)' }, opposite: true
                    }
                ],
                legend: {
                    enabled: true,
                    labelFormatter: function (s, e) {
                        return '<b>' + this.userOptions.name + '</b>';
                    }

                },
                credits: { enabled: false },
                series: series,
                drilldown: {
                    //series: drilldown
                    series: []
                },
            });
            return chartdiv;
        }
        function getdrilldown(data, levername, id) {
            var groupname;
            var sn1, sn2, sn3;
            if (levername == "province") { groupname = "city"; sn1 = "市"; sn2 = "市"; sn3 = "市" }
            if (levername == "city") { groupname = "county"; sn1 = "县"; sn2 = "县"; sn3 = "县" }
            if (levername == "county") { groupname = "town"; sn1 = "乡"; sn2 = "乡"; sn3 = "乡" }
            if (levername == "town") { groupname = "name"; sn1 = "农户"; sn2 = "农户"; sn3 = "农户" }
            if (levername == "name") { sn1 = "总面积"; sn2 = "年份"; sn3 = "补贴金额" }
            var currdata = { title: sn1, name: "总面积", id: id, data: [], type: "column", color: "#4169E1", tooltip: { valueSuffix: ' 亩' } };
            var subcurrdata = { title: sn2, name: "违种面积", id: id, data: [], type: "column", color: "#DC143C", tooltip: { valueSuffix: ' 亩' } };
            var currdata1 = { title: sn3, name: "补贴金额", id: id, data: [], type: "spline", yAxis: 1, color: "#95c471", tooltip: { valueSuffix: ' 元' } };
            drilldown.push(currdata);
            drilldown.push(subcurrdata);
            drilldown.push(currdata1);
            if (!Dev.IsNull(groupname)) {
                var seriesdata = Enumerable.From(data).GroupBy('s=>s.' + groupname.toLowerCase()).OrderBy('s=>s.' + groupname.toLowerCase()).ToArray();
                for (var i = 0; i < seriesdata.length; i++) {
                    var totalArea = Enumerable.From(seriesdata[i].source).Sum('s=>s.massifarea');
                    var temp = Enumerable.From(seriesdata[i]).Where("s=>s.state == '3'").ToArray();         //违种信息
                    var subArea = Enumerable.From(temp).Sum('s=>s.massifarea');
                    var subSbidy = Enumerable.From(temp).Sum('s=>s.subsidy');
                    var totalTime = Enumerable.From(seriesdata[i].source).Sum('s=>s.subsidy');
                    if (subSbidy > 0) totalTime -= subSbidy;   //实际津贴= 总津贴 - 违种津贴
                    var drilldownName = Guid.NewGuid().ToString("N");
                    var labelname = seriesdata[i].source[0][groupname.toLowerCase()];
                    if (Dev.IsNull(labelname)) labelname = "其他";
                    currdata.data.push({ name: labelname, y: Number(totalArea.toFixed(3)), drilldown: drilldownName });
                    subcurrdata.data.push({ name: labelname, y: Number(subArea.toFixed(3)), drilldown: drilldownName });
                    currdata1.data.push({ name: labelname, y: totalTime, drilldown: drilldownName });
                    getdrilldown(seriesdata[i].source, groupname, drilldownName);
                }
            }
            else {
                var years = Enumerable.From(data).Distinct("s=>s.year").OrderBy("s=>s.year").ToArray();
                var illegal = Enumerable.From(data).Where("s=>s.state =='3'").ToArray();        //减去不通过的
                var totalArea = {}, ilArea = {}, subsidy = {}, ilsubsidy = {};
                for (var ss = 0; ss < years.length; ss++) {
                    var yy = years[ss].year;              //获取唯一 年份
                    var temp1 = Enumerable.From(data).Where("s=>s.year ==" + yy).ToArray();
                    totalArea[yy] = Enumerable.From(temp1).Sum("s=>s.massifarea");
                    subsidy[yy] = Enumerable.From(temp1).Sum("s=>s.subsidy");
                    var temp2 = Enumerable.From(illegal).Where("s=>s.year ==" + yy).ToArray();
                    ilArea[yy] = Enumerable.From(temp2).Sum("s=>s.massifarea");
                    ilsubsidy[yy] = Enumerable.From(temp2).Sum("s=>s.subsidy");     //某年所有 违法补贴
                    currdata.data.push({ name: yy, y: parseFloat(totalArea[yy].toFixed(3)) });
                    subcurrdata.data.push({ name: yy, y: parseFloat(ilArea[yy].toFixed(3)) });
                    currdata1.data.push({ name: yy, y: subsidy[yy] - ilsubsidy[yy] });
                }
            }
        }

        //清除
        function clearSearch() {
            $("#treecomboDiv").combotree('reset');
            $("#planttype").prop("$this").SetText("");
            $("#time1,#time2").datebox("setValue", "");
            $("#min").prop("$this").Clear();
            $("#max").prop("$this").Clear();
            clearBottomPanel();
        }
        function clearBottomPanel() {
            statData = null;
            bottom.ClearTool();
            bottom.Content.empty();
            bottom.SetVisible(false);
        }

        // 初始化ComboTree
        function initComboTree() {
            var isHighlight = true;
            $("#treecomboDiv").combotree({
                method: "post",
                url: Dev.GetSystemUrlByRelID("Service") + 'dictionary/asyncdata/county',
                panelWidth: '210',
                onClick: function (node) {
                },
                onBeforeExpand: function (node) {
                    $(this).tree('options').url = Dev.GetSystemUrlByRelID("Service") + 'dictionary/asyncdata/county?id=' + node.id;
                },
                onLoadSuccess: function () {
                    if (!isHighlight) return;
                    $(this).find("li:eq(0)").find("div").addClass("tree-node-selected");
                    var n = $(this).tree("getSelected");
                    if (n != null) $(this).tree("select", n.target);
                    isHighlight = false;
                },
                loadFilter: function (data) {
                    data = data.data;
                    for (var i = 0; i < data.length; i++) {
                        if ('data' in data[i]) {
                            data[i].text = data[i].data;
                        }
                        if (data[i].remark === "县") {
                            data[i].state = "close";
                        }
                    }
                    return data;
                }
            });
        }
        // 查找combotree的父级节点
        function getParentNode(node) {
            var tree = $('#treecomboDiv').combotree('tree');
            return tree.tree('getParent', node.target);
        }
        function bindResultData(data) {
            if (!bottom.Visible) {
                bottom.SetVisible(true);
                bottom.Header.css({ "background-color": "#0099cc", "color": "#fcfcfc", "font-weight": "bold" });
                bottom.SetIconCls("icon-statlist");
                bottom.SetTitle("轮作休耕列表");
                bottom.ClearTool();
                bottom.AddTool([{ ID: 'btnExport', IconCls: 'icon-export-white', TipTitle: '导出' }, {
                    ID: 'btnStatist',
                    IconCls: 'icon-statgraph',
                    TipTitle: '统计图'
                }]);
            }
            var div = $('<div style="width:100%;height:100%;"></div>');
            Dev.App.BottomPanel.Add(div);
            //显示数据
            box = new Dev.Box({ HasBorder: false });
            box.Target.css({
                width: Dev.App.BottomPanel.Target.width() + "px",
                height: (Dev.App.BottomPanel._Height - 28) + "px"
            });
            box.Target.appendTo(div);
            var table = $('<table class="statInfo" cellspacing="0" cellpadding="0"><tr><th>省</th><th>市</th><th>县</th><th>乡</th><th>农户</th><th>地块</th><th>种植类型</th><th>年份</th><th>月份</th><th>作物</th><th>地块面积(亩)</th><th>补贴金额(元)</th><th>任务状态</th></tr></table>');

            //行数有多少条
            var provincedata = Enumerable.From(data).GroupBy('s=>s.province').ToArray();
            var isprorow = false, iscityrow = false, iscountyrow = false, istownrow = false, isfarmerow = false, isplantrow = false;
            for (var i = 0; i < provincedata.length; i++) {
                isprorow = true;
                var provincerowcount = provincedata[i].source.length;
                var provincename = provincedata[i].source[0].province;
                var citys = Enumerable.From(provincedata[i].source).GroupBy('s=>s.city').ToArray();
                for (var j = 0; j < citys.length; j++) {
                    iscityrow = true;
                    var cityrowcount = citys[j].source.length;
                    var cityname = citys[j].source[0].city;
                    var county = Enumerable.From(citys[j].source).GroupBy('s=>s.county').ToArray();
                    for (var k = 0; k < county.length; k++) {
                        iscountyrow = true;
                        var countyrowcount = county[k].source.length;
                        var countyname = county[k].source[0].county;
                        var town = Enumerable.From(county[k].source).GroupBy('s=>s.town').ToArray();
                        for (var l = 0; l < town.length; l++) {
                            istownrow = true;
                            var townrowcount = town[l].source.length;
                            var townname = town[l].source[0].town;
                            var farmer = Enumerable.From(town[l].source).GroupBy('s=>s.name').ToArray();
                            for (var r = 0; r < farmer.length; r++) {
                                isfarmerow = true;
                                var farmerCount = farmer[r].source.length;
                                var farmerName = farmer[r].source[0].name;
                                var massifids = Enumerable.From(farmer[r].source).GroupBy('s=>s.massifid').ToArray();
                                for (var t = 0; t < massifids.length; t++) {
                                    isplantrow = true;
                                    var massifidsCount = massifids[t].source.length;
                                    var massifidName = massifids[t].source[0].massifid;

                                    var plantmethod = massifids[t].source[0].planting;

                                    var year = Enumerable.From(massifids[t].source).GroupBy('s=>s.year').ToArray();
                                    for (var s = 0; s < year.length; s++) {
                                        var yearCount = year[s].source.length;
                                        for (var m = 0; m < yearCount; m++) {
                                            var yearName = year[s].source[m].year;
                                            var tr = $('<tr></tr>').appendTo(table);
                                            if (isprorow) {
                                                tr.append($('<td rowspan="' + provincerowcount + '">' + (Dev.IsNull(provincename) ? "-" : provincename) + '</td>'));
                                                isprorow = false;
                                            }
                                            if (iscityrow) {
                                                tr.append($('<td rowspan="' + cityrowcount + '">' + (Dev.IsNull(cityname) ? "-" : cityname) + '</td>'));
                                                iscityrow = false;
                                            }
                                            if (iscountyrow) {
                                                tr.append($('<td rowspan="' + countyrowcount + '">' + (Dev.IsNull(countyname) ? "-" : countyname) + '</td>'));
                                                iscountyrow = false;
                                            }
                                            if (istownrow) {
                                                tr.append($('<td rowspan="' + townrowcount + '">' + (Dev.IsNull(townname) ? "-" : townname) + '</td>'));
                                                istownrow = false;
                                            }
                                            if (isfarmerow) {
                                                tr.append($('<td rowspan="' + farmerCount + '">' + (Dev.IsNull(farmerName) ? "-" : farmerName) + '</td>'));
                                                isfarmerow = false;
                                            }
                                            if (isplantrow) {
                                                tr.append($('<td rowspan="' + massifidsCount + '">' + (Dev.IsNull(massifidName) ? "-" : massifidName) + '</td>'));
                                                tr.append($('<td rowspan="' + massifidsCount + '">' + (Dev.IsNull(plantmethod) ? "-" : plantmethod) + '</td>'));
                                                isplantrow = false;
                                            }
                                            tr.append($('<td>' + (Dev.IsNull(yearName) ? "-" : yearName) + '</td>'));
                                            tr.append($('<td>' + (Dev.IsNull(year[s].source[m].mouth) ? "-" : year[s].source[m].mouth) + '</td>'));     //后台字段为mouth，将错就错
                                            tr.append($('<td>' + (Dev.IsNull(year[s].source[m].type) ? "0" : year[s].source[m].type) + '</td>'));
                                            tr.append($('<td>' + (Dev.IsNull(year[s].source[m].massifarea) ? "0" : year[s].source[m].massifarea) + '</td>'));
                                            tr.append($('<td>' + (Dev.IsNull(year[s].source[m].subsidy) ? "0" : year[s].source[m].subsidy) + '</td>'));
                                            tr.append($('<td>' + (Dev.IsNull(year[s].source[m].state) ? "-" : getState(year[s].source[m].state)) + '</td>'));
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            box.SetContent(table);
        }
        // 统计的时候绑定行政区信息
        function bindRegionMessage(node) {
            if (node == null || Dev.IsNull(node.remark)) return;
            var remark = node.remark;
            if (remark === nodeType.province) {
                region.province = node.text;
            }
            else if (remark === nodeType.city) {
                region.city = node.text;
            }
            else if (remark === nodeType.county) {
                region.county = node.text;
            }
            else if (remark === nodeType.town) {
                region.town = node.text;
            }
            //查找父级节点，没有则退出
            var parent = getParentNode(node);
            if (parent != null) {
                bindRegionMessage(parent)
            }
        }
        //获取任务状态
        function getState(s) {
            var t;
            if (s == "0") t = "未处理";
            if (s == "1") t = "已核查";
            if (s == "2") t = "通过";
            if (s == "3") t = "不通过";
            return t;
        }
        // 生成查询条件
        function getCondition() {
            var condition = "1=1 ";
            selectRegionNode = $("#treecomboDiv").combotree('tree').tree('getSelected');  //初始获取不到，一直为空？
            region = {};
            bindRegionMessage(selectRegionNode);
            if (!Dev.IsNull(region.province)) {
                condition += " AND \"PROVINCE\"='" + region.province + "'"
            }
            if (!Dev.IsNull(region.city)) {
                condition += " AND \"CITY\"='" + region.city + "'"
            }
            if (!Dev.IsNull(region.county)) {
                condition += " AND \"COUNTY\"='" + region.county + "'"
            }
            if (!Dev.IsNull(region.town)) {
                condition += " AND \"TOWN\"='" + region.town + "'"
            }
            plantType = $("#planttype").prop("$this").GetText();
            if (!Dev.IsNull(plantType) && plantType != "-不限-") condition += " AND \"PLANTING\"='" + plantType + "'";
            time1 = $("#time1").datebox("getValue");
            time2 = $("#time2").datebox("getValue");
            if (!Dev.IsNull(time1) && !Dev.IsNull(time2)) {
                var t1 = new Date(time1.replace(/-/g, "/"));
                var t2 = new Date(time2.replace(/-/g, "/"));
                if (t1.getTime() > t2.getTime()) {
                    var temp = time1;
                    time1 = time2;
                    time2 = temp;
                }
            }
            if (!Dev.IsNull(time1)) {
                var year = time1.substring(0, 4);
                var month = time1.substring(5, 7);
                year = Number(year);
                month = Number(month);
                condition += " AND \"YEAR\">='" + year + "'";
                condition += " AND ( \"MOUTH\">='" + month + "' OR \"MOUTH\" = 'null' )";
            }
            if (!Dev.IsNull(time2)) {
                var year = time2.substring(0, 4);
                var month = time2.substring(5, 7);
                year = Number(year);
                month = Number(month);
                condition += " AND \"YEAR\"<='" + year + "'";
                condition += " AND (\"MOUTH\"<='" + month + "' OR \"MOUTH\" = 'null' )";
            }

            min = $("#min").prop("$this").GetValue();
            max = $("#max").prop("$this").GetValue();
            if (!Dev.IsNull(min)) condition += " AND \"SUBSIDY\">='" +parseInt(min) + "'";
            if (!Dev.IsNull(max)) condition += " AND \"SUBSIDY\"<='" + parseInt(max) + "'";
            return condition;
        }
        //bottomPanel 的Size发生改变
        function resize() {
            if (!Dev.IsNull(box)) box.SetSize({ Width: bottom.Target.width(), Height: (bottom.Height - 28) });
        }
    </script>
</head>
<body style="height: 100%; width: 100%;">
    <div class="content">
        <div class="row">
            <div class="title">选择地区</div>
            <div class="control">
                <div id="treecomboDiv" style="height: 28px; width: 210px;" opt="{'TipInfo':'请选择统计区域，默认为全国'}"></div>
                <div style="position: relative; height: 10px; width: 10px; top: -21px; left: 188px; color: red; line-height: 10px;">*</div>
            </div>
        </div>

        <div class="row">
            <div class="title">种植类型</div>
            <div class="control">
                <div id="planttype" class="dev-combobox" style="width: 100%;"
                    opt='{"Height":28,"TipInfo":"请选择","Data":["-不限-","一年一熟","一年多熟"],"Padding":"0px 5px","TextAlign":"left"}'>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="title">时间</div>
            <div class="control">
                <div  style="width: 94px; height: 35px; line-height: 35px; display: inline-block; float: left;">
                    <input id="time1" />
                </div>
                <div style="width: 20px; height: 35px; line-height: 35px; display: inline-block; float: left; text-align: center">至</div>
                <div style="width: 94px; height: 35px; line-height: 35px; display: inline-block; float: left; margin-left: 1px;">
                    <input id="time2" />
                </div>
            </div>
        </div>

        <div class="row">
            <div class="title">补贴金额</div>
            <div class="control">
                <div id="min" class="dev-textbox" style="width: 94px; height: 25px; display: inline-block; float: left; margin-top: 4px;" opt='{"TipInfo":"最低补贴(元)"}'></div>
                <div style="width: 20px; height: 35px; line-height: 35px; display: inline-block; float: left; text-align: center">-</div>
                <div id="max" class="dev-textbox" style="width: 94px; height: 25px; display: inline-block; float: left; margin-top: 4px;" opt='{"TipInfo":"最高补贴(元)"}'></div>
            </div>
        </div>

        <div class="row" style="text-align: right">
            <div id="errorMsg"
                style="width: 120px; height: 28px; line-height: 28px; display: inline-block; float: left; color: red; margin-left: 18px; text-align: left;">
            </div>
            <div class="Button" tag="statistics" style="margin-left: 10px;">
                <div class="icon-statgraph"
                    style="height: 16px; width: 16px; margin-top: 4px; margin-left: 5px; display: inline-block; float: left;">
                </div>
                <span style="line-height: 28px; color: #fcfcfc;">统&nbsp;计</span>
            </div>
            <div class="Button" tag="cancel" style="margin-right: 10px;">
                <div class="machine-reset"
                    style="height: 16px; width: 16px; margin-top: 4px; margin-left: 5px; display: inline-block; float: left;">
                </div>
                <span style="line-height: 28px; color: #fcfcfc;">重&nbsp;置</span>
            </div>
        </div>
    </div>
</body>
</html>
