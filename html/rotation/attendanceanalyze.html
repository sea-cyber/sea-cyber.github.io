<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>考勤统计</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <link rel="stylesheet" href="../../theme/default/easyui.css"/>
    <link rel="stylesheet" type="text/css" href="../../theme/icon.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/app.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/main.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/icon.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/dev.css"/>
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../js/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="../../js/linq.min.js"></script>
    <script type="text/javascript" src="../../js/data.util.js"></script>
    <script type="text/javascript" src="../../js/highcharts.js"></script>
    <script type="text/javascript" src="../../js/highcharts-more.js"></script>
    <script type="text/javascript" src="../../js/solid-gauge.js"></script>
    <script type="text/javascript" src="../../js/dev.ui.js"></script>
    <script type="text/javascript" src="../../js/drilldown.js"></script>
    <script type="text/javascript" src="../../js/highcharts-zh_CN.js"></script>
    <script type="text/javascript" src="../../js/guid.js"></script>
    <style type="text/css">
        .content {
            height: 100%;
            width: 100%;
            position: relative;
        }

        .content .row {
            width: 100%;
            height: 28px;
            margin-top: 5px;
        }

        .content .row .title {
            width: 70px;
            height: 28px;
            line-height: 28px;
            display: inline-block;
            float: left;
            text-align: right;
            padding-right: 5px;
        }

        .content .row .control {
            width: 210px;
            padding-left: 5px;
            display: inline-block;
            height: 28px;
            min-width: 60px;
        }

        .content .row .Button {
            width: 60px;
            height: 26px;
            margin-top: 7px;
            background-color: #16dbbb;
            /*border-radius: 5px;*/
            text-align: center;
            border: 1px solid #16dbbb;
            display: inline-block;
            margin-left: 5px;
        }

        .content .row .Button:hover {
            background-color: #5227de;
            border: 1px solid #5227de;
            cursor: pointer;
        }

          .content .row .Button:active {
                background-color: #210097;
                border: 1px solid #210097;
                cursor: pointer;
            }
    </style>
    <script type="text/javascript">
        var Dev = window.top.window.dev, parent, isNull = Dev.IsNull, orgId = Dev.cookie.user.orgid,
            baseUrl = Dev.GetSystemUrlByRelID("Service"),
            dialog = new Dev.Messager({ AutoShow: false, Type: "question", Timeout: 1000, ButtonVisible: false, AutoVisible: true, Effect: "normal" });
        var left = Dev.App.LeftPanel, bottom = Dev.App.BottomPanel, statWin;
        var taskCategory, selectRegionNode, box, statData, region = {};
        var nodeType = {
            province: '省',
            city: '市',
            county: '县',
            town: '乡'
        };

        function WidgetCommunication(s) {//部件通讯
            parent = s.parent;
            initComboTree();
            $(".Button").click(function () {
                $("#errorMsg").html("");
                var tag = $(this).attr("tag");
                if (tag === "statistics") statistics();
                else if (tag === "cancel") clearSearch();
            });
            left.SetIconCls("icon-statwork");
            left.Header.css("background-color", "#5AB4D6");
            left.bind("onResize", function () {
                var width = left.Target.outerWidth();
                $(".control").css("width", (width - 90) + "px");
            });
            bottom.bind("onResize", function () {
                resize();
            });
            bottom.bind("onToolClick", function (s, e) {
                var id = e.ToolItem.ID;
                if (id === "btnStatist") {
                    initStatisWin();
                }
                else if (id === "btnExport") {
                    Dev.exportExcelByUrl(baseUrl + "inspect/export/" + orgId, getQuerySql());
                }
            });
            parent.one("onClosing", function () {
                left.unbind("onResize");
                bottom.unbind("onResize");
                bottom.unbind("onToolClick");
                bottom.ClearTool();
                bottom.Content.empty();
                bottom.SetVisible(false);
                if (!isNull(statWin)) {
                    statWin.unbind("onResize");
                    statWin.Close();
                    statWin.Destroy();
                    statWin = null;
                }
                if (!isNull(box)) box = null;
            });
        }

        // 初始化统计图的 Win
        function initStatisWin() {
            selectRegionNode = null;
            //需要有数据才能统计
            if (isNull(statData)) return;
            //弹出窗体
            if (isNull(statWin)) {
                statWin = new Dev.Window({
                    ID: "workstat",
                    IconCls: 'icon-statgraph',
                    Title: "考勤统计图",
                    Parent: Dev.App.FillPanel.Target,
                    Maximizable: true,
                    Modal: true,
                    Draggable: true,
                    HAlign: 'center',
                    VAlign: 'center',
                    Resizable: false,
                    Content: initChartData(),
                    Height: 450,
                    Width: 600
                });
                statWin.bind("onResize", function (s, e) {
                    //改变统计图大小
                    var winheight = statWin.Height;
                    var winwidth = statWin.Width;
                    var chartdiv = $(".chartDiv", statWin.Target);
                    chartdiv.css({"width": (winwidth - 2) + "px", "height": (winheight - 32) + "px"});
                    var chart = $("#chart", chartdiv);
                    if (isNull(chart) || chart.length === 0) return;
                    if (!isNull($(chart[0]).highcharts())) $(chart[0]).highcharts().setSize(winwidth - 2, winheight - 32, false);
                });
            }
            else {
                statWin.SetContent(initChartData());
                statWin.Open();
            }
        }

        var drilldown = []; // 存储能下钻的数据
        // 初始化统计图
        var currentTime = new Date().getTime();

        function initChartData() {
            var chartdiv = $('<div class="chartDiv"></div>');
            var chart = $('<div id="chart"></div>').appendTo(chartdiv);
            var seriesdata = Enumerable.From(statData).GroupBy('s=>s.province').ToArray();
            var series = [{ name: "已完成", data: [], type: "column", color: '#9Dc8f1', drilldown: true, tag: "省" }, {
                name: "超时",
                data: [],
                type: 'column',
                color: "#FF0033",
                drilldown: true, tag: "省"
            }, {name: "未完成", data: [], type: 'column', color: "#f9ba85", drilldown: true, tag: "省"}];
            for (var i = 0; i < seriesdata.length; i++) {
                var check = Enumerable.From(seriesdata[i]).Sum('s=>s.check');
                var overtime = Enumerable.From(seriesdata[i]).Sum('s=>s.overtime');
                var notcheck = Enumerable.From(seriesdata[i]).Sum('s=>s.notcheck');
                var drilldownName = Guid.NewGuid().ToString("N");
                var name = seriesdata[i].source[0].province;
                series[0].data.push({name: name, y: check, drilldown: drilldownName});
                series[1].data.push({name: name, y: overtime, drilldown: drilldownName});
                series[2].data.push({name: name, y: notcheck, drilldown: drilldownName});
                getdrilldown(seriesdata[i].source, "province", drilldownName);
            }
            // 上钻按钮中的文字
            Highcharts.setOptions({
                lang: {
                    drillUpText: '返回 {series.tag}'
                }
            });
            chart.highcharts({
                chart: {
                    type: 'column',
                    events: {
                        drilldown: function (e) {
                            if (e.timeStamp - currentTime < 500) {
                                return;
                            }
                            currentTime = e.timeStamp;
                            var c = this;
                            var drilldownid = e.point.drilldown;
                            var newseries = Enumerable.From(drilldown).Where('s=>s.id=="' + drilldownid + '"').ToArray();
                            for (var i = 0; i < newseries.length; i++) c.addSingleSeriesAsDrilldown(e.point, newseries[i]);
                            c.applyDrilldown();
                            return false;
                        },
                        click: function (e) {
                            var hoverpoints = e.currentTarget.hoverPoints;
                            if (isNull(hoverpoints)) return;
                            var drilldownName = hoverpoints[0].name;
                            $(".highcharts-drilldown-axis-label:contains('" + drilldownName + "')", statWin.Target).click();
                        }
                    }
                },
                title: null,
                xAxis: {
                    type: 'category',
                    crosshair: true
                },
                yAxis: {
                    min: 0,
                    title: {
                        text: '次数'
                    }
                },
                tooltip: {
                    headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                    pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                    '<td style="padding:0"><b>{point.y:.0f} 次</b></td></tr>',
                    footerFormat: '</table>',
                    shared: true,
                    useHTML: true
                },
                plotOptions: {
                    column: {
                        borderWidth: 0,
                        cursor: 'pointer'
                    }

                },
                series: series,
                credits: {enabled: false},
                drilldown: {
                    series: []
                }
            });
            return chartdiv;
        }

        // 初始化下钻数据，存入drilldown
        function getdrilldown(data, levername, id) {
            var groupname;
            var sname;
            if (levername === "province") {
                groupname = "city";
                sname = "市";
            }
            else if (levername === "city") {
                groupname = "county";
                sname = "县";
            }
            else if (levername === "county") {
                groupname = "town";
                sname = "乡";
            }
            else if (levername === "town") {
                groupname = "username";
                sname = "任务接收人";
            }
            else if (levername === "username") {
                groupname = "type";
                sname = "任务类型";
            }
            var complete = { name: "已完成", id: id, data: [], type: "column", color: '#9Dc8f1', tag: sname };
            var unfinished = { name: "超时", id: id, data: [], type: 'column', color: "#FF0033", tag: sname };
            var history = { name: "未完成", id: id, data: [], type: 'column', color: "#f9ba85", tag: sname };
            if (!isNull(groupname)) {
                var seriesdata = Enumerable.From(data).GroupBy('s=>s.' + groupname.toLowerCase()).ToArray();
                for (var i = 0; i < seriesdata.length; i++) {
                    var keyName = seriesdata[i].source[0][groupname.toLowerCase()];
                    if (isNull(keyName)) { // 当下钻的下级的name为空的时候，跳过它
                        keyName = "其他";
                    }
                    var check = Enumerable.From(seriesdata[i]).Sum('s=>s.check');
                    var overtime = Enumerable.From(seriesdata[i]).Sum('s=>s.overtime');
                    var notcheck = Enumerable.From(seriesdata[i]).Sum('s=>s.notcheck');
                    var drilldownId = Guid.NewGuid().ToString("N");
                    complete.data.push({name: keyName, y: check, drilldown: drilldownId});
                    unfinished.data.push({name: keyName, y: overtime, drilldown: drilldownId});
                    history.data.push({name: keyName, y: notcheck, drilldown: drilldownId});
                    getdrilldown(seriesdata[i].source, groupname, drilldownId);
                }
                if (complete.tag && unfinished.tag && history.tag) {
                    drilldown.push(complete, unfinished, history);
                }
            }
            else {
                if (data.length <= 1) return; //当这个人只有一种任务类型，不再下钻
                drilldown.push(complete, unfinished, history);
                for (i = 0; i < data.length; i++) {
                    var name = data[i].type;
                    complete.data.push({name: name, y: data[i].check});
                    unfinished.data.push({name: name, y: data[i].overtime});
                    history.data.push({name: name, y: data[i].notcheck});
                }
            }
        }

        // 统计
        function statistics() {
            region = {};
            getCondition();
            if (isNull($("#treecomboDiv").combotree('getValue'))) {
                return $("#errorMsg").text("请选择行政区！");
            }
            $.ajax({
                type: "post",
                url: baseUrl + "inspect/calculation/" + orgId,
                data: getQuerySql(),
                contentType: "application/json",
                success: function (response) {
                    if (isNull(response) || response.statusCode != 200) {
                        return dialog.Alert("网络超时，请稍后再试！", "error");
                    }
                    statData = response.data;
                    if (isNull(statData) || statData.length === 0) {
                        clearBottomPanel();
                        return $("#errorMsg").html("暂时没有统计数据!");
                    }
                    bindResultData(statData);
                }
            });
        }

        function bindResultData(data) {
            if (!bottom.Visible) {
                bottom.SetVisible(true);
                bottom.Header.css({"background-color": "#0099cc", "color": "#fcfcfc", "font-weight": "bold"});
                bottom.SetIconCls("icon-statlist");
                bottom.SetTitle("作业统计列表");
                bottom.ClearTool();
                bottom.AddTool([{ID: 'btnExport', IconCls: 'icon-export-white', TipTitle: '导出'}, {
                    ID: 'btnStatist',
                    IconCls: 'icon-statgraph',
                    TipTitle: '统计图'
                }]);
            }
            bottom.Content.empty();
            var div = $('<div style="width:100%;height:100%;"></div>');
            bottom.Add(div);
            //显示数据
            box = new Dev.Box({HasBorder: false});
            box.Target.css({
                width: bottom.Target.width() + "px",
                height: (bottom._Height - 28) + "px"
            });
            box.Target.appendTo(div);
            var table = $('<table class="statInfo" cellspacing="0" cellpadding="0"><tr><th>省</th><th>市</th><th>县</th><th>乡</th><th>任务接收人</th><th>任务类型</th><th>已完成次数</th><th>已超时次数</th><th>未完成次数</th></tr></table>');
            //行数有多少条
            var provincedata = Enumerable.From(data).GroupBy('s=>s.province').ToArray();
            var isprorow = false, iscityrow = false, iscountyrow = false, istownrow = false, isReceiver = false;
            for (var i = 0; i < provincedata.length; i++) {
                isprorow = true;
                var provincerowcount = provincedata[i].source.length;
                var provincename = provincedata[i].source[0].province;
                var citys = Enumerable.From(provincedata[i].source).GroupBy('s=>s.city').ToArray();
                for (var j = 0; j < citys.length; j++) {
                    iscityrow = true;
                    var cityrowcount = citys[j].source.length;
                    var cityname = citys[j].source[0].city;
                    var county = Enumerable.From(citys[j].source).GroupBy('s=>s.county').ToArray();
                    for (var k = 0; k < county.length; k++) {
                        iscountyrow = true;
                        var countyrowcount = county[k].source.length;
                        var countyname = county[k].source[0].county;
                        var town = Enumerable.From(county[k].source).GroupBy('s=>s.town').ToArray();
                        for (var l = 0; l < town.length; l++) {
                            istownrow = true;
                            var townrowcount = town[l].source.length;
                            var townname = town[l].source[0].town;
                            var receiver = Enumerable.From(town[l].source).GroupBy('s=>s.username').ToArray();
                            for (var r = 0; r < receiver.length; r++) {
                                isReceiver = true;
                                var receiverCount = receiver[r].source.length;
                                var receiverName = receiver[r].source[0].username;
                                var type = Enumerable.From(receiver[r].source).GroupBy('s=>s.type').ToArray();
                                for (var t = 0; t < type.length; t++) {
                                    var typeCount = type[t].source.length;
                                    for (var m = 0; m < typeCount; m++) {
                                        var typeName = type[t].source[m].type;
                                        var tr = $('<tr></tr>').appendTo(table);
                                        if (isprorow) {
                                            tr.append($('<td rowspan="' + provincerowcount + '">' + (isNull(provincename) ? "-" : provincename) + '</td>'));
                                            isprorow = false;
                                        }
                                        if (iscityrow) {
                                            tr.append($('<td rowspan="' + cityrowcount + '">' + (isNull(cityname) ? "-" : cityname) + '</td>'));
                                            iscityrow = false;
                                        }
                                        if (iscountyrow) {
                                            tr.append($('<td rowspan="' + countyrowcount + '">' + (isNull(countyname) ? "-" : countyname) + '</td>'));
                                            iscountyrow = false;
                                        }
                                        if (istownrow) {
                                            tr.append($('<td rowspan="' + townrowcount + '">' + (isNull(townname) ? "-" : townname) + '</td>'));
                                            istownrow = false;
                                        }
                                        if (isReceiver) {
                                            tr.append($('<td rowspan="' + receiverCount + '">' + (isNull(receiverName) ? "-" : receiverName) + '</td>'));
                                            isReceiver = false;
                                        }
                                        tr.append($('<td>' + (isNull(typeName) ? "-" : typeName) + '</td>'));
                                        tr.append($('<td>' + (isNull(type[t].source[m].check) ? "0" : type[t].source[m].check) + '</td>'));
                                        tr.append($('<td>' + (isNull(type[t].source[m].overtime) ? "0" : type[t].source[m].overtime) + '</td>'));
                                        tr.append($('<td>' + (isNull(type[t].source[m].notcheck) ? "0" : type[t].source[m].notcheck) + '</td>'));
                                    }
                                }
                            }
                        }
                    }
                }
            }
            box.SetContent(table);
        }

        // 重置搜索栏
        function clearSearch() {
            $("#treecomboDiv").combotree('reset');
            $("#taskcategory").prop("$this").SetText("");
            clearBottomPanel();
        }

        // 清空bottom
        function clearBottomPanel() {
            bottom.ClearTool();
            bottom.Content.empty();
            bottom.SetVisible(false);
        }

        //bottomPanel 的Size发生改变
        function resize() {
            if (!isNull(box)) box.SetSize({Width: bottom.Target.width(), Height: (bottom.Height - 28)});
        }

        // 统计的时候绑定行政区信息
        function bindRegionMessage(node) {
            if (node == null || isNull(node.remark)) return;
            var remark = node.remark;
            if (remark === nodeType.province) {
                region.province = node.text;
            }
            else if (remark === nodeType.city) {
                region.city = node.text;
            }
            else if (remark === nodeType.county) {
                region.county = node.text;
            }
            else if (remark === nodeType.town) {
                region.town = node.text;
            }
            //查找父级节点，没有则退出
            var parent = getParentNode(node);
            if (parent != null) {
                bindRegionMessage(parent)
            }
        }

        // 查找combotree的父级节点
        function getParentNode(node) {
            var tree = $('#treecomboDiv').combotree('tree');
            return tree.tree('getParent', node.target);
        }

        // 绑定查询条件查询
        function getCondition() {
            selectRegionNode = $("#treecomboDiv").combotree('tree').tree('getSelected');
            bindRegionMessage(selectRegionNode);
            taskCategory = $("#taskcategory").prop("$this").GetText();
        }

        // 生成查询条件
        function getQuerySql() {
            var condition = "1=1";
            if (!isNull(region.province)) {
                condition += " AND a.\"PROVINCE\"='" + region.province + "'"
            }
            if (!isNull(region.city)) {
                condition += " AND a.\"CITY\"='" + region.city + "'"
            }
            if (!isNull(region.county)) {
                condition += " AND a.\"COUNTY\"='" + region.county + "'"
            }
            if (!isNull(region.town)) {
                condition += " AND a.\"TOWN\"='" + region.town + "'"
            }
            if (!isNull(taskCategory) && taskCategory !== "-不限-") {
                condition += " AND a.\"TYPE\"='" + taskCategory + "'";
            }
            return condition;
        }

        // 初始化ComboTree
        function initComboTree() {
            $("#treecomboDiv").combotree({
                method: "post",
                url: Dev.GetSystemUrlByRelID("Service") + 'dictionary/asyncdata/county',
                panelWidth: '210',
                onClick: function (node) {
                },
                onBeforeExpand: function (node) {
                    $(this).tree('options').url = Dev.GetSystemUrlByRelID("Service") + 'dictionary/asyncdata/county?id=' + node.id;
                },
                loadFilter: function (data) {
                    data = data.data;
                    for (var i = 0; i < data.length; i++) {
                        if ('data' in data[i]) {
                            data[i].text = data[i].data;
                        }
                        if (data[i].remark === "县") {
                            data[i].state = "close";
                        }
                    }
                    return data;
                }
            });
        }


    </script>

</head>
<body style="height: 100%; width: 100%;">
<div class="content">
    <div class="row">
        <div class="title">选择地区</div>
        <div class="control">
            <div id="treecomboDiv" style="height: 28px; width: 210px;"></div>
        </div>
        <div style="position: absolute; height: 10px; width: 10px; top: 8px; right: 28px; color: red; line-height: 10px;">
            *
        </div>
    </div>
    <div class="row">
        <div class="title">任务类别</div>
        <div class="control">
            <div id="taskcategory" class="dev-combobox" style="z-index: 4; width: 100%;"
                 opt='{"Height":28,"TipInfo":"请选择","Data":["-不限-","核查任务","核实任务"],"Padding":"0px 5px","TextAlign":"left"}'></div>
        </div>
    </div>
    <div class="row" style="text-align: right">
        <div id="errorMsg"
             style="width: 120px; height: 28px; line-height: 28px; display: inline-block; float: left; color: red; margin-left: 18px; text-align: left;"></div>
        <div class="Button" tag="statistics" style="margin-left: 10px;">
            <div class="icon-statgraph"
                 style="height: 16px; width: 16px; margin-top: 4px; margin-left: 5px; display: inline-block; float: left;"></div>
            <span style="line-height: 28px; color: #fcfcfc;">统&nbsp;计</span>
        </div>
        <div class="Button" tag="cancel" style="margin-right: 10px;">
            <div class="machine-reset"
                 style="height: 16px; width: 16px; margin-top: 4px; margin-left: 5px; display: inline-block; float: left;"></div>
            <span style="line-height: 28px; color: #fcfcfc;">重&nbsp;置</span>
        </div>
    </div>
</div>
</body>
</html>
