<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>休耕轮作详细信息</title>
    <link rel="stylesheet" href="../../theme/default/easyui.css" />
    <link rel="stylesheet" type="text/css" href="../../theme/icon.css" />
    <link rel="stylesheet" type="text/css" href="../../css/app.css" />
    <link rel="stylesheet" type="text/css" href="../../css/main.css" />
    <link rel="stylesheet" type="text/css" href="../../css/icon.css" />
    <link type="text/css" href="../../css/dev.css" rel="stylesheet" />
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../js/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="../../js/linq.min.js"></script>
    <script type="text/javascript" src="../../js/data.util.js"></script>
    <!--    <script type="text/javascript" src="../../js/dev.ui.js"></script>
    <script type="text/javascript" src="../../js/guid.js"></script>-->
    <script type="text/javascript" src="../../js/jquery.dev.control.js"></script>
    <style type="text/css">
        .rotations {
            width: 100%;
            height: 100%;
        }
    </style>
    <script type="text/javascript">
        var Dev = window.top.window.dev;
        var parent, id, showdata;
        var tabControl, linkdata;
        var fieldsConfig = Dev.App.Config.Extend.DetailFields.FieldInfo;
        var basicfields;
        var inspectfields;
        var inspectdata;
        var feedbackdata;
        var feedbackdiv;
        var isadmin;
        function WidgetCommunication(s) {//部件通讯
            parent = s.parent;
            id = s.param.rotationid;
            showdata = s.param.showdata;
            isadmin = (Dev.cookie.user.posts[0].postowner == 1 && Dev.cookie.user.posts[0].mainpost == 1);
            //加载基础信息
            if (Dev.IsNull(fieldsConfig)) return;
            if (Dev.IsNull(fieldsConfig.length)) basicfields = [Dev.ObjClone(fieldsConfig)];
            else basicfields = fieldsConfig.clone();
            basicfields = Enumerable.From(basicfields).Where('s=>s.BelongData.indexOf("V_ROTATIONFARMER")>=0').ToArray();
            inspectfields = Enumerable.From(fieldsConfig).Where('s=>s.BelongData.indexOf("AGRI_INSPECT")>=0').ToArray();
            //避免修改xml 造成冲突
            var category_fields = {
                ID: '43',
                Name: 'CATEGORY',
                ByName: '任务类别',
                ValueType: 'string',
                IsDetailVisible: 'true',
                IsPopupVisible: 'true',
                BelongData: 'AGRI_INSPECT',
                Order: '43'
            }
            inspectfields.push(category_fields);
            inspectfields = Enumerable.From(inspectfields).OrderBy("s=>s.Order").ToArray();
            //查询所有关联数据
            getlinkdata();
            getinspectdata();
            //显示详细信息情况
            initTab();
            parent.one("onClosing", function () {
                if (!Dev.IsNull(tabControl)) {
                    tabControl.unbind("onSelected");
                    tabControl = null;
                }
                if (!Dev.IsNull(massifDataGrid)) {
                    massifDataGrid.Target.unbind("onClickRow");
                    massifDataGrid = null;
                }
                if (!Dev.IsNull(inspectDataGrid)) {
                    inspectDataGrid.Target.unbind("onClickRow");
                    inspectDataGrid = null;
                }

            });
        }
        function getlinkdata() {
            $.ajax({
                url: Dev.GetSystemUrlByRelID("Service") + "rotationfallow/querybyid/" + id,
                type: "GET",
                contentType: 'application/json',
                dataType: 'json',
                async: false,
                success: function (result) {//0 本身、1 地块关联表、2 规则表、3 文件表
                    linkdata = result.data;
                }
            });
        }
        function initTab() {
            $(".rotations").empty();
            var items = [{ ID: "rotationTab", Name: "基本信息", Content: $("#rotationDetail"), Width: $(window).width() - 2, Height: $(window).height() - 26 },
                    { ID: "rotationTab", Name: "关联地块信息", Content: $("#massifLink"), Width: $(window).width() - 2, Height: $(window).height() - 26 }];
            if (!Dev.IsNull(inspectdata) && inspectdata.length > 0) items.push({ ID: "rotationTab", Name: "核实核查信息", Content: $("#inspectInfo"), Width: $(window).width() - 2, Height: $(window).height() - 26 });
            tabControl = new Dev.Tab({
                ID: "rotationtab",
                Width: $(window).width(),
                Height: $(window).height(),
                TabNormalCls: "liveNormalTabCls",
                TabSelectedCls: "liveSelectedTabCls",
                Items: items
            });
            tabControl.bind("onSelected", function () {
                if (!Dev.IsNull(massifDataGrid)) massifDataGrid.Resize($(window).width() - 2, 180);
                if (!Dev.IsNull(inspectDataGrid)) inspectDataGrid.Resize($(window).width() - 2, 150);
            });
            $(".rotations").append(tabControl.Target);
            tabControl.Layout();
            loadBasicInfo();
            loadMassifData();
            //加载核查核实信息
            initinspectgrid();

        }
        var piclist;
        function loadBasicInfo() {
            if (Dev.IsNull(showdata)) return;
            var row;
            var isaddress = false;
            var height = 0;
            for (var i = 0; i < basicfields.length; i++) {
                if (basicfields[i].Name.toLowerCase() == "address") {
                    isaddress = true;
                    row = $('<div style="height: 34px; width: 100%; border-bottom: 1px solid #ddd;"></div>').appendTo($("#rotationDetail"));
                    var title = $('<div style="width:80px; text-align: right; padding-right: 5px; float: left; display: inline-block;border-right:1px solid #ddd;line-height:34px;">' + basicfields[i].ByName + '</div>').appendTo(row);
                    var width = $(window).width() - 93;
                    var text = "";
                    if (!Dev.IsNull(showdata.province) && showdata.province != "undefined") text += showdata.province + " ";
                    if (!Dev.IsNull(showdata.city) && showdata.city != "undefined") text += showdata.city + " ";
                    if (!Dev.IsNull(showdata.county) && showdata.county != "undefined") text += showdata.county + " ";
                    if (!Dev.IsNull(showdata.town) && showdata.town != "undefined") text += showdata.town + " ";
                    if (!Dev.IsNull(showdata.village) && showdata.village != "undefined") text += showdata.village + " ";
                    var value = $('<div style="width:' + width + 'px;height:34px; text-align: left; padding-left: 5px; display: inline-block;line-height:34px;">' + (Dev.IsNullAll(text) ? "" : text) + '</div>').appendTo(row);
                    height += 34;
                }
                else {
                    if ((isaddress && (i % 2 == 1)) || (!isaddress && (i % 2 == 0))) { row = $('<div style="height: 34px; width: 100%; border-bottom: 1px solid #ddd;"></div>').appendTo($("#rotationDetail")); height += 34; }
                    var cell = $('<div style="height: 34px; width: 50%; display: inline-block; float: left; position: relative;"></div>').appendTo(row);
                    var title = $('<div style="width:80px; text-align: right; padding-right: 5px; float: left; display: inline-block;border-right:1px solid #ddd;line-height:34px;">' + basicfields[i].ByName + '</div>').appendTo(cell);
                    var width = ($(window).width() * 0.5) - 93;
                    var text = showdata[(basicfields[i].Name).toLowerCase()];
                    if (basicfields[i].ValueType == "datetime" && !Dev.IsNull(text)) text = Dev.GetDateString(text, true);
                    //如果不是岗位管理员则需要简易加密
                    if (!isadmin) {
                        if (basicfields[i].Name.toLowerCase() == "name") text = Dev.simpleencryp(text, 1, 0);
                        if (basicfields[i].Name.toLowerCase() == "cardid") text = Dev.simpleencryp(text, 3, 4);
                        if (basicfields[i].Name.toLowerCase() == "mobilephone") text = Dev.simpleencryp(text, 3, 3);
                        if (basicfields[i].Name.toLowerCase() == "bankcard") text = Dev.simpleencryp(text, 4, 3);
                    };
                    var value = $('<div style="width:' + width + 'px;height:34px; text-align: left; padding-left: 5px; display: inline-block;line-height:34px;">' + (Dev.IsNullAll(text) ? "" : text) + '</div>').appendTo(cell);
                }
            }
            var picheight = $("#rotationDetail").height() - height;
            var picviewDiv = $('<div style="width:100%;height:' + picheight + 'px;position:relative;"></div>').appendTo($("#rotationDetail"));
            $("<div class='pageIndex' name='pageIndex' style='width: 40px;height: 40px;position: absolute;left: 0;right: 0;margin: 10px auto;'></div>").appendTo(picviewDiv);
            var picview = $('<div title="图片预览" style="position:absolute;width:80%;left:10%;height:80%;top:10%;background-repeat: no-repeat; background-position: center;"></div>').appendTo(picviewDiv);
            var leftbtn = $('<div style="height:24px;width:24px;position:absolute;left:10px;top:' + ((picheight - 24) / 2) + 'px;background-image:url(' + Dev.App.Root + 'image/agri/leftbtn.png);background-repeat: no-repeat;background-position: center;display:none;"></div>').appendTo(picviewDiv);
            var rightbtn = $('<div style="height:24px;width:24px;position:absolute;right:10px;top:' + ((picheight - 24) / 2) + 'px;background-image:url(' + Dev.App.Root + 'image/agri/rightbtn.png);background-repeat: no-repeat;background-position: center;display:none;"></div>').appendTo(picviewDiv);
            piclist = linkdata[3];
            if (!Dev.IsNull(piclist) && piclist.length > 1) {
                picviewDiv.mouseover(function () {
                    leftbtn.css("display", "block");
                    rightbtn.css("display", "block");
                }).mouseleave(function () {
                    leftbtn.css("display", "none");
                    rightbtn.css("display", "none");
                });
                leftbtn.click(function () {
                    var currfile = picview.prop("bg_file");
                    if (Dev.IsNull(currfile)) return;
                    var index = Enumerable.From(piclist).IndexOf(currfile);
                    if (index <= 0) return;
                    var showindex = index - 1;
                    picview.css({ "background-image": "url(" + piclist[showindex].path + ")" });
                    picview.prop("bg_file", piclist[showindex]);
                    $(".pageIndex[name='pageIndex']").text(showindex + 1 + "/" + piclist.length);
                });
                rightbtn.click(function () {
                    var currfile = picview.prop("bg_file");
                    if (Dev.IsNull(currfile)) return;
                    var index = Enumerable.From(piclist).IndexOf(currfile);
                    if (index < 0 || index >= piclist.length - 1) return;
                    var showindex = index + 1;
                    picview.css({ "background-image": "url(" + piclist[showindex].path + ")" });
                    picview.prop("bg_file", piclist[showindex]);
                    $(".pageIndex[name='pageIndex']").text(showindex + 1 + "/" + piclist.length);
                });
            }
            //判断是否有图片
            if (Dev.IsNull(linkdata[3]) || linkdata[3].length == 0) {
                $(".pageIndex[name='pageIndex']").text('');
                picview.css("background-image", 'url(' + Dev.App.Root + 'image/agri/nopic.png)');
                return;
            }
            $(".pageIndex[name='pageIndex']").text(1 + "/" + piclist.length);
            picview.css("background-image", 'url(' + piclist[0].path + ')');
            picview.prop("bg_file", piclist[0]);
            var imgs = [];
            for (var i = 0; i < piclist.length; i++) imgs.push(piclist[i].path);
            picview.prop("imgsrcs", imgs);
            Dev.mousewheel(picview, function () {
                leftbtn.click();
            }, function () {
                rightbtn.click();
            });
            picview.click(function () {
                var imgsource = $(this).prop("imgsrcs");
                Dev.PreViewPics(imgsource);
            });
        }
        //初始化地块关联数据
        var massifDataGrid;
        function loadMassifData() {
            //初始化地块
            $("#massifLink").empty();
            var gridDiv = $('<div style="height:180px;width:100%;border-bottom:1px solid #ddd;"></div>').appendTo($("#massifLink"));
            var columns = [
                    { field: "massifid", width: 75, align: 'center', title: '地块编号', sortable: false },
                    { field: "type", width: 55, align: 'center', title: '轮耕类型', sortable: false },
                    { field: "planting", width: 60, align: 'center', title: '种植方式', sortable: false, formatter: function (value, row, index) { return Dev.IsNullAll(value) ? "—" : value; } },
                    { field: "massifarea", width: 60, align: 'center', title: '地块面积(亩)', sortable: false },
                    { field: "subsidystandard", width: 60, align: 'center', title: '补贴标准', sortable: false },
                    { field: "subsidy", width: 60, align: 'center', title: '补贴金额(元)', sortable: false }];

            massifDataGrid = new UCDataGrid(Dev, { ID: "massiflinkGrid", pagequery: false, IsPage: false, RowNumbers: false });
            gridDiv.append(massifDataGrid.Target);
            massifDataGrid.Layout(columns);
            massifDataGrid.Target.bind("onClickRow", function (s, e) { initMassifRow(e.Row); });
            massifDataGrid.Load(linkdata[1]);
            initMassifRow(linkdata[1][0]);
            massifDataGrid.DataGrid.datagrid("selectRow", 0);
        }
        function initMassifRow(rowdata) {
            $(".massifdiv", $("#massifLink")).remove();
            $(".plandiv", $("#massifLink")).remove();
            if (Dev.IsNull(rowdata)) return;
            var massif_curr;
            //查询当前地块数据
            $.ajax({
                url: Dev.GetSystemUrlByRelID("Service") + "massif/query/" + rowdata.massifid + "?" + new Date().getTime(),
                type: "GET",
                contentType: 'application/json',
                dataType: 'json',
                async: false,
                success: function (result) {//0 本身、1 地块关联表、2 规则表、3 文件表
                    if (!Dev.IsNull(result.data)) massif_curr = result.data;
                }
            });
            if (Dev.IsNull(massif_curr)) return;
            var massifdiv = $('<div class="massifdiv" style="width:100%;position:relative;"></div>').appendTo($("#massifLink"));
            var divtitle = $('<div style="width:100%;height:30px;background-color:#ddd;line-height:30px;border-bottom:1px solid #ddd;"><span style="margin-left:15px;">地块基本信息</span></div>').appendTo(massifdiv);
            var width = ($(window).width() * 0.5) - 94;
            var massifrow = $('<div style="height: 34px; width: 100%; border-bottom: 1px solid #ddd;"></div>').appendTo(massifdiv);
            var massifcell0 = $('<div style="height: 34px; width: 50%; display: inline-block; float: left; position: relative;"></div>').appendTo(massifrow);
            var title0 = $('<div style="width:80px; text-align: right; padding-right: 5px; float: left; display: inline-block;border-right:1px solid #ddd;line-height:34px;">地块编号</div>').appendTo(massifcell0);
            var value0 = $('<div style="width:' + width + 'px;height:34px; text-align: left; padding-left: 5px; display: inline-block;line-height:34px;">' + massif_curr.massifid + '</div>').appendTo(massifcell0);
            var massifcell1 = $('<div style="height: 34px; width: 50%; display: inline-block; float: left; position: relative;"></div>').appendTo(massifrow);
            var title1 = $('<div style="width:79px; text-align: right; padding-right: 5px; float: left; display: inline-block;border-right:1px solid #ddd;line-height:34px;border-left:1px solid #ddd;">地类名称</div>').appendTo(massifcell1);
            var value1 = $('<div style="width:' + width + 'px;height:34px; text-align: left; padding-left: 5px; display: inline-block;line-height:34px;">' + massif_curr.classname + '</div>').appendTo(massifcell1);
            var massifrow1 = $('<div style="height: 34px; width: 100%; border-bottom: 1px solid #ddd;"></div>').appendTo(massifdiv);
            var massifcell4 = $('<div style="height: 34px; width: 50%; display: inline-block; float: left; position: relative;"></div>').appendTo(massifrow1);
            var title4 = $('<div style="width:80px; text-align: right; padding-right: 5px; float: left; display: inline-block;border-right:1px solid #ddd;line-height:34px;">权属性质</div>').appendTo(massifcell4);
            var value4 = $('<div style="width:' + width + 'px;height:34px; text-align: left; padding-left: 5px; display: inline-block;line-height:34px;">' + massif_curr.ownership + '</div>').appendTo(massifcell4);
            var massifrow4 = $('<div style="height: 34px; width: 100%; border-bottom: 1px solid #ddd;"></div>').appendTo(massifdiv);
            var massifcell5 = $('<div style="height: 34px; width: 100%; display: inline-block; float: left; position: relative;"></div>').appendTo(massifrow4);
            var title5 = $('<div style="width:79px; text-align: right; padding-right: 5px; float: left; display: inline-block;border-right:1px solid #ddd;line-height:34px;border-left:1px solid #ddd;">权属单位</div>').appendTo(massifcell5);
            var value5 = $('<div style="width:' + ($(window).width() - 94) + 'px;height:34px; text-align: left; padding-left: 5px; display: inline-block;line-height:34px;">' + massif_curr.ownershipname + '</div>').appendTo(massifcell5);
            var massifrow2 = $('<div style="height: 34px; width: 100%; border-bottom: 1px solid #ddd;"></div>').appendTo(massifdiv);
            var massifcell2 = $('<div style="height: 34px; width: 50%; display: inline-block; float: left; position: relative;"></div>').appendTo(massifrow2);
            var title2 = $('<div style="width:80px; text-align: right; padding-right: 5px; float: left; display: inline-block;border-right:1px solid #ddd;line-height:34px;">耕地类型</div>').appendTo(massifcell2);
            var value2 = $('<div style="width:' + width + 'px;height:34px; text-align: left; padding-left: 5px; display: inline-block;line-height:34px;">' + massif_curr.landtype + '</div>').appendTo(massifcell2);
            var massifcell3 = $('<div style="height: 34px; width: 50%; display: inline-block; float: left; position: relative;"></div>').appendTo(massifrow2);
            var title3 = $('<div style="width:79px; text-align: right; padding-right: 5px; float: left; display: inline-block;border-right:1px solid #ddd;line-height:34px;border-left:1px solid #ddd;">农田类型</div>').appendTo(massifcell3);
            var value3 = $('<div style="width:' + width + 'px;height:34px; text-align: left; padding-left: 5px; display: inline-block;line-height:34px;">' + massif_curr.farmlandtype + '</div>').appendTo(massifcell3);
            //方案类型
            var currrules = Enumerable.From(linkdata[2]).Where('s=>s.massifid=="' + rowdata.massifid + '"').ToArray();
            if (Dev.IsNull(currrules) || currrules.length == 0 || rowdata.type === "休耕") return;

            var plandiv = $('<div class="plandiv" style="width:100%;position:relative;overflow-y:auto"></div>').appendTo($("#massifLink"));
            var plantitle = $('<div style="width:100%;height:30px;background-color:#ddd;line-height:30px;border-bottom:1px solid #ddd;"><span style="margin-left:15px;">方案信息</span></div>').appendTo(plandiv);
            var currrules = Enumerable.From(linkdata[2]).Where('s=>s.massifid=="' + rowdata.massifid + '"').ToArray();
            //获取type 
            if (rowdata.planting == "一年一熟") $('<div style="width:100%;height:30px;border-bottom:1px solid #ddd;"><div style="width:' + ($(window).width() * 0.5 - 1) + 'px;height:30px;line-height:30px;text-align:center;display:inline-block;float:left;border-right:1px solid #ddd;">年份</div><div style="width:' + ($(window).width() * 0.5) + 'px;height:30px;line-height:30px;text-align:center;display:inline-block;">种植作物</div></div>').appendTo(plandiv);
            if (rowdata.planting == "一年多熟") $('<div style="width:100%;height:30px;border-bottom:1px solid #ddd;"><div style="width:' + ($(window).width() * 0.33 - 1) + 'px;height:30px;line-height:30px;text-align:center;display:inline-block;float:left;border-right:1px solid #ddd;">年份</div><div style="width:' + ($(window).width() * 0.33 - 1) + 'px;height:30px;line-height:30px;text-align:center;display:inline-block;float:left;border-right:1px solid #ddd;">月份</div><div style="width:' + ($(window).width() * 0.34) + 'px;height:30px;line-height:30px;text-align:center;display:inline-block;">种植作物</div></div>').appendTo(plandiv);
            var rulesdiv = $('<div style="width:100%;height:108px;"></div>').appendTo(plandiv);
            var boxw = new Dev.Box({
                Parent: rulesdiv[0],
                Width: $(window).width(),
                Height: 108,
                HasBorder: false
            });
            boxw.Layout();
            var height = currrules.length * 30;
            var rowsdiv = $('<div style="width:' + $(window).width() + 'px;height:' + height + 'px;"></div>');
            for (var i = 0; i < currrules.length; i++) {
                if (rowdata.planting == "一年一熟")
                    $('<div style="width:100%;height:30px;border-bottom:1px solid #ddd;"><div style="width:' + ($(window).width() * 0.5 - 1) + 'px;height:30px;line-height:30px;text-align:center;display:inline-block;float:left;border-right:1px solid #ddd;">' + currrules[i].year + '</div><div style="width:' + ($(window).width() * 0.5) + 'px;height:30px;line-height:30px;text-align:center;display:inline-block;">' + currrules[i].type + '</div></div>').appendTo(rowsdiv);
                if (rowdata.planting == "一年多熟")
                    $('<div style="width:100%;height:30px;border-bottom:1px solid #ddd;"><div style="width:' + ($(window).width() * 0.33 - 1) + 'px;height:30px;line-height:30px;text-align:center;display:inline-block;float:left;border-right:1px solid #ddd;">' + currrules[i].year + '</div><div style="width:' + ($(window).width() * 0.33 - 1) + 'px;height:30px;line-height:30px;text-align:center;display:inline-block;float:left;border-right:1px solid #ddd;">' + currrules[i].mouth + '</div><div style="width:' + ($(window).width() * 0.34) + 'px;height:30px;line-height:30px;text-align:center;display:inline-block;">' + currrules[i].type + '</div></div>').appendTo(rowsdiv);
            }
            boxw.SetContent(rowsdiv);
        }
        //初始化核实核查数据
        var inspectDataGrid;
        function initinspectgrid() {
            $("#inspectInfo").empty();
            var gridDiv = $('<div style="height:150px;width:100%;border-bottom:1px solid #ddd;"></div>').appendTo($("#inspectInfo"));
            var columns = [
                     { field: "massifid", width: 75, align: 'center', title: '地块编号', sortable: false },
                     { field: "type", width: 55, align: 'center', title: '任务类型', sortable: false },
                    // { field: "content", width: 140, align: 'center', title: '任务内容', sortable: false },
                    { field: "receiveder", width: 60, align: 'center', title: '任务接受人', sortable: false },
                     {
                         field: "state", width: 60, align: 'center', title: '任务状态', sortable: false, formatter: function (value, row, index) {
                             if (value == "0") return "待核查";
                             if (value == "1") return "待审批";
                             if (value == "2") return "审批已通过";
                             if (value == "3") return "审批不通过"
                         }
                     },
                     { field: "category", width: 60, align: 'center', title: '任务类别', sortable: false ,hidden:true}];
            inspectDataGrid = new UCDataGrid(Dev, { ID: "massiflinkGrid", pagequery: false, IsPage: false, RowNumbers: false });
            gridDiv.append(inspectDataGrid.Target);
            inspectDataGrid.Layout(columns);
            inspectDataGrid.Target.bind("onClickRow", function (s, e) {
                loadinspectdata(e.Row);
                getfeedbackdata(e.Row);

            });
            inspectDataGrid.Load(inspectdata);
            if (inspectdata.length > 0) {
                inspectDataGrid.DataGrid.datagrid("selectRow", 0);
                loadinspectdata(inspectdata[0]);
                getfeedbackdata(inspectdata[0]);

            }
            //var condition = "\"ROTATIONFALLOWID\"='" + id + "'";
            //var inspectdata;
            //$.ajax({
            //    url: Dev.GetSystemUrlByRelID("Service") + "inspect/getbyfilter/" + condition,
            //    type: "GET",
            //    contentType: 'application/json',
            //    dataType: 'json',
            //    async: false,
            //    success: function (result) {
            //        if (Dev.IsNull(result.data)) result.data = [];
            //        inspectdata = result.data;
            //        inspectDataGrid.Load(result.data);
            //        inspectDataGrid.DataGrid.datagrid("selectRow", 0);
            //        loadinspectdata(result.data[0]);
            //    }
            //});
        }
        function loadinspectdata(inspectrow) {
            $(".inspectinfo", $("#inspectInfo")).remove();
            if (Dev.IsNull(inspectrow)) return;
            var info = $('<div class="inspectinfo" style="width:100%;height:130px;"></div>').appendTo($("#inspectInfo"));
            var iscontent = false;
            var row;
            for (var i = 0; i < inspectfields.length; i++) {
                if (inspectfields[i].Name.toLowerCase() == "content") {
                    row = $('<div style="height: 60px; width: 100%; border-bottom: 1px solid #ddd;"></div>').appendTo(info);
                    var title = $('<div style="width:80px; text-align: right; padding-right: 5px; float: left; display: inline-block;border-right:1px solid #ddd;line-height:60px;">' + inspectfields[i].ByName + '</div>').appendTo(row);
                    var width = $(window).width() - 93;
                    $('<div style="width:' + width + 'px;height:60px; text-align: left; padding-left: 5px; display: inline-block;line-height:20px;word-wrap:break-word">' + inspectrow[inspectfields[i].Name.toLowerCase()] + '</div>').appendTo(row);
                    iscontent = true;
                } else {
                    if (inspectfields[i].Name.toLowerCase() != "content" && inspectfields[i].Name.toLowerCase() != "state" && inspectfields[i].Name.toLowerCase() != "receiveder") {
                        iscontent = false;
                        if ((iscontent && (i % 2 == 1)) || (!iscontent && (i % 2 == 0))) {
                            row = $('<div style="height: 34px; width: 100%; border-bottom: 1px solid #ddd;"></div>').appendTo(info);
                            isrow = true;
                        }
                        var cell = $('<div style="height: 34px; width:50%; display: inline-block; float: left; position: relative;"></div>').appendTo(row);
                        var title = $('<div style="width:80px; text-align: right; padding-right: 5px; float: left; display: inline-block;border-right:1px solid #ddd;line-height:34px;">' + inspectfields[i].ByName + '</div>').appendTo(cell);
                        var width = ($(window).width() * 0.5) - 94;
                        var text = inspectrow[(inspectfields[i].Name).toLowerCase()];
                        if (inspectfields[i].ValueType == "datetime" && !Dev.IsNull(text)) text = Dev.GetDateString(text);
                        if (Dev.IsNullAll(text)) text = "";
                        var value = $('<div style="width:' + width + 'px;height:34px; text-align: left; padding-left: 5px; display: inline-block;line-height:34px;">' + text + '</div>').appendTo(cell);
                        if (isrow) value.css("border-right", "1px solid #ddd");
                        isrow = false;
                    }
                }
            }
            if (inspectrow.state == "2" || inspectrow.state == "3") {
                row = $('<div style="height: 50px; width: 100%; border-bottom: 1px solid #ddd;"></div>').appendTo(info);
                var title = $('<div style="width:80px; text-align: right; padding-right: 5px; float: left; display: inline-block;border-right:1px solid #ddd;line-height:50px;">审批内容</div>').appendTo(row);
                var width = $(window).width() - 93;
                $('<div style="width:' + width + 'px;height:50px; text-align: left; padding-left: 5px; display: inline-block;line-height:15px;word-wrap:break-word">' + inspectrow.reviewcontent + '</div>').appendTo(row);
                $(".inspectinfo").css("height", "181px");
                // $(".feedback").css("height", ($(window).height() - 362) + "px")
            }
        }
        function getinspectdata() {
            var condition = "\"ROTATIONFALLOWID\"='" + id + "'";
            $.ajax({
                url: Dev.GetSystemUrlByRelID("Service") + "inspect/querybyfilter",
                type: "POST",
                contentType: 'application/json',
                dataType: 'json',
                data: condition,
                async: false,
                success: function (result) {
                    if (Dev.IsNull(result.data)) result.data = [];
                    inspectdata = result.data;
                },
                error: function (msg) {
                    var k = "";
                }
            });
        }

        //初始化反馈信息数据
        function loadfeedbackdata(feedbackdata) {
            $(".feedback", $("#inspectInfo")).remove();
            if (Dev.IsNull(feedbackdata) || feedbackdata.length == 0) return;
            var width = ($(window).width() * 0.5) - 96;
            var info = $('<div class="feedback" style="width:100%;height:' + ($(window).height() - 362) + 'px;border-bottom: 1px solid #ddd;"></div>').appendTo($("#inspectInfo"));
            var leftdiv = $('<div style="width:49.5%;height:100%;float:left;border-right:1px solid #ddd;"></div>').appendTo(info);
            var contentcell0 = $('<div style="height: 115px; width: 100%; display: inline-block; float: left; position: relative;border-bottom:1px solid #ddd;"></div>').appendTo(leftdiv);
            var title0 = $('<div style="width:80px; text-align: right; padding-right: 5px; float: left; display: inline-block;border-right:1px solid #ddd;line-height:115px;">反馈内容</div>').appendTo(contentcell0);
            var value0 = $('<div style="width:' + width + 'px;height:34px; text-align: left; padding-left: 5px; display: inline-block;line-height:19px;word-wrap:break-word">' + feedbackdata.feedBackEntity.content + '</div>').appendTo(contentcell0);
            var picdiv = $('<div style="width:50%;height:100%;float:right;"></div>').appendTo(info);
            var feedusercell = $('<div style="height: 34px; width: 100%; display: inline-block; float: left; position: relative;border-bottom:1px solid #ddd;"></div>').appendTo(leftdiv);
            var title1 = $('<div style="width:80px; text-align: right; padding-right: 5px; float: left; display: inline-block;border-right:1px solid #ddd;line-height:34px;">反馈人</div>').appendTo(feedusercell);
            var value1 = $('<div style="width:' + width + 'px;height:34px; text-align: left; padding-left: 5px; display: inline-block;line-height:34px;">' + feedbackdata.trueName + '</div>').appendTo(feedusercell);
            var feedtimecell = $('<div style="height: 34px; width: 100%; display: inline-block; float: left; position: relative;"></div>').appendTo(leftdiv);
            var title2 = $('<div style="width:80px; text-align: right; padding-right: 5px; float: left; display: inline-block;border-right:1px solid #ddd;line-height:34px;">反馈时间</div>').appendTo(feedtimecell);
            var value3 = $('<div style="width:' + width + 'px;height:34px; text-align: left; padding-left: 5px; display: inline-block;line-height:34px;">' + Dev.GetDateString(feedbackdata.feedBackEntity.time) + '</div>').appendTo(feedtimecell);
            var piccell = $('<div style="height: 100%; width: 100%; display: inline-block;position: relative;"></div>').appendTo(picdiv);
            var __picture = $('<div name="_picture"  style="width: 100%; height: 100%; display: inline-block;"></div>').appendTo(piccell);
            var imgviewer1 = $(' <div class="imgviewer1" style="width: 100%; height: 100%; position: relative; background-repeat: no-repeat; background-position: center; background-size: 423px 159px;"></div>').appendTo(__picture);
            var pageIndex = $('<div name="pageIndex" style="width: 100%; height: 40px; line-height: 40px; text-align: center"></div>').appendTo(imgviewer1);
            var picview1 = $('<div id="picview1" style="cursor: pointer; width: 70%; height: 70%; left: 15%; top: 15%; position: absolute; background-repeat: no-repeat; background-position: center;" title="点击预览"></div>').appendTo(imgviewer1);
            var PicLeft1 = $('<div class="PicLeft1 ImgBtn"  style="background-image: url(\'../../image/agri/leftbtn.png\'); background-repeat: no-repeat; background-position: center; width: 24px; height: 24px; position: absolute; left: 10px; top: 110px; background-size: cover;"></div>').appendTo(imgviewer1);
            var PicRight1 = $('<div class="PicRight1 ImgBtn" style="background-image: url(\'../../image/agri/rightbtn.png\'); background-repeat: no-repeat; background-position: center; width: 24px; height: 24px; position: absolute; right: 10px; top: 110px; background-size: cover;"></div>').appendTo(imgviewer1);

        }

        function getfeedbackdata(row) {
            if (Dev.IsNull(row)) return;
            var url = Dev.GetSystemUrlByRelID("Service") + "feedback/findFeedBackAndFile/" + row.id;
            $.ajax({
                url: url,
                type: "GET",
                async: false,
                contentType: 'application/json',
                dataType: 'json',
                success: function (result) {
                    if (result.statusCode != 200 || Dev.IsNull(result.data)) result.data = [];
                    loadfeedbackdata(result.data);
                    piclist1 = result.data.fileList;
                    loadFeedbackPic(piclist1);
                }
            });
        }

        //加载反馈图片
        function loadFeedbackPic(piclist) {
            if (Dev.IsNull(piclist) || piclist.length == 0) {
                $(".feedback[name=_picture]").empty();
                $(".feedback[name=_picture]").html('<div style="height: 100%;width: 100%;text-align: center;line-height: 244px;">未上传附件</div>');
                return;
            }
            $("[name='pageIndex']", $(".feedback")).text(1 + "/" + piclist.length);
            $("#picview1", $(".feedback")).css({
                "background-image": "url(" + piclist[0].path + ")",
                "background-size": "contain"
            });
            $(".imgviewer1", $(".feedback")).prop("bg_file", piclist[0]);
            initimg1();
        }
        var piclist1 = [];
        //图片绑定鼠标事件
        function initimg1() {
            $('.ImgBtn', $(".feedback")).css("display", "none");
            $(".imgviewer1", $(".feedback")).mouseover(function () {
                $('.ImgBtn', $(".feedback")).css("display", "block");
            }).mouseleave(function () {
                $('.ImgBtn', $(".feedback")).css("display", "none");
            });
            $("#picview1", $(".feedback")).bind("click", function () {
                if (piclist1.length == 0) return;
                var previewimg = [];
                for (var i = 0; i < piclist1.length; i++) previewimg.push(piclist1[i].path);
                var curfile = $(".imgviewer1", $(".feedback")).prop("bg_file");
                if (Dev.IsNull(curfile)) { return; }
                var curIndex = Enumerable.From(piclist1).IndexOf(curfile);
                Dev.PreViewPics(previewimg, curIndex);
            });
            $(".ImgBtn", $(".feedback")).bind("click", function () {
                if (piclist1.length == 0) return;
                var currfile = $(".imgviewer1", $(".feedback")).prop("bg_file");
                if (Dev.IsNull(currfile)) return;
                //当前图片的数组索引
                var index = Enumerable.From(piclist1).IndexOf(currfile);
                if (index < 0) return;
                // MARK: 更正了切换方式
                if ($(this).hasClass("PicLeft1")) {
                    if (index == 0) return;
                    --index;
                    $("[name='pageIndex']", $(this).parent()).text(index + 1 + "/" + piclist1.length);
                }
                if ($(this).hasClass("PicRight1")) {
                    if (index >= piclist1.length - 1) return;
                    ++index;
                    $("[name='pageIndex']", $(this).parent()).text(index + 1 + "/" + piclist1.length);
                }
                $("#picview1", $(".feedback")).css({ "background-image": "url(" + piclist1[index].path + ")" });
                $(".imgviewer1", $(".feedback")).prop("bg_file", piclist1[index]);
            });
        }

    </script>
</head>
<body>
    <div class="rotations">
    </div>
    <div id="rotationDetail" style="height: 100%; width: 100%;">
    </div>
    <div id="massifLink"></div>
    <div id="inspectInfo"></div>
</body>
</html>
