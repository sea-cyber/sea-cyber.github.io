<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>核查管理</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <link rel="stylesheet" href="../../theme/default/easyui.css" />
    <link rel="stylesheet" type="text/css" href="../../theme/icon.css" />
    <link rel="stylesheet" type="text/css" href="../../css/app.css" />
    <link rel="stylesheet" type="text/css" href="../../css/main.css" />
    <link rel="stylesheet" type="text/css" href="../../css/icon.css" />
    <link type="text/css" href="../../css/dev.css" rel="stylesheet" />
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../js/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="../../js/linq.min.js"></script>
    <script type="text/javascript" src="../../js/data.util.js"></script>
    <script type="text/javascript" src="../../js/jquery.dev.control.js"></script>
    <script type="text/javascript" src="../../js/dev.ui.js"></script>
    <script type="text/javascript" src="../../js/guid.js"></script>
    <style type="text/css">
        .content {
            height: 100%;
            width: 100%;
            position: relative;
        }

        .Title {
            width: 75px;
            text-align: right;
            line-height: 40px;
            height: 40px;
            display: inline-block;
            float: left;
        }

            .Title .Icon {
                width: 16px;
                height: 16px;
                display: inline-block;
                margin-top: 11px;
            }

            .Title .Text {
                display: inline-block;
                float: right;
                width: 49px;
            }

        .content .SearchDiv {
            width: 210px;
            height: 40px;
            display: inline-block;
            margin-left: 0px;
            margin-right: 0px;
            float: left;
        }

        .content .Button {
            width: 70px;
            height: 26px;
            float: left;
            margin-top: 7px;
            background-color: #16dbbb;
            text-align: center;
            border: 1px solid #16dbbb;
            display: inline-block;
            margin-left: 5px;
        }

            .content .Button:hover {
                background-color: #5227de;
                border: 1px solid #5227de;
                cursor: pointer;
            }

            .content .Button:active {
                background-color: #210097;
                border: 1px solid #210097;
                cursor: pointer;
            }

        /*.datagrid-body {
            overflow-y: hidden;
        }*/
    </style>
    <script type="text/javascript">
        var Dev = window.top.window.dev;
        var parent;
        var treeControl, dataGrid;
        var pageIndex = 1, pageSize = 5;
        var rotationfallowControl, rotationfallowIndex = 1, rotationfallowSize = 5;
        var verifyMassifControl, verifyMassifIndex = 1, verifyMassifSize = 5;
        var receivederIndex = 1, receivederSize = 5;
        var editWin, feedbackWin, approvalWin;
        var approvalState = 2;
        var radio1, radio2;
        var selectOrgid;//当前被选择的orgid
        var selectOrgid1;
        var winOrgid;//上一个被选择的orgid
        var curRFId;//当前休耕轮作id
        var orgControl;
        var orgFilter;
        var AGRI_INSPECT_TYPE = "核查任务";
        var dialog, flashDialog;
        var updateId;
        var filter;
        var isallow = true;//防止重复请求
        var MSG_CONTENT = {
            netout: "网络超时，请稍后再试！",
            deleteFailed: "删除失败，请稍后再试",
            deleteSuccess: "删除成功！",
            saveSuccess: "保存成功！",
            saveFailed: "保存失败，请稍后再试！"
        };
        var MSG_ICON = {
            SUCCESS: "success",
            INFO: "info",
            ERROR: "error"
        };
        var curPlancrop;

        function WidgetCommunication(s) {//部件通讯
            parent = s.parent;
            // Dev.App.BottomPanel.SetHeight(262);
            Dev.App.BottomPanel.Header.css({ "background": "#14cdad", "color": "#fcfcfc", "font-weight": "bold" });
            Dev.App.BottomPanel.SetIconCls("machine-caralarm");
            //获取树数据
            $(window).resize(function () { resize(); });
            initDataGrid();
            initTree();

            $('.Button').click(function () {
                var tag = $(this).attr("tag");
                if (tag == "search") {
                    pageIndex = 1;
                    queryData();
                }
                if (tag == "searchClear") {
                    searchClear();
                    pageIndex = 1;
                    queryData();
                }
                if (tag == "add") { updateId = null; initWin(true); }
                if (tag == "fbsave") fbsave();
                if (tag == "fbcancel") {
                    feedbackWin.Close();
                    clearFBWin();
                }
            });
            parent.one("onClosing", function () {
                Dev.App.BottomPanel.SetHeight(262);
                //进行释放
                if (!Dev.IsNull(treeControl)) {
                    treeControl.unbind("onSelectChanged");
                    treeControl.Clear();
                    treeControl = null;
                }
                if (!Dev.IsNull(dataGrid)) {
                    dataGrid.Target.unbind("onSelectPage");
                    dataGrid.Target.unbind("onPageSizeChange");
                    dataGrid = null;
                }
                if (!Dev.IsNull(orgControl)) {
                    orgControl.unbind("onSelectChanged");
                    orgControl.Clear();
                    orgControl = null;
                }
                if (!Dev.IsNull(editWin)) {
                    editWin.unbind("onClosing");
                    editWin.Close();
                    editWin.Destroy();
                    editWin = null;
                }
                if (!Dev.IsNull(feedbackWin)) {
                    feedbackWin.unbind("onClosing");
                    feedbackWin.Close();
                    feedbackWin.Destroy();
                    feedbackWin = null;
                }
                if (!Dev.IsNull(approvalWin)) {
                    var radios = $(".dev-radio", approvalWin.Target);
                    if (!Dev.IsNull(radios) && radios.length > 0) {
                        var curRadio = $(radios).prop("$this");
                        curRadio.Target.unbind("onChange");
                    }
                    approvalWin.unbind("onClosing");
                    approvalWin.Close();
                    approvalWin.Destroy();
                    approvalWin = null;
                }
                if (!Dev.IsNull(detailwin)) {
                    detailwin.Close();
                    detailwin.Destroy();
                    detailwin = null;
                }
                var plancropdateControl = $(".dev-combobox[name='plancropdate']", $(".MachineEdit", Dev.App.FillPanel.Target)).prop("$this");
                if (!Dev.IsNull(plancropdateControl)) {
                    plancropdateControl.unbind("onClosing");
                    plancropdateControl.Destroy();
                    plancropdateControl = null;
                }
            });
            resize();
            flashDialog = new Dev.Messager({ Height: 95, Width: 200, AutoShow: false, Type: "question", Timeout: 1500, ButtonVisible: false, AutoVisible: true, Effect: "normal" });
            dialog = new Dev.Messager({ AutoShow: false, Type: "question" });//删除提示框
        }
        /*
        *   初始化组织树
        * */
        function initTree() {
            treeControl = $('.dev-tree').prop("$this");
            var orgid = Dev.cookie.user.orgid;
            $.ajax({
                url: Dev.GetSystemUrlByRelID("Service") + "organize/gettreebyid/" + orgid + "?" + new Date().getTime(),
                type: "GET",
                contentType: 'application/json',
                dataType: 'json',
                success: function (result) {
                    var treedata = Dev.ConvertTreeData(result.data, orgid);
                    treeControl.LoadData(treedata);
                    if (treedata.length > 0) treeControl.SetSelectNode(treeControl.GetRoots()[0]);
                }
            });
            /*组织数的点击切换事件*/
            treeControl.bind("onSelectChanged", function (s, e) {
                getOrgFilter(e);
                if (!Dev.IsNull(editWin)) editWin.Close();
                if (!Dev.IsNull(dataGrid)) { pageIndex = 1; searchClear(); queryData(); }
            });
        }
        //获取组织编号
        function getOrgFilter(e) {
            var treenode = e;
            var orgids = [];
            var isleaf = treeControl.IsLeaf(treenode);
            orgFilter = " \"ORGID\" IN ('" + e.id + "',";
            selectOrgid = e.id;
            orgids.push(e.id);
            if (!isleaf) {
                var allchilds = treeControl.GetAllChildren(treenode);
                for (var i = 0; i < allchilds.length; i++) {
                    orgFilter += "'" + allchilds[i].id + "',";
                    orgids.push(allchilds[i].id);
                }
            }
            orgFilter = orgFilter.substr(0, orgFilter.length - 1);
            orgFilter += ")";
        }

        /*
        *   初始化展示列表
        * */
        function initDataGrid() {
            if (Dev.IsNull(dataGrid)) {
                $("#gridDiv").empty();
                var columns = [
                    { field: "massifid", width: 70, align: 'center', title: '地块编号', sortable: false },
                    { field: "category", width: 40, align: 'center', title: '任务类别', sortable: false },
                    {
                        field: "state", width: 50, align: 'center', title: '任务状态', sortable: false,
                        formatter: function (value, row, index) {
                            if (value == "0") { return '<span>待核查</span>'; }
                            if (value == "1") { return '<span>待审批</span>'; }
                            if (value == "2") { return '<span>审批已通过</span>'; }
                            if (value == "3") { return '<span>审批不通过</span>'; }
                        }
                    },
                    { field: "content", width: 80, align: 'center', title: '任务内容', sortable: false },
                    { field: "username", width: 40, align: 'center', title: '接收人', sortable: false },
                    {
                        field: "completeterm", width: 70, align: 'center', title: '完成期限', sortable: false,
                        formatter: function (value, row, index) {
                            if (Dev.IsNull(value) || value.length == 0) return "-";
                            return Dev.GetDateString(value);
                        }
                    },
                    {
                        field: "_address", width: 120, align: 'center', title: '详细地址', sortable: false,
                        formatter: function (value, row, index) {
                            var str = "";
                            if (!Dev.IsNullAll(row.province)) { str += row.province; }
                            if (!Dev.IsNullAll(row.city)) { str += row.city; }
                            if (!Dev.IsNullAll(row.county)) { str += row.county; }
                            if (!Dev.IsNullAll(row.town)) { str += row.town; }
                            return str;
                        }
                    },

                    {
                        field: "_oprate",
                        width: 65,
                        align: 'center',
                        title: '操作',
                        sortable: false,
                        formatter: function (value, row, index) {
                            var str = "";
                            if (row.state == "0") {
                                str += '<a href="javascript:void(0)" style="color:blue;" onclick="feedback(\'' + index + '\')" title="反馈"><img src="../../image/agri/feedback.png"/></a>';
                                str += ' &nbsp;<a href="javascript:void(0)" style="color:blue;" onclick="updateInfo(\'' + index + '\')" title="修改"><img src="../../image/agri/update.png"/></a>';
                            } else {
                                if (row.state == "1") {
                                    str = '<a href="javascript:void(0)" style="color:blue;" onclick="approval(\'' + row.id + '\',\'' + index + '\')" title="审批"><img src="../../image/agri/approved.png"/></a> ';
                                } else { str += '<a style="opacity: 0"><img src="../../image/agri/unupdate.png"/></a> '; }
                                str += '&nbsp;<a href="javascript:void(0)" style="color:blue;" title="不可修改"><img src="../../image/agri/unupdate.png"/></a>';
                            }
                            str += '&nbsp;<a href="javascript:void(0)" style="color:blue;margin-left:6px;" onclick="showdetail(\'' + row.id + '\' ,\'' + index + '\')" title="详细信息"><img src="../../image/agri/cartype.png"/></a>';
                            str += '&nbsp;<a href="javascript:void(0)" style="color:blue;margin-left:6px;" onclick="deleteInfo(\'' + row.id + '\')" title="删除"><img src="../../image/agri/delete.png"/></a>';
                            return str;
                        }
                    }
                ];
                dataGrid = new UCDataGrid(Dev, { PageIndex: pageIndex, PageSize: pageSize, RowNumbers: false, ID: "taskverifiGrid", pagequery: false, IsSizeSelect: true });
                $("#gridDiv").append(dataGrid.Target);
                dataGrid.Layout(columns);
                dataGrid.Target.bind("onSelectPage", function (s, e) {
                    pageIndex = e.index;
                    queryData();
                });
                dataGrid.Target.bind("onPageSizeChange", function (s, e) {
                    if (Dev.IsNull(e)) return;
                    pageIndex = 1;
                    pageSize = e;
                    queryData();
                });
            }
        }
        //设置datagrid尺寸
        function resize() {
            // Dev.App.BottomPanel.SetHeight(262);
            $(".datagrid-row").css({ "height": "28px" });
            var height = $(window).height();
            var gridheight = height - 40;
            var gridwidth = $(window).width() * 0.80 - 1;//searchDiv、gridDiv的左边框都占了1，
            if (gridwidth < 1060) {
                gridwidth = 1060;
                gridheight = parseInt(gridheight) - 17;//X轴滚动条的宽度
                $(".datagrid-row").css({ "height": "25px" });//当有滑动条时，减小行高适应
            }
            $("#searchDiv").width(gridwidth);
            $("#gridDiv").height(gridheight).width(gridwidth);
            if (!Dev.IsNull(dataGrid)) dataGrid.Resize(gridwidth, gridheight);
            treeControl.SetHeight(height == 0 ? (262 - 26) : (height - 26));
        }
        //查询数据
        function queryData() {
            var con = getCondition();
            //当前是核查表
            con += "AND \"TYPE\"='" + AGRI_INSPECT_TYPE + "' " + "ORDER BY \"CREATEDATE\" DESC";
            $.ajax({
                url: Dev.GetSystemUrlByRelID("Service") + "inspect/querypagebyfilter/" + pageIndex + "/" + pageSize,
                type: "POST",
                contentType: "application/json",
                dataType: 'json',
                data: con,
                success: function (result) {
                    if (result.statusCode != 200 || Dev.IsNull(result.data)) result.data = { dataSource: [], pageInfo: { pageCount: 0, pageIndex: pageIndex, pageSize: 5, totalCount: 0 } };
                    dataGrid.Load(result.data.dataSource, result.data.pageInfo);
                    resize();
                }
            });
        }
        //获取查询条件
        function getCondition() {
            var condition = " 1=1 ";
            var massifControl = $("#massifid").prop("$this");
            if (!Dev.IsNull(massifControl)) {
                var massifid = massifControl.GetValue();
                if (!Dev.IsNull(massifid)) condition += " AND \"MASSIFID\" LIKE '%" + $.trim(massifid) + "%'";
            }
            var typeControl = $("#searchtype").prop("$this");
            if (!Dev.IsNull(typeControl)) {
                var stateValue = typeControl.GetValue();
                if (!Dev.IsNull(stateValue) && stateValue != "-1") condition += " AND \"STATE\"='" + stateValue + "'";
            }
            //时间
            var time1 = $("#completeterm1").datebox("getValue");
            var time2 = $("#completeterm2").datebox("getValue");
            if (!Dev.IsNull(time1) && !Dev.IsNull(time2)) {
                var t1 = new Date(time1.replace(/-/g, "/"));
                var t2 = new Date(time2.replace(/-/g, "/"));
                if (t1.getTime() > t2.getTime()) {
                    var temp = time1;
                    time1 = time2;
                    time2 = temp;
                }
            }
            if (!Dev.IsNull(time1)) condition += " AND \"COMPLETETERM\">'" + time1 + "'";
            if (!Dev.IsNull(time2)) condition += " AND \"COMPLETETERM\"<='" + time2 + "'";
            //组织机构
            if (!dev.IsNull(orgFilter)) condition += " AND  " + orgFilter;
            return condition;
        }
        //清理查询
        function searchClear() {
            var textControl = $('.dev-textbox', $("#searchDiv"));
            for (var i = 0; i < textControl.length; i++) {
                var curControl = $(textControl[i]).prop("$this");
                curControl.Clear();
            }
            var comboControl = $('.dev-combobox', $("#searchDiv"));
            for (var i = 0; i < comboControl.length; i++) {
                var curControl = $(comboControl[i]).prop("$this");
                curControl.SetValue("");
            }
            $("#completeterm1", $("#searchDiv")).datebox("setValue", "");
            $("#completeterm2", $("#searchDiv")).datebox("setValue", "");
        }
        //保存新增
        function saveInfo() {
            if (!isallow) { return; }
            var model = { id: Guid.NewGuid().ToString("N") };
            var completeterm = $("#completeterm", $(".MachineEdit", Dev.App.FillPanel.Target)).datetimebox("getValue");
            var category = $(".dev-combobox[name='category']", $(".MachineEdit", Dev.App.FillPanel.Target)).prop("$this").GetText();
            var orgid = selectOrgid1;
            var massifid = $("#verifyMassif", $(".MachineEdit", Dev.App.FillPanel.Target)).combogrid("getValue");
            var textcontrol = $('.dev-textbox', $(".MachineEdit", Dev.App.FillPanel.Target));
            if (!Dev.IsNull(textcontrol) && textcontrol.length > 0) {
                for (var i = 0; i < textcontrol.length; i++) {
                    var tag = $(textcontrol[i]).attr("name");
                    var curcontrol = $(textcontrol[i]).prop("$this");
                    var value = curcontrol.GetValue();
                    model[tag] = value.trim();
                }
            }
            var plancropdate = $(".dev-combobox[name='plancropdate']", $(".MachineEdit", Dev.App.FillPanel.Target)).prop("$this").GetText();
            var receiveder = $("#receiveder", $(".MachineEdit", Dev.App.FillPanel.Target)).combogrid("getValue");
            var curRow = rotationfallowControl.combogrid("grid").datagrid("getSelected");
            if (!Dev.IsNull(curRow)) {
                model.rotationfallowid = curRow.id;
                model.province = Dev.IsNull(curRow.province) ? null : curRow.province;
                model.city = Dev.IsNull(curRow.city) ? null : curRow.city;
                model.county = Dev.IsNull(curRow.county) ? null : curRow.county;
                model.town = Dev.IsNull(curRow.town) ? null : curRow.town;
                model.village = Dev.IsNull(curRow.village) ? null : curRow.village;
            }
            model.plancropdate = plancropdate;
            model.massifid = massifid;
            model.orgid = orgid;
            model.completeterm = (!Dev.IsNull(completeterm)) ? new Date(completeterm.replace(/-/g, "/")).getTime() : completeterm;
            model.receiveder = receiveder;
            model.category = category;
            //补充字段
            model.type = AGRI_INSPECT_TYPE;//核查表
            model.state = "0";//待核查
            model.updatedate = new Date(Dev.GetNowDateString().replace(/-/g, "/")).getTime();
            //验证字段完整性
            var isok = verifyInfo(model);
            if (!isok) return;
            var url = Dev.GetSystemUrlByRelID("Service") + "inspect/addinspect";
            if (!Dev.IsNull(updateId)) {
                var url = Dev.GetSystemUrlByRelID("Service") + "inspect/updateInspect";
                model.id = updateId;
                updateId = null;
            }
            isallow = false;
            $.ajax({
                url: url,
                type: "POST",
                contentType: 'application/json',
                dataType: 'json',
                data: JSON.stringify(model),
                success: function (result) {
                    if (result.statusCode != 200) { flashDialog.Alert(MSG_CONTENT.saveFailed, MSG_ICON.ERROR); }
                    editWin.Close();
                    pageIndex = 1;
                    queryData();
                    flashDialog.Alert(MSG_CONTENT.saveSuccess, MSG_ICON.SUCCESS);
                },
                error: function (e) {
                    flashDialog.Alert(MSG_CONTENT.netout, MSG_ICON.ERROR);
                },
                complete: function () {
                    isallow = true;
                }
            });
        }
        //验证字段完整
        function verifyInfo(model) {
            var errorMsg1 = $("#errorMsg1", $(".MachineEdit", Dev.App.FillPanel.Target));
            errorMsg1.html("");
            if (Dev.IsNull(model.category)) { errorMsg1.html("任务类别不能为空！"); return false; }
            if (Dev.IsNull(model.orgid)) { errorMsg1.html("组织机构不能为空！"); return false; }
            if (Dev.IsNull(model.rotationfallowid)) { errorMsg1.html("轮作休耕不能为空！"); return false; }
            if (Dev.IsNull(model.massifid)) { errorMsg1.html("地块不能为空！"); return false; }
            if (Dev.IsNull(model.plancropdate)) { errorMsg1.html("种植日期不能为空！"); return false; }
            if (Dev.IsNull(model.receiveder)) { errorMsg1.html("接收人不能为空！"); return false; }
            if (Dev.IsNull(model.content)) { errorMsg1.html("任务内容不能为空！"); return false; }
            if (model.content.length > 60) { errorMsg1.html("任务内容过长！"); return false; }
            if (model.remark.length > 120) { errorMsg1.html("备注过长！"); return false; }
            if (Dev.IsNull(model.completeterm)) { errorMsg1.html("完成期限不能为空！"); return false; }
            return true;
        }
        //删除
        function deleteInfo(id) {
            if (Dev.IsNull(id)) return null;
            dialog.Confirm('确定删除所选记录吗？', function (r) {
                if (!r) return;
                $.ajax({
                    type: "GET",
                    contentType: "application/json",
                    url: Dev.GetSystemUrlByRelID("Service") + "inspect/deleteInspectById/" + id,
                    success: function (result) {
                        if (!result.statusCode == 200) { flashDialog.Alert(MSG_CONTENT.deleteFailed, MSG_ICON.ERROR); return; }
                        pageIndex = 1;
                        queryData();
                        flashDialog.Alert(MSG_CONTENT.deleteSuccess, MSG_ICON.SUCCESS);
                    },
                    error: function (e) {
                        flashDialog.Alert(MSG_CONTENT.netout, MSG_ICON.ERROR);
                    }
                });
            });
        }
        //修改
        function updateInfo(index) {
            if (Dev.IsNull(index)) return;
            dataGrid.DataGrid.datagrid("selectRow", index);
            var row = dataGrid.DataGrid.datagrid("getSelected");
            updateId = row.id;
            if (Dev.IsNull(updateId)) { return; }
            initWin(false, row);
        }
        //编辑窗口填充数据
        function loadData(row) {
            clearWin();//记载之前清空
            $("#completeterm", $(".MachineEdit", Dev.App.FillPanel.Target)).datetimebox("setValue", Dev.GetDateString(row.completeterm));
            var categoryControl = $(".dev-combobox[name='category']", $(".MachineEdit", Dev.App.FillPanel.Target)).prop("$this");
            if (!Dev.IsNull(categoryControl)) { categoryControl.SetText(row.category); }//填充任务类型
            if (!Dev.IsNull(orgControl)) orgControl.SetValueEx(row.orgid);
            if (!Dev.IsNull(rotationfallowControl)) {//填充休耕轮作
                findRFbyid(row.rotationfallowid);//设置文本值
                rotationfallowControl.combogrid('readonly', true);//要设为可编辑，需要重写findRFbyid方法
            }
            if (!Dev.IsNull(verifyMassifControl)) {//填充地块
                getPage4Massif(row.rotationfallowid);
                verifyMassifControl.combogrid("setValue", row.massifid);
                verifyMassifControl.combogrid('readonly', true);
            }
            var plancropdateControl = $(".dev-combobox[name='plancropdate']", $(".MachineEdit", Dev.App.FillPanel.Target)).prop("$this");
            if (!Dev.IsNull(plancropdateControl)) {
                curPlancrop = { plancropdate: row.plancropdate, type: row.plancrop, text: row.plancropdate };
                getPlancropdate(row.rotationfallowid, row.massifid, row.plancropdate);
            }
            var plancropControl = $(".dev-textbox[name='plancrop']", $(".MachineEdit", Dev.App.FillPanel.Target)).prop("$this");
            plancropControl.SetValue(row.plancrop)
            var receivederControl = $("#receiveder", $(".MachineEdit", Dev.App.FillPanel.Target));
            if (!Dev.IsNull(receivederControl)) {//填充任务接收人
                findUserbyid(row.receiveder);
            }
            var contentcontrol = $(".dev-textbox[name='content']", $(".MachineEdit", Dev.App.FillPanel.Target)).prop("$this");
            if (!Dev.IsNull(contentcontrol)) {//填充任务内容
                contentcontrol.SetValue(row.content);
            }
            var remarkcontrol = $(".dev-textbox[name='remark']", $(".MachineEdit", Dev.App.FillPanel.Target)).prop("$this");
            if (!Dev.IsNull(remarkcontrol)) {//填充备注
                remarkcontrol.SetValue(row.remark);
            }
        }
        //主键查询休耕轮作
        function findRFbyid(id) {
            var url = Dev.GetSystemUrlByRelID("Service") + "rotationfalloview/getbyid/" + id;
            $.ajax({
                url: url,
                type: "GET",
                contentType: 'application/json',
                success: function (result) {
                    if (result.statusCode != 200 || Dev.IsNull(result.data)) return;
                    rotationfallowControl.combogrid("grid").datagrid("loadData", { "total": 1, "rows": [result.data] });
                    rotationfallowControl.combogrid("setValue", result.data.id);
                }
            });
        }
        //主键查询用户
        function findUserbyid(id) {
            var url = Dev.GetSystemUrlByRelID("Service") + "user/getbyid/" + id;
            $.ajax({
                url: url,
                type: "GET",
                contentType: 'application/json',
                success: function (result) {
                    if (result.statusCode != 200 || Dev.IsNull(result.data)) return;
                    var receivederControl = $("#receiveder", $(".MachineEdit", Dev.App.FillPanel.Target));
                    receivederControl.combogrid("setValue", result.data.id);
                    receivederControl.combogrid("setText", result.data.truename);
                }
            });
        }

        //详细信息
        var detailwin;
        function showdetail(id, index) {
            if (Dev.IsNull(id)) return;
            //获取当前行
            dataGrid.DataGrid.datagrid("selectRow", index);
            var selectRowData = dataGrid.DataGrid.datagrid("getSelected");
            if (Dev.IsNull(selectRowData)) return;
            if (!Dev.IsNull(detailwin)) { detailwin.Close(); detailwin.Destroy(); detailwin = null; }
            detailwin = new Dev.Window({
                ID: "inspectDetailWin",
                IconCls: 'icon-detailinfo',
                Title: "详细信息",
                Parent: Dev.App.FillPanel.Target,
                Maximizable: false,
                Modal: true,
                Draggable: true,
                HAlign: 'center',
                VAlign: 'center',
                Resizable: false,
                Url: Dev.App.Root + "html/rotation/inspectdetail.html",
                Height: 390,
                Width: 602,
                Parameters: { inspectid: id, showdata: selectRowData }
            });
        }

        /*
        *  初始化新增、修改窗口
        * */
        function initWin(isadd, row) {
            var ico = isadd ? "machine-add" : "icon-featureupdate";
            var title = isadd ? "核查新增" : "核查修改";
            if (Dev.IsNull(editWin)) {
                editWin = new Dev.Window({
                    ID: "taskWin",
                    IconCls: ico,
                    Title: title,
                    Parent: Dev.App.FillPanel.Target,
                    Maximizable: false,
                    Modal: true,
                    Draggable: true,
                    HAlign: 'center',
                    VAlign: 'center',
                    Resizable: false,
                    Content: $("#EditDiv"),
                    Height: 390,
                    Width: 500
                });
                //每次打开窗口时获取当前组织id
                selectOrgid = treeControl.GetSelectNode()[0].id;
                getOrgFilter(treeControl.GetSelectNode()[0]);

                /*1、控件的初始化只需要在新增窗体init的时候执行*/
                $("#completeterm", $(".MachineEdit", Dev.App.FillPanel.Target)).datetimebox({ width: 150, height: 25 });
                initRotationfallow();//初始化休耕轮作列表
                initVerifyMassif();//初始化地块
                bindPlanCropDate();//绑定种植日期事件
                initOrgTree();//初始化组织树
                initReceiveder();//初始化接收人列表

                $(".Button", $(".MachineEdit", Dev.App.FillPanel.Target)).click(function () {
                    var tag = $(this).attr("tag");
                    if (tag == "save") saveInfo();
                    if (tag == "edit-cancel") editWin.Close();
                });
                editWin.Target.bind("onClosing", function () { clearWin(); });//关闭时清空
            } else {//如果存在则open
                clearWin();
                editWin.SetTitle(title);
                editWin.SetIconCls(ico);
                editWin.Open();
            }
            //绑定数据
            var selectNode = treeControl.GetSelectNode();
            orgControl.SetData(selectNode[0].$this);
            getFirstPageData();//初始化分页数据，和当前orgid有关
            //编辑窗口数据填充
            if (!isadd) loadData(row);
        }
        //初始化休耕轮作
        function initRotationfallow() {
            rotationfallowControl = $("#rotationfallow", $(".MachineEdit", Dev.App.FillPanel.Target));
            rotationfallowControl.combogrid({
                idField: 'id', //能获取该文本框值的id号 的字段
                textField: 'name',//要在文本框显示 的字段
                columns: [[
                    { field: 'name', title: '农户名称', width: 60, align: 'center' },
                    { field: 'cardid', title: '身份证号', width: 120, align: 'center' },
                    { field: 'subsidy', title: '补贴金额', width: 60, align: 'center' },
                    { field: 'fallowarea', title: '面积', width: 50, align: 'center' },
                    {
                        field: '_address', title: '地址', width: 200, align: 'center',
                        formatter: function (value, row, index) {
                            var str = "";
                            if (!Dev.IsNull(row.province) && row.province != null) { str += row.province }
                            if (!Dev.IsNull(row.city) && row.city != null) { str += row.city }
                            if (!Dev.IsNull(row.county) && row.county != null) { str += row.county }
                            if (!Dev.IsNull(row.town) && row.town != null) { str += row.town }
                            if (!Dev.IsNull(row.village) && row.village != null) { str += row.village }
                            return str;
                        }
                    },
                    {
                        field: 'contractstarttime', title: '合同开始时间', width: 80, align: 'center',
                        formatter: function (value, row, index) { return Dev.GetDateString(value).replace("00:00:00", ""); }
                    },
                    {
                        field: 'contractendtime', title: '合同结束时间', width: 80, align: 'center',
                        formatter: function (value, row, index) { return Dev.GetDateString(value).replace("00:00:00", ""); }
                    }
                ]],
                width: 150,
                height: 25,
                panelWidth: 652,
                panelHeight: 221,
                pagination: true,
                toolbar: $("#toolbarRf"),
                onClickRow: function (rowIndex, rowData) {//选择休耕轮作后联动查询对应的核查地块
                    verifyMassifControl.combogrid("setValue", "");
                    curRFId = rowData.id;
                    getPage4Massif(curRFId);
                }
            });
            var rotationfallowPage = rotationfallowControl.combogrid("grid").datagrid("getPager");
            var parampage = {
                showPageList: false,
                showRefresh: false,
                pageNumber: rotationfallowIndex,
                pageSize: rotationfallowSize,
                onSelectPage: function (index, size) {
                    rotationfallowIndex = index;//A翻页页码加一
                    getPage4RF();
                }
            };
            rotationfallowPage.pagination(parampage);
            searchTbRfnameC = $('#rfname', rotationfallowControl.combogrid("panel")).prop("$this");
            searchTbRfidC = $('#rfid', rotationfallowControl.combogrid("panel")).prop("$this");
            Rfstart = $("#ctime1", rotationfallowControl.combogrid("panel"));
            Rfstart.datebox({ panelWidth: 140, width: 120, editable: false });
            Rfstart.datebox("textbox").attr("placeholder", "合同时间");
            Rfend = $("#ctime2", rotationfallowControl.combogrid("panel"));
            Rfend.datebox({ panelWidth: 140, width: 120, editable: false });
            Rfend.datebox("textbox").attr("placeholder", "合同时间");
            $("#rfsearch", rotationfallowControl.combogrid("panel")).click(function () {
                searchTbRf();
            });
            $("#rfreset", rotationfallowControl.combogrid("panel")).click(function () {
                searchResetRf();
            });

        }
        var searchTbFilterRf;
        var searchTbRfnameC, searchTbRfidC, Rfstart, Rfend;
        function searchTbRf() {
            rotationfallowIndex = 1;
            searchTbFilterRf = "1=1";
            var searchTbRfname = $.trim(searchTbRfnameC.GetValue());
            if (!Dev.IsNull(searchTbRfname)) searchTbFilterRf += " AND  \"NAME\" LIKE '%" + searchTbRfname + "%'";
            var searchTbRfid = $.trim(searchTbRfidC.GetValue());
            if (!Dev.IsNull(searchTbRfid)) searchTbFilterRf += " AND  \"CARDID\" LIKE '%" + searchTbRfid + "%'";
            var searchStart = Rfstart.datebox("getValue");
            if (!Dev.IsNull(searchStart)) searchTbFilterRf += "AND \"CONTRACTSTARTTIME\" >= '" + searchStart + "'";
            var searchEnd = Rfend.datebox("getValue");
            if (!Dev.IsNull(searchEnd)) searchTbFilterRf += "AND \"CONTRACTSTARTTIME\" <= '" + searchEnd + "'";
            getPage4RF();
        }
        function searchResetRf() {
            if (!Dev.IsNull(searchTbRfnameC)) searchTbRfnameC.Clear();
            if (!Dev.IsNull(searchTbRfidC)) searchTbRfidC.Clear();
            Rfstart.datebox("setValue", "");
            Rfend.datebox("setValue", "")
            searchTbRf();
        }

        //初始化地块
        function initVerifyMassif() {
            verifyMassifControl = $("#verifyMassif", $(".MachineEdit", Dev.App.FillPanel.Target));
            verifyMassifControl.combogrid({
                idField: 'massifid',
                textField: 'massifid',
                columns: [[
                    { field: 'massifid', title: '地块编号', align: 'center', width: 65 },
                    { field: 'classname', title: '地类名称', align: 'center', width: 80 },
                    { field: 'ownership', title: '权属性质', align: 'center', width: 70 },
                    { field: 'ownershipname', title: '权属单位名称', align: 'center', width: 140 },
                    {
                        field: 'farmlandarea', title: '基本农田面积（亩）', align: 'center', width: 110,
                        formatter: function (value, row, index) {
                            return Dev.SqrtMetersToMu(value, 3);//单位转换成亩
                        }
                    }
                ]],
                width: 150,
                height: 25,
                panelWidth: 467,
                panelHeight: 221,
                pagination: true,
                toolbar: $("#toolbarland"),
                rowStyler: function (index, row) {
                    if (row.isinspect === "0") {
                        return 'background-color:#CCCCCC;color:#fff;';
                    }
                },
                onClickRow: function (rowIndex, rowData) {//选择地块后联动查询对应的种植规则
                    var plancropControl = $(".dev-textbox[name='plancrop']", $(".MachineEdit", Dev.App.FillPanel.Target)).prop("$this");
                    plancropControl.Clear();
                    var massifid = rowData.massifid;
                    var rotationfallowControl = $("#rotationfallow", $(".MachineEdit", Dev.App.FillPanel.Target));
                    var rotationfallowid = rotationfallowControl.combogrid("getValue");
                    getPlancropdate(rotationfallowid, massifid);
                },
                onChange: function (newValue, oldValue) {
                    var plancropdateControl = $(".dev-combobox[name='plancropdate']", $(".MachineEdit", Dev.App.FillPanel.Target)).prop("$this");
                    plancropdateControl.Clear();
                    var plancropControl = $(".dev-textbox[name='plancrop']", $(".MachineEdit", Dev.App.FillPanel.Target)).prop("$this");
                    plancropControl.Clear();
                }
            });
            verifyMassifControl.combogrid("grid").datagrid("loadData", { 'total': 0, 'rows': [] });
            var verifyMassifPage = verifyMassifControl.combogrid("grid").datagrid("getPager");
            var parampage = {
                showPageList: false,
                showRefresh: false,
                pageNumber: verifyMassifIndex,
                pageSize: verifyMassifSize,
                onSelectPage: function (index, size) {
                    verifyMassifIndex = index;
                    getPage4Massif(curRFId);
                }
            };
            verifyMassifPage.pagination(parampage);
            searchTblnoC = $('#landnoSearch', verifyMassifControl.combogrid("panel")).prop("$this");
            searchTbltypeC = $('#landtypeSearch', verifyMassifControl.combogrid("panel")).prop("$this");
            searchTblattrC = $('#landattrSearch', verifyMassifControl.combogrid("panel")).prop("$this");
            var dicdatas = Dev.GetDicData(["LandName", "Ownership"]);
            var classnameType = Enumerable.From(dicdatas).Where('s=>s.type=="LandName"').ToArray();
            var ownershipType = Enumerable.From(dicdatas).Where('s=>s.type=="Ownership"').ToArray();
            if (!Dev.IsNull(classnameType) && classnameType.length > 0) {
                var bt = classnameType.concat();         //不改变 字典数据
                bt.unshift({ "data": "不限", "id": 9999999999, "parentid": bt[0].parentid }); //插入数组首部
                searchTbltypeC.SetData(bt);
                searchTbltypeC.Layout();
            }
            if (!Dev.IsNull(ownershipType) && ownershipType.length > 0) {
                var bb = ownershipType.concat();         //不改变 字典数据
                bb.unshift({ "data": "不限", "id": 9999999999, "parentid": bb[0].parentid }); //插入数组首部
                searchTblattrC.SetData(bb);
                searchTblattrC.Layout();
            }

            $("#landsearch", verifyMassifControl.combogrid("panel")).click(function () {
                searchTbland();
            });
            $("#landreset", verifyMassifControl.combogrid("panel")).click(function () {
                searchResetland();
            });

        }
        var searchTblnoC, searchTbltypeC, searchTblattrC;           //地块编号，类型，权属
        function searchTbland() {
            verifyMassifIndex = 1;
            getPage4Massif(curRFId);
        }
        function searchResetland() {
            if (!Dev.IsNull(searchTblnoC)) searchTblnoC.Clear();
            if (!Dev.IsNull(searchTbltypeC)) searchTbltypeC.SetValue("");
            if (!Dev.IsNull(searchTblattrC)) searchTblattrC.SetValue("");
            searchTbland();
        }

        //初始化新增窗口中的组织树
        function initOrgTree() {
            if (Dev.IsNull(orgControl)) {
                //初始化树
                orgControl = new Dev.Combotree({
                    Required: true,
                    PopupHeight: 120,
                    TipInfo: "选择组织",
                    MultiSelect: false,
                    ValueField: "id",
                    TextField: "name",
                    ChildrenField: "child",
                    Height: 25,
                    Border: "1px",
                    Width: 150
                });
                $("#orgtreecomboDiv", $(".MachineEdit", Dev.App.FillPanel.Target)).append(orgControl.Target);
                orgControl.Layout();
                //组织变更的时，切换任务接收人
                orgControl.bind("onSelectChanged", function (n, e) {
                    var receivederControl = $("#receiveder", $(".MachineEdit", Dev.App.FillPanel.Target));
                    receivederControl.combogrid("setValue", "");//用setText不行
                    receivederControl.combogrid("grid").datagrid('loadData', { total: 0, rows: [] });
                    var orgidArr = [];
                    var treenode = e;
                    var isleaf = orgControl.tree.IsLeaf(treenode);
                    selectOrgid1 = e.id;
                    orgidArr.push(e.id);
                    if (!isleaf) {
                        var allchilds = orgControl.tree.GetAllChildren(treenode);
                        for (var i = 0; i < allchilds.length; i++) {
                            orgidArr.push(allchilds[i].id);
                        }
                    }
                    filter = orgids2Filter(orgidArr);
                    receivederIndex = 1;
                    getPage4User(filter);//查询关联的用户
                });
            }
        }
        //初始化接收人
        function initReceiveder() {
            var receivederControl = $("#receiveder", $(".MachineEdit", Dev.App.FillPanel.Target));
            receivederControl.combogrid({
                idField: 'id',
                textField: 'truename',
                columns: [[
                    { field: 'id', title: '主键', align: 'center', width: 60, hidden: true },
                    { field: 'no', title: '编号', align: 'center', width: 50 },
                    { field: 'truename', title: '真实姓名', align: 'center', width: 70 },
                    { field: 'name', title: '登录名', align: 'center', width: 60 },
                    { field: 'cano', title: 'CA证书', align: 'center', width: 50 },
                    { field: 'type', title: '人员类别', align: 'center', width: 58 },
                ]],
                width: 150,
                height: 25,
                panelWidth: 290,
                panelHeight: 221,
                pagination: true,
                toolbar: $("#toobarRec"),
            });
            var receivederPage = receivederControl.combogrid("grid").datagrid("getPager");
            var parampage = {
                showPageList: false,
                showRefresh: false,
                pageNumber: receivederIndex,
                pageSize: receivederSize,
                onSelectPage: function (index, size) {
                    receivederIndex = index;//A翻页页码加一
                    getPage4User(filter);
                }
            };
            receivederPage.pagination(parampage);
            searchTbRnoControl = $('#PnoSearch', receivederControl.combogrid("panel")).prop("$this");
            searchTbRnameControl = $('#PnameSearch', receivederControl.combogrid("panel")).prop("$this");
            searchTbRtypeControl = $('#PTypeSearch', receivederControl.combogrid("panel")).prop("$this");
            $("#recsearch", receivederControl.combogrid("panel")).click(function () {
                searchTbRec();
            });
            $("#recreset", receivederControl.combogrid("panel")).click(function () {
                searchResetRec();
            });

        }
        //ToolbarRec任务接收人查询
        var searchTbFilterRec;
        var searchTbRnoControl, searchTbRnameControl, searchTbRtypeControl;           //接收人编号，姓名，类别
        function searchTbRec() {
            receivederIndex = 1;
            searchTbFilterRec = "1=1";
            var searchTbRno = searchTbRnoControl.GetValue();
            if (!Dev.IsNull(searchTbRno)) searchTbFilterRec += " AND  \"NO\" LIKE '%" + searchTbRno + "%'";
            var searchTbRname = searchTbRnameControl.GetValue();
            if (!Dev.IsNull(searchTbRname)) searchTbFilterRec += " AND  \"TRUENAME\" LIKE '%" + searchTbRname + "%'";
            var searchTbRtype = searchTbRtypeControl.GetValue();
            if (!Dev.IsNull(searchTbRtype)) searchTbFilterRec += " AND  \"TYPE\" = " + searchTbRtype;
            getPage4User(orgFilter + " AND " + searchTbFilterRec);
        }
        function searchResetRec() {
            if (!Dev.IsNull(searchTbRnoControl)) searchTbRnoControl.Clear();
            if (!Dev.IsNull(searchTbRnameControl)) searchTbRnameControl.Clear();
            if (!Dev.IsNull(searchTbRtypeControl)) searchTbRtypeControl.Clear();
            searchTbRec();
        }

        //清空窗口数据
        function clearWin() {
            $("#errorMsg1", $(".MachineEdit", Dev.App.FillPanel.Target)).html("");
            $("#completeterm", $(".MachineEdit", Dev.App.FillPanel.Target)).datetimebox("setValue", "");
            $("#completeterm", $(".MachineEdit", Dev.App.FillPanel.Target)).datetimebox("hidePanel");
            var typecontrol = $(".dev-combobox[name='category']", $(".MachineEdit", Dev.App.FillPanel.Target)).prop("$this");
            if (!Dev.IsNull(typecontrol)) {//清空任务接收人
                typecontrol.SetValue("");
            }
            if (!Dev.IsNull(orgControl)) {//清空组织树
                orgControl.text.Clear();
                orgControl.tree.SelectedItem = null;
            }
            if (!Dev.IsNull(rotationfallowControl)) {//清空休耕轮作
                rotationfallowControl.combogrid("setValue", "");
                rotationfallowControl.combogrid('readonly', false);
                rotationfallowControl.combogrid("hidePanel");
            }
            if (!Dev.IsNull(verifyMassifControl)) {//清空地块
                verifyMassifControl.combogrid("setValue", "");
                verifyMassifControl.combogrid("grid").datagrid('loadData', { total: 0, rows: [] });//重新加载空数据
                verifyMassifControl.combogrid('readonly', false);
                verifyMassifControl.combogrid("hidePanel");
            }
            var receivederControl = $("#receiveder", $(".MachineEdit", Dev.App.FillPanel.Target));
            if (!Dev.IsNull(receivederControl)) {//清空接收人
                receivederControl.combogrid("setValue", "");
                receivederControl.combogrid("grid").datagrid('loadData', { total: 0, rows: [] });//重新加载空数据
                receivederControl.combogrid("hidePanel");
            }
            var textcontrol = $('.dev-textbox', $(".MachineEdit", Dev.App.FillPanel.Target));
            for (var i = 0; i < textcontrol.length; i++) {
                var curcontrol = $(textcontrol[i]).prop("$this");
                curcontrol.Clear();
            }
        }

        /*
        *  加载数据
        * */
        //加载休耕轮作第一页数据
        function getFirstPageData() {
            var temporgid = selectOrgid;//当前组织id
            if (temporgid != winOrgid) {
                rotationfallowIndex = 1;//B如果是新的组织id，分页页码重置
                verifyMassifIndex = 1;
            }
            getPage4RF(temporgid);
        }
        //获取休耕轮作分页
        function getPage4RF(temporgid) {
            var url = Dev.GetSystemUrlByRelID("Service") + "rotationfalloview/getbyfilter/" + rotationfallowIndex + "/" + rotationfallowSize;
            var con = orgFilter.concat();
            if (!Dev.IsNull(searchTbFilterRf)) con += "AND " + searchTbFilterRf;
            $.ajax({
                url: url,
                type: "POST",
                contentType: 'application/json',
                dataType: 'json',
                async: false,//设为异步，农耕框就没有值
                data: con,
                success: function (result) {
                    if (result.statusCode != 200 || Dev.IsNull(result.data)) return;
                    if (!Dev.IsNull(rotationfallowControl)) {
                        rotationfallowControl.combogrid("grid").datagrid("loadData", result.data.dataSource);//绑定数据
                        var page = rotationfallowControl.combogrid("grid").datagrid("getPager");
                        page.pagination('refresh', {
                            total: result.data.pageInfo.totalCount,
                            pageNumber: result.data.pageInfo.pageIndex
                        });
                        winOrgid = temporgid;//如果查询成功，更新全局组织id
                    }
                }
            });
        }
        //获取地块分页
        function getPage4Massif(id) {
            var url = Dev.GetSystemUrlByRelID("Service") + "massif/findbyrotationfallid/" + id + "/" + verifyMassifIndex + "/" + verifyMassifSize;
            $.ajax({
                url: url,
                type: "POST",
                contentType: 'application/json',
                dataType: 'json',
                async: false,//设为异步，地块框就没有值
                data: JSON.stringify({
                    massifid: searchTblnoC.GetValue(),
                    classname: searchTbltypeC.GetText(),
                    ownership: searchTblattrC.GetText()
                }),
                success: function (result) {
                    if (result.statusCode != 200 || Dev.IsNull(result.data)) return;
                    //给地块加上状态
                    if (result.data.dataSource.length != 0) {
                        var massifidArr = result.data.dataSource.map(function (value) { return value.massifid; });
                        var massifids = "'" + massifidArr.join("','") + "'";
                        getPlancropdate1(id, massifids, result.data);
                    }
                }
            });
        }
        //通过种植类型查询
        function bindPlanCropDate() {
            var plancropdateControl = $(".dev-combobox[name='plancropdate']", $(".MachineEdit", Dev.App.FillPanel.Target)).prop("$this");
            plancropdateControl.bind("onSelectChanged", function (e, node) {
                var plancropControl = $(".dev-textbox[name='plancrop']", $(".MachineEdit", Dev.App.FillPanel.Target)).prop("$this");
                plancropControl.SetValue(node.type);

            })
        }

        //给分页查询到的地块数据添加属性
        function getPlancropdate1(rotationfallowid, massifids, preData) {
            var url = Dev.GetSystemUrlByRelID("Service") + "rule/getRulesNoInspect/" + rotationfallowid + "/" + massifids;
            $.ajax({
                url: url,
                type: "GET",
                contentType: 'application/json',
                async: false,
                success: function (result) {
                    if (result.statusCode != 200 || Dev.IsNull(result.data)) return;
                    var massifArr = preData.dataSource;
                    var resultArr = massifArr.map(function (value) {
                        var has = result.data.some(function (value1) {
                            return value1.rotationfallid === rotationfallowid && value1.massifid === value.massifid;
                        });
                        value.isinspect = has ? "1" : "0";
                        return value;
                    });
                    //给地块加载数据
                    if (!Dev.IsNull(verifyMassifControl)) {
                        verifyMassifControl.combogrid("grid").datagrid("loadData", resultArr);//绑定数据
                        var page = verifyMassifControl.combogrid("grid").datagrid("getPager");
                        page.pagination('refresh', {
                            total: preData.pageInfo.totalCount,
                            pageNumber: preData.pageInfo.pageIndex
                        });
                    }
                }
            });
        }
        //获取计划种植日期
        function getPlancropdate(rotationfallowid, massifid, plancropdate) {
            var url = Dev.GetSystemUrlByRelID("Service") + "rule/getRuleNoInspect/" + rotationfallowid + "/" + massifid;
            $.ajax({
                url: url,
                type: "GET",
                contentType: 'application/json',
                success: function (result) {
                    if (result.statusCode != 200 || Dev.IsNull(result.data)) return;
                    loadPlancropdate(result.data);
                    var plancropdateControl = $(".dev-combobox[name='plancropdate']", $(".MachineEdit", Dev.App.FillPanel.Target)).prop("$this");
                    if (!Dev.IsNull(plancropdate)) {
                        plancropdateControl.SetText(plancropdate);
                    }
                }
            });
        }
        //绑定计划种植日期数据
        function loadPlancropdate(data) {
            for (var i = 0; i < data.length; i++) {
                var plancropdate = data[i].year;
                var text = plancropdate;
                if (!Dev.IsNullAll(data[i].mouth)) { plancropdate += "-" + data[i].mouth; }
                if (!Dev.IsNullAll(data[i].mouth)) { text += "-" + data[i].mouth; }
                data[i].plancropdate = plancropdate;
                data[i].text = text;
            }
            var plancropdateControl = $(".dev-combobox[name='plancropdate']", $(".MachineEdit", Dev.App.FillPanel.Target)).prop("$this");
            plancropdateControl.SetData([]);
            if (!Dev.IsNull(curPlancrop))
                data.push(curPlancrop);
            plancropdateControl.SetData(data);
        }
        //用组织编号查询用户分页
        function getPage4User(filter) {
            var url = Dev.GetSystemUrlByRelID("Service") + "user/getbyfilter/" + receivederIndex + "/" + receivederSize;
            $.ajax({
                url: url,
                type: "POST",
                contentType: 'application/json',
                dataType: 'json',
                async: false,
                data: filter,
                success: function (result) {
                    if (result.statusCode != 200) return;
                    var userArr = Dev.IsNull(result.data.dataSource) ? [] : result.data.dataSource;
                    var receivederControl = $("#receiveder", $(".MachineEdit", Dev.App.FillPanel.Target));
                    receivederControl.combogrid("grid").datagrid('loadData', { total: userArr.length, rows: userArr });
                    var page = receivederControl.combogrid("grid").datagrid("getPager");
                    page.pagination('refresh', {
                        total: result.data.pageInfo.totalCount,
                        pageNumber: result.data.pageInfo.pageIndex
                    });
                }
            });
        }
        //组织编号数组转换成sql
        function orgids2Filter(orgidArr) {
            var str = " \"ORGID\" IN ('";
            str += orgidArr.toString().replace(/,/g, "','") + "')";
            return str;
        }

        /*
        * 反馈功能
        * */
        function feedback(index) {
            dataGrid.DataGrid.datagrid("selectRow", index);
            var row = dataGrid.DataGrid.datagrid("getSelected");
            updateId = row.id;
            initFeedbackWin();
        }
        //初始化反馈窗口
        function initFeedbackWin() {
            if (Dev.IsNull(feedbackWin)) {
                feedbackWin = new Dev.Window({
                    ID: "feedbackWin",
                    IconCls: 'machine-trackedit',
                    Title: "核查反馈",
                    Parent: Dev.App.FillPanel.Target,
                    Maximizable: false,
                    Modal: true,
                    Draggable: true,
                    HAlign: 'center',
                    VAlign: 'center',
                    Resizable: false,
                    Content: $("#FeedbackDiv"),
                    Height: 380,
                    Width: 510
                });

                initimg();//初始化上传图片窗口
                feedbackWin.Target.bind("onClosing", function () { clearFBWin(); });//关闭时清空
            } else {
                clearFBWin();
                feedbackWin.Open();
            }
        }
        //反馈保存
        function fbsave() {
            if (!isallow) { return; }
            var form = new FormData();
            //反馈内容、备注
            var textcontrol = $('.dev-textbox', $(".TaskWorkEdit", Dev.App.FillPanel.Target));
            if (!Dev.IsNull(textcontrol) && textcontrol.length > 0) {
                for (var i = 0; i < textcontrol.length; i++) {
                    var tag = $(textcontrol[i]).attr("name");
                    var curcontrol = $(textcontrol[i]).prop("$this");
                    var value = curcontrol.GetValue().trim();
                    if (tag == "content") {
                        if (Dev.IsNull(value)) { $("#errorMsg2", $(".TaskWorkEdit", Dev.App.FillPanel.Target)).html("请填写反馈内容！"); return; }
                        if (value.length > 120) { $("#errorMsg2", $(".TaskWorkEdit", Dev.App.FillPanel.Target)).html("反馈内容过长！"); return; }
                    } else if (value.length > 120) { $("#errorMsg2", $(".TaskWorkEdit", Dev.App.FillPanel.Target)).html("备注过长！"); return; }

                    form.append(tag, value);
                }
            }
            form.append("inspectid", updateId);
            //图片上传
            form.append("attid", Guid.NewGuid().ToString("N"));
            var fkder = Dev.cookie.user.id;
            form.append("fkder", fkder);
            if (piclist.length > 0 && !Dev.IsNull(piclist)) {
                for (var i = 0; i < piclist.length; i++) form.append("devfile", piclist[i]);
            }
            //提交
            isallow = false;
            $.ajax({
                type: "POST",
                data: form,
                url: Dev.GetSystemUrlByRelID("Service") + "feedback/addfileandupdate",
                contentType: false,
                processData: false,
                success: function (result) {
                    feedbackWin.Close();
                    flashDialog.Alert(MSG_CONTENT.saveSuccess, MSG_ICON.SUCCESS);
                    queryData();
                },
                error: function (msg) {
                    flashDialog.Alert(MSG_CONTENT.netout, MSG_ICON.ERROR);
                },
                complete: function () {
                    isallow = true;
                }
            })
        }
        //清空反馈窗口
        function clearFBWin() {
            $("#errorMsg2", $(".TaskWorkEdit", Dev.App.FillPanel.Target)).html("");
            //反馈内容、备注
            var textcontrol = $('.dev-textbox', $(".TaskWorkEdit", Dev.App.FillPanel.Target));
            if (!Dev.IsNull(textcontrol) && textcontrol.length > 0) {
                for (var i = 0; i < textcontrol.length; i++) {
                    var curcontrol = $(textcontrol[i]).prop("$this");
                    var value = curcontrol.Clear();
                }
            }
            $("#picview", $(".TaskWorkEdit", Dev.App.FillPanel.Target)).css({ "background-image": "" });
            $("#picview", $(".TaskWorkEdit", Dev.App.FillPanel.Target)).prop("bg_file", null);
            piclist = [];//图片置空

        }
        //初始化图片
        var piclist = [];
        function initimg() {
            $('.ImgBtn', $(".TaskWorkEdit", Dev.App.FillPanel.Target)).css("display", "none");
            $(".imgviewer", $(".TaskWorkEdit", Dev.App.FillPanel.Target)).mouseover(function () {
                $('.ImgBtn', $(".TaskWorkEdit", Dev.App.FillPanel.Target)).css("display", "block");
            }).mouseleave(function () {
                $('.ImgBtn', $(".TaskWorkEdit", Dev.App.FillPanel.Target)).css("display", "none");
            });
            $("#picview", $(".TaskWorkEdit", Dev.App.FillPanel.Target)).bind("click", function () {
                if (piclist.length == 0) return;
                var previewimg = [];
                for (var i = 0; i < piclist.length; i++) previewimg.push(window.URL.createObjectURL(piclist[i]));
                var curfile = $("#picview", $(".TaskWorkEdit", Dev.App.FillPanel.Target)).prop("bg_file");
                if (Dev.IsNull(curfile)) { return; }
                var curIndex = Enumerable.From(piclist).IndexOf(curfile);
                Dev.PreViewPics(previewimg, curIndex);
            });
            $(".ImgBtn", $(".TaskWorkEdit", Dev.App.FillPanel.Target)).click(function () {
                if ($(this).hasClass("PicAdd")) {
                    $("input[name='devfile']", $(".TaskWorkEdit", Dev.App.FillPanel.Target)).click();
                }
                else {
                    if (piclist.length == 0) return;
                    var curfile = $("#picview", $(".TaskWorkEdit", Dev.App.FillPanel.Target)).prop("bg_file");
                    if (dev.IsNull(curfile)) return;
                    var index = Enumerable.From(piclist).IndexOf(curfile);
                    if (index < 0) return;
                    var showindex = -1;
                    if ($(this).hasClass("PicDel")) {
                        piclist.splice(index, 1);
                        if (piclist.length > 0) showindex = piclist.length - 1;
                    }
                    if ($(this).hasClass("PicLeft")) {
                        if (index == 0) return;
                        showindex = index - 1;
                    }
                    if ($(this).hasClass("PicRight")) {
                        if (index >= piclist.length - 1) return;
                        showindex = index + 1;
                    }
                    if (showindex == -1) {
                        $("#picview", $(".TaskWorkEdit", Dev.App.FillPanel.Target)).css({ "background-image": "" });
                        $("#picview", $(".TaskWorkEdit", Dev.App.FillPanel.Target)).prop("title", "");
                        $("#picview", $(".TaskWorkEdit", Dev.App.FillPanel.Target)).prop("bg_file", null);
                    }
                    else {
                        $("#picview", $(".TaskWorkEdit", Dev.App.FillPanel.Target)).css({ "background-image": "url(" + window.URL.createObjectURL(piclist[showindex]) + ")" });
                        $("#picview", $(".TaskWorkEdit", Dev.App.FillPanel.Target)).prop("bg_file", piclist[showindex]);
                    }
                }
            });
            $("input[name='devfile']", $(".TaskWorkEdit", Dev.App.FillPanel.Target)).change(function (event) {
                var files = $(this)[0].files;
                if (Dev.IsNull(files) || files.length == 0) return;
                var ispic = true;
                for (var i = 0; i < files.length; i++) {
                    //过滤掉非图片的文件
                    var filename = files[i].name;
                    var file_ex = filename.substr(filename.lastIndexOf('.'));
                    if (file_ex.toUpperCase() == ".PNG" || file_ex.toUpperCase() == ".GIF" || file_ex.toUpperCase() == ".JPG" || file_ex.toUpperCase() == ".JPEG") {
                        piclist.push(files[i]);
                    }
                    else ispic = false;
                }
                //判断是否继续获取放弃
                if (!ispic) {
                    if (Dev.IsNull(dialog)) dialog = new Dev.Messager({ AutoShow: false, Type: "question" });
                    dialog.Confirm('以过滤非图片文件，是否继续上传？', function (r) {
                        if (!r) return;
                        //加载最后一个文件
                        if (piclist.length == 0) return;
                        $("#picview", $(".TaskWorkEdit", Dev.App.FillPanel.Target)).css({ "background-image": "url(" + window.URL.createObjectURL(piclist[piclist.length - 1]) + ")" });
                        $("#picview", $(".TaskWorkEdit", Dev.App.FillPanel.Target)).attr("title", "点击预览");
                        $("#picview", $(".TaskWorkEdit", Dev.App.FillPanel.Target)).prop("bg_file", piclist[piclist.length - 1]);
                    });
                } else {
                    //加载最后一个文件
                    if (piclist.length == 0) return;
                    $("#picview", $(".TaskWorkEdit", Dev.App.FillPanel.Target)).css({ "background-image": "url(" + window.URL.createObjectURL(piclist[piclist.length - 1]) + ")" });
                    $("#picview", $(".TaskWorkEdit", Dev.App.FillPanel.Target)).attr("title", "点击预览");
                    $("#picview", $(".TaskWorkEdit", Dev.App.FillPanel.Target)).prop("bg_file", piclist[piclist.length - 1]);
                }
                /* $(this).prepend($('<input type="file" name="devfile" multiple="multiple" style="cursor: pointer; display: none;" accept="image/png,image/jpeg" />'));
                 $(this).remove();*/
                event.target.value = '';
            });
        }

        /*
        * 审批功能
        * */
        function approval(id, index) {
            if (!isallow) { return; }
            dataGrid.DataGrid.datagrid("selectRow", index);
            var curdata = dataGrid.DataGrid.datagrid("getSelected");
            if (Dev.IsNull(curdata)) return;
            var _address = "";
            if (!Dev.IsNullAll(curdata.province)) { _address += curdata.province; }
            if (!Dev.IsNullAll(curdata.city)) { _address += curdata.city; }
            if (!Dev.IsNullAll(curdata.county)) { _address += curdata.county; }
            if (!Dev.IsNullAll(curdata.town)) { _address += curdata.town; }
            curdata._address = _address;
            var url = Dev.GetSystemUrlByRelID("Service") + "organize/getbyid/" + curdata.orgid;
            isallow = false;
            $.ajax({
                url: url,
                type: "GET",
                dataType: 'json',
                async: false,
                success: function (result) {
                    if (result.statusCode != 200 || Dev.IsNull(result.data)) return;
                    var _organizename = result.data.name;
                    curdata._organizename = _organizename;
                },
                complete: function () {
                    isallow = true;
                }
            });
            if (Dev.IsNull(approvalWin)) {
                approvalWin = new Dev.Window({
                    ID: "approvalWin",
                    IconCls: "icon-approvalWin",
                    Title: "核查审批",
                    Maximizable: false,
                    Minimizable: false,
                    Modal: true,
                    Draggable: true,
                    HAlign: 'center',
                    VAlign: 'center',
                    Resizable: false,
                    Height: 447,
                    Width: 602
                });
                var items = [{ ID: "taskInfo", IsSelected: true, Name: "任务信息", Content: $('<div id="InspectInfoTab"></div>') /*$("#inspectTab")*/ },
                    { ID: "feedbackInfo", IsSelected: false, Name: "反馈信息", Content: $("#feedbackTab") }];
                var tab = new Dev.Tab({
                    ID: "maptiptab",
                    Position: "top",
                    Width: 600,
                    Height: 415,
                    TabNormalCls: "NormalTabCls",
                    TabSelectedCls: "SelectedTabCls1",
                    Items: items
                });
                approvalWin.SetContent(tab.Target);
                tab.Layout();
                approvalWin.Target.bind("onClosing", function () { clearApprovalWin(); });//关闭时清空
            }
            else {
                approvalWin.Open();
            }

            $("#InspectInfoTab", approvalWin.Target).empty();
            var tab1content = tabcontent1(curdata);
            $("#InspectInfoTab", approvalWin.Target).append(tab1content);

            buildFeedBackData(id);
            $(".Button[tag='cancel']", approvalWin.Target).click(function () {
                approvalWin.Close();
            });
            $(".Button[tag='save']", approvalWin.Target).click(function () {
                $("#errorMsg", approvalWin.Target).html("");
                var reviewcontent = $("#approvalText", approvalWin.Target).prop("$this").GetValue();
                if (Dev.IsNull(reviewcontent) && reviewcontent.length == 0) {
                    $("#errorMsg", approvalWin.Target).html("审批内容不能为空!");
                    return;
                }
                if (Dev.IsNull(reviewcontent) && reviewcontent.length > 120) {
                    $("#errorMsg", approvalWin.Target).html("审批内容过长!");
                    return;
                }
                var data = $(this).prop("data");
                //获取当前审批用户名
                var curUser = Dev.cookie.user;
                var examineder = curUser.truename;
                //更新参数
                var paramdata = {
                    state: approvalState,
                    reviewtime: new Date(Dev.GetNowDateString().replace(/-/g, "/")).getTime(),
                    updatedate: new Date(Dev.GetNowDateString().replace(/-/g, "/")).getTime(),
                    reviewcontent: reviewcontent,
                    examineder: examineder,
                    id: data.id,
                    orgid: data.orgid
                };
                $.ajax({
                    url: Dev.GetSystemUrlByRelID("Service") + "inspect/updateInspect",
                    type: "POST",
                    contentType: "application/json",
                    dataType: 'json',
                    data: JSON.stringify(paramdata),
                    success: function (result) {
                        if (result.statusCode != 200 || Dev.IsNull(result.data)) {
                            flashDialog.Alert(MSG_CONTENT.saveFailed, MSG_ICON.ERROR);
                            return;
                        }
                        approvalWin.Close();
                        pageIndex = 1;
                        queryData();
                        flashDialog.Alert(MSG_CONTENT.saveSuccess, MSG_ICON.SUCCESS);
                    },
                    error: function (e) {
                        flashDialog.Alert(MSG_CONTENT.netout, MSG_ICON.ERROR)
                    }
                });
            });
        }
        //任务基本信息
        function tabcontent1(data) {
            var tab = $('<div class="approvalWin"></div>');
            var row = $('<div class="Row"></div>').appendTo(tab);
            $('<div  class="Title">任务类别</div>').appendTo(row);
            $('<div name="category" class="taskinfo" style="width: 204px; height: 34px; display: inline-block; float: left; line-height: 34px; text-align: left; padding-left: 10px; border-right: 1px dashed #ddd;"></div>').appendTo(row);
            $('<div  class="Title">地块编号</div>').appendTo(row);
            $('<div name="massifid" class="taskinfo" style="width: 205px; height: 34px; display: inline-block; line-height: 34px; padding-left: 10px;"></div>').appendTo(row);

            var row2 = $('<div class="Row"></div>').appendTo(tab);
            $('<div  class="Title">组织机构</div>').appendTo(row2);
            $('<div name="_organizename" class="taskinfo" style="width: 204px; height: 34px; display: inline-block; float: left; line-height: 34px; text-align: left; padding-left: 10px; border-right: 1px dashed #ddd;"></div>').appendTo(row2);
            $('<div  class="Title">接收人</div>').appendTo(row2);
            $('<div name="username" class="taskinfo" style="width: 205px; height: 34px; display: inline-block; line-height: 34px; padding-left: 10px;"></div>').appendTo(row2);

            var row3 = $('<div class="Row"></div>').appendTo(tab);
            $('<div  class="Title" style="height:34px;line-height:34px;">详细地址</div>').appendTo(row3);
            $('<div name="_address" class="taskinfo" style="width:505px;height:34px;display:inline-block;padding-left:10px;line-height:34px;"></div>').appendTo(row3);

            var row4 = $('<div class="Row" style="height:60px;"></div>').appendTo(tab);
            $('<div  class="Title" style="height:60px;line-height:60px;">任务内容</div>').appendTo(row4);
            $('<div name="content" class="taskinfo" style="width:505px;height:54px;display:inline-block;padding-left:10px;padding-top:5px;"></div>').appendTo(row4);

            var row5 = $('<div class="Row"></div>').appendTo(tab);
            $('<div  class="Title">创建时间</div>').appendTo(row5);
            $('<div name="createdate" class="taskinfo" style="width: 204px; height: 34px; display: inline-block; float: left; line-height: 34px; text-align: left; padding-left: 10px; border-right: 1px dashed #ddd;">2017-09-20 18:47:53</div>').appendTo(row5);
            $('<div  class="Title">完成期限</div>').appendTo(row5);
            $('<div name="completeterm" class="taskinfo" style="width: 205px; height: 34px; display: inline-block; line-height: 34px; padding-left: 10px;">2017-09-25 09:32:42</div>').appendTo(row5);

            var row6 = $('<div style="height:30px;width:600px;background-color:#fcfcfc;border-bottom:1px solid #ddd"></div>').appendTo(tab);
            $('<div  class="taskinfo" style="width:560px;height:30px;line-height:30px;display:inline-block;float:left;padding-left:10px;letter-spacing:4px;">审批信息&nbsp;</div>').appendTo(row6);

            var row9 = $('<div class="Row"></div>').appendTo(tab);
            $('<div  class="Title">审批意见</div>').appendTo(row9);
            var opinionDiv = $('<div style="width:505px;height:20px;display:inline-block;padding-left:10px;padding-top:11px;"></div>').appendTo(row9);
            radio1 = new Dev.Radio({ Value: "2", Name: "opinionGroup", Text: "通过", Checked: true });
            opinionDiv.append(radio1.Target);
            radio1.Target.bind("onChange", function (s, e) {
                approvalState = 2;
                staticcheckchange(e);
            });
            radio2 = new Dev.Radio({ Value: "3", Name: "opinionGroup", Text: "不通过", CSS: { "margin-left": "10px" } });
            opinionDiv.append(radio2.Target);
            radio2.Target.bind("onChange", function (s, e) {
                approvalState = 3;
                staticcheckchange(e);
            });
            var row7 = $('<div class="Row" style="height:80px;"></div>').appendTo(tab);
            $('<div  class="Title" style="height:80px;line-height:80px;">审批内容</div>').appendTo(row7);
            var approvalDiv = $('<div style="width:515px;height:79px;display:inline-block;text-overflow:ellipsis: "></div>').appendTo(row7);
            var textbox = new Dev.TextBox({
                ID: "approvalText",
                Type: "multi-text",
                Height: 79,
                Width: 510,
                Border: "0px",
                Required: true,
                MaxLength:120
            });
            approvalDiv.append(textbox.Target);

            var row8 = $('<div class="ButtonDiv"></div>').appendTo(tab);
            $('<div id="errorMsg" style="position:absolute;left:15px;color:red;line-height:40px;text-align:center;"></div>').appendTo(row8);
            var savebutton = $('<div class="Button" style="left:225px;" tag="save">保&nbsp;存</div>').appendTo(row8);
            savebutton.prop("data", data);
            var cancelbutton = $('<div class="Button" style="left:305px;" tag="cancel">取&nbsp;消</div>').appendTo(row8);
            //绑定数据
            var infoControl = $(".taskinfo", tab);
            for (var i = 0; i < infoControl.length; i++) {
                var name = $(infoControl[i]).attr("name");
                if (name == "createdate" || name == "completeterm") {
                    $(infoControl[i]).html(Dev.GetDateString(data[name]));
                } else {
                    $(infoControl[i]).html(data[name]);
                }
            }
            return tab;

        }
        //获取反馈信息
        function buildFeedBackData(id) {
            $.ajax({
                url: Dev.GetSystemUrlByRelID("Service") + "feedback/findFeedBackAndFile/" + id,
                type: "GET",
                contentType: "application/json",
                dataType: 'json',
                async: false,
                success: function (result) {
                    if (result.statusCode != 200) { clearfeedbackInfo(); return; }
                    var feedbackData = result.data.feedBackEntity;
                    feedbackData.time = Dev.GetDateString(feedbackData.time);
                    feedbackData.trueName = result.data.trueName;
                    piclist1 = result.data.fileList;
                    loadfeedbackInfo(feedbackData);
                    loadFeedbackPic(piclist1);
                }
            });
        }
        //加载反馈信息
        function loadfeedbackInfo(feedbackData) {
            var feedbackDivs = $(".feedbackTab", approvalWin);
            for (var i = 0; i < feedbackDivs.length; i++) {
                var curName = $(feedbackDivs[i]).attr("name");
                var value = feedbackData[curName];
                if (curName == "time") { value = Dev.GetDateString(value); }
                $(feedbackDivs[i]).text(value);
            }
        }
        //清空反馈信息
        function clearfeedbackInfo() {
            var feedbackDivs = $(".feedbackTab", approvalWin);
            for (var i = 0; i < feedbackDivs.length; i++) {
                var curName = $(feedbackDivs[i]).attr("name");
                if (curName == "_picture") { continue; }
                $(feedbackDivs[i]).text("");
            }
        }
        //加载反馈图片
        function loadFeedbackPic(piclist) {
            if (Dev.IsNull(piclist) || piclist.length == 0) {
                $(".feedbackTab[name='_picture']", approvalWin).empty();
                $(".feedbackTab[name='_picture']", approvalWin).html('<div style="height: 100%;width: 100%;text-align: center;line-height: 244px;">未上传附件</div>');
                return;
            }

            if (!Dev.IsNull(piclist) && piclist.length > 1) {
                $(".imgviewer1", approvalWin).mouseover(function () {
                    $('.ImgBtn', approvalWin).css("display", "block");
                }).mouseleave(function () {
                    $('.ImgBtn', approvalWin).css("display", "none");
                });
                $(".ImgBtn", approvalWin).bind("click", function () {
                    if ($(this).hasClass("PicRight1")) {
                        var currfile = $(".imgviewer1", approvalWin).prop("bg_file");
                        if (Dev.IsNull(currfile)) return;
                        var index = Enumerable.From(piclist).IndexOf(currfile);
                        if (index < 0 || index >= piclist.length - 1) return;
                        var showindex = index + 1;
                        $("#picview1", approvalWin).css({ "background-image": "url(" + piclist[showindex].path + ")" });
                        $(".imgviewer1", approvalWin).prop("bg_file", piclist[showindex]);
                        $("[name='pageIndex']", $("#feedbackTab", approvalWin)).text(showindex + 1 + "/" + piclist.length);
                    }

                    if ($(this).hasClass("PicLeft1")) {
                        var currfile = $(".imgviewer1", approvalWin).prop("bg_file");
                        if (Dev.IsNull(currfile)) return;
                        var index = Enumerable.From(piclist).IndexOf(currfile);
                        if (index <= 0) return;
                        var showindex = index - 1;
                        $("#picview1", approvalWin).css({ "background-image": "url(" + piclist[showindex].path + ")" });
                        $(".imgviewer1", approvalWin).prop("bg_file", piclist[showindex]);
                        $("[name='pageIndex']", $("#feedbackTab", approvalWin)).text(showindex + 1 + "/" + piclist.length);
                    }

                });
            }

            $("[name='pageIndex']", $("#feedbackTab", approvalWin)).text(1 + "/" + piclist.length);
            $("#picview1", approvalWin).css({ "background-image": 'url(' + piclist[0].path + ')', "background-size": "contain" });
            $(".imgviewer1", approvalWin).prop("bg_file", piclist[0]);
            var imgs = [];
            for (var i = 0; i < piclist.length; i++) imgs.push(piclist[i].path);
            $("#picview1", approvalWin).prop("imgsrcs", imgs);

            $("#picview1", approvalWin).bind("click", function () {
                var imgsource = $(this).prop("imgsrcs");
                Dev.PreViewPics(imgsource);
            });

        }
        var piclist1 = [];

        //清空审批窗口
        function clearApprovalWin() {
            $("#picview1", approvalWin).css({ "background-image": "" });
            $(".imgviewer1", approvalWin).prop("bg_file", null);
            $("#picview1", approvalWin).prop("imgsrcs", "");
        }

        function staticcheckchange(e) {
            var arr = [radio1, radio2];
            for (var i = 0; i < arr.length; i++) {
                if (arr[i].Value === e.Value) continue;
                if (arr[i].Checked) arr[i].SetCheckState(false);
            }
        }

    </script>
</head>
<body style="height: 100%; width: 100%">
    <div id="content" class="content">
        <div style="height: 100%; width: 20%; position: absolute;">
            <!--<div style="height: 26px; line-height: 26px; width: 100%; background-color: #ddd;"><span style="margin-left: 15px; color: #0099cc; line-height: 26px; letter-spacing: 3px; font-size: 12px;">组织机构</span></div>-->
            <div id="treediv" style="width: 100%; height: 100%;">
                <div class="dev-tree" opt='{"ValueField":"id","TextField":"name","ChildrenField":"child","Height":220}'></div>
            </div>
        </div>
        <div style="height: 100%; width: 80%; position: absolute; left: 20%; overflow-y: hidden;">
            <div id="searchDiv" style="height: 40px; width: 100%; border-left: 1px solid #ddd; position: relative;">
                <div style="height: 40px; position: absolute; left: 0px;">
                    <div class="SearchDiv">
                        <div id="massifid" class="dev-textbox" style="z-index: 2; width: 190px; display: inline-block;" opt='{"TipInfo":"","HeaderCSS":{"padding":"0px","width":"75px"},"IsOverShow":true,"Padding":"0px 5px","TextAlign":"left","BodyCSS": { "background-color": "transparent","margin-top":"8px","margin-left":"8px" },"Title":"<div class=\"Title\"><div class=\"Icon machine-carnum\"></div><span class=\"Text\">地块编号</span></div>"}'></div>
                    </div>
                    <div class="SearchDiv">
                        <div class="Title">
                            <div class="Icon machine-carnum"></div>
                            <span class="Text">任务状态</span>
                        </div>
                        <div style="height: 26px; width: 130px; display: inline-block; z-index: 2; margin-top: 8px;">
                            <div id="searchtype" class="dev-combobox" opt='{"Data":[{"id":"-1","text":"不限"},{"id":"0","text":"待核查"},{"id":"1","text":"待审批"},{"id":"2","text":"审批已通过"},{"id":"3","text":"审批不通过"}],"TextField":"text","ValueField":"id","Width":"120","TipInfo":"请选择","IsOverShow":true,"Padding":"0px 5px","TextAlign":"left","CSS":{"background-color":"transparent","margin-left":"8px"}}'></div>
                        </div>
                    </div>
                    <div class="SearchDiv" style="margin-left: 5px;">
                        <div style="width: 71px; height: 40px; line-height: 40px; text-align: right; display: inline-block; float: left;">
                            <div class="icon-calendar" style="height: 16px; width: 16px; display: inline-block; float: left; margin-left: 5px; margin-top: 11px;"></div>
                            <span style="height: 40px; line-height: 40px; width: 49px; float: right;">完成期限</span>
                        </div>
                        <div style="width: 120px; height: 40px; line-height: 38px; padding: 0px 5px; display: inline-block; float: left; margin-top: 0px;">
                            <input id="completeterm1" class="easyui-datebox" data-options="width:120,height:24,editable: false" />
                        </div>
                    </div>
                    <div class="SearchDiv">
                        <div style="width: 25px; height: 40px; display: inline-block; line-height: 40px; text-align: center;">至</div>
                        <div style="width: 120px; height: 40px; line-height: 38px; padding: 0px 5px; display: inline-block; margin-top: 0px;">
                            <input id="completeterm2" class="easyui-datebox" data-options="width:120,height:24,editable: false" />
                        </div>
                    </div>
                </div>
                <div style="width: 239px; height: 100%; position: absolute; right: 10px; z-index: 2">
                    <div class="Button" tag="search">
                        <div class="machine-query" style="height: 16px; width: 16px; margin-top: 4px; margin-left: 4px; display: inline-block; float: left;"></div>
                        <span style="line-height: 26px; color: #fcfcfc;">查&nbsp;询</span>
                    </div>
                    <div class="Button" tag="searchClear">
                        <div class="machine-reset" style="height: 16px; width: 16px; margin-top: 4px; margin-left: 4px; display: inline-block; float: left;"></div>
                        <span style="line-height: 26px; color: #fcfcfc;">重&nbsp;置</span>
                    </div>
                    <div class="Button" tag="add">
                        <div class="machine-add" style="height: 16px; width: 16px; margin-top: 4px; margin-left: 4px; display: inline-block; float: left;"></div>
                        <span style="line-height: 26px; color: #fcfcfc;">新&nbsp;增</span>
                    </div>
                </div>
            </div>
            <div id="gridDiv" style="width: 100%; border-left: 1px solid #ddd; border-top: 1px solid #ddd;"></div>
        </div>
    </div>
    <div id="EditDiv" class="MachineEdit" style="height: 285px;">
        <div class="Row">
            <div class="Cell">
                <div style="width: 70px; height: 100%; line-height: 35px; text-align: right; padding-right: 5px; float: left">
                    任务类别
                </div>
                <div style="width: 149px; height: 100%; line-height: 38px; line-height: 32px; float: left; margin-top: 0px;">
                    <div class="dev-combobox" name="category" style="z-index: 3; width: 150px; margin-top: 5px;" opt='{"Required":true,"TipInfo":"请选择","Height":26,"HeaderCSS":{"padding":"0px","width":"75px"},"Data":["计划任务","调度任务"],"IsOverShow":true,"Padding":"0px 5px","TextAlign":"left","BodyCSS": { "background-color": "transparent" }}'></div>
                </div>
            </div>
        </div>
        <div class="Row">
            <div class="Cell">
                <div style="width: 70px; height: 100%; line-height: 35px; text-align: right; padding-right: 5px; float: left">
                    组织机构
                </div>
                <div id="orgtreecomboDiv"
                    style="height: 24px; width: 150px; margin-top: 5px; display: block; float: left;">
                </div>
            </div>
            <div class="Cell">
                <div style="width: 75px; height: 100%; line-height: 35px; text-align: right; padding-right: 5px; float: left">
                    休耕轮作
                </div>
                <div style="width: 159px; height: 35px; line-height: 33px; display: inline-block; float: left; margin-top: 1px; position: relative;">
                    <div id="rotationfallow" data-options="editable:false"></div>
                </div>
            </div>
        </div>
        <div class="Row">
            <div class="Cell">
                <div style="width: 70px; height: 100%; line-height: 35px; text-align: right; padding-right: 5px; float: left">
                    地块
                </div>
                <div style="width: 159px; height: 35px; line-height: 33px; display: inline-block; float: left; margin-top: 1px; position: relative;">
                    <div id="verifyMassif" data-options="editable:false"></div>
                </div>
            </div>
            <div class="Cell">
                <div style="width: 75px; height: 100%; line-height: 35px; text-align: right; padding-right: 5px; float: left">
                    种植日期
                </div>
                <div style="width: 149px; height: 100%; line-height: 38px; line-height: 32px; float: left; margin-top: 0px;">
                    <div class="dev-combobox" name="plancropdate" style="z-index: 3; width: 150px; margin-top: 5px;" opt='{"Required":true,"TipInfo":"请选择","Height":26,"HeaderCSS":{"padding":"0px","width":"75px"},"TextField":"text","ValueField":"plancropdate","IsOverShow":true,"Padding":"0px 5px","TextAlign":"left","BodyCSS": { "background-color": "transparent" }}'></div>
                </div>
            </div>

        </div>
        <div class="Row">
            <div class="Cell">
                <div style="width: 70px; height: 100%; line-height: 35px; text-align: right; padding-right: 5px; float: left">
                    计划作物
                </div>
                <div style="width: 149px; height: 100%; line-height: 38px; line-height: 32px; float: left; margin-top: 0px;">
                    <div class="dev-textbox" name="plancrop" style="width: 149px; height: 27px; margin-top: 5px; float: left"
                        opt='{"Readonly":"true","TipInfo":"","HeaderCSS":{"padding":"0px 5px","width":"80px", "text-align": "RIGHT"},"IsOverShow":true,"Padding":"5px"}'>
                    </div>
                </div>
            </div>
            <div class="Cell">
                <div style="width: 75px; height: 100%; line-height: 35px; text-align: right; padding-right: 5px; float: left">
                    接收人
                </div>
                <div style="width: 159px; height: 35px; line-height: 33px; display: inline-block; float: left; margin-top: 1px; position: relative;">
                    <div id="receiveder" data-options="editable:false"></div>
                </div>
            </div>
        </div>
        <div class="Row" style="height: 65px; width: 100%; border-bottom: 1px solid #ddd;">
            <div class="Cell" style="height: 60px; width: 488px;">
                <div style="width: 70px; height: 100%; line-height: 65px; text-align: right; padding-right: 5px; float: left">
                    任务内容
                </div>
                <div class="dev-textbox" name="content" style="z-index: 2; width: 404px; height: 55px; margin-top: 5px; float: left"
                    opt='{"MaxLength":120,"TipInfo":"","Type":"multi-text","IsOverShow":true,"Padding":"5px"}'>
                </div>
            </div>
        </div>
        <div class="Row">
            <div class="Cell">
                <div style="width: 70px; height: 100%; line-height: 35px; text-align: right; padding-right: 5px; float: left">
                    完成期限
                </div>
                <div style="width: 150px; height: 100%; line-height: 38px; line-height: 32px; float: left; margin-top: 0px;">
                    <input id="completeterm" data-options="editable:false" />
                </div>
            </div>
        </div>
        <div class="Row" style="height: 65px; width: 100%; border-bottom: 1px solid #ddd;">
            <div class="Cell" style="height: 60px; width: 488px;">
                <div style="width: 70px; height: 100%; line-height: 65px; text-align: right; padding-right: 5px; float: left">
                    备注
                </div>
                <div class="dev-textbox" name="remark" style="z-index: 2; width: 404px; height: 55px; margin-top: 5px; float: left"
                    opt='{"MaxLength":120,"TipInfo":"","Type":"multi-text","IsOverShow":true,"Padding":"5px"}'>
                </div>
            </div>
        </div>

        <div id="errorMsg1"
            style="height: 35px; width: 200px; line-height: 35px; display: inline-block; color: red; padding-left: 10px; margin-left: 20px;">
        </div>
        <div class="Submit" style="margin-right: 19px">
            <div class="Button" tag="save">
                <span style="line-height: 26px; color: #fcfcfc;">保&nbsp;&nbsp;存</span>
            </div>
            <div class="Button" tag="edit-cancel">
                <span style="line-height: 26px; color: #fcfcfc;">取&nbsp;&nbsp;消</span>
            </div>
        </div>
        <div style="position: absolute; height: 10px; width: 10px; top: 49px; left: 200px; z-index: 1; color: red; line-height: 10px;">*</div>
        <div style="position: absolute; height: 10px; width: 10px; top: 49px; right: 35px; z-index: 1; color: red; line-height: 10px;">*</div>
        <div style="position: absolute; height: 10px; width: 10px; top: 121px; left: 200px; z-index: 2; color: red; line-height: 10px;">*</div>
        <div style="position: absolute; height: 10px; width: 10px; top: 121px; left: 450px; z-index: 2; color: red; line-height: 10px;">*</div>
        <div style="position: absolute; height: 10px; width: 10px; top: 172px; left: 460px; z-index: 2; color: red; line-height: 10px;">*</div>
        <div style="position: absolute; height: 10px; width: 10px; top: 223px; left: 200px; z-index: 2; color: red; line-height: 10px;">*</div>
    </div>
    <div id="FeedbackDiv" class="TaskWorkEdit">
        <div class="Row" style="height: 65px; width: 100%; border-bottom: 1px solid #ddd;">
            <div class="Cell" style="height: 60px; width: 100%;">
                <div class="dev-textbox" name="content" style="z-index: 2; width: 495px; height: 55px; margin-top: 5px;"
                    opt='{"MaxLength":120,"TipInfo":"","Type":"multi-text","HeaderCSS":{"padding":"0px 5px","width":"60px", "text-align": "RIGHT"},"IsOverShow":true,"Padding":"5px","Title":"<div class=\"Title\">反馈内容</div>"}'>
                </div>
            </div>
        </div>
        <div class="Row" style="height: 65px; width: 100%; border-bottom: 1px solid #ddd;">
            <div class="Cell" style="height: 60px; width: 100%;">
                <div class="dev-textbox" name="remark" style="z-index: 2; width: 495px; height: 55px; margin-top: 5px;"
                    opt='{"MaxLength":120,"TipInfo":"","Type":"multi-text","HeaderCSS":{"padding":"0px 5px","width":"60px", "text-align": "RIGHT"},"IsOverShow":true,"Padding":"5px","Title":"<div class=\"Title\">备注</div>"}'>
                </div>
            </div>
        </div>
        <div class="Row" style="height: 167px; width: 100%;">
            <div style="display: inline-block; width: 57px; line-height: 167px; float: left; text-align: right; padding-right: 13px;"><span>附件</span></div>
            <div style="display: inline-block; width: 423px; height: 167px;">
                <div class="imgviewer" style="width: 423px; height: 159px; margin-top: 4px; border: 1px solid #95b8e7; position: relative;">
                    <div id="picview" style="width: 80%; height: 80%; left: 10%; top: 10%; background-repeat: no-repeat; background-position: center; position: absolute"></div>
                    <div class="PicLeft ImgBtn"></div>
                    <div class="PicRight ImgBtn"></div>
                    <div class="PicAdd icon-imgadd ImgBtn" title="上传图片"></div>
                    <div class="PicDel icon-imgdel ImgBtn" title="移除图片"></div>
                    <input type="file" name="devfile" multiple="multiple" style="cursor: pointer; display: none;" accept="image/png,image/jpeg" />
                </div>
            </div>
        </div>

        <div id="errorMsg2"
            style="height: 35px; width: 200px; line-height: 35px; display: inline-block; color: red; padding-left: 10px; margin-left: 20px;">
        </div>
        <div class="Submit">
            <div class="Button" tag="fbsave">
                <span style="line-height: 26px; color: #fcfcfc;">保&nbsp;&nbsp;存</span>
            </div>
            <div class="Button" tag="fbcancel">
                <span style="line-height: 26px; color: #fcfcfc;">取&nbsp;&nbsp;消</span>
            </div>
        </div>

        <div style="position: absolute; height: 10px; width: 10px; top: 26px; right: 30px; z-index: 2; color: red; line-height: 10px;">*</div>
    </div>
    <div id="feedbackTab" style="height: 100%; width: 100%;">
        <div style="height: 34px; width: 100%; border-bottom: 1px dashed #ddd;">
            <div style="height: 100%; width: 50%; display: inline-block; float: left; position: relative;">
                <div style="width: 80px; text-align: right; padding-right: 5px; display: inline-block; border-right: 1px dashed #ddd; border-left: 1px dashed #ddd; border-left: 1px dashed #ddd; line-height: 34px; float: left;">
                    反馈人
                </div>
                <div class="feedbackTab" name="trueName" style="width: 208px; height: 100%; text-align: left; padding-left: 5px; display: inline-block; line-height: 34px; float: left;"></div>
            </div>
            <div style="height: 100%; width: 50%; display: inline-block; float: left; position: relative;">
                <div style="width: 80px; text-align: right; padding-right: 5px; display: inline-block; border-right: 1px dashed #ddd; border-left: 1px dashed #ddd; line-height: 34px; float: left;">
                    反馈时间
                </div>
                <div class="feedbackTab" name="time" style="width: 208px; height: 100%; text-align: left; padding-left: 5px; display: inline-block; line-height: 34px; float: left;"></div>
            </div>
        </div>
        <div style="height: 130px; width: 100%; border-bottom: 1px dashed #ddd;">
            <div style="height: 100%; width: 100%; display: inline-block; float: left; position: relative;">
                <div style="width: 80px; text-align: right; padding-right: 5px; display: inline-block; border-right: 1px dashed #ddd; border-left: 1px dashed #ddd; line-height: 130px; float: left;">
                    反馈内容
                </div>
                <div class="feedbackTab" name="content" style="width: 500px; height: 100%; text-align: left; padding-left: 5px; display: inline-block; line-height: 25px; test-index: 2em; float: left;"></div>
            </div>
        </div>
        <div style="height: 225px; width: 100%; border-bottom: 1px dashed #ddd;">
            <div style="height: 100%; width: 100%; display: inline-block; float: left; position: relative;">
                <div class="feedbackTab" name="_picture" style="width: 585px; height: 100%; padding-left: 5px; display: inline-block; float: left;">
                    <div style="display: inline-block; width: 100%; height: 100%;">
                        <div class="imgviewer1" style="width: 100%; height: 100%; position: relative;">
                            <div name="pageIndex" style="width: 100%; height: 30px; line-height: 30px; text-align: center"></div>
                            <div id="picview1" style="cursor: pointer; width: 80%; height: 70%; left: 10%; top: 15%; position: absolute; background-repeat: no-repeat; background-position: center;" title="点击预览"></div>
                            <div class="PicLeft1 ImgBtn" style="background-image: url('image/agri/leftbtn.png'); background-repeat: no-repeat; background-position: center; width: 24px; height: 24px; position: absolute; left: 0px; top: 95px; background-size: cover; display: none;"></div>
                            <div class="PicRight1 ImgBtn" style="background-image: url('image/agri/rightbtn.png'); background-repeat: no-repeat; background-position: center; width: 24px; height: 24px; position: absolute; right: 0px; top: 95px; background-size: cover; display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toobarRec" style="height: 35px; background-color: #fcfcfc">
        <div style="margin-top: 5px;">
            <div style="margin-top: 5px;">
                <div id="PnoSearch" class="dev-textbox" style="width: 60px; float: left; margin-left: 6px; display: inline-block;" opt='{"TipInfo":"编号"}'></div>
                <div id="PnameSearch" class="dev-textbox" style="width: 60px; float: left; margin-left: 4px; display: inline-block;" opt='{"TipInfo":"姓名"}'></div>
                <div id="PTypeSearch" class="dev-textbox" style="width: 60px; float: left; margin-left: 4px; display: inline-block;" opt='{"TipInfo":"人员类别"}'></div>
                <div style="width: 76px; height: 30px; display: inline-block; margin-left: 8px;">
                    <div id="recsearch" style="cursor: pointer; height: 24px; width: 35px; display: inline-block; background-color: #03afd9; float: left; color: #fff; line-height: 24px; text-align: center;">查询</div>
                    <div id="recreset" style="cursor: pointer; height: 24px; width: 35px; display: inline-block; background-color: #03afd9; margin-left: 6px; color: #fff; line-height: 24px; text-align: center;">重置</div>
                </div>
            </div>
        </div>
    </div>
    <div id="toolbarRf" style="height: 35px; background-color: #fcfcfc">
        <div style="margin-top: 5px;">
            <div style="margin-top: 5px;">
                <div id="rfname" class="dev-textbox" style="width: 117px; float: left; margin-left: 10px; display: inline-block;" opt='{"TipInfo":"输入姓名"}'></div>
                <div id="rfid" class="dev-textbox" style="width: 117px; float: left; margin-left: 8px; display: inline-block;" opt='{"TipInfo":"输入身份证号"}'></div>
                <div style="width: 122px; height: 24px; line-height: 24px; display: inline-block; float: left; margin-left: 10px; margin-top: -1px">
                    <input id="ctime1" />
                </div>
                <span style="float: left; width: 26px; height: 21px; line-height: 21px; text-align: center">至</span>
                <div style="width: 122px; height: 24px; line-height: 24px; display: inline-block; float: left; margin-top: -1px;">
                    <input id="ctime2" />
                </div>
                <div style="width: 90px; height: 30px; display: inline-block; margin-left: 20px;">
                    <div id="rfsearch" style="cursor: pointer; height: 24px; width: 35px; display: inline-block; background-color: #03afd9; float: left; color: #fff; line-height: 24px; text-align: center;">查询</div>
                    <div id="rfreset" style="cursor: pointer; height: 24px; width: 35px; display: inline-block; background-color: #03afd9; margin-left: 10px; color: #fff; line-height: 24px; text-align: center;">重置</div>
                </div>
            </div>
        </div>
    </div>
    <div id="toolbarland" style="height: 35px; background-color: #fcfcfc">
        <div style="margin-top: 5px;">
            <div id="landnoSearch" class="dev-textbox" style="width: 108px; float: left; margin-left: 10px; display: inline-block;" opt='{"TipInfo":"请输入编号"}'></div>
            <div id="landtypeSearch" class="dev-combobox" style="width: 108px; float: left; margin-left: 10px; display: inline-block;" opt='{ "PopupHeight":"auto","TextField":"data","ValueField":"id","TipInfo":"选择地类名称"}'></div>
            <div id="landattrSearch" class="dev-combobox" style="width: 108px; float: left; margin-left: 10px; display: inline-block;" opt='{ "PopupHeight":"auto","TextField":"data","ValueField":"id","TipInfo":"选择权属属性"}'></div>
            <div style="width: 76px; height: 30px; display: inline-block; margin-left: 16px;">
                <div id="landsearch" style="cursor: pointer; height: 24px; width: 35px; display: inline-block; background-color: #03afd9; float: left; color: #fff; line-height: 24px; text-align: center;">查询</div>
                <div id="landreset" style="cursor: pointer; height: 24px; width: 35px; display: inline-block; background-color: #03afd9; margin-left: 6px; color: #fff; line-height: 24px; text-align: center;">重置</div>
            </div>
        </div>
    </div>

</body>
</html>
