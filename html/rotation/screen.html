<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>分屏显示</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <link rel="stylesheet" href="../../theme/default/easyui.css" />
    <link rel="stylesheet" type="text/css" href="../../theme/icon.css" />
    <link rel="stylesheet" type="text/css" href="../../css/app.css" />
    <link rel="stylesheet" type="text/css" href="../../css/main.css" />
    <link rel="stylesheet" type="text/css" href="../../css/icon.css" />
    <link type="text/css" href="../../css/dev.css" rel="stylesheet" />
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../js/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="../../js/linq.min.js"></script>
    <script type="text/javascript" src="../../js/data.util.js"></script>
    <script type="text/javascript" src="../../js/jquery.dev.control.js"></script>
    <script type="text/javascript" src="../../js/dev.ui.js"></script>
    <script type="text/javascript" src="../../js/guid.js"></script>
    <style type="text/css">
        .content {
            width: 100%;
            height: 100%;
            position: relative;
        }
    </style>
    <script type="text/javascript">
        var Dev = window.top.window.dev;
        var parent;
        var treecontrol;
        var layerconfig = Dev.App.Config.Extend.LayerForTree.LayerRoot;
        var layersinfo;
        var screenmap1, screenmap2, screenmap3, screenmap4, mapView;
        var screenlegend1, screenlegend2, screenlegend3, screenlegend4;
        function WidgetCommunication(s) {//部件通讯
            parent = s.parent;
            Dev.App.LeftPanel.SetIconCls("icon-mutiscreen");
            if (!Dev.IsNull(layerconfig)) layersinfo = getlayertreebyType("screen");

            inittree();
            //初始化地图
            Dev.App.FillPanel.bind("onResize", function () {
                if (Dev.IsNull(screenpanel)) return;
                var width = Dev.App.FillPanel.Target.outerWidth();
                var height = Dev.App.FillPanel.Target.outerHeight();
                var mapdiv = $('div[name="mappanel"]', screenpanel);
                if (mapdiv.length < 4) {
                    var soliddiv = $('div[name="solid"]', screenpanel);
                    var allmapwidth = width - (soliddiv.length * 3);
                    var temp = allmapwidth % mapdiv.length;
                    var mapwidth = (temp == 0 ? (allmapwidth / mapdiv.length) : ((allmapwidth - temp) / mapdiv.length));
                    var lastmapwidth = allmapwidth - ((mapdiv.length - 1) * mapwidth);
                    var allchild = screenpanel.children();
                    var hasw = 0;
                    var mapdivindex = 0;
                    for (var i = 0; i < allchild.length; i++) {
                        var name = $(allchild[i]).attr("name");
                        var cw;
                        if (name == "mappanel") {
                            cw = mapwidth;
                            mapdivindex++;
                            if (mapdivindex == mapdiv.length - 1) cw = lastmapwidth;
                        }
                        if (name == "solid") cw = 3;
                        $(allchild[i]).css({ "width": cw + "px", "height": height + "px", "left": hasw + "px" });
                        hasw += cw;
                    }
                }
                if (mapdiv.length == 4) {
                    var children = screenpanel.children();
                    var nh = height - 3;
                    var temph = nh % 2;
                    var containerh = (temph == 0 ? (nh / 2) : ((nh - temph) / 2));
                    var lastcontainerh = nh - containerh;

                    var nw = width - 3;
                    var tempw = nw % 2;
                    var containerw = (tempw == 0 ? (nw / 2) : ((nw - tempw) / 2));
                    var lastw = nw - containerw;
                    //var containerh
                    var index = 0;
                    for (var i = 0; i < children.length; i++) {
                        var name = $(children[i]).attr("name");
                        var h = containerh;
                        var top = 0;
                        if (name == "container") {
                            if (index > 0) { h = lastcontainerh; top = containerh + 3; }
                            index++;
                        }
                        if (name == "outsolid") { h = 3; top = containerh; }
                        $(children[i]).css({ "width": width + "px", "height": h + "px", "top": top + "px" });
                        var subchild = $(children[i]).children();
                        var mapdivindex = 0, hasw = 0;
                        for (var j = 0; j < subchild.length; j++) {
                            var name = $(subchild[j]).attr("name");
                            var cw;
                            if (name == "mappanel") {
                                cw = containerw;
                                if (mapdivindex == 1) cw = lastw;
                                mapdivindex++;
                            }
                            if (name == "solid") cw = 3;
                            $(subchild[j]).css({ "width": cw + "px", "height": h + "px", "left": hasw + "px" });
                            hasw += cw;
                        }
                    }
                }
            });
            //关闭
            parent.one("onClosing", function () {
                //释放
                Dev.App.MapPanel.Target.unbind("onMapRefresh");
                if (!Dev.IsNull(treecontrol)) {
                    treecontrol.unbind("onChecked");
                    treecontrol = null;
                }
                Dev.App.FillPanel.unbind("onResize");
                screenmap1 = screenmap2 = screenmap3 = screenmap4 = null;
                screenlegend1 = screenlegend2 = screenlegend3 = screenlegend4 = null;
                if (!Dev.IsNull(screenpanel)) screenpanel.remove();
            });
            resize();
            $(window).resize(function () { resize(); });
            mapView = Dev.initView();
            Dev.App.MapPanel.Target.bind("onMapRefresh", function () { mapView = Dev.initView(); });
        }
        function inittree() {
            treecontrol = $('.dev-tree').prop("$this");
            treecontrol.bind("onChecked", function () {
                var checknode = treecontrol.GetChecked(true);
                var checkdata = [];
                for (var i = 0; i < checknode.length; i++) {
                    if (treecontrol.IsLeaf(checknode[i])) checkdata.push(checknode[i].$this);
                }
                initMapinfo(checkdata);
            });
            treecontrol.LoadData(layersinfo);
        }
        function resize() {
            var height = $(window).outerHeight();
            //$("#treediv").height(height);
            $("#content").height(height);
            if (!Dev.IsNull(treecontrol)) treecontrol.SetHeight(height);
        }
        var screenpanel;
        var ismove = false;
        var positionX, clientLeft;
        var positionY, clientTop;
        var movesolid;
        var movetype = "V";
        function initMapinfo(checklayers) {
            if (!Dev.IsNull(screenpanel)) { screenpanel.remove(); screenmap1 = null; screenmap2 = null; screenmap3 = null; screenmap4 = null; }
            if (dev.IsNull(checklayers) || checklayers.length == 0) return;
            screenpanel = $('<div style="height:100%;width:100%;position:relative;"></div>');
            Dev.App.FillPanel.Add(screenpanel, "", "", 10000);
            var maxlength = 4;
            if (checklayers.length < 4) maxlength = checklayers.length;
            //根据高度和高度
            var allwidth = Dev.App.FillPanel.Target.width(), allheight = Dev.App.FillPanel.Target.height();
            var width, height, lastwidth, lastheight;
            if (maxlength < 4) {
                var temp = allwidth % maxlength;
                width = temp == 0 ? (allwidth / maxlength) : ((allwidth - temp) / maxlength);
                lastwidth = allwidth - (maxlength - 1) * width;
                height = allheight;
                lastheight = allheight;
                for (var i = 0; i < maxlength; i++) {
                    var div = $('<div name="mappanel" style="position:absolute;background-color:#fff;"></div>').appendTo(screenpanel);
                    var colwidth = width - 3;
                    if (i == 0) colwidth = width;
                    if (i == maxlength - 1) colwidth = lastwidth - 3;
                    div.css({ "width": width + "px", "height": height + "px", "left": ((i == 0) ? 0 : (i * width) + 3) + "px" });
                    if (i < maxlength - 1) {
                        var solid = $('<div name="solid" style="height:' + allheight + 'px;width:3px;background-color:#ddd;position:absolute;left:' + ((i + 1) * width) + 'px;z-index:100"></div>').appendTo(screenpanel);
                        solid.mouseover(function (e) {
                            $(this).css({ "background-color": "#808080", "cursor": "w-resize" });
                        }).mouseleave(function (e) {
                            $(this).css({ "background-color": "#ddd", "cursor": "default" });
                        }).mousedown(function (e) {
                            ismove = true;
                            movetype = "V";
                            positionX = e.clientX;
                            clientLeft = parseFloat($(this).css("left"));
                            movesolid = $(this);
                        }).mouseup(function () {
                            ismove = false;
                        })
                    }
                    mapload(i, div, checklayers[i]);//添加图层
                    var title = $('<div style="height:35px;line-height:35px;width:100%;position:absolute;left:15px;z-index:10001;top:0px;font-weight:bold;font-size:15px;color:#0099cc">' + checklayers[i].Text + '</div>').appendTo(div);
                }
            }
            screenpanel.mousemove(function (e) {
                if (!ismove) return;
                if (movetype == "V") {
                    movesolid.css({ "background-color": "#808080", "cursor": "w-resize" });
                    var newleft = clientLeft + (e.clientX - positionX);
                    if (!dev.IsNull(movesolid)) movesolid.css("left", newleft + "px");
                    //改变改父节点中所有的宽度
                    changesize(movesolid, newleft);
                }
                if (movetype == "H") {
                    movesolid.css({ "background-color": "#808080", "cursor": "s-resize" });
                    var newtop = clientTop + (e.clientY - positionY);
                    if (!dev.IsNull(movesolid)) movesolid.css("top", newtop + "px");
                    changeheight(movesolid, newtop);
                }
            }).mouseup(function () { ismove = false; });
            if (maxlength == 4) {
                var temp = allwidth % 2;
                width = temp == 0 ? (allwidth / 2) : ((allwidth - temp) / 2);
                lastwidth = allwidth - width;
                var temp1 = allheight % 2;
                height = temp1 == 0 ? (allheight / 2) : ((allheight - temp1) / 2);
                lastheight = allheight - height;
                var topdiv = $('<div name="container" style="width:' + allwidth + 'px;height:' + height + 'px;top:0px;position:absolute;background-color:#fff;"></div>').appendTo(screenpanel);
                var midsolid = $('<div name="outsolid" style="width:' + allwidth + 'px;height:3px;top:' + height + 'px;position:absolute;background-color:#ddd;z-index:100"></div>').appendTo(screenpanel);
                midsolid.mousedown(function (e) {
                    ismove = true;
                    movetype = "H";
                    positionY = e.clientY;
                    clientTop = parseFloat($(this).css("top"));
                    movesolid = $(this);
                }).mouseover(function (e) {
                    $(this).css({ "background-color": "#808080", "cursor": "s-resize" });
                }).mouseup(function (e) {
                    ismove = false;
                }).mouseleave(function (e) {
                    $(this).css({ "background-color": "#ddd", "cursor": "default" });
                });
                var bottomdiv = $('<div name="container" style="width:' + allwidth + 'px;height:' + (lastheight - 3) + 'px;top:' + (height + 3) + 'px;position:absolute;background-color:#fff;"></div>').appendTo(screenpanel);
                for (var i = 0; i < maxlength; i++) {
                    var left = width + 3;
                    var currwidth = lastwidth - 3;
                    if (i % 2 == 0) { left = 0; currwidth = width; }
                    var parent = topdiv;
                    if (i >= 2) parent = bottomdiv;
                    var div = $('<div name="mappanel" style="position:absolute;height:100%;"></div>').appendTo(topdiv).appendTo(parent);
                    div.css({ "width": currwidth + "px", "left": left + "px" });
                    if (i % 2 == 0) {
                        var solid = $('<div name="solid" style="width:3px;height:100%;top:' + top + 'px;position:absolute;left:' + width + 'px;background-color:#ddd;"></div>').appendTo(parent);
                        solid.mouseover(function (e) {
                            $(this).css({ "background-color": "#808080", "cursor": "w-resize" });
                        }).mouseleave(function (e) {
                            $(this).css({ "background-color": "#ddd", "cursor": "default" });
                        }).mousedown(function (e) {
                            ismove = true;
                            movetype = "V";
                            positionX = e.clientX;
                            clientLeft = parseFloat($(this).css("left"));
                            movesolid = $(this);
                        }).mouseup(function () {
                            ismove = false;
                        })
                    }
                    mapload(i, div, checklayers[i]);
                    var title = $('<div style="height:35px;line-height:35px;width:100%;position:absolute;left:15px;z-index:10001;top:0px;font-weight:bold;font-size:15px;color:#0099cc">' + checklayers[i].Text + '</div>').appendTo(div);
                }
            }
        }
        function changesize(movesolid, left) {
            var nextall = movesolid.nextAll();
            var preall = movesolid.prevAll();
            prewidth(left, preall);
            nextwidth(left, nextall);
            updatemapsize();
        }
        function changeheight(movesolid, top) {
            var nextnode = movesolid.next();
            var prenode = movesolid.prev();
            var allheigth = Dev.App.FillPanel.Target.height();
            prenode.height(top);
            var prechild = prenode.children();
            for (var i = 0; i < prechild.length; i++) $(prechild[i]).height(top);
            nextnode.css({ "height": (allheigth - top - 3) + "px", "top": (top + 3) + "px" });
            var nextchild = nextnode.children();
            for (var i = 0; i < nextchild.length; i++) $(nextchild[i]).height(allheigth - top - 3);
            updatemapsize();
        }
        function nextwidth(prewidth, nextall) {
            if (dev.IsNull(nextall) || nextall.length == 0) return;
            if (dev.IsNull(prewidth)) prewidth = 0;
            var allwidth = Dev.App.FillPanel.Target.width();
            var nextwidth = allwidth - prewidth - 3;
            //判断有多少个mapdiv,多少个solid;
            var mapdiv = [], soliddiv = [];
            for (var i = 0; i < nextall.length; i++) {
                var name = $(nextall[i]).attr("name");
                if (name == "mappanel") mapdiv.push(nextall[i]);
                if (name == "solid") soliddiv.push(nextall[i]);
            }
            var allmapwidth = nextwidth - (soliddiv.length * 3);
            var temp = allmapwidth % mapdiv.length;
            var mapwidth = ((temp == 0) ? (allmapwidth / mapdiv.length) : ((allmapwidth - temp) / mapdiv.length));
            var lastmapw = allmapwidth - (mapwidth * (mapdiv.length - 1));
            var mapindex = 0, hasw = 0;
            for (var i = 0; i < nextall.length; i++) {
                var name = $(nextall[i]).attr("name");
                var currw;
                if (name == "mappanel") {
                    currw = mapwidth;
                    if (mapindex == mapdiv.length - 1) currw = lastmapw;
                    mapindex++;
                }
                if (name == "solid") currw = 3;
                $(nextall[i]).css({ "width": currw + "px", "left": ((prewidth + 3) + hasw) + "px" });
                hasw += currw;
            }
        }
        function prewidth(width, preall) {
            if (Dev.IsNull(preall) || preall.length == 0 || Dev.IsNull(width) || width == 0) return;
            //判断有多少个mapdiv,有多少个solid
            var mapdiv = []; var soliddiv = [];
            for (var i = 0; i < preall.length; i++) {
                var name = $(preall[i]).attr("name");
                if (name == "mappanel") mapdiv.push(preall[i]);
                if (name == "solid") soliddiv.push(preall[i]);
            }
            var allmapwidth = width - (soliddiv.length * 3);
            var temp = allmapwidth % mapdiv.length;
            var mapwidth = ((temp == 0) ? (allmapwidth / mapdiv.length) : ((allmapwidth - temp) / mapdiv.length));
            var lastmapw = allmapwidth - (mapwidth * (mapdiv.length - 1));
            var mapindex = 0, hasw = 0;
            for (var i = 0; i < preall.length; i++) {
                var name = $(preall[i]).attr("name");
                var currw;
                if (name == "mappanel") {
                    var currw = mapwidth;
                    if (mapindex == 0) currw = lastmapw;
                    mapindex++;
                }
                if (name == "solid") currw = 3;
                hasw += currw;
                $(preall[i]).css({ "width": currw + "px", "left": (width - hasw) + "px" });
            }
        }
        function mapload(index, parent, checklayer) {
            if (Dev.IsNull(parent)) return;
            if (index == 0) {
                screenmap1 = initMap(parent, mapView);
                //添加图层
                addLayer(checklayer, screenmap1);
                var envlop = checklayer.Envelop.split(',');
                var extent = [parseFloat(envlop[0]), parseFloat(envlop[1]), parseFloat(envlop[2]), parseFloat(envlop[3])];
                var mapproj = screenmap1.getView().getProjection();
                if (mapproj.getCode() != Dev.App.Config.SystemMap.DataEPSG) extent = Dev.proj.transformExtent(extent, Dev.App.Config.SystemMap.DataEPSG, mapproj.getCode());
                screenmap1.getView().fit(extent, screenmap1.getSize());
                //初始化图例
                if (!Dev.IsNull(checklayer.SldLegend) && checklayer.SldLegend.length > 0) {
                    var legends = checklayer.SldLegend.clone();
                    legends.unshift({ Text: "全部" });
                    screenlegend1 = new Dev.UCLegend({ Parent: parent });
                    screenlegend1.SetData(legends);
                    screenlegend1.Target.bind("onLegendItemClick", function (s, e) {
                        var newlayer = Dev.ObjClone(checklayer);
                        if (e.Text != "全部") {
                            var slds = Enumerable.From(newlayer.SldLegend).Where('s=>s.ID=="' + e.ID + '" && s.Text=="' + e.Text + '"').ToArray();
                            newlayer.SldLegend = slds;
                        }
                        addLayer(newlayer, screenmap1);
                    });
                }
            }
            if (index == 1) {
                screenmap2 = initMap(parent, mapView);
                addLayer(checklayer, screenmap2);
                var envlop = checklayer.Envelop.split(',');
                var extent = [parseFloat(envlop[0]), parseFloat(envlop[1]), parseFloat(envlop[2]), parseFloat(envlop[3])];
                var mapproj = screenmap1.getView().getProjection();
                if (mapproj.getCode() != Dev.App.Config.SystemMap.DataEPSG) extent = Dev.proj.transformExtent(extent, Dev.App.Config.SystemMap.DataEPSG, mapproj.getCode());
                screenmap1.getView().fit(extent, screenmap1.getSize());
              //  screenmap1.getView().setCenter([(parseFloat(envlop[0]) + parseFloat(envlop[2])) / 2, (parseFloat(envlop[1]) + parseFloat(envlop[3])) / 2]);
                if (!Dev.IsNull(checklayer.SldLegend) && checklayer.SldLegend.length > 0) {
                    var legends = checklayer.SldLegend.clone();
                    legends.unshift({ Text: "全部" });
                    screenlegend2 = new Dev.UCLegend({ Parent: parent });
                    screenlegend2.SetData(legends);
                    screenlegend2.Target.bind("onLegendItemClick", function (s, e) {
                        var newlayer = Dev.ObjClone(checklayer);
                        if (e.Text != "全部") {
                            var slds = Enumerable.From(newlayer.SldLegend).Where('s=>s.ID=="' + e.ID + '" && s.Text=="' + e.Text + '"').ToArray();
                            newlayer.SldLegend = slds;
                        }
                        addLayer(newlayer, screenmap2);
                    });
                }
            }
            if (index == 2) {
                screenmap3 = initMap(parent, mapView);
                addLayer(checklayer, screenmap3);
                var envlop = checklayer.Envelop.split(',');
                var extent = [parseFloat(envlop[0]), parseFloat(envlop[1]), parseFloat(envlop[2]), parseFloat(envlop[3])];
                var mapproj = screenmap1.getView().getProjection();
                if (mapproj.getCode() != Dev.App.Config.SystemMap.DataEPSG) extent = Dev.proj.transformExtent(extent, Dev.App.Config.SystemMap.DataEPSG, mapproj.getCode());
                screenmap1.getView().fit(extent, screenmap1.getSize());
              //  screenmap1.getView().setCenter([(parseFloat(envlop[0]) + parseFloat(envlop[2])) / 2, (parseFloat(envlop[1]) + parseFloat(envlop[3])) / 2]);
                if (!Dev.IsNull(checklayer.SldLegend) && checklayer.SldLegend.length > 0) {
                    var legends = checklayer.SldLegend.clone();
                    legends.unshift({ Text: "全部" });
                    screenlegend3 = new Dev.UCLegend({ Parent: parent });
                    screenlegend3.SetData(legends);
                    screenlegend3.Target.bind("onLegendItemClick", function (s, e) {
                        var newlayer = Dev.ObjClone(checklayer);
                        if (e.Text != "全部") {
                            var slds = Enumerable.From(newlayer.SldLegend).Where('s=>s.ID=="' + e.ID + '" && s.Text=="' + e.Text + '"').ToArray();
                            newlayer.SldLegend = slds;
                        }
                        addLayer(newlayer, screenmap3);
                    });
                }
            }
            if (index == 3) {
                screenmap4 = initMap(parent, mapView);
                addLayer(checklayer, screenmap4);
                var envlop = checklayer.Envelop.split(',');
                var extent = [parseFloat(envlop[0]), parseFloat(envlop[1]), parseFloat(envlop[2]), parseFloat(envlop[3])];
                var mapproj = screenmap1.getView().getProjection();
                if (mapproj.getCode() != Dev.App.Config.SystemMap.DataEPSG) extent = Dev.proj.transformExtent(extent, Dev.App.Config.SystemMap.DataEPSG, mapproj.getCode());
                screenmap1.getView().fit(extent, screenmap1.getSize());
             //   screenmap1.getView().setCenter([(parseFloat(envlop[0]) + parseFloat(envlop[2])) / 2, (parseFloat(envlop[1]) + parseFloat(envlop[3])) / 2]);
                if (!Dev.IsNull(checklayer.SldLegend) && checklayer.SldLegend.length > 0) {
                    var legends = checklayer.SldLegend.clone();
                    legends.unshift({ Text: "全部" });
                    screenlegend4 = new Dev.UCLegend({ Parent: parent });
                    screenlegend4.SetData(legends);
                    screenlegend4.Target.bind("onLegendItemClick", function (s, e) {
                        var newlayer = Dev.ObjClone(checklayer);
                        if (e.Text != "全部") {
                            var slds = Enumerable.From(newlayer.SldLegend).Where('s=>s.ID=="' + e.ID + '" && s.Text=="' + e.Text + '"').ToArray();
                            newlayer.SldLegend = slds;
                        }
                        addLayer(newlayer, screenmap4);
                    });
                }
            }
        }
        var mapconfig = Dev.ObjClone(Dev.App.Config.SystemMap);
        function initMap(parent, view) {
            var map = new Dev.Map({
                controls: new Dev.control.defaults({ zoom: false, rotate: false, attribution: false }),
                interactions: Dev.interaction.defaults().extend([new Dev.interaction.DragRotateAndZoom()]),
                target: parent[0],
                logo: false,
                view: view
            });
            var initExtent = [parseFloat(mapconfig.Extent.XMin), parseFloat(mapconfig.Extent.YMin), parseFloat(mapconfig.Extent.XMax), parseFloat(mapconfig.Extent.YMax)];
            if (Dev.App.Config.SystemMap.DisplayEPSG != Dev.App.Config.SystemMap.DataEPSG) initExtent = Dev.proj.transformExtent(initExtent, Dev.App.Config.SystemMap.DataEPSG, Dev.App.Config.SystemMap.DisplayEPSG);
            map.getView().fit(initExtent, map.getSize());
            map.getView().setZoom(parseInt(mapconfig.Zoom));
            //加载基础图层
            //获取第一个图册
            loadbasicinfo($.extend({ Map: map }, mapconfig));
            //Dev.MapLoad.InitMap($.extend({ Map: map }, mapconfig));
            return map;
        }
        function loadbasicinfo(param) {
            if (Dev.IsNull(param) || Dev.IsNull(param.Map) || Dev.IsNull(param.LayerInfo) || Dev.IsNull(param.LayerInfo.BaseLayers)) return;
            var layerparam = {};
            var baseLayers = param.LayerInfo.BaseLayers;
            if (baseLayers.length == undefined) baseLayers = [param.LayerInfo.BaseLayers];
            for (var i = 0; i < baseLayers.length; i++) {
                var layerparam = { Map: param.Map, ID: baseLayers[i].Name, LayerInfo: baseLayers[i] };
                if (Dev.IsNull(baseLayers[i].Visible)) layerparam.Visible = false;
                else if (Dev.IsBoolean(baseLayers[i].Visible)) layerparam.Visible = baseLayers[i].Visible;
                else layerparam.Visible = baseLayers[i].Visible.toLowerCase() == "true" ? true : false;
                switch (baseLayers[i].Type) {
                    case Dev.LayerType.TileXYZ:
                        layerparam.Url = baseLayers[i].Url;
                        if (!Dev.IsNull(baseLayers[i].Envelop)) {
                            var arr = baseLayers[i].Envelop.split(',');
                            layerparam.Extent = [parseFloat(arr[0]), parseFloat(arr[1]), parseFloat(arr[2]), parseFloat(arr[3])];
                        }
                        $.extend(baseLayers[i], layerparam);
                        if (Dev.App.Config.SystemMap.DisplayEPSG == "EPSG:4326") Dev.MapLoad.AddTileXYZLayer2(baseLayers[i]);
                        else Dev.MapLoad.AddTileXYZLayer3(baseLayers[i]);
                        break;
                }
            }
        }
        function addLayer(layerparam, map) {
            if (!Dev.IsNull(layerparam.LayerType) && layerparam.LayerType == Dev.LayerType.Tile) {
                //显示图层
                var param = {
                    ID: layerparam.Value,
                    Url: Dev.GetSystemUrlByRelID(layerparam.Url),
                    Layers: layerparam.TypeName,
                    Map: map,
                    Resolution: "0.703125",
                    Level: 20
                };
                if (!Dev.IsNull(layerparam.Envelop)) {
                    var arry = layerparam.Envelop.split(',');
                    param.Extent = [parseFloat(arry[0]), parseFloat(arry[1]), parseFloat(arry[2]), parseFloat(arry[3])];
                }
                Dev.MapUtils.RemoveLayer(layerparam.Value, dev.App.Map);
                Dev.MapLoad.AddWMTSLayer(param);
            }
            else {
                //显示图层
                var param = {
                    ID: layerparam.Value,
                    Url: Dev.GetSystemUrlByRelID(layerparam.Url),
                    Layers: layerparam.TypeName,
                    ServerType: layerparam.ServerType,
                    Map: map
                };
                if (!Dev.IsNull(layerparam.Sld)) {
                    var sldbody = Dev.MapUtils.LoadSLD(layerparam.Sld);
                    sldbody = sldbody.replace("%NAME%", layerparam.TypeName);
                    param.Sldbody = sldbody;
                }
                if (!Dev.IsNull(layerparam.SldLegend)) {
                    if (Dev.IsNull(layerparam.SldLegend.length)) layerparam.SldLegend = [layerparam.SldLegend];
                    param.Sldbody = Dev.GetSLDString(layerparam.TypeName, Dev.LegendToRule(layerparam.SldLegend));
                }
                //判断是否已存在
                Dev.MapUtils.RemoveLayer(layerparam.Value, dev.App.Map);
                Dev.MapLoad.AddWMSLayer(param);
            }

        }
        function updatemapsize() {
            if (!Dev.IsNull(screenmap1)) screenmap1.updateSize();
            if (!Dev.IsNull(screenmap2)) screenmap2.updateSize();
            if (!Dev.IsNull(screenmap3)) screenmap3.updateSize();
            if (!Dev.IsNull(screenmap4)) screenmap4.updateSize();
        }

        function getlayertreebyType(type) {
            var layertree = [];
            if (Dev.IsNull(layerconfig)) return null;
            if (Dev.IsNull(layerconfig.length)) layertree = [Dev.ObjClone(layerconfig)];
            else layertree = layerconfig.clone();
            //首先找到根级节点为该类型的
            layertree = Enumerable.From(layertree).Where('s=>s.Type.indexOf("' + type + '")>=0').ToArray();
            getnodebytype(layertree, type);
            return layertree;
        }
        function getnodebytype(nodes, type) {
            if (Dev.IsNull(nodes) || Dev.IsNull(type)) return;
            for (var i = 0; i < nodes.length; i++) {
                if (Dev.IsNull(nodes[i].Child)) continue;
                if (Dev.IsNull(nodes[i].Child.length)) nodes[i].Child = [nodes[i].Child];
                nodes[i].Child = Enumerable.From(nodes[i].Child).Where('s=>s.Type!=undefined && s.Type!=null && s.Type.indexOf("' + type + '")>=0').ToArray();
                if (!Dev.IsNull(nodes[i].Child) && nodes[i].Child.length > 0) getnodebytype(nodes[i].Child, type);
            }
        }
    </script>
</head>
<body style="width: 100%; height: 100%;">
    <div class="content">
        <div class="dev-tree" opt='{"ValueField":"Value","TextField":"Text","ChildrenField":"Child","StateField":"State","CheckBox":true,"Width":300}'></div>
    </div>
</body>
</html>
