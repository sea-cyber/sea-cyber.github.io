<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>轮耕休作编辑</title>
    <link rel="stylesheet" href="../../theme/default/easyui.css" />
    <link rel="stylesheet" type="text/css" href="../../theme/icon.css" />
    <link rel="stylesheet" type="text/css" href="../../css/app.css" />
    <link rel="stylesheet" type="text/css" href="../../css/main.css" />
    <link rel="stylesheet" type="text/css" href="../../css/icon.css" />
    <link type="text/css" href="../../css/dev.css" rel="stylesheet" />
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../js/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="../../js/linq.min.js"></script>
    <script type="text/javascript" src="../../js/data.util.js"></script>
    <script type="text/javascript" src="../../js/dev.ui.js"></script>
    <script type="text/javascript" src="../../js/guid.js"></script>
    <script type="text/javascript" src="../../js/jquery.dev.control.js"></script>
    <style type="text/css">
        .eidtcontent {
            width: 100%;
            height: 100%;
            position: relative;
        }

            .eidtcontent .Row {
                height: 35px;
                width: 100%;
                border-bottom: 1px solid #ddd;
            }

                .eidtcontent .Row .Title {
                    text-align: right;
                    padding-right: 8px;
                }

                .eidtcontent .Row .Cell {
                    height: 100%;
                    width: 340px;
                    display: inline-block;
                    margin-left: 0px;
                    margin-right: 0px;
                    float: left;
                }

                .eidtcontent .Row .PicLeft {
                    width: 24px;
                    height: 24px;
                    position: absolute;
                    left: 0px;
                    top: 67px;
                    background-image: url('../../image/agri/leftbtn.png');
                    background-repeat: no-repeat;
                    background-position: center;
                }

                .eidtcontent .Row .PicRight {
                    width: 24px;
                    height: 24px;
                    position: absolute;
                    right: 0px;
                    top: 67px;
                    background-image: url('../../image/agri/rightbtn.png');
                    background-repeat: no-repeat;
                    background-position: center;
                }

                .eidtcontent .Row .PicAdd {
                    height: 24px;
                    width: 24px;
                    border: 1px solid #95b8e7;
                    top: 5px;
                    right: 35px;
                    position: absolute;
                }

                .eidtcontent .Row .PicDel {
                    height: 24px;
                    width: 24px;
                    border: 1px solid #95b8e7;
                    top: 5px;
                    right: 5px;
                    position: absolute;
                }

            .eidtcontent .Submit {
                width: 150px;
                height: 45px;
                text-align: center;
                float: right;
                margin-right: 20px;
            }

                .eidtcontent .Submit .Button {
                    width: 70px;
                    height: 26px;
                    margin-top: 10px;
                    background-color: #16dbbb;
                    border-radius: 5px;
                    text-align: center;
                    display: inline-block;
                    margin-left: 2px;
                }

                    .eidtcontent .Submit .Button:hover {
                        background-color: #5227de;
                        cursor: pointer;
                    }

                    .eidtcontent .Submit .Button:active {
                        background-color: #210097;
                        cursor: pointer;
                    }
    </style>
    <script type="text/javascript">
        var Dev = window.top.window.dev;
        var parent;
        var orgfilter;
        var framercontrol, framerindex = 1, framersize = 5;//农户相关变量
        var orgfilter, orglist, orgcontrol;//组织机构信息
        var id, isupdate = false;
        var massiffilter;
        var polygonkey;
        var dialog, flashDialog;
        function WidgetCommunication(s) {//部件通讯
            parent = s.parent;
            if (!Dev.IsNull(s.param) && !Dev.IsNull(s.param.orglist)) orglist = s.param.orglist;
            if (!Dev.IsNull(s.param) && !Dev.IsNull(s.param.orgFilter)) orgfilter = s.param.orgFilter;
            if (Dev.IsNull(orgfilter)) orgfilter = "1=1";
            if (!Dev.IsNull(s.param) && !Dev.IsNull(s.param.updateid)) { id = s.param.updateid; isupdate = true; }
            init();
            //  parent.one("onClosing", function () { parent.clear(); });
            flashDialog = new Dev.Messager({ Height: 95, Width: 200, AutoShow: false, Type: "question", Timeout: 1500, ButtonVisible: false, AutoVisible: true, Effect: "normal" });
            parent.clear = function () {
                if (!Dev.IsNull(framercontrol)) {
                    framercontrol.combogrid("setValue", "");
                    framercontrol.combogrid("hidePanel");
                    framercontrol = null;
                }
                if (!Dev.IsNull(massifGrid)) {
                    massifGrid.Target.unbind("onSelectPage");
                    massifGrid.Target.unbind("onClickRow");
                    massifGrid.Target.unbind("onCheck");
                    massifGrid.Target.unbind("onUncheck");
                    massifGrid = null;
                }
                if (!Dev.IsNull(planwin)) {
                    $(".dev-combobox[name='planting']", planwin.Target).prop("$this").unbind("onSelectChanged");
                    clearplanwin();
                    planwin.unbind("onClosing");
                    planwin.Close();
                    planwin.Destroy();
                    planwin = null;
                }
                if (!Dev.IsNull(polyganKey)) { Dev.MapUtils.removePointKey("rotationhightlight1", Dev.App.Map); polyganKey = null; }
                Dev.MapUtils.ClearFeature("tempGraphicLayer", Dev.App.Map);
                xzqcontrol = null;
                rotation_massiflist = null;
                piclist = [];
            }
        }
        //保存数据
        var isok = true;
        function saveinfo() {
            if (!isok) return;
            //轮耕信息表
            $("#emsg").html("");
            var model = {};
            if (isupdate) model.id = id;
            var farmerid = framercontrol.combogrid("getValue");
            if (Dev.IsNull(farmerid)) { $("#emsg").html("请选择农户！"); return; }
            model.farmerid = framercontrol.combogrid("getValue");
            model.orgid = orgcontrol.GetValue();
            //获取所有地块
            if (Dev.IsNull(rotation_massiflist) || rotation_massiflist.length == 0) {
                //判断是否有地块
                var massifdata = massifGrid.DataGrid.datagrid("getData").rows;
                if (massifdata.length == 0) $("#emsg").html("请去地块管理模块添加地块!");
                $("#emsg").html("请选择地块!");
                return;
            }
            var checkmassiflist = Enumerable.From(rotation_massiflist).Where('s=>s.ischecked==true').ToArray();
            if (Dev.IsNull(checkmassiflist) || checkmassiflist.length == 0) { $("#emsg").html("请选择地块!"); return; }
            var farmerrow = framercontrol.combogrid("grid").datagrid("getSelected");
            model.regionsid = farmerrow.regionsid;
            model.province = farmerrow.province;
            model.city = farmerrow.city;
            model.county = farmerrow.county;
            model.town = farmerrow.town;
            model.village = farmerrow.village;
            //总面积和总的补贴金额
            var area = $(".dev-numberbox[name='fallowarea']").prop("$this").GetValue();
            model.fallowarea = area;
            var subsidy = $('.dev-numberbox[name="subsidy"]').prop("$this").GetValue();
            model.subsidy = subsidy;
            //合同图片
            if (piclist.length == 0) {
                $("#emsg").html("至少上传一张图片！");
                return;
            }
            if (isupdate) {
                model.attid = $(".imgviewer").attr("attid");
                var newpiclist = [];
                for (var i = 0; i < piclist.length; i++) {
                    if (piclist[i].isupdate) continue;
                    piclist.folderid = model.attid;
                    newpiclist.push(piclist[i]);
                }
                piclist = newpiclist;
            }
            //合同签订日期
            var contractstarttime = $("#compectBTime").datetimebox("getValue");
            if (Dev.IsNull(contractstarttime)) { $("#emsg").html("请选择合同签订日期！"); return; }
            model.contractstarttime = new Date(contractstarttime.replace(/-/g, "/")).getTime();
            var contractendtime = $("#compectETime").datetimebox("getValue");
            if (Dev.IsNull(contractendtime)) { $("#emsg").html("请选择合同失效时间！"); return; }
            model.contractendtime = new Date(contractendtime.replace(/-/g, "/")).getTime();
            //判断开始时间大于结束时间
            if (model.contractstarttime > model.contractendtime) { $("#emsg").html("合同签订日期不能大于合同失效日期！"); return; }
            if (model.contractstarttime == model.contractendtime) { $("#emsg").html("合同签订日期不能等于合同失效日期！"); return; }
            var massiflinklist = [];
            var rulelist = [];
            for (var i = 0; i < checkmassiflist.length; i++) {
                var checkmassifmodel = {};
                $.each(checkmassiflist[i], function (o, e) {
                    if (o != "ischecked") {
                        if (o == "rules" && !Dev.IsNull(e)) {
                            var rules = e;
                            for (var j = 0; j < rules.length; j++) rulelist.push({ massifid: checkmassiflist[i].massifid, year: rules[j].year, mouth: rules[j].mouth, type: rules[j].crop, effective: '1' });
                        }
                        else checkmassifmodel[o] = e;
                    }
                });
                massiflinklist.push(checkmassifmodel);
            }
            var url = Dev.GetSystemUrlByRelID("Service") + "rotationfallow/addro";
            var data = { rEntity: model, mList: massiflinklist, rList: rulelist, fList: piclist };
            if (isupdate) {
                url = Dev.GetSystemUrlByRelID("Service") + "rotationfallow/updatero";
                data.deleteId = delids;
            }
            isok = false;
            $.ajax({
                data: JSON.stringify(data),
                url: url,
                type: "POST",
                contentType: 'application/json',
                dataType: 'json',
                success: function (result) {
                    if (isupdate) {
                        $(".imgviewer").removeAttr("attid");
                        framercontrol.prop("linkdata", null);
                        massifGrid.Target.removeAttr("isupdateload");
                        isupdate = false;

                        flashDialog.Alert("保存成功！", { Type: "success" });
                    }
                    parent.Close();
                    isok = true;
                },
                error: function (msg) {
                    isok = true;
                    flashDialog.Alert("网络超时，请稍后再试！", { Type: "error" });
                }
            });
        }
        function init() {
            initframer();
            initmassif();
            initorg();
            // initxzq();
            //初始化日期
            $("#compectBTime").datebox({
                width: 255, height: 26, panelWidth: 255,
                onSelect: function (date) { $("#compectETime").datebox("validate"); }
            }).datebox('calendar').calendar({//链式后不能返回control
                validator: function (date) {
                    return date <= new Date(); //签订日期必须早于当天
                }
            });
            $("#compectETime").datebox({
                width: 245, height: 26, panelWidth: 255,
                onSelect: function (date) { $("#compectBTime").datebox("validate"); }
            });
            $.extend($.fn.validatebox.defaults.rules, {
                startCheck: {
                    validator: function (value, param) {
                        var dateStr = $(param[0]).datebox("getValue");
                        if (Dev.IsNullAll(dateStr)) { return true; }
                        var date = new Date(dateStr.replace(/-/g, "/"));
                        date.setFullYear(date.getFullYear() - 1);
                        return new Date(value.replace(/-/g, "/")) <= date;
                    },
                    message: '合同时间必须大于一年！'
                },
                endCheck: {
                    validator: function (value, param) {
                        var dateStr = $(param[0]).datebox("getValue");
                        if (Dev.IsNullAll(dateStr)) { return true; }
                        var date = new Date(dateStr.replace(/-/g, "/"));
                        date.setFullYear(date.getFullYear() + 1);
                        return new Date(value.replace(/-/g, "/")) >= date;
                    },
                    message: '合同时间必须大于一年！'
                }

            });
            initimg();
            $(".Button").click(function () {
                var tag = $(this).attr("tag");
                if (tag == "save") saveinfo();
                if (tag == "cancel") { parent.clear(); parent.Close(); }
            });
            if (isupdate) loadupdate();
            searchResetFer();       //保证每次打开是 初始化的状态
        }
        //初始化农户信息
        function initframer() {
            framercontrol = $("#farmerinfo");
            framercontrol.combogrid({
                idField: 'id',
                textField: 'name',
                columns: [[
                    { field: 'name', title: '姓名', width: 70, align: 'center' },
                    { field: 'cardid', title: '身份证', align: 'center', width: 120 },
                    { field: 'mobilephone', title: '电话号码', align: 'center', width: 80 },
                    { field: 'cultivated', title: '耕地面积', align: 'center', width: 80 },
                    { field: 'address', title: '详细地址', align: 'center', width: 93,hidden:true },
                    {
                        field: 'province', title: '地区', align: 'center',formatter: function (value, row, index) {
                            var address_xzq="";
                            if (!Dev.IsNullAll(row.province)) address_xzq += row.province + " ";
                            if (!Dev.IsNullAll(row.city)) address_xzq += row.city + " ";
                            if (!Dev.IsNullAll(row.county)) address_xzq += row.county + " ";
                            if (!Dev.IsNullAll(row.town)) address_xzq += row.town + " ";
                            if (!Dev.IsNullAll(row.village)) address_xzq += row.village + " ";
                            return address_xzq;
                        }
                    }
                ]],
                width: 255,
                height: 26,
                panelWidth: 445,
                panelHeight: 221,
                pagination: true,
                toolbar: $("#toobarFarmer"),
                onSelect: function (s, e) {
                    if (dev.IsNull(e)) return;
                    var framerid = e.id;
                    $(".massifselect").css("display", "block");
                    if (!Dev.IsNull(massifGrid)) { massifGrid.ClearSearchFilter(); massiffilter = null; }
                    $(".dev-numberbox[name='fallowarea']").prop("$this").SetValue("");
                    $(".dev-numberbox[name='subsidy']").prop("$this").SetValue("");
                    initmassif(framerid);
                }
            });
            var machinepage = framercontrol.combogrid("grid").datagrid("getPager");
            var parampage = {
                showPageList: false,
                showRefresh: false,
                pageNumber: framerindex,
                pageSize: framersize,
                onSelectPage: function (index, size) {
                    framerindex = index;
                    getframer();
                }
            };
            machinepage.pagination(parampage);
            if (!isupdate) getframer();
            searchTbFnameControl = $('#FnameSearch', framercontrol.combogrid("panel")).prop("$this");
            searchTbFidControl = $('#FidSearch', framercontrol.combogrid("panel")).prop("$this");
            searchTbFtelControl = $('#FtelSearch', framercontrol.combogrid("panel")).prop("$this");
            $("#Fersearch", framercontrol.combogrid("panel")).click(function () {
                searchTbFer();
            });
            $("#Fercreset", framercontrol.combogrid("panel")).click(function () {
                searchResetFer();
            });
        }
        function getframer() {
            if (dev.IsNull(framercontrol)) return;
            var con = orgfilter.concat();
            if (!Dev.IsNull(searchTbFilterFer)) con += "AND " + searchTbFilterFer;
            $.ajax({
                url: Dev.GetSystemUrlByRelID("Service") + "farmer/getbyfilter/" + framerindex + "/" + framersize,
                type: "POST",
                contentType: 'application/json',
                dataType: 'json',
                data: con,
                async: false,
                success: function (result) {
                    framercontrol.combogrid("grid").datagrid("loadData", result.data.dataSource);
                    var page = framercontrol.combogrid("grid").datagrid("getPager");
                    page.pagination('refresh', { total: result.data.pageInfo.totalCount, pageNumber: result.data.pageInfo.pageIndex, displayMsg: "当前页显示第" + (((result.data.pageInfo.pageIndex - 1) * result.data.pageInfo.pageSize) + 1) + "-" + (result.data.pageInfo.pageIndex * result.data.pageInfo.pageSize) + "条记录,共{total}条数据" });
                }
            });
        }
        function getfarmerbyid(id) {
            if (Dev.IsNull(id)) return;
            $.ajax({
                url: Dev.GetSystemUrlByRelID("Service") + "farmer/getbyid/" + id + "?" + new Date().getTime(),
                type: "GET",
                contentType: 'application/json',
                dataType: 'json',
                async: false,
                success: function (result) {
                    var r_data = [];
                    if (!Dev.IsNull(result)) r_data = [result.data];
                    framercontrol.combogrid("grid").datagrid("loadData", r_data);
                    var page = framercontrol.combogrid("grid").datagrid("getPager");
                    page.pagination('refresh', { total: 1, pageNumber: 1, displayMsg: "当前页显示第1-5条记录,共{total}条数据" });
                }
            });
        }
        //初始化组织机构
        function initorg() {
            if (Dev.IsNull(orgcontrol)) {
                orgcontrol = new Dev.Combotree({
                    Required: true, PopupHeight: 120, TipInfo: "请选择",
                    MultiSelect: false, StateField: "State", ValueField: "id",
                    TextField: "name", ChildrenField: "child", Height: 26, Border: "1px", Width: 245, Padding: "0px 5px", PopupHeight: 'auto'
                });
                $("#orgcombotree").append(orgcontrol.Target);
                orgcontrol.Layout();
            }
            if (Dev.IsNull(orglist)) orglist = [];
            orgcontrol.SetData(orglist);
        }
        //初始化图片
        var piclist = [];
        var delids = [];
        function initimg() {
            $('.ImgBtn').css("display", "none");
            $(".imgviewer").mouseover(function () {
                $('.ImgBtn').css("display", "block");
            }).mouseleave(function () {
                $('.ImgBtn').css("display", "none");
            });
            $("#picview").click(function () {
                if (piclist.length == 0) return;
                var previewimg = [];
                for (var i = 0; i < piclist.length; i++) previewimg.push(piclist[i].path);
                Dev.PreViewPics(previewimg);
            });
            $("input[name='devfile']").change(function (s, e) {
                var files = $(this)[0].files;
                if (Dev.IsNull(files) || files.length == 0) return;
                //上传到服务
                var imgfrom = new FormData();
                var ispic = true;
                for (var i = 0; i < files.length; i++) {
                    //过滤掉非图片的文件
                    var filename = files[i].name;
                    var file_ex = filename.substr(filename.lastIndexOf('.'));
                    if (file_ex.toUpperCase() == ".PNG" || file_ex.toUpperCase() == ".GIF" || file_ex.toUpperCase() == ".JPG" || file_ex.toUpperCase() == ".JPEG") imgfrom.append("devfile", files[i]);
                    else ispic = false;
                }
                //判断是否继续获取放弃
                if (!ispic) {
                    if (Dev.IsNull(dialog)) dialog = new Dev.Messager({ AutoShow: false, Type: "question" });
                    dialog.Confirm('您上传了非图片文件,是否确认继续上传（非图片格式文件将不上传）？', function (r) {
                        if (!r) return;
                        uploadimg(imgfrom);
                    });
                }
                else uploadimg(imgfrom);
            });
            $(".ImgBtn").click(function () {
                if ($(this).hasClass("PicAdd")) {
                    $("input[name='devfile']").click();
                }
                else {
                    if (piclist.length == 0) return;
                    var currfile = $(".imgviewer").prop("bg_file");
                    if (dev.IsNull(currfile)) return;
                    var index = Enumerable.From(piclist).IndexOf(currfile);
                    if (index < 0) return;
                    var showindex = -1;
                    if ($(this).hasClass("PicDel")) {
                        //移除图片
                        if (currfile.isupdate) delids.push(currfile.id);
                        piclist.splice(index, 1);
                        if (piclist.length > 0) showindex = piclist.length - 1;
                    }
                    if ($(this).hasClass("PicLeft")) {
                        if (index == 0) return;
                        showindex = index - 1;
                    }
                    if ($(this).hasClass("PicRight")) {
                        if (index >= piclist.length - 1) return;
                        showindex = index + 1;
                    }
                    if (showindex == -1) {
                        $("#picview").css({ "background-image": "" });
                        $(".imgviewer").prop("bg_file", null);
                        $("#picview").attr("title", "");
                    }
                    else {
                        $("#picview").css({ "background-image": "url(" + piclist[showindex].path + ")" });
                        $("#picview").attr("title", "点击预览");
                        $(".imgviewer").prop("bg_file", piclist[showindex]);
                    }
                    $("#pictip").html((showindex + 1) + "/" + piclist.length);
                }
            });
        }
        //上传图片
        function uploadimg(imgfrom) {
            if (Dev.IsNull(imgfrom)) return;
            $.ajax({
                type: 'post',
                url: Dev.GetSystemUrlByRelID("Service") + "file/upload",
                data: imgfrom,
                contentType: false,
                processData: false,
                success: function (response) {
                    $("input[name='devfile']")[0].value = '';
                    if (response.statusCode != 200 || Dev.IsNull(response.data)) return;
                    for (var i = 0; i < response.data.length; i++) piclist.push(response.data[i]);
                    //加载最后一个文件
                    if (piclist.length == 0) return;
                    $("#pictip").html(piclist.length + "/" + piclist.length);
                    $("#picview").css({ "background-image": "url(" + piclist[piclist.length - 1].path + ")" });
                    $("#picview").attr("title", "点击预览");
                    $(".imgviewer").prop("bg_file", piclist[piclist.length - 1]);
                }
            });
        }
        //初始化地块
        var massifGrid, massifIndex = 1, massifSize = 5;
        var planwin;
        function initmassif(framerid) {
            rotation_massiflist = [];
            massifIndex = 1;
            if (Dev.IsNull(massifGrid)) {
                var columns = [
                   { field: "ck", width: 30, align: 'center', title: '勾选', sortable: false, checkbox: true },
                   {
                       field: "imgflag", width: 30, align: 'center', title: '', sortable: false, formatter: function (value, row, index) {
                           var charasci = 65 + index;
                           return '<div style="margin-left:10px; width: 20px; height:20px; background-image: url(' + Dev.App.Root + 'image/marker.png);color:#fff;text-align:center;line-height:14px;"><span>' + String.fromCharCode(charasci) + '</span></div>';
                       }
                   },
                   { field: "massifid", width: 75, align: 'center', title: '地块编号', sortable: false },
                   { field: "classname", width: 75, align: 'center', title: '地类名称', sortable: false },
                   { field: "ownership", width: 75, align: 'center', title: '权属性质', sortable: false },
                   { field: "farmlandtype", width: 55, align: 'center', title: '基本农田类型', sortable: false },
                   {
                       field: "farmlandarea", width: 60, align: 'center', title: '基本农田面积(亩)', sortable: false, formatter: function (value, row, index) {
                           return Dev.SqrtMetersToMu(value);
                       }
                   },
                ];
                massifGrid = new UCDataGrid(Dev, {
                    PageIndex: massifIndex, PageSize: massifSize, RowNumbers: false, ID: "massifGrid", pagequery: true, TextPrompt: "输入地块编号、名称、权属性质"
                });
                $("#massifgrid").append(massifGrid.Target);
                massifGrid.Layout(columns);
                massifGrid.Target.bind("onSelectPage", function (s, e) {
                    massifIndex = e.index;
                    var framerid = framercontrol.combogrid("grid").datagrid("getSelected").id;
                    getmassif(framerid);
                });
                massifGrid.Target.bind("onClickRow", function (s, e) {
                    var row = e.Row;
                    highlight(row);
                });
                massifGrid.Target.bind("onCheckAll", function (s, e) {
                    //判断所有选中的里面有方案的能选中，没有方案的不能选中
                    var rows = e.Rows;
                    if (Dev.IsNull(rows) || rows.length == 0) return;
                    for (var i = 0; i < rows.length; i++) {
                        var crow = rows[i];
                        var currrowdata = Enumerable.From(rotation_massiflist).Where('s=>s.massifid=="' + crow.massifid + '"').FirstOrDefault();
                        if (Dev.IsNull(currrowdata)) {
                            //当前行的数据进行不选中
                            var alldata = massifGrid.DataGrid.datagrid("getData");
                            var index = Enumerable.From(alldata.rows).IndexOf(crow);
                            if (index >= 0) massifGrid.DataGrid.datagrid("uncheckRow", index);
                        }
                        else {
                            var index = Enumerable.From(rotation_massiflist).IndexOf(currrowdata);
                            rotation_massiflist[index].ischecked = true;
                        }
                    }
                    var areavsubsiy = getareaandsubsidy();
                    $(".dev-numberbox[name='fallowarea']").prop("$this").SetValue(areavsubsiy[0]);
                    $(".dev-numberbox[name='subsidy']").prop("$this").SetValue(areavsubsiy[1]);
                });
                massifGrid.Target.bind("onUncheckAll", function (s, e) {
                    var rows = e.Rows;
                    if (Dev.IsNull(rows) || rows.length == 0) return;
                    for (var i = 0; i < rows.length; i++) {
                        var crow = rows[i];
                        var currrowdata = Enumerable.From(rotation_massiflist).Where('s=>s.massifid=="' + crow.massifid + '"').FirstOrDefault();
                        if (Dev.IsNull(currrowdata)) continue;
                        var index = Enumerable.From(rotation_massiflist).IndexOf(currrowdata);
                        rotation_massiflist[index].ischecked = false;
                    }
                    var areavsubsiy = getareaandsubsidy();
                    $(".dev-numberbox[name='fallowarea']").prop("$this").SetValue(areavsubsiy[0]);
                    $(".dev-numberbox[name='subsidy']").prop("$this").SetValue(areavsubsiy[1]);
                })
                massifGrid.Target.bind("onCheck", function (s, e) {
                    var isStartTime = $("#compectBTime").datebox("isValid");
                    var isEndTime = $("#compectETime").datebox("isValid");
                    var startTime = $("#compectBTime").datebox("getValue");
                    var endTime = $("#compectETime").datebox("getValue");
                    if (!isStartTime || !isEndTime || Dev.IsNull(startTime) || Dev.IsNull(endTime)) {
                        flashDialog.Alert("请先确认合同日期!", { Type: "info" });
                        massifGrid.DataGrid.datagrid("uncheckRow", e.index);
                        return;
                    }
                    //判断是否已经提交过合同
                    var is_tag = massifGrid.Target.attr("isupdateload");
                    if (!Dev.IsNull(is_tag) && is_tag) { massifGrid.Target.removeAttr("isupdateload"); return; }
                    var row = e.Row;
                    initplanWin(row);
                });
                massifGrid.Target.bind("onUncheck", function (s, e) {
                    var row = e.Row;
                    if (Dev.IsNull(rotation_massiflist) || rotation_massiflist.length == 0) return;
                    var currrowdata = Enumerable.From(rotation_massiflist).Where('s=>s.massifid=="' + row.massifid + '"').FirstOrDefault();
                    if (Dev.IsNull(currrowdata)) return;
                    var index = Enumerable.From(rotation_massiflist).IndexOf(currrowdata);
                    rotation_massiflist[index].ischecked = false;
                    var areavsubsiy = getareaandsubsidy();
                    //显示补贴金额和总面积
                    $(".dev-numberbox[name='fallowarea']").prop("$this").SetValue(areavsubsiy[0]);
                    $(".dev-numberbox[name='subsidy']").prop("$this").SetValue(areavsubsiy[1]);
                    //rotation_massiflist = Enumerable.From(rotation_massiflist).Where('s=>s.massifid!="' + row.id + '"').ToArray();
                });
                massifGrid.Target.bind("onSearchClick", function (s, e) {
                    massiffilter = "";
                    var value = $.trim(e.value);
                    if (!Dev.IsNull(value))
                        massiffilter = " ( \"MASSIFID\" LIKE '%" + value + "%' OR \"CLASSNAME\" LIKE '%" + value + "%' OR \"OWNERSHIP\" LIKE '%" + value + "%')";
                    massifGrid.DataGrid.datagrid('getPager').pagination('select', 1);
                });
                massifGrid.Resize(679, 181);
            }
            getmassif(framerid);
        }
        function getmassif(framerid) {
            if (Dev.IsNull(framerid)) { massifGrid.Load([], { totalCount: 0, pageIndex: massifIndex, pageSize: massifSize, pageCount: 0 }); return; }
            if (!Dev.IsNull(polyganKey)) { Dev.MapUtils.removePointKey("rotationhightlight1", Dev.App.Map); polyganKey = null; }
            var con = "1=1 AND \"CLASSNAME\"='耕地'";
            if (!Dev.IsNull(massiffilter)) con += " AND " + massiffilter;
            var param = { condition: con };
            if (isupdate && !dev.IsNull(id)) param.rotationId = id;
            $.ajax({
                url: Dev.GetSystemUrlByRelID("Service") + 'massif/query/rotation/' + massifIndex + '/' + massifSize + "/" + framerid,
                type: "POST",
                //contentType: 'application/json',
                dataType: 'json',
                data: param,
                success: function (result) {
                    if (result.statusCode != 200 || Dev.IsNull(result.data)) {
                        massifGrid.Load([], { totalCount: 0, pageIndex: massifIndex, pageSize: massifSize, pageCount: 0 });
                        return;
                    }
                    result.data.dataSource = convertData(result.data.dataSource);
                    massifGrid.Load(result.data.dataSource, result.data.pageInfo);
                    showpageblocks(result.data.dataSource);//显示当前页图形
                    if (isupdate) {
                        var linkdata = framercontrol.prop("linkdata");
                        if (Dev.IsNull(linkdata) || linkdata.length == 0) return;
                        for (var i = 0; i < linkdata.length; i++) {
                            var cdata = Enumerable.From(result.data.dataSource).Where('s=>s.massifid=="' + linkdata[i].massifid + '"').FirstOrDefault();
                            if (Dev.IsNull(cdata)) continue;
                            var index = Enumerable.From(result.data.dataSource).IndexOf(cdata);
                            if (index >= 0) {
                                massifGrid.Target.attr("isupdateload", true);
                                massifGrid.DataGrid.datagrid("checkRow", index);
                            }
                        }
                    }
                    if (!Dev.IsNull(rotation_massiflist) && rotation_massiflist.length > 0) {
                        for (var i = 0; i < rotation_massiflist.length; i++) {
                            var cdata = Enumerable.From(result.data.dataSource).Where('s=>s.massifid=="' + rotation_massiflist[i].massifid + '"').FirstOrDefault();
                            if (Dev.IsNull(cdata)) continue;
                            var index = Enumerable.From(result.data.dataSource).IndexOf(cdata);
                            if (index >= 0) { massifGrid.Target.attr("isupdateload", true); massifGrid.DataGrid.datagrid("checkRow", index); }
                        }
                    }
                },
                error: function () {
                    massifGrid.Load([], { totalCount: 0, pageIndex: massifIndex, pageSize: massifSize, pageCount: 0 });
                }
            });
        }
        //初始化方案窗体
        var rotation_massiflist;
        function initplanWin(data) {
            if (Dev.IsNull(data)) return;
            if (Dev.IsNull(planwin)) {
                var content = $('<div style="height:100%;width:100%;background-color:red;position:relative;"></div>');
                planwin = new Dev.Window({
                    ID: "planWin",
                    IconCls: 'icon-setup',
                    Title: "方案配置",
                    Parent: Dev.App.FillPanel.Target,
                    Maximizable: false,
                    Modal: true,
                    Draggable: true,
                    HAlign: 'center',
                    VAlign: 'center',
                    Resizable: false,
                    Content: $(".MassifPlanEdit"),
                    Height: 177,
                    Width: 400
                });
                planwin.bind("onClosing", function () {
                    var issave = planwin.Target.prop("issave");
                    if (!issave) {
                        var currdata = planwin.Target.prop("rowdata");
                        var alldata = massifGrid.DataGrid.datagrid("getData");
                        var index = Enumerable.From(alldata.rows).IndexOf(currdata);
                        if (index >= 0) massifGrid.DataGrid.datagrid("uncheckRow", index);
                    }
                    else { planwin.Target.prop("issave", false); }
                    clearplanwin();
                });
                //加载数据
                var plantcontrol = $(".dev-combobox[name='planting']", $(".MassifPlanEdit", Dev.App.FillPanel.Target)).prop("$this");
                plantcontrol.SetSelectedIndex(0);
                plantcontrol.bind("onSelectChanged", function () {
                    planindex = 1;
                    plancontrol.combogrid("setValue", "");
                    getplan();
                });
                inittype();
                initplan();
                //保存点击
                $("#savebtn", planwin.Target).click(function () {
                    $("#errormsg", planwin.Target).html("");
                    planwin.Target.prop("issave", true);
                    //获取地块信息
                    var massifinfo = planwin.Target.prop("rowdata");
                    //获取轮耕地块关联表
                    var rvmmodel = { massifid: massifinfo.massifid };
                    //这个时候方案对应的规则表也要进行保存
                    var defualtcontrol = $('div[tag="inputcontrol"]', planwin.Target);
                    for (var i = 0; i < defualtcontrol.length; i++) {
                        var name = $(defualtcontrol[i]).attr("name");
                        var value = $(defualtcontrol[i]).prop("$this").GetValue();
                        if ($(defualtcontrol[i]).hasClass("dev-numberbox")) {
                            if (Dev.IsNull(value)) value = 0;
                            else value = parseFloat(value);
                        }
                        rvmmodel[name] = value;
                    }
                    if (rvmmodel.type == "休耕") rvmmodel.planting = null;
                    if (rvmmodel.type == "轮耕") rvmmodel.fallowreason = null;
                    //获取选中方案编号
                    rvmmodel.programmeid = plancontrol.combogrid("getValue");
                    rvmmodel.rules = getrulebyplanid(rvmmodel.programmeid, rvmmodel.planting);
                    rvmmodel.ischecked = true;
                    var vdata = verifinfo(rvmmodel);
                    if (!vdata.isok) {
                        $("#errormsg", planwin.Target).html(vdata.msg);
                        return;
                    }
                    //根据地块编号判断是否已存在没有存在则push,存在则替换掉
                    var cmo = Enumerable.From(rotation_massiflist).Where('s=>s.massifid=="' + massifinfo.massifid + '"').FirstOrDefault();
                    if (Dev.IsNull(cmo)) rotation_massiflist.push(rvmmodel);
                    else {
                        var cindex = Enumerable.From(rotation_massiflist).IndexOf(cmo);
                        rotation_massiflist[cindex] = rvmmodel;
                    }
                    var areavsubsiy = getareaandsubsidy();
                    //显示补贴金额和总面积
                    $(".dev-numberbox[name='fallowarea']").prop("$this").SetValue(areavsubsiy[0]);
                    $(".dev-numberbox[name='subsidy']").prop("$this").SetValue(areavsubsiy[1]);
                    planwin.Close();
                });
                //取消点击
                $("#cancelbtn", planwin.Target).click(function () {
                    planwin.Target.prop("issave", false);
                    planwin.Close();
                });
            }
            else {
                planindex = 1;
                getplan();
                planwin.Open();
            }
            //加载地块面积
            $('.dev-numberbox[name="massifarea"]', planwin.Target).prop("$this").SetValue(Dev.SqrtMetersToMu(data.farmlandarea));
            //判断该地块数据是否存在
            if (!Dev.IsNull(rotation_massiflist) && rotation_massiflist.length > 0) {
                var currotation = Enumerable.From(rotation_massiflist).Where('s=>s.massifid=="' + data.massifid + '"').FirstOrDefault();
                if (!Dev.IsNull(currotation)) loadplanwindata(currotation);
            }
            planwin.Target.prop("rowdata", data);
        }
        //初始化方案类型
        function inittype() {
            var type_jequery = $('#rotationtype', $(".MassifPlanEdit", Dev.App.FillPanel.Target));
            var typecontrol = type_jequery.prop("$this");
            typecontrol.bind("onSelectChanged", function (s, e) {
                if (e == "轮作") {
                    $(".rotation", $(".MassifPlanEdit", Dev.App.FillPanel.Target)).css("display", "block");
                    $(".fallow", $(".MassifPlanEdit", Dev.App.FillPanel.Target)).css("display", "none");
                    //判断种植方式是否选择
                }
                if (e == "休耕") {
                    $(".rotation", $(".MassifPlanEdit", Dev.App.FillPanel.Target)).css("display", "none");
                    $(".fallow", $(".MassifPlanEdit", Dev.App.FillPanel.Target)).css("display", "block");
                    $(".Rules", $(".MassifPlanEdit", Dev.App.FillPanel.Target)).css("display", "none");
                }
            })
            typecontrol.SetSelectedIndex(0);
        }
        //初始化方案
        var plancontrol, planindex = 1, plansize = 5;
        function initplan() {
            plancontrol = $("#planinfo", $(".MassifPlanEdit", Dev.App.FillPanel.Target));
            plancontrol.combogrid({
                idField: 'id',
                textField: 'programmename',
                columns: [[

                       { field: 'programmename', title: '方案名称', width: 140, align: 'center' },
                       { field: 'programmecontent', title: '方案内容', align: 'center', width: 240 },
                ]],
                width: 119,
                height: 26,
                panelWidth: 400,
                panelHeight: 183,
                pagination: true
            });
            var planpage = plancontrol.combogrid("grid").datagrid("getPager");
            var parampage = {
                showPageList: false,
                showRefresh: false,
                pageNumber: planindex,
                pageSize: plansize,
                onSelectPage: function (index, size) {
                    planindex = index;
                    getplan();
                }
            };
            planpage.pagination(parampage);
            getplan();
        }
        function getplan() {
            var model = {};
            var type = $(".dev-combobox[name='planting']", planwin.Target).prop("$this").GetValue();
            model.type = type;
            var startTimeArr = $("#compectBTime").datebox("getValue").split("-");
            var endTimeArr = $("#compectETime").datebox("getValue").split("-");
            var startTime = startTimeArr[0];
            if (type == "一年多熟") { startTime += startTimeArr[1]; }
            model.startTime = startTime;
            var endTime = endTimeArr[0];
            if (type == "一年多熟") { endTime += endTimeArr[1]; }
            model.endTime = endTime;
            var orgid = orgcontrol.GetValue();//获取组织id
            model.orgid = orgid;
            $.ajax({
                url: Dev.GetSystemUrlByRelID("Service") + 'programme/findPagebyParams/' + planindex + '/' + plansize,
                type: "POST",
                contentType: 'application/json',
                dataType: 'json',
                data: JSON.stringify(model),
                success: function (result) {
                    plancontrol.combogrid("grid").datagrid("loadData", result.data.dataSource);
                    var page = plancontrol.combogrid("grid").datagrid("getPager");
                    page.pagination('refresh', { total: result.data.pageInfo.totalCount, pageNumber: result.data.pageInfo.pageIndex, displayMsg: "显示第" + (((result.data.pageInfo.pageIndex - 1) * result.data.pageInfo.pageSize) + 1) + "-" + (result.data.pageInfo.pageIndex * result.data.pageInfo.pageSize) + "条记录,共{total}条数据" });
                }
            });
        }
        //加载方案窗体数据
        function loadplanwindata(model) {
            if (Dev.IsNull(model)) return;
            var defualtcontrol = $('div[tag="inputcontrol"]', planwin.Target);
            for (var i = 0; i < defualtcontrol.length; i++) {
                var name = $(defualtcontrol[i]).attr("name");
                $(defualtcontrol[i]).prop("$this").SetValue(model[name]);
            }
            if (!Dev.IsNull(plancontrol)) {
                //查询当前记录
                $.ajax({
                    url: Dev.GetSystemUrlByRelID("Service") + 'programme/getbyid/' + model.programmeid + "?" + new Date().getTime(),
                    type: "Get",
                    contentType: 'application/json',
                    dataType: 'json',
                    async: false,
                    success: function (result) {
                        if (Dev.IsNull(result)) return;
                        var c_data = result.data;
                        var griddata = plancontrol.combogrid("grid").datagrid("getData").rows;
                        griddata.splice(0, 1, c_data);
                        plancontrol.combogrid("grid").datagrid("loadData", griddata);
                    }
                });
                plancontrol.combogrid("setValue", model.programmeid);

            }
        }
        //清空方案窗体
        function clearplanwin() {
            $("#errormsg", planwin.Target).html("");
            var type_jequery = $('#rotationtype', planwin.Target);
            var typecontrol = type_jequery.prop("$this");
            typecontrol.SetSelectedIndex(0);
            $(".dev-combobox[name='planting']", planwin.Target).prop("$this").SetSelectedIndex(0);
            var textcontrol = $('.dev-textbox', planwin.Target);
            var numbercontrol = $('.dev-numberbox', planwin.Target);
            for (var i = 0; i < textcontrol.length; i++) $(textcontrol[i]).prop("$this").Clear();
            for (var i = 0; i < numbercontrol.length; i++) $(numbercontrol[i]).prop("$this").Clear();
            plancontrol.combogrid("setValue", "");
            plancontrol.combogrid("hidePanel");
            planindex = 1;
        }
        //加载修改数据
        function loadupdate() {
            var linkdata;
            $.ajax({
                url: Dev.GetSystemUrlByRelID("Service") + "rotationfallow/querybyid/" + id,
                type: "GET",
                contentType: 'application/json',
                dataType: 'json',
                async: false,
                success: function (result) {//0 本身、1 地块关联表、2 规则表、3 文件表
                    linkdata = result.data;
                }
            });
            //加载数据
            if (Dev.IsNull(linkdata)) return;
            var rotationmodel = linkdata[0];
            var rotationlink = linkdata[1];
            var massifrules = linkdata[2];
            var imgfiles = linkdata[3];
            if (isupdate) {
                getfarmerbyid(rotationmodel.farmerid);
                framercontrol.combogrid("grid").datagrid("selectRow", 0);
                framercontrol.combogrid("readonly", true);//设置为只读
            }
            else framercontrol.combogrid("setValue", rotationmodel.farmerid);//加载农户 
            //查询当前农户信息
            orgcontrol.SetValueEx(rotationmodel.orgid); //加载组织机构
            // loadxzqnode(rotationmodel.regionsid, rotationmodel);//加载行政区
            //加载对应农户所属地块
            var framerdata = framercontrol.combogrid("grid").datagrid("getData");
            var currdata = Enumerable.From(framerdata.rows).Where('s=>s.id=="' + rotationmodel.farmerid + '"').FirstOrDefault();
            if (!Dev.IsNull(currdata)) {
                var index = Enumerable.From(framerdata.rows).IndexOf(currdata);
                if (index >= 0) framercontrol.combogrid("grid").datagrid("selectRow", index);
                framercontrol.prop("linkdata", rotationlink);
            }
            else massifGrid.Load([], { totalCount: 0, pageIndex: massifIndex, pageSize: massifSize, pageCount: 0 });
            rotation_massiflist = [];
            for (var i = 0; i < rotationlink.length; i++) {
                var currmodel = rotationlink[i];
                currmodel.ischecked = true;
                var rules = Enumerable.From(massifrules).Where('s=>s.massifid=="' + currmodel.massifid + '"').ToArray();
                if (Dev.IsNull(rules) || rules.length == 0) { rotation_massiflist.push(currmodel); continue; }
                currmodel.rules = [];
                for (var j = 0; j < rules.length; j++) currmodel.rules.push({ programmeid: rotationlink[i].programmeid, year: rules[j].year, mouth: rules[j].mouth, crop: rules[j].type });
                rotation_massiflist.push(currmodel);
            }
            $(".dev-numberbox[name='fallowarea']").prop("$this").SetValue(rotationmodel.fallowarea);//加载面积
            $(".dev-numberbox[name='subsidy']").prop("$this").SetValue(rotationmodel.subsidy);//加载金额
            //加载时间
            $("#compectBTime").datebox("setValue", Dev.GetDateString(rotationmodel.contractstarttime));
            $("#compectETime").datebox("setValue", Dev.GetDateString(rotationmodel.contractendtime));
            //加载图片
            for (var i = 0; i < imgfiles.length; i++) {
                imgfiles[i].isupdate = true;
                piclist.push(imgfiles[i]);
            }
            $("#picview").css({ "background-image": "url(" + piclist[piclist.length - 1].path + ")" });
            $("#picview").attr("title", "点击预览");
            $(".imgviewer").prop("bg_file", piclist[piclist.length - 1]);
            $(".imgviewer").attr("attid", rotationmodel.attid);
        }
        //显示当前页地块信息
        function showpageblocks(blocks) {
            if (Dev.IsNull(blocks) || blocks.length == 0) return;
            Dev.MapUtils.ClearFeature("tempGraphicLayer", Dev.App.Map);
            var features = [], locationfs = [];
            for (var i = 0; i < blocks.length; i++) {
                var currfeature = new Dev.Feature(blocks[i].geom);
                currfeature.setProperties(blocks[i]);
                features.push(currfeature);
                var extent = blocks[i].geom.getExtent();
                var centerpoint = [(extent[0] + extent[2]) / 2, (extent[1] + extent[3]) / 2];
                var c_loctionf = new Dev.Feature(new Dev.geom.Point(centerpoint));
                c_loctionf.setProperties(blocks[i]);
                c_loctionf.setId("locationb" + blocks[i].massifid);
                c_loctionf.setStyle(new Dev.style.Style({
                    image: new Dev.style.Icon({ src: Dev.App.Root + "image/poi_red.png", anchor: [0.5, 1] }),
                    text: new Dev.style.Text({
                        text: String.fromCharCode(65 + i),
                        font: "15px serif",
                        fill: new Dev.style.Fill({ color: [255, 255, 255, 1] }),
                        offsetX: 0,
                        offsetY: -22
                    })
                }));
                locationfs.push(c_loctionf);
            }
            Dev.MapUtils.AddFeatures(features, "tempGraphicLayer");
            Dev.MapUtils.AddFeatures(locationfs, "tempGraphicLayer");
            //显示范围
            var extend = Dev.getExtentByFeatures(features);
            Dev.App.Map.getView().fit(extend, Dev.App.Map.getSize());
            //添加标识
        }
        var polyganKey;
        function highlight(row) {
            if (Dev.IsNull(row)) return;
            if (!Dev.IsNull(polyganKey)) { Dev.MapUtils.removePointKey("rotationhightlight1", Dev.App.Map); polyganKey = null; }
            var feature = new Dev.Feature({ id: "rotationhightlight1", geometry: row.geom });
            feature.setId("rotationhightlight1")
            polyganKey = Dev.MapUtils.LineSymbolStyle(feature,null,null,false);
            var extent = feature.getGeometry().getExtent();
            Dev.App.Map.getView().centerOn([((extent[0] + extent[2]) / 2), ((extent[1] + extent[3]) / 2)], Dev.App.Map.getSize(), [Dev.App.Map.getSize()[0] / 2, Dev.App.Map.getSize()[1] / 2]);
            locationhighlight(row);
        }
        function locationhighlight(row) {
            var templayer = Dev.MapUtils.GetLayer("tempGraphicLayer", Dev.App.Map);
            var temp_source = templayer.getSource();
            var temp_features = temp_source.getFeatures();
            var b_index = 0;
            for (var i = 0; i < temp_features.length; i++) {
                if (Dev.IsNull(temp_features[i].getId())) continue;
                if (temp_features[i].getId().indexOf("locationb") < 0) continue;
                var iconurl = Dev.App.Root + "image/poi_red.png"
                if (temp_features[i].getId() == ("locationb" + row.massifid)) iconurl = Dev.App.Root + "image/poi_blue.png";
                temp_features[i].setStyle(new Dev.style.Style({
                    image: new Dev.style.Icon({ src: iconurl, anchor: [0.5, 1] }),
                    text: new Dev.style.Text({
                        text: String.fromCharCode(65 + b_index),
                        font: "15px serif", fill: new Dev.style.Fill({ color: [255, 255, 255, 1] }), offsetX: 0, offsetY: -22
                    })
                }));
                b_index++;
            }
        }
        //辅助函数
        function convertData(data) {
            for (var i = 0; i < data.length; i++) {
                if (Dev.IsNull(data[i].geom)) continue;
                var type = data[i].geom.substring(0, data[i].geom.indexOf('('));
                var geomstr = data[i].geom.replace(type, '');
                if (type == "MULTIPOLYGON") data[i].geom = new Dev.geom.MultiPolygon(getGeoByGeomStr(geomstr, type));
            }
            return data;
        }
        function getGeoByGeomStr(str, type) {
            var geom = [];
            var geosStr = str.substr(str.indexOf('(') + 1, str.lastIndexOf(')') - 1);
            if (type == "MULTIPOLYGON") {
                var polygonStrs = geosStr.split(')),');
                for (var i = 0; i < polygonStrs.length - 1; i++) polygonStrs[i] = polygonStrs + "))";
                for (var i = 0; i < polygonStrs.length; i++) {
                    var currPolygonStr = polygonStrs[i];
                    geom.push(getGeoByGeomStr(currPolygonStr, "POLYGON"));
                }
            }
            if (type == "POLYGON") {
                var ringStrs = geosStr.split('),');
                for (var i = 0; i < ringStrs.length - 1; i++) ringStrs[i] = ringStrs[i] + ")";
                for (var i = 0; i < ringStrs.length; i++) {
                    var currRingStr = ringStrs[i];
                    geom.push(getGeoByGeomStr(currRingStr, "LineString"));
                }
            }
            if (type == "LineString") {
                var pointStrs = geosStr.split(',');
                for (var i = 0; i < pointStrs.length; i++) {
                    var currPointStr = pointStrs[i];
                    geom.push([parseFloat(currPointStr.split(' ')[0]), parseFloat(currPointStr.split(' ')[1])]);
                }
            }
            return geom;
        }
        function getrulebyplanid(id, type) {
            var alldata = plancontrol.combogrid("grid").datagrid("getData").rows;
            if (Dev.IsNull(alldata) || alldata.length == 0) return null;
            var currdata = Enumerable.From(alldata).Where('s=>s.id=="' + id + '"').FirstOrDefault();
            if (Dev.IsNull(currdata)) return null;
            var list = currdata.list;
            //过滤掉方案里不再合同期内的规则
            var startTimeArr = $("#compectBTime").datebox("getValue").split("-");
            var endTimeArr = $("#compectETime").datebox("getValue").split("-");
            var startTime = startTimeArr[0];
            if (type == "一年多熟") startTime += startTimeArr[1];
            var endTime = endTimeArr[0];
            if (type == "一年多熟") endTime += endTimeArr[1];
            var rules = list.filter(function (value, index, array) {
                var time = Dev.IsNullAll(value.mouth) ? value.year : (value.year + (parseInt(value.mouth) > 10 ? value.mouth : ("0" + value.mouth)));
                return parseInt(time, 10) >= parseInt(startTime) && parseInt(time, 10) <= parseInt(endTime);
            });
            return rules;
        }
        function getareaandsubsidy() {
            var area = 0, subsidy = 0;
            if (Dev.IsNull(rotation_massiflist) || rotation_massiflist.length == 0) return [area, subsidy];
            var checklist = Enumerable.From(rotation_massiflist).Where('s=>s.ischecked==true').ToArray();
            if (Dev.IsNull(checklist) || checklist.length == 0) return [area, subsidy];
            area = Enumerable.From(checklist).Sum('s=>s.massifarea');
            subsidy = Enumerable.From(checklist).Sum('s=>s.subsidy');
            return [area, subsidy];
            //return [Dev.SqrtMetersToMu(area,3), subsidy];
        }
        function loadxzqnode(id, model) {
            if (Dev.IsNull(id)) return;
            if (!Dev.IsNull(model)) {
                if (!Dev.IsNull(model.province)) xzqvlaues.province = model.province;
                if (!Dev.IsNull(model.city)) xzqvlaues.city = model.city;
                if (!Dev.IsNull(model.county)) xzqvlaues.county = model.county;
                if (!Dev.IsNull(model.town)) xzqvlaues.town = model.town;
                if (!Dev.IsNull(model.village)) xzqvlaues.village = model.village;
            }
            $.ajax({
                type: 'post',
                url: Dev.GetSystemUrlByRelID("Service") + '/dictionary/expandto/' + id,
                success: function (response) {
                    xzqcontrol.combotree("loadData", response);
                    xzqcontrol.combotree("setValue", id);
                    xzqcontrol.combotree("setText", gettext())

                }
            })
        }
        function verifinfo(model) {
            var verifydata = { isok: true, msg: "" };
            if (Dev.IsNull(model) || Dev.IsNull(planwin)) { verifydata.isok = false; return verifydata; }
            if (Dev.IsNull(model.type)) { verifydata.isok = false; verifydata.msg = "请选择轮耕类型!"; return verifydata; }
            if (Dev.IsNull(model.massifarea)) { verifydata.isok = false; verifydata.msg = "请选择类型!"; return verifydata; }
            if (model.type == "轮作") {
                if (Dev.IsNull(model.planting)) { verifydata.isok = false; verifydata.msg = "请选择种植方式!"; return verifydata; }
                if (Dev.IsNull(model.programmeid)) { verifydata.isok = false; verifydata.msg = "请选择方案!"; return verifydata; }
            }
            if (model.type == "休耕") {
                if (Dev.IsNull(model.fallowreason.trim())) { verifydata.isok = false; verifydata.msg = "请输入休耕原因!"; return verifydata; }
            }
            if (Dev.IsNull(model.subsidy)) { verifydata.isok = false; verifydata.msg = "请输入补贴金额!"; return verifydata; }
            return verifydata;
        }

        //ToolbarFarmer农户查询
        var searchTbFilterFer;
        var searchTbFnameControl, searchTbFidControl, searchTbFtelControl;           //农户姓名，身份证号，电话号码
        function searchTbFer() {
            framerindex = 1;
            searchTbFilterFer = "1=1";
            var searchTbFname = $.trim(searchTbFnameControl.GetValue());
            if (!Dev.IsNull(searchTbFname)) searchTbFilterFer += " AND ( \"NAME\"  LIKE '%" + searchTbFname + "%'" + " OR " + "UPPER( \"NAME\" )  LIKE " + "UPPER('%" + searchTbFname + "%')" + " OR " + "LOWER( \"NAME\" )  LIKE " + "LOWER('%" + searchTbFname + "%'))";
            var searchTbFid = $.trim(searchTbFidControl.GetValue());
            if (!Dev.IsNull(searchTbFid)) searchTbFilterFer += " AND (UPPER ( \"CARDID\" ) LIKE '%" + searchTbFid + "%' OR LOWER ( \"CARDID\") LIKE '%" + searchTbFid + "%')";
            var searchTbFtel = $.trim(searchTbFtelControl.GetValue());
            if (!Dev.IsNull(searchTbFtel)) searchTbFilterFer += " AND  \"MOBILEPHONE\" LIKE '%" + searchTbFtel + "%'";
            getframer();
        }
        function searchResetFer() {
            if (!Dev.IsNull(searchTbFnameControl)) searchTbFnameControl.Clear();
            if (!Dev.IsNull(searchTbFidControl)) searchTbFidControl.Clear();
            if (!Dev.IsNull(searchTbFtelControl)) searchTbFtelControl.Clear();
            searchTbFer();
        }

    </script>
</head>
<body>
    <div class="eidtcontent">
        <div class="Row">
            <div class="Cell">
                <div style="display: inline-block; width: 77px; line-height: 35px; float: left; text-align: right; padding-right: 8px;"><span>合同签订日期</span></div>
                <div style="width: 255px; height: 35px; line-height: 33px; display: inline-block; float: left; margin-top: 0px; position: relative;">
                    <input id="compectBTime" data-options="editable:false" validtype="startCheck['#compectETime']" />
                    <div style="position: absolute; height: 10px; width: 10px; top: 12px; right: 20px; color: red; line-height: 10px;">*</div>
                </div>
            </div>
            <div class="Cell">
                <div style="display: inline-block; width: 87px; line-height: 35px; float: left; text-align: right; padding-right: 8px;"><span>合同失效日期</span></div>
                <div style="width: 245px; height: 35px; line-height: 33px; display: inline-block; float: left; margin-top: 0px; position: relative;">
                    <input id="compectETime" data-options="editable:false" validtype="endCheck['#compectBTime']" />
                    <div style="position: absolute; height: 10px; width: 10px; top: 12px; right: 20px; color: red; line-height: 10px;">*</div>
                </div>
            </div>
        </div>
        <div class="Row">
            <div class="Cell">
                <div style="display: inline-block; width: 77px; line-height: 35px; float: left; text-align: right; padding-right: 8px;"><span>农户</span></div>
                <div style="width: 255px; height: 35px; line-height: 33px; display: inline-block; float: left; margin-top: 1px; position: relative;">
                    <div id="farmerinfo" data-options="editable:false"></div>
                    <div style="position: absolute; height: 10px; width: 10px; top: 12px; right: 20px; color: red; line-height: 10px;">*</div>
                </div>
            </div>
            <div class="Cell">
                <div style="display: inline-block; width: 87px; line-height: 35px; float: left; text-align: right; padding-right: 8px;"><span>组织机构</span></div>
                <div id="orgcombotree" style="width: 245px; height: 35px; line-height: 33px; display: inline-block; float: left; margin-top: 5px;">
                </div>
            </div>
        </div>
        <div class="Row massifselect" style="height: 181px;">
            <div id="massifgrid" style="width: 679px; height: 100%; border-right: 1px solid #ddd;"></div>
        </div>
        <div class="Row">
            <div class="Cell">
                <div class="dev-numberbox" name="fallowarea" style="width: 340px; margin-top: 5px;" opt='{"Disabled":true,"Readonly":true,"Precision":3,"Min":0,"Height":26,"HeaderCSS":{"padding":"0px","width":"85px"},"IsOverShow":true,"Padding":"0px 5px","Title":"<div class=\"Title\"><span>总面积(亩)</span></div>"}'></div>
            </div>
            <div class="Cell">
                <div class="dev-numberbox" name="subsidy" style="width: 340px; margin-top: 5px;" opt='{"Disabled":true,"Readonly":true,"Precision":2,"Min":0,"Height":26,"HeaderCSS":{"padding":"0px","width":"95px"},"IsOverShow":true,"Padding":"0px 5px","Title":"<div class=\"Title\"><span>总补贴金额(元)</span></div>"}'></div>
            </div>
        </div>
        <div class="Row" style="height: 167px;">
            <div style="display: inline-block; width: 77px; line-height: 167px; float: left; text-align: right; padding-right: 8px;"><span>合同图片</span></div>
            <div style="display: inline-block; width: 595px; height: 167px; position: relative;">
                <div class="imgviewer" style="width: 593px; height: 159px; margin-top: 4px; border: 1px solid #95b8e7; position: relative;">
                    <div id="picview" style="width: 500px; height: 149px; position: absolute; left: 46px; top: 5px; background-repeat: no-repeat; background-position: center;"></div>
                    <div class="PicLeft ImgBtn"></div>
                    <div class="PicRight ImgBtn"></div>
                    <div class="PicAdd icon-imgadd ImgBtn" title="上传图片"></div>
                    <div class="PicDel icon-imgdel ImgBtn" title="删除图片"></div>
                    <input type="file" name="devfile" multiple="multiple" style="cursor: pointer; display: none;" accept="image/png,image/jpeg" />
                </div>
                <div id="pictip" style="height: 25px; width: 60px; color: #ff0000; position: absolute; bottom: 0px; left: calc(50% - 30px);">0/0</div>
            </div>
        </div>
        <div style="width: 100%; height: 45px;">
            <div id="emsg" style="display: inline-block; line-height: 45px; height: 45px; width: 515px; margin-left: 15px; color: red;"></div>
            <div class="Submit">
                <div class="Button" tag="save">
                    <span style="line-height: 26px; color: #fcfcfc;">保&nbsp;&nbsp;存</span>
                </div>
                <div class="Button" tag="cancel">
                    <span style="line-height: 26px; color: #fcfcfc;">取&nbsp;&nbsp;消</span>
                </div>
            </div>
        </div>
    </div>
    <div class="MassifPlanEdit" style="width: 100%; height: 100%;">
        <div style="height: 35px; width: 100%; border-bottom: 1px solid #ddd;">
            <div style="height: 35px; width: 194px; display: inline-block; float: left;">
                <div id="rotationtype" tag="inputcontrol" class="dev-combobox" name="type" style="width: 194px; margin-top: 5px;" opt='{"Required":true,"Data":["轮作","休耕"],"Height":26,"HeaderCSS":{"padding":"0px","width":"75px"},"IsOverShow":true,"Padding":"0px 5px","Title":"<div style=\"text-align: right;padding-right: 8px;\"><span>类型</span></div>"}'></div>
            </div>
            <div style="height: 35px; width: 194px; display: inline-block; float: left;">
                <div class="dev-numberbox" tag="inputcontrol" name="massifarea" style="width: 194px; margin-top: 5px;" opt='{"Required":true,"Precision":3,"Min":0,"Max":10000, "Height":26,"HeaderCSS":{"padding":"0px","width":"75px"},"IsOverShow":true,"Padding":"0px 5px","Title":"<div style=\"text-align: right;padding-right: 7px;\"><span>面积(亩)</span></div>"}'></div>
            </div>
        </div>
        <div class="rotation" style="height: 35px; width: 100%; border-bottom: 1px solid #ddd;">
            <div style="height: 35px; width: 194px; display: inline-block; float: left;">
                <div class="dev-combobox" tag="inputcontrol" name="planting" style="width: 194px; margin-top: 5px;" opt='{"Required":true,"Data":["一年一熟","一年多熟"],"Height":26,"HeaderCSS":{"padding":"0px","width":"75px"},"IsOverShow":true,"Padding":"0px 5px","Title":"<div style=\"text-align: right;padding-right: 8px;\"><span>种植方式</span></div>"}'></div>
            </div>
            <div style="height: 35px; width: 194px; display: inline-block; float: left;">
                <div style="display: inline-block; width: 67px; line-height: 35px; float: left; text-align: right; padding-right: 8px;"><span>方案</span></div>
                <div style="width: 119px; height: 35px; line-height: 33px; display: inline-block; float: left; margin-top: 1px; position: relative;">
                    <div id="planinfo" data-options="editable:false"></div>
                    <div style="position: absolute; height: 10px; width: 10px; top: 12px; right: 20px; color: red; line-height: 10px;">*</div>
                </div>
            </div>
        </div>
        <div class="fallow" style="height: 35px; width: 100%; border-bottom: 1px solid #ddd; display: none;">
            <div style="height: 35px; width: 388px; display: inline-block; float: left;">
                <div class="dev-textbox" tag="inputcontrol" name="fallowreason" style="z-index: 2; width: 388px; margin-top: 5px;" opt='{"Required":true,"TipInfo":"请输入休耕原因","Height":26,"HeaderCSS":{"padding":"0px","width":"75px"},"IsOverShow":true,"Padding":"0px 5px","Title":"<div style=\"text-align: right;padding-right: 8px;\">休耕原因</div>"}'></div>
            </div>
        </div>
        <div style="height: 35px; width: 100%; border-bottom: 1px solid #ddd;">
            <div style="height: 35px; width: 194px; display: inline-block; float: left;">
                <div class="dev-textbox" tag="inputcontrol" name="subsidystandard" style="z-index: 3; width: 194px; margin-top: 5px;" opt='{"Height":26,"TipInfo":"请输入补贴标准","HeaderCSS":{"padding":"0px","width":"75px"},"IsOverShow":true,"Padding":"0px 5px","TextAlign":"left","BodyCSS": { "background-color": "transparent" },"Title":"<div style=\"text-align: right;padding-right: 8px;\"><span>补贴标准</span></div>"}'></div>
            </div>
            <div style="height: 35px; width: 194px; display: inline-block; float: left;">
                <div class="dev-numberbox" tag="inputcontrol" name="subsidy" style="width: 194px; margin-top: 5px;" opt='{"Precision":2,"Min":0,"Height":26,"HeaderCSS":{"padding":"0px","width":"75px"},"IsOverShow":true,"Padding":"0px 5px","Title":"<div style=\"text-align: right;\"><span>补贴金额(元)</span></div>"}'></div>
            </div>
        </div>
        <div style="width: 398px; height: 35px;">
            <div id="errormsg" style="display: inline-block; line-height: 35px; height: 35px; width: 233px; margin-left: 15px; color: red;"></div>
            <div style="height: 35px; width: 140px; text-align: center; float: right; margin-right: 10px;">
                <div id="savebtn" style="cursor: pointer; width: 60px; height: 26px; margin-top: 5px; background-color: #445ee8; text-align: center; display: inline-block; margin-left: 2px;" tag="save"><span style="line-height: 26px; color: #fcfcfc;">确定</span></div>
                <div id="cancelbtn" style="cursor: pointer; width: 60px; height: 26px; margin-top: 5px; background-color: #445ee8; text-align: center; display: inline-block; margin-left: 12px;" tag="cancel"><span style="line-height: 26px; color: #fcfcfc;">取消</span></div>
            </div>
        </div>
    </div>

    <div id="toobarFarmer" style="height: 35px; background-color: #fcfcfc">
        <div style="margin-top: 5px; width: 444px;">
            <div id="FnameSearch" class="dev-textbox" style="width: 108px; float: left; margin-left: 10px; display: inline-block;" opt='{"TipInfo":"输入姓名"}'></div>
            <div id="FidSearch" class="dev-textbox" style="width: 108px; float: left; margin-left: 8px; display: inline-block;" opt='{"TipInfo":"输入身份证号"}'></div>
            <div id="FtelSearch" class="dev-textbox" style="width: 108px; float: left; margin-left: 8px; display: inline-block;" opt='{"TipInfo":"输入电话号码"}'></div>
            <div style="width: 76px; height: 30px; display: inline-block; margin-left: 8px;">
                <div id="Fersearch" style="height: 24px; width: 35px; display: inline-block; background-color: #03afd9; float: left; color: #fff; line-height: 24px; text-align: center; cursor: default;">查询</div>
                <div id="Fercreset" style="height: 24px; width: 35px; display: inline-block; background-color: #03afd9; color: #fff; margin-left: 6px; line-height: 24px; text-align: center; cursor: default;">重置</div>
            </div>
        </div>
    </div>

</body>
</html>
