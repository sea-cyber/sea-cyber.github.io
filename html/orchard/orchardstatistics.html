<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>果园信息统计</title>
    <link rel="stylesheet" href="../../theme/default/easyui.css" />
    <link rel="stylesheet" type="text/css" href="../../theme/icon.css" />
    <link rel="stylesheet" type="text/css" href="../../css/app.css" />
    <link rel="stylesheet" type="text/css" href="../../css/main.css" />
    <link rel="stylesheet" type="text/css" href="../../css/icon.css" />
    <link type="text/css" href="../../css/dev.css" rel="stylesheet" />
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../js/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="../../js/autoMergeCells.js"></script>
    <script type="text/javascript" src="../../js/linq.min.js"></script>
    <script type="text/javascript" src="../../js/data.util.js"></script>
    <script type="text/javascript" src="../../js/highcharts.js"></script>
    <script type="text/javascript" src="../../js/highcharts-more.js"></script>
    <script type="text/javascript" src="../../js/solid-gauge.js"></script>
    <script type="text/javascript" src="../../js/drilldown.js"></script>
    <script type="text/javascript" src="../../js/jquery.dev.control.js"></script>
    <script type="text/javascript" src="../../js/dev.ui.js"></script>
    <script type="text/javascript" src="../../js/guid.js"></script>
    <script type="text/javascript" src="../../js/highcharts-zh_CN.js"></script>
    <style>
        .leftBox {
            height: 100%;
            position: absolute;
            width: 69%;
        }

        .content_div {
            border-radius: 25px;
            background-color: #ffffff;
            -webkit-box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            -moz-box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .lefttop {
            margin: 20px 10px 10px 20px;
            width: 100%;
            height: 50%;
        }

        .leftbottom {
            width: 100%;
            height: 44%;
            margin-left: 20px;
        }

        .rightBox {
            height: 100%;
            width: 28.5%;
            position: absolute;
            left: 70.6%;
            top: 0;
        }

        .righttop {
            height: 31%;
            width: 100%;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .rightcenter {
            height: 31%;
            width: 100%;
            margin-bottom: 10px;
        }

        .rightbottom {
            height: 31%;
            width: 100%;
        }


        .grid_chart {
            width: 96%;
            height: 90%;
            position: relative;
            top: 5%;
            left: 2%;
        }

        /*grid的样式*/
        #gridDiv {
            border: 1px solid #E0E0E0;
        }

            #gridDiv .datagrid-header-row {
                height: 40px;
                line-height: 40px;
                background-color: #EFF0F6;
            }

                #gridDiv .datagrid-header-row .datagrid-cell {
                    color: #222222;
                    font-size: 14px !important;
                    font-weight: bold;
                    font-family: 'Microsoft YaHei';
                }

            #gridDiv .datagrid-row {
                height: 20px;
                line-height: 20px;
            }

                #gridDiv .datagrid-row .datagrid-cell {
                    color: #666666;
                    font-size: 14px !important;
                    font-family: 'Microsoft YaHei';
                }


        .datagrid-pager {
            color: #666666;
            font-size: 14px !important;
            font-family: 'Microsoft YaHei';
        }
    </style>
    <script type="text/javascript">
        var Dev = window.top.window.dev;
        var parent;

        //定义grid
        var dataGrid, pageIndex = 1, pageSize = 15;

        //定义柱状图
        var barChart, pieChartByName, pieChartByType, pieChartByVillage, pieChart;

        //初始化方法
        function WidgetCommunication(s) {
            parent = s.parent;
            initDataGrid();//初始化grid
            initBargraph();
            initpieByvillage();
            initpieByType();
            initpieByName();
            resize();
            $(window).resize(function () { resize(); });
            parent.one("onClosing", function () {
                   clear();
            });
            Dev.OrchardTipClose();
            $("#closeBtn").one("click", function () {
                var cooperative_layer = Dev.MapUtils.GetLayer("cooplayer", Dev.App.Map); //获取合作社图层
                if (!Dev.IsNull(cooperative_layer)) cooperative_layer.setVisible(true);//显示图层
                var orchard_layer = Dev.MapUtils.GetLayer("orchardlayer", Dev.App.Map);//获取果园图层
                if (!Dev.IsNull(orchard_layer)) orchard_layer.setVisible(true);//显示图层
                parent.unbind("onClosing"); clear();
                Dev.App.MenuInit.CloseCurrentWidget();
            });
        }


        //初始化grid
        function initDataGrid() {
            if (Dev.IsNull(dataGrid)) {
                $("#gridDiv").empty();
                var columns = [
                    { field: "VILLAGE", width: 40, align: 'center', title: '所在村社', sortable: false },
                    { field: "ORCHARDTYPE", width: 40, align: 'center', title: '果园类型', sortable: false },
                    { field: "ORCHARDNAME", width: 80, align: 'center', title: '果园名称', sortable: false },
                    { field: "FRUITTYPE", width: 60, align: 'center', title: '水果类型', sortable: false },
                    { field: "AREA", width: 40, align: 'center', title: '种植面积(亩)', sortable: false }
                ];
                dataGrid = new UCDataGrid(Dev, { PageIndex: pageIndex, PageSize: pageSize, RowNumbers: false, ID: "orchardGrid", pagequery: false });
                $("#gridDiv").append(dataGrid.Target);
                dataGrid.Layout(columns);
                dataGrid.Target.bind("onSelectPage", function (s, e) {
                    pageIndex = e.index;
                    search();
                });
                dataGrid.Target.bind("onClickRow", function (s, e) {
                    var row = e.Row;
                    highlight(row);
                });
                dataGrid.Target.bind("onLoadSuccess", function (s, data) {
                    dataGrid.DataGrid.datagrid("autoMergeCells", ['VILLAGE', 'ORCHARDTYPE', 'ORCHARDNAME']);
                });
            }
            search();

        }

        //grid的查询方法
        function search() {
            $.ajax({
                type: "GET",
                url: Dev.GetSystemUrlByRelID("Service") + "orchardVariety/getOrchardVarietyInfo/" + pageIndex + "/" + pageSize,
                success: function (result) {
                    if (!result.statusCode == 200) return;
                    dataGrid.Load(result.data.dataSource, result.data.pageInfo);
                }
            });
        }

        //请求柱状图后台服务数据
        function initBargraph() {
            var seriesdata = [];
            var categories = [];
            $.ajax({
                type: "GET",
                url: Dev.GetSystemUrlByRelID("Service") + "orchardVariety/getAllOrchardVarietyList",
                success: function (result) {
                    if (!result.statusCode == 200) return;
                    var data = result.data;
                    $.each(data, function (s, value) {
                        categories.push(s);
                        var index = -1;
                        for (var i = 0; i < value.length; i++) {
                            var obj = { name: value[i].orchardName, data: [parseFloat(value[i].area)] };
                            for (var k = 0; k < seriesdata.length; k++) {
                                var newname = obj.name;
                                var seriesname = seriesdata[k].name;
                                if (newname == seriesname) {
                                    index = k;
                                }
                            }
                            if (index != -1) {
                                seriesdata[index].data.push(parseFloat(value[i].area));
                            } else {
                                seriesdata.push(obj)
                            }
                        }
                    });

                    setBarChart(categories, seriesdata);
                }

            });
        }

        //将数值赋值给柱状图
        function setBarChart(categories, seriesdata) {

            barChart = $("#barGraph").highcharts({
                chart: {
                    type: 'column'
                },
                credits: {
                    enabled: false
                },
                title: {
                    text: '果园种植面积',
                    style: {
                        "color": "#222222", "fontSize": "14px"
                    }
                },
                colors: ["#595ef2", "#fd6065", "#feb26b", "#31e4e1", "#7cb5ed"],
                xAxis: {
                    categories: categories,
                    crosshair: true
                },
                yAxis: {
                    min: 0,
                    title: {
                        text: '种植面积(亩)'
                    }
                },
                tooltip: {
                    pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                    '<td style="padding:0"><b>{point.y:.1f}亩</b></td></tr>',
                },
                plotOptions: {
                    column: {
                        borderWidth: 0,
                        pointWidth: 15
                    }
                },
                series: seriesdata
            });
        }

        //定义饼状图
        function setPiechart() {
            if (Dev.IsNull(pieChart)) {
                pieChart = "";
            }
            pieChart = {
                title: {
                    text: ''
                },
                credits: {
                    enabled: false
                },
                colors: ["#595ef2", "#fd6065", "#feb26b", "#31e4e1", "#7cb5ed"],
                tooltip: {
                    headerFormat: '{series.name}<br>',
                    pointFormat: '{point.name}: <b>{point.percentage:.1f}%</b>'
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,  // 可以被选择
                        cursor: 'pointer',       // 鼠标样式
                        dataLabels: {
                            enabled: true,
                            format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                            style: {
                                color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                            }
                        }
                    }
                },
                series: [{
                    type: 'pie',
                    name: '',
                    data: []
                }]

            };

            return pieChart;
        }

        //加载饼图-果园名称
        function initpieByvillage() {
            var villagePie = setPiechart();
            villagePie.title.text = "果园名称占比";
            villagePie.series[0].name = "果园名称所占比例";
            $.ajax({
                type: "GET",
                url: Dev.GetSystemUrlByRelID("Service") + "/orchard/getOrchardArea",
                success: function (result) {
                    if (!result.statusCode == 200) return;
                    fruitTypeData = result.data;
                    if (!Dev.IsNull(fruitTypeData))
                        villagePie.series[0].data = fruitTypeData;
                    pieChartByVillage= $("#pieByvillage").highcharts(villagePie);
                }
            });
        }

        //加载饼图-品种类型
        function initpieByType() {
            var fruitTypeData;
            var TypePie = setPiechart();
            TypePie.title.text = "品种类型占比";
            TypePie.series[0].name = "品种类型所占比例";
            $.ajax({
                type: "GET",
                url: Dev.GetSystemUrlByRelID("Service") + "orchardVariety/getFruitTypeArea",
                success: function (result) {
                    if (!result.statusCode == 200) return;
                    fruitTypeData = result.data;
                    if (!Dev.IsNull(fruitTypeData))
                        TypePie.series[0].data = fruitTypeData;
                    pieChartByType=$("#pieByType").highcharts(TypePie);
                }
            });


        }

        //加载饼图-果园类型
        function initpieByName() {
            var NamePie = setPiechart();
            NamePie.title.text = "果园类型占比";
            NamePie.series[0].name = "果园类型所占比例";
            $.ajax({
                type: "GET",
                url: Dev.GetSystemUrlByRelID("Service") + "/orchard/getOrchardTypeArea",
                success: function (result) {
                    if (!result.statusCode == 200) return;
                    fruitTypeData = result.data;
                    if (!Dev.IsNull(fruitTypeData))
                        NamePie.series[0].data = fruitTypeData;
                    pieChartByName = $("#pieByName").highcharts(NamePie);
                }
            });
        }

        //窗口重置
        function resize() {
            var height = $(window).outerHeight();
            //设置grid的高度和宽度
            var gridheight = height * 0.5 * 0.9;
            var gridwidth = parseInt($(window).width() * 0.69 * 0.96) - 2;
            $("#gridDiv").height(gridheight).width(gridwidth) - 2;
            if (!Dev.IsNull(dataGrid)) dataGrid.Resize(gridwidth, gridheight);
            //设置柱状图的高度
            var barheight = height * 0.44 * 0.9;
            $("#barGraph").height(barheight).width(gridwidth) - 2;
            if (!Dev.IsNull(barChart)) $("#barGraph").highcharts().reflow();
            //设置饼图的高度和宽度
            var piewidth = parseInt($(window).width() * 0.285 * 0.96) - 2;
            var pieheight = height * 0.31 * 0.9;
            $(".piechart").height(pieheight).width(piewidth) - 2
            if (!Dev.IsNull(pieChartByName)) $("#pieByvillage").highcharts().reflow();
            if (!Dev.IsNull(pieChartByType)) $("#pieByType").highcharts().reflow();
            if (!Dev.IsNull(pieChartByVillage)) $("#pieByName").highcharts().reflow();
        }

        //释放页面
        function clear() {
            pieChartByType = "";
            dataGrid = "";
            pieChart = "";
            pieChartByName = "";
            pieChartByVillage = "";
        }//页面关闭清空
    </script>
</head>
<body>
    <div style="width: 100%; height: 100%; background: #EFF0F6;">
        <div id="closeBtn" style="z-index: 50; top: 0px; width: 30px; height: 40px; text-align: center; right: 0px; color: rgb(255, 255, 255); line-height: 35px; padding-left: 10px; font-size: 30px; font-weight: bold; position: absolute; border-bottom-left-radius: 40px; background-color: rgba(0, 0, 0, 0.6); cursor: pointer;">×</div>
        <div class="leftBox">
            <div class="content_div lefttop">
                <div id="gridDiv" class="grid_chart"></div>
            </div>
            <div class="content_div leftbottom">
                <div id="barGraph" class="grid_chart"></div>
            </div>
        </div>
        <div class="rightBox">
            <div class="content_div righttop">
                <div class="piechart grid_chart" id="pieByvillage"></div>
            </div>
            <div class="content_div rightcenter">
                <div class="piechart grid_chart" id="pieByType"></div>
            </div>
            <div class="content_div rightbottom">
                <div class="piechart grid_chart" id="pieByName"></div>
            </div>
        </div>
    </div>
</body>
</html>
