<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>历史轨迹管理</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <link rel="stylesheet" href="../../theme/default/easyui.css" />
    <link rel="stylesheet" type="text/css" href="../../theme/icon.css" />
    <link rel="stylesheet" type="text/css" href="../../css/app.css" />
    <link rel="stylesheet" type="text/css" href="../../css/main.css" />
    <link rel="stylesheet" type="text/css" href="../../css/icon.css" />
    <link type="text/css" href="../../css/dev.css" rel="stylesheet" />
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../js/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="../../js/linq.min.js"></script>
    <script type="text/javascript" src="../../js/data.util.js"></script>
    <script type="text/javascript" src="../../js/jquery.dev.control.js"></script>
    <script src="../../js/dev.ui.js"></script>
    <style type="text/css">
        .content {
            height: 100%;
            width: 100%;
            position: relative;
        }

        .Title {
            width: 75px;
            text-align: right;
            line-height: 40px;
            height: 38px;
            display: inline-block;
            float: left;
        }

            .Title .Icon {
                width: 16px;
                height: 16px;
                display: inline-block;
                margin-left: 2px;
                float: left;
                margin-top: 11px;
            }

            .Title .Text {
                display: inline-block;
                text-align: left;
                margin-left: 0px;
                width: 51px;
            }

        .content .SearchDiv {
            width: 200px;
            height: 38px;
            display: inline-block;
            margin-left: 0px;
            margin-right: 0px;
            float: left;
        }

        .content .Button {
            width: 70px;
            height: 26px;
            float: left;
            margin-top: 5px;
            background-color: #16dbbb;
            /*border-radius: 5px;*/
            text-align: center;
            border: 1px solid #16dbbb;
            display: inline-block;
            cursor: pointer;
        }

            .content .Button:hover {
                background-color: #5227de;
                border: 1px solid #5227de;
                cursor: pointer;
            }

            .content .Button:active {
                background-color: #210097;
                border: 1px solid #210097;
                cursor: pointer;
            }

        .datagrid-row {
            height: 28px;
        }
    </style>
    <script type="text/javascript">
        var Dev = window.top.window.dev;
        var dataGrid, pageIndex = 1, pageSize = 5;
        var treeControl;
        var parent;
        var selectorgid, selectorgName;
        var searchNum;
        var playWin;
        var isplay = false;
        var playindex = 0;
        var timeinterval;
        var speedtime = 1000;
        var speed = 1;
        var trackpoints, tracktimes = [];
        var geoMarker;
        var dialog1;
        var dialog = new Dev.Messager({ AutoShow: false, Type: "question", Timeout: 1000, ButtonVisible: false, AutoVisible: true, Effect: "normal" });
        var orgFilter;
        var treeData = [];
        var orgids = [];
        msg = {
            netout: "网络超时，请稍后再试！",
            deleteFailed: "删除失败，请稍后再试！",
            deleteSuccess: "删除成功！"
        };
        var trackpolygonstyle = new Dev.style.Style({
            fill: new Dev.style.Fill({ color: 'rgba(237, 117, 65,0.4)' }),
            stroke: new Dev.style.Stroke({ color: 'rgba(237, 117, 65,0.6)', width: 2 })
        });
        var paramType;
        function WidgetCommunication(s) {//部件通讯
            parent = s.parent;
            if (!Dev.IsNull(s.param) && !Dev.IsNull(s.param.DeviceType)) paramType = s.param.DeviceType;
            //  Dev.App.BottomPanel.SetHeight(262);
            Dev.App.BottomPanel.Header.css({ "background": "#14cdad", "color": "#fcfcfc", "font-weight": "bold" });
            Dev.App.BottomPanel.SetIconCls("machine-trackmanage");
            inittree();
            initDataGrid();
            $(window).resize(function () { resize(); });
            searchNum = $("#machineNum").prop("$this");
            $(".Button").click(function () {
                var tag = $(this).attr("tag");
                if (tag == "search") { pageIndex = 1; bindData() };
                if (tag == "clear") {
                    searchclear();
                    bindData();
                }
            });
            dialog1 = new Dev.Messager({ AutoShow: false, Type: "question" });
            parent.one("onClosing", function () {
                Dev.App.BottomPanel.SetHeight(262);
                searchclear();
                if (!Dev.IsNull(timeinterval)) clearInterval(timeinterval);
                if (!Dev.IsNull(treeControl)) {
                    treeControl.unbind("onSelectChanged");
                    treeControl.Clear();
                    treeControl = null;
                }
                if (!Dev.IsNull(dataGrid)) {
                    dataGrid.Target.unbind("onSelectPage");
                    dataGrid.Target.unbind("onClickRow");
                    dataGrid.Target.unbind("onPageSizeChange");
                    dataGrid = null;
                }
                if (!Dev.IsNull(playWin)) {
                    playWin.unbind("onClosing");
                    playWin.Close();
                    playWin.Destroy();
                    playWin = null;
                }
                Dev.MapUtils.ClearFeature("tempTrackLayer");
                Dev.MapUtils.ClearFeature("tempGraphicLayer");
            });
            resize();
        
            if (!Dev.IsNull(paramType)) $("#searchtype").css("display", "none");
            else {
                var deviceType = $("#devicetype").prop("$this");
                deviceType.SetData(getdevicetype());
            }


        }
        function initDataGrid() {
            if (Dev.IsNull(dataGrid)) {
                $("#gridDiv").empty();
                var columns = [{ field: "no", width: 60, align: 'center', title: '设备编号', sortable: false }];
                if (Dev.IsNull(paramType)) columns.push({ field: "devicetype", width: 60, align: 'center', title: '设备类型', sortable: false });
                columns.push({ field: "uploadTime", width: 80, align: 'center', title: '上传时间', sortable: false, formatter: formatTime });
                columns.push({ field: "startTime", width: 80, align: 'center', title: '轨迹开始时间', sortable: false, formatter: formatTime });
                columns.push({ field: "endTime", width: 80, align: 'center', title: '轨迹结束时间', sortable: false, formatter: formatTime });
                columns.push({ field: "trackLength", width: 50, align: 'center', title: '轨迹时长(s)', sortable: false });
                columns.push({
                    field: "_oprate", width: 80, align: 'center', title: '操作', sortable: false, formatter: function (value, row, index) {
                        return '<a href="javascript:void(0)" style="color:blue;"onclick="trackplay(\'' + row.ID + '\',\'' + index + '\')" title="播放"><img src="../../image/agri/trackplay1.png"/></a>&nbsp;&nbsp;<a href="javascript:void(0)" style="color:blue;margin-left:6px;" onclick="deleteinfo(\'' + index + '\')" title="删除"><img src="../../image/agri/delete.png"/></a>'
                    }
                });
                dataGrid = new UCDataGrid(Dev, {
                    PageIndex: pageIndex, PageSize: pageSize, RowNumbers: false, ID: "trackGrid", pagequery: false, IsSizeSelect: true
                });
                $("#gridDiv").append(dataGrid.Target);
                dataGrid.Layout(columns);
                dataGrid.Target.bind("onClickRow", function (s, e) {
                    trackplay(e.Row.ID, e.index);
                });
                dataGrid.Target.bind("onSelectPage", function (s, e) {
                    pageIndex = e.index;
                    bindData();
                });
                dataGrid.Target.bind("onPageSizeChange", function (s, e) {
                    if (Dev.IsNull(e)) return;
                    pageIndex = 1;
                    pageSize = e;
                    bindData();
                });
            }
        }
        function bindData() {
            var data = null;
            var condition = "1=1";//搜索条件
            if (!Dev.IsNull(searchNum)) {
                var machineNumvalue = searchNum.GetValue();
                if (!Dev.IsNull(machineNumvalue) && machineNumvalue.length > 0) condition += " AND \"NO\" like '%" + machineNumvalue + "%'";
            }
            if (dev.IsNull(paramType)) {
                var deviceType = $("#devicetype").prop("$this");
                if (!Dev.IsNull(deviceType)) {
                    var value = deviceType.GetValue();
                    if (!Dev.IsNull(value)) condition += " AND \"DEVICETYPE\"='" + value + "'";
                }
            }
            else condition += " AND \"DEVICETYPE\"='" + paramType + "'";
            //获取上次时间
            var time1 = $("#uploadtime1").datebox("getValue");
            var time2 = $("#uploadtime2").datebox("getValue");
            if (!Dev.IsNull(time1) && !Dev.IsNull(time2)) {
                if (!Dev.IsNull(time1) && !Dev.IsNull(time2)) {
                    if (time1 > time2) {
                        return;
                    }
                }
            }
            if (!Dev.IsNull(time1)) condition += " AND \"UPLOADTIME\" >='" + time1 + " 00:00:00'";
            if (!Dev.IsNull(time2)) condition += " AND \"UPLOADTIME\" <='" + time2 + " 23:59:59'";
            if (!dev.IsNull(orgFilter)) condition += " AND  " + orgFilter;
            condition += " ORDER BY \"UPLOADTIME\" DESC";
            //请求分页内容
            $.ajax({
                type: "POST",
                data: condition,
                contentType: "application/json;charset=UTF-8",
                url: Dev.cookie.baseUri + "history/getbyfilter/" + pageIndex + "/" + pageSize,
                success: function (response) {
                    if (response.statusCode != 200 || Dev.IsNull(response.data)) { loadError(); return; }
                    dataGrid.Load(response.data.dataSource, response.data.pageInfo);
                },
                error: function (e) {
                    dialog.Alert(msg.netout, "error");
                    loadError();
                }
            })
        }
        function loadError() {
            dataGrid.Load([], { totalCount: 0, pageIndex: pageIndex, pageSize: pageSize, pageCount: 0 });
        }
        function inittree() {
            treeControl = $('.dev-tree').prop("$this");
            treeControl.bind("onSelectChanged", function (s, e) {
                searchclear();
                var treenode = e;
                var isleaf = treeControl.IsLeaf(treenode);
                orgids = [];
                selectorgid = e.id;
                orgids.push(e.id);
                if (!isleaf) {
                    var allchilds = treeControl.GetAllChildren(treenode);
                    for (var i = 0; i < allchilds.length; i++) orgids.push(allchilds[i].id);
                }
                orgFilter = "";
                if (Dev.IsNull(orgids) || orgids.length == 0) return;
                orgFilter = "\"ORGID\"  IN(";
                for (var i = 0; i < orgids.length; i++) orgFilter += "'" + orgids[i] + "',";
                orgFilter = orgFilter.substr(0, orgFilter.length - 1);
                orgFilter += ")";
                bindData();
            });
            var orgid = Dev.cookie.user.orgid;
            $.ajax({
                url: Dev.GetSystemUrlByRelID("Service") + "organize/gettreebyid/" + orgid + "?" + new Date().getTime(),
                type: "Get",
                contentType: 'application/json',
                dataType: 'json',
                success: function (result) {
                    treeData = Dev.ConvertTreeData(result.data, orgid);
                    treeControl.LoadData(treeData);
                    if (treeData.length > 0) treeControl.SetSelectNode(treeControl.GetRoots()[0]);
                }
            });
            bindData();
        }
        function resize() {
            //  Dev.App.BottomPanel.SetHeight(262);
            var wh = Dev.App.BottomPanel.Target.outerHeight();
            var height = $(window).outerHeight();
            treeControl.SetHeight(height == 0 ? (wh - 26) : (height - 26));
            var gridheight = height - 40;
            var gridwidth = $(window).width() * 0.80 - 2;
            var newgridheight = gridheight;
            if (gridwidth < 1020) {
                gridwidth = 1020;
                gridheight = parseInt(gridheight) - 16;
            }
            $("#searchDiv").width(gridwidth);
            $("#gridDiv").height(gridheight).width(gridwidth);
            if (!Dev.IsNull(dataGrid)) dataGrid.Resize(gridwidth, gridheight);
            $("#treediv").height(height - 26);
        }
        function searchclear() {
            pageIndex = 1;
            if (!Dev.IsNull(searchNum)) searchNum.Clear();
            $("#uploadtime1").datebox("setValue", "");
            $("#uploadtime2").datebox("setValue", "");
            var deviceType = $("#devicetype").prop("$this");
            if (!Dev.IsNull(deviceType)) deviceType.SetValue("");
        }
        function getdevicetype() {
            var devicetypes = [];
            $.each(Dev.DeviceType, function (s, e) {
                devicetypes.push(e);
            });
            return devicetypes;
        }
        //删除
        function deleteinfo(index) {
            dataGrid.DataGrid.datagrid("selectRow", index);
            var row = dataGrid.DataGrid.datagrid("getSelected");
            if (Dev.IsNull(row) || row.length == 0) return;
            dialog1.Confirm('确定删除所选记录吗？', function (r) {
                if (!r) return;
                removeData(row);
                bindData();
            }, "question");
        }
        function removeData(row) {
            var id = row.id;
            $.ajax({
                type: "GET",
                url: Dev.cookie.baseUri + "history/deleteTrackById/" + id,
                success: function (response) {
                    if (response.statusCode == 200) {
                        dialog.Alert(msg.deleteSuccess, "success");
                        pageIndex = 1;
                        bindData();
                    } else {
                        dialog.Alert(msg.deleteFailed, "error");
                    }
                },
                error: function (e) {
                    dialog.Alert(msg.netout, "error");
                }
            })
        }
        //轨迹播放
        function trackplay(id, index) {
            dataGrid.DataGrid.datagrid("selectRow", index);
            var row = dataGrid.DataGrid.datagrid("getSelected");
            var list = row.trackList;
            if (Dev.IsNull(row) || row.length === 0) return;
            if (Dev.IsNull(list) || list.length === 0) return;
            //显示轨迹数据
            var points = [];
            var listEx = list.split(';');
            if (listEx != null && listEx.length > 0) {
                for (var j = 0; j < listEx.length; j++) {
                    var track = listEx[j];
                    if (Dev.IsNull(track) || track.length > 0) {
                        var infos = track.split(',');
                        points.push([parseFloat(infos[0]), parseFloat(infos[1])]);
                        tracktimes.push(infos[2]);
                    }
                }
            }
            trackpoints = points;
            Dev.MapUtils.ClearFeature("tempTrackLayer");
            Dev.MapUtils.ClearFeature("tempGraphicLayer");
            if (Dev.IsNull(playWin)) {
                playWin = new Dev.Window({
                    ID: "PlayWin",
                    Title: row.no,
                    Parent: Dev.App.MapPanel.Target,
                    Maximizable: false,
                    Modal: false,
                    Draggable: true,
                    HAlign: 'right',
                    VAlign: 'bottom',
                    Resizable: false,
                    Content: $("#Player"),
                    Height: 87,
                    Width: 482,
                    TriggerEl: Dev.App.BottomPanel.Target
                });
                playWin.bind("onClosing", function () {
                    Dev.MapUtils.ClearFeature("tempTrackLayer");
                    Dev.MapUtils.ClearFeature("tempGraphicLayer");
                    if (!Dev.IsNull(timeinterval)) clearInterval(timeinterval);
                });
                $(".playicon", $("#Player", Dev.App.MapPanel.Target)).click(function () {
                    if ($(this).hasClass("icon-rewind")) rewindplay();//快退
                    if ($(this).hasClass("icon-stop")) stoppaly();//停止
                    if ($(this).hasClass("icon-play") || $(this).hasClass("icon-timeout")) {
                        //播放/暂停
                        if ($(this).hasClass("icon-play")) {
                            $(this).removeClass("icon-play").addClass("icon-timeout");
                            if (Dev.IsNull(speed)) speed = 1;
                            startplay();
                        }
                        else {
                            $(this).removeClass("icon-timeout").addClass("icon-play");
                            timeoutplay();
                        }
                    }
                    if ($(this).hasClass("icon-fast")) fastplay(); //快进
                });
            }
            else {
                playWin.SetTitle(row.no);
                playWin.Open();
                stoppaly();
                playindex = 0;
            }
            $("#playslider", $("#Player", Dev.App.MapPanel.Target)).slider({
                max: trackpoints.length,
                showTip: false,
                value: 0,
                onSlideStart: function () {
                    if (!Dev.IsNull(timeinterval)) clearInterval(timeinterval);
                },
                onSlideEnd: function (value) {
                    //首先判断当前的pageindex
                    playindex = value;
                    var c_p = trackpoints[playindex];
                    var mapproj = Dev.App.Map.getView().getProjection();
                    if (mapproj.getCode() != Dev.App.Config.SystemMap.DataEPSG) c_p = Dev.proj.transform(c_p, Dev.App.Config.SystemMap.DataEPSG, mapproj.getCode());
                    (geoMarker.getGeometry()).setCoordinates(c_p);
                    Dev.MapUtils.ClearFeature("tempTrackLayer");
                    for (var i = 1; i <= playindex; i++) {
                        var t_pstart = trackpoints[i - 1];
                        var t_pend = trackpoints[i];
                        if (t_pstart[0] == t_pend[0] && t_pstart[1] == t_pend[1]) continue;
                        if (mapproj.getCode() != Dev.App.Config.SystemMap.DataEPSG) {
                            t_pstart = Dev.proj.transform(t_pstart, Dev.App.Config.SystemMap.DataEPSG, mapproj.getCode());
                            t_pend = Dev.proj.transform(t_pend, Dev.App.Config.SystemMap.DataEPSG, mapproj.getCode());
                        }
                        var geom = getbufferpolygon(t_pstart, t_pend);
                        var polygonFeature = new Dev.Feature({ id: "polygonfM" + i, geometry: geom });
                        polygonFeature.setStyle(trackpolygonstyle);
                        Dev.MapUtils.AddFeature(polygonFeature, "tempTrackLayer", Dev.App.Map, false);
                    }
                    $(" .icon-play", $("#Player", Dev.App.MapPanel.Target)).removeClass("icon-play").addClass("icon-timeout");
                    startplay();
                }
            });
            $("#trackLength", playWin.Target).text(row.trackLength);
            var feature = new Dev.Feature({ id: "track", geometry: new Dev.geom.LineString(points) });
            Dev.MapUtils.AddFeature(feature, "tempGraphicLayer");
            var extent = feature.getGeometry().getExtent();
            if (!Dev.IsNull(extent)) {
                var c_points = [[extent[0], extent[1]], [extent[0], extent[3]], [extent[2], extent[3]], [extent[2], extent[1]], [extent[0], extent[1]]];
                var extendfeature = new Dev.Feature(new Dev.geom.Polygon([c_points]));
                Dev.setcountyposition(extendfeature);
                Dev.App.Map.getView().fit(extent, Dev.App.Map.getSize());
            }
            Dev.App.Map.getView().centerOn([((extent[0] + extent[2]) / 2), ((extent[1] + extent[3]) / 2)], Dev.App.Map.getSize(), [Dev.App.Map.getSize()[0] / 2, Dev.App.Map.getSize()[1] / 2]);
            //进行轨迹播放
            geoMarker = new Dev.Feature({
                type: 'geoMarker',
                geometry: new Dev.geom.Point(points[0])
            });
            geoMarker.setStyle(function (resolution) {
                return new Dev.style.Style({
                    image: new Dev.style.Icon({
                        src: Dev.App.Root + (paramType == Dev.DeviceType.machine ? "show/showimg/tractor.png" : "show/showimg/uav.png"),
                        scale: Dev.App.Map.getView().getZoom() / 15,
                        rotateWithView: false,
                        rotation: 0
                    })
                });
            });
            Dev.MapUtils.AddFeature(geoMarker, "tempGraphicLayer");
            $("#tracktime", $("#Player", Dev.App.MapPanel.Target)).html("轨迹时间:" + tracktimes[0]);
        }
        //播放
        function startplay() {
            isplay = true;
            //speed = 1;
            $("#speedText", $("#Player", Dev.App.MapPanel.Target)).html("速度:" + speed + "X");
            if (playindex == 0) {
                Dev.MapUtils.ClearFeature("tempTrackLayer");
                var c_point = trackpoints[0];
                var mapproj = Dev.App.Map.getView().getProjection();
                if (mapproj.getCode() != Dev.App.Config.SystemMap.DataEPSG) c_point = Dev.proj.transform(c_point, Dev.App.Config.SystemMap.DataEPSG, mapproj.getCode());
                (geoMarker.getGeometry()).setCoordinates(c_point);
                $("#playslider", $("#Player", Dev.App.MapPanel.Target)).slider("setValue", playindex);
            }
            timeinterval = setInterval(function () {
                if (isplay) moveplay();
            }, speedtime);
        }
        //停止播放
        function stoppaly() {
            isplay = false;
            if (!Dev.IsNull(timeinterval)) clearInterval(timeinterval);
            playindex = 0;
            speed = 1;
            (geoMarker.getGeometry()).setCoordinates(trackpoints[0]);
            Dev.MapUtils.ClearFeature("tempTrackLayer");
            $(" .icon-timeout", $("#Player", Dev.App.MapPanel.Target)).removeClass("icon-timeout").addClass("icon-play");
            $("#playslider", $("#Player", Dev.App.MapPanel.Target)).slider("setValue", playindex);
            $("#speedText", $("#Player", Dev.App.MapPanel.Target)).html("速度:" + speed + "X");
        }
        //快进
        function fastplay() {
            if (isplay) {
                clearInterval(timeinterval);
                if (speed < 5) speed++;
                timeinterval = setInterval(function () { moveplay(); }, (speedtime - (speed * 200)));
                $("#speedText", $("#Player", Dev.App.MapPanel.Target)).html("速度:" + speed + "X");
            }
        }
        //快退
        function rewindplay() {
            if (isplay) {
                clearInterval(timeinterval);
                if (speed <= 5 && speed > -5) speed--;
                timeinterval = setInterval(function () {
                    moveplay();
                }, (speedtime - (speed * 200)));
                //显示速度
                $("#speedText", $("#Player", Dev.App.MapPanel.Target)).html("速度:" + speed + "X");
            }
        }
        //暂停
        function timeoutplay() {
            isplay = false;
            clearInterval(timeinterval);
            var currpoint = trackpoints[playindex];
            (geoMarker.getGeometry()).setCoordinates(currpoint);
        }
        //播放公共函数
        function moveplay() {
            playindex++;
            $("#playslider", $("#Player", Dev.App.MapPanel.Target)).slider("setValue", playindex);
            if (playindex > trackpoints.length - 1) {
                isplay = false;
                clearInterval(timeinterval);
                playindex = 0;
                $(" .icon-timeout", $("#Player", Dev.App.MapPanel.Target)).removeClass("icon-timeout").addClass("icon-play");
                return;
            }
            var currpoint = trackpoints[playindex];
            var mapproj = Dev.App.Map.getView().getProjection();
            if (mapproj.getCode() != Dev.App.Config.SystemMap.DataEPSG) currpoint = Dev.proj.transform(currpoint, Dev.App.Config.SystemMap.DataEPSG, mapproj.getCode());
            (geoMarker.getGeometry()).setCoordinates(currpoint);
            if (playindex < trackpoints.length - 1) {
                var anage = getrotation(trackpoints[playindex], trackpoints[playindex + 1]);
                geoMarker.setStyle(new Dev.style.Style({
                    image: new Dev.style.Icon(({
                        crossOrigin: 'anonymous',
                        src: Dev.App.Root + (paramType == Dev.DeviceType.machine ? "show/showimg/tractor.png" : "show/showimg/uav.png"),
                        rotation: anage * Math.PI / 180
                    }))
                }));
            }
            //显示范围
            var t_pstart = trackpoints[playindex - 1];
            var t_pend = trackpoints[playindex];
            var mapproj = Dev.App.Map.getView().getProjection();
            if (mapproj.getCode() != Dev.App.Config.SystemMap.DataEPSG) {
                t_pstart = Dev.proj.transform(t_pstart, Dev.App.Config.SystemMap.DataEPSG, mapproj.getCode());
                t_pend = Dev.proj.transform(t_pend, Dev.App.Config.SystemMap.DataEPSG, mapproj.getCode());
            }
            var geom = getbufferpolygon(t_pstart, t_pend);
            if (!Dev.IsNull(geom)) {
                var polygonFeature = new Dev.Feature({ id: "polygonfM" + playindex, geometry: geom });
                //获取角度
                polygonFeature.setStyle(trackpolygonstyle);
                Dev.MapUtils.AddFeature(polygonFeature, "tempTrackLayer", Dev.App.Map, false);
            }
            $("#tracktime", $("#Player", Dev.App.MapPanel.Target)).html("轨迹时间:" + tracktimes[playindex]);
        }
        //根据两点获取角度
        function getrotation(startpoint, endpoint) {
            curPos = startpoint.clone();
            targetPos = endpoint.clone();
            var mapproj = Dev.App.Map.getView().getProjection();
            if (mapproj.getCode() != Dev.App.Config.SystemMap.DataEPSG) {
                curPos = Dev.proj.transform(curPos, Dev.App.Config.SystemMap.DataEPSG, mapproj.getCode());
                targetPos = Dev.proj.transform(targetPos, Dev.App.Config.SystemMap.DataEPSG, mapproj.getCode());
            }
            curPos = Dev.App.Map.getPixelFromCoordinate(curPos);
            targetPos = Dev.App.Map.getPixelFromCoordinate(targetPos);
            curPos = { x: curPos[0], y: curPos[1] };
            targetPos = { x: targetPos[0], y: targetPos[1] };
            var x = Math.abs(targetPos.x - curPos.x);
            var y = Math.abs(targetPos.y - curPos.y);
            var z = Math.sqrt(x * x + y * y);
            var ration = Math.round((Math.asin(y / z) / Math.PI * 180));
            var a = 0;
            if (targetPos.y < curPos.y && targetPos.x == curPos.x) a = 270;
            else if (targetPos.y > curPos.y && targetPos.x == curPos.x) a = 90;
            else if (targetPos.y == curPos.y && targetPos.x < curPos.x) a = 180;
            else if (targetPos.y == curPos.y && targetPos.x > curPos.x) a = 0
            else if (targetPos.y > curPos.y && targetPos.x > curPos.x) a = ration;
            else if (targetPos.y > curPos.y && targetPos.x < curPos.x) a = 180 - ration;
            else if (targetPos.y < curPos.y && targetPos.x < curPos.x) a = 180 + ration;
            else if (targetPos.y < curPos.y && targetPos.x > curPos.x) a = 360 - ration;
            return a;
        }
        //根据线获取缓冲图形
        function getbufferpolygon(point1, point2) {
            var temppoint1 = point1;
            var temppoint2 = point2;
            var mapproj = Dev.App.Map.getView().getProjection();
            if (mapproj.getCode() == Dev.App.Config.SystemMap.DataEPSG) {
                temppoint1 = new Dev.proj.transform(temppoint1, mapproj.getCode(), "EPSG:3857");
                temppoint2 = new Dev.proj.transform(temppoint2, mapproj.getCode(), 'EPSG:3857');
            }
            var lonlat = { lon: temppoint1[0], lat: temppoint1[1] };
            var lastLonlat = { lon: temppoint2[0], lat: temppoint2[1] };

            var x1 = lastLonlat.lon - 1 * Math.sin(Math.atan((lonlat.lat - lastLonlat.lat) / (lonlat.lon - lastLonlat.lon)));
            var y1 = lastLonlat.lat + 1 * Math.cos(Math.atan((lonlat.lat - lastLonlat.lat) / (lonlat.lon - lastLonlat.lon)));

            var x2 = lastLonlat.lon + 1 * Math.sin(Math.atan((lonlat.lat - lastLonlat.lat) / (lonlat.lon - lastLonlat.lon)));
            var y2 = lastLonlat.lat - 1 * Math.cos(Math.atan((lonlat.lat - lastLonlat.lat) / (lonlat.lon - lastLonlat.lon)));

            var x3 = lonlat.lon - 1 * Math.sin(Math.atan((lastLonlat.lat - lonlat.lat) / (lastLonlat.lon - lonlat.lon)));
            var y3 = lonlat.lat + 1 * Math.cos(Math.atan((lastLonlat.lat - lonlat.lat) / (lastLonlat.lon - lonlat.lon)));

            var x4 = lonlat.lon + 1 * Math.sin(Math.atan((lastLonlat.lat - lonlat.lat) / (lastLonlat.lon - lonlat.lon)));
            var y4 = lonlat.lat - 1 * Math.cos(Math.atan((lastLonlat.lat - lonlat.lat) / (lastLonlat.lon - lonlat.lon)));
            if (isNaN(x1) || isNaN(y1) || isNaN(x2) || isNaN(y2) || isNaN(x3) || isNaN(y3) || isNaN(x4) || isNaN(y4)) return null;
            //var p1 = new Dev.proj.transform([x1, y1], "EPSG:3857", Dev.App.Map.getView().getProjection());
            //var p2 = new Dev.proj.transform([x2, y2], "EPSG:3857", Dev.App.Map.getView().getProjection());
            //var p3 = new Dev.proj.transform([x3, y3], "EPSG:3857", Dev.App.Map.getView().getProjection());
            //var p4 = new Dev.proj.transform([x4, y4], "EPSG:3857", Dev.App.Map.getView().getProjection());
            var p1 = [x1, y1];
            var p2 = [x2, y2];
            var p3 = [x3, y3];
            var p4 = [x4, y4];
            if (mapproj.getCode() == Dev.App.Config.SystemMap.DataEPSG) {
                p1 = new Dev.proj.transform(p1, "EPSG:3857", mapproj.getCode());
                p2 = new Dev.proj.transform(p2, "EPSG:3857", mapproj.getCode());
                p3 = new Dev.proj.transform(p3, "EPSG:3857", mapproj.getCode());
                p4 = new Dev.proj.transform(p4, "EPSG:3857", mapproj.getCode());
            }
            var points = [p1, p2, p4, p3, p1];
            var geom = new Dev.geom.Polygon([points]);
            return geom;
        }
        //辅助函数
        function formatTime(value, row, index) {
            if (!Dev.IsNull(value)) {
                return Dev.DateToString("/Date(" + value + ")/")
            }
            else return value;
        };
    </script>
</head>
<body>
    <div id="content" class="content">
        <div style="height: 100%; width: 20%; position: absolute;">
            <!--<div style="height: 26px; line-height: 26px; width: 100%; background-color: #ddd;"><span style="margin-left: 15px; color: #0099cc; line-height: 26px; letter-spacing: 3px; font-size: 12px;">组织机构</span></div>-->
            <div id="treediv" style="width: 100%; height: 100%;">
                <div class="dev-tree" opt='{"ValueField":"id","TextField":"name","ChildrenField":"child","Height":220}'></div>
            </div>
        </div>
        <div style="height: 100%; width: 80%; position: absolute; left: 20%; overflow: auto; overflow-y: hidden">
            <div id="searchDiv" style="height: 38px; border-left: 1px solid #ddd; position: relative; min-width: 1020px;">
                <div style="height: 100%; width: 200px; margin-left: 10px; display: inline-block;">
                    <div class="Title">
                        <div class="Icon machine-carnum"></div>
                        <span class="Text">设备编号</span>
                    </div>
                    <div style="width: 120px; height: 38px; line-height: 38px; float: left; margin-left: 5px;">
                        <div id="machineNum" class="dev-textbox" style="z-index: 2; width: 120px; margin-top: 8px;" opt='{"TipInfo":"","IsOverShow":true,"Padding":"0px 5px","TextAlign":"left","BodyCSS": { "background-color": "transparent" }}'></div>
                    </div>
                </div>
                <div id="searchtype" style="height: 100%; width: 200px; margin-left: 5px; display: inline-block">
                    <div class="Title">
                        <div class="Icon machine-carnum"></div>
                        <span class="Text">设备类型</span>
                    </div>
                    <div style="width: 120px; height: 38px; line-height: 38px; float: left; margin-left: 5px;">
                        <div id="devicetype" class="dev-combobox" style="z-index: 2; width: 120px; margin-top: 8px;" opt='{"TipInfo":"","IsOverShow":true,"Padding":"0px 5px","TextAlign":"left","BodyCSS": { "background-color": "transparent" }}'></div>
                    </div>
                </div>
                <div style="height: 100%; width: 200px; margin-left: 4px; display: inline-block;">
                    <div class="Title">
                        <div class="Icon icon-calendar"></div>
                        <span class="Text">上传时间</span>
                    </div>
                    <div style="width: 120px; height: 38px; line-height: 38px; display: inline-block; float: left; margin-left: 5px;">
                        <input id="uploadtime1" class="easyui-datebox" data-options="width:120,height:24,editable:false" />
                    </div>
                </div>
                <div style="height: 38px; width: 146px; margin-left: 4px; display: inline-block;">
                    <div style="width: 12px; height: 100%; display: inline-block; line-height: 38px; text-align: center; float: left; margin-left: 2px;">至</div>
                    <div style="width: 120px; height: 100%; line-height: 38px; display: inline-block; margin-left: 12px; float: left;">
                        <input id="uploadtime2" class="easyui-datebox" data-options="width:120,height:24,editable:false,validType:'equaldDate[\'#uploadtime1\']'" />
                    </div>
                </div>
                <div style="width: 160px; height: 38px; float: right; margin-right: 10px; z-index: 2; display: inline-block;">
                    <div class="Button" tag="search" style="margin-left: 10px;">
                        <div class="machine-query" style="height: 16px; width: 16px; margin-top: 5px; margin-left: 5px; display: inline-block; float: left;"></div>
                        <span style="line-height: 28px; color: #fcfcfc; width: 40px; text-align: center; margin-left: 3px;">查&nbsp;询</span>
                    </div>
                    <div class="Button" tag="clear" style="margin-left: 6px;">
                        <div class="machine-query" style="height: 16px; width: 16px; margin-top: 5px; margin-left: 5px; display: inline-block; float: left;"></div>
                        <span style="line-height: 28px; color: #fcfcfc; width: 40px; text-align: center; margin-left: 3px;">重&nbsp;置</span>
                    </div>
                </div>
            </div>
            <div id="gridDiv" style="width: 100%; border-left: 1px solid #ddd; border-top: 1px solid #ddd;"></div>
        </div>
    </div>
    <div id="Player" style="height: 55px; width: 480px; margin: auto; background-color: #f5f5f5; position: relative;">
        <div id="tools" style="height: 30px; width: 100%;">
            <div class="playicon icon-rewind" style="margin-left: 8px;"></div>
            <div class="playicon icon-stop"></div>
            <div class="playicon icon-play"></div>
            <div class="playicon icon-fast"></div>
            <div style="height: 24px; display: inline-block; width: 280px; margin-top: 4px; margin-left: 18px;">
                <input id="playslider" style="width: 280px;" />
            </div>
        </div>
        <div id="texts" style="height: 25px; width: 100%;">
            <span id="tracktime" style="margin-left: 15px; line-height: 25px;">轨迹时间:0000-00-00 00:00:00</span>
            <span id="speedText" style="margin-left: 45px; line-height: 25px;">速度:1X</span>
            <span style="margin-left: 70px; line-height: 25px;">总时间:<span id="trackLength"></span> &nbsp;s</span>
        </div>

    </div>
</body>
</html>
