<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>发动机管理</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <link rel="stylesheet" href="../../theme/default/easyui.css" />
    <link rel="stylesheet" type="text/css" href="../../theme/icon.css" />
    <link rel="stylesheet" type="text/css" href="../../css/app.css" />
    <link rel="stylesheet" type="text/css" href="../../css/main.css" />
    <link rel="stylesheet" type="text/css" href="../../css/icon.css" />
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../js/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="../../js/linq.min.js"></script>
    <script type="text/javascript" src="../../js/data.util.js"></script>
    <script type="text/javascript" src="../../js/jquery.dev.control.js"></script>
    <script type="text/javascript" src="../../js/dev.ui.js"></script>
    <script type="text/javascript" src="../../js/highcharts.js"></script>
    <script type="text/javascript" src="../../js/highcharts-more.js"></script>
    <script type="text/javascript" src="../../js/solid-gauge.js"></script>
    <script type="text/javascript">
        var Dev = window.top.window.dev;
        var parent;
        var flashDialog;
        var box, treecontrol, dataGrid;
        var pageIndex = 1, pageSize = 5;
        var selectdevice;
        var orgid;
        var paramType;
      //  var mapproj;
        function WidgetCommunication(s) {//部件通讯
            parent = s.parent;
            if (!Dev.IsNull(s.param) && !Dev.IsNull(s.param.DeviceType)) paramType = s.param.DeviceType;
            Dev.App.LeftPanel.bind("onResize", function () {//LeftPanel大小改变事件监听(Q:那么窗体改变的时候会进入该事件吗？)
                resize();
            });
            Dev.App.BottomPanel.bind("onResize", function () {
                if (!Dev.IsNull(dataGrid)) {
                    dataGrid.Resize(Dev.App.BottomPanel.Target.width(), Dev.App.BottomPanel.Target.outerHeight() - 26);
                }
            });
            flashDialog = new Dev.Messager({ Height: 95, Width: 200, AutoShow: false, Type: "question", Timeout: 1200, ButtonVisible: false, AutoVisible: true, Effect: "normal" });
            //改变LeftPanel的头部背景色
            Dev.App.LeftPanel.SetIconCls("machine-carmanage");
            Dev.App.LeftPanel.Header.css("background", "#14cdad");
            //改变LeftPanel头部的图标
            inittree();
            resize();
            parent.one("onClosing", function () {
                Dev.App.LeftPanel.unbind("onResize");
                Dev.App.BottomPanel.unbind("onResize");
                if (!Dev.IsNull(treecontrol)) treecontrol.unbind("onSelectChanged");
                if (!Dev.IsNull(dataGrid)) {
                    dataGrid.Target.unbind("onSelectPage");
                    dataGrid.Target.unbind("onClickRow");
                    dataGrid.Target.unbind("onPageSizeChange");
                    dataGrid = null;
                }
                Dev.MapUtils.ClearFeature("tempGraphicLayer");
                //清空
                Dev.App.BottomPanel.Clear();
                Dev.App.BottomPanel.SetVisible(false);
                //清空
                Dev.App.RightPanel.Clear();
                Dev.App.RightPanel.SetVisible(false);
              //  if (!Dev.IsNull(listenKey)) Dev.App.Map.unByKey(listenKey);
                Dev.App.BottomPanel.SetHeight(262);
                if (!Dev.IsNull(listenKey)) {
                    Dev.MapUtils.removePointKey(listenkeyId, dev.App.Map);
                    listenKey = null;
                }
            });
        }
        function inittree() {
            treecontrol = new Dev.Tree({ //初始化树
                ValueField: "id",
                TextField: "name",
                ChildrenField: "child"
            });
            $(".content").append(treecontrol.Target);//将树添加到滚动框中
            treecontrol.bind("onSelectChanged", function (e, o) {//绑定树选中事件
                //判断当前选中项是否为设备
                //  var currdata = o.$this;
                //  if (Dev.IsNull(currdata.isdevice) || !currdata.isdevice) return;
                //  selectdevice = currdata.no;
                var currdata = o.$this;
                if (Dev.IsNull(currdata.isdevice) || !currdata.isdevice) {
                    selectdevice = "";
                    var isleaf = treecontrol.IsLeaf(o);
                    var orgids = [];
                    orgids.push(o.id);
                    if (!isleaf) {
                        var allchilds = treecontrol.GetAllChildren(o);
                        for (var i = 0; i < allchilds.length; i++) orgids.push(allchilds[i].id);
                    }
                    orgid = "";
                    if (Dev.IsNull(orgids) || orgids.length == 0) return;
                    orgid = "\"ORGID\"  IN(";
                    for (var i = 0; i < orgids.length; i++) orgid += "'" + orgids[i] + "',";
                    orgid = orgid.substr(0, orgid.length - 1);
                    orgid += ")";
                } else {
                    selectdevice = currdata.no;
                    orgid = "";
                }
                getenginedata();
                // Dev.MapUtils.ClearFeature("tempGraphicLayer");
            });
            gettreedata();
        }
        function gettreedata() {
            var orgid = Dev.cookie.user.orgid;
            var paradata = { orgid: orgid };
            if (!Dev.IsNull(paramType)) paradata.deviceType = paramType;
            $.ajax({
                url: Dev.GetSystemUrlByRelID("Service") + "device/finddeviceandorgs",
                type: "POST",
                data: paradata,
                dataType: 'json',
                success: function (result) {
                    if (result.statusCode != 200 || result.data.orglist.length == 0) return;
                    var rootdata = Enumerable.From(result.data.orglist).Where('s=>s.id=="' + orgid + '"').FirstOrDefault();
                    rootdata.child = converttreedata(result.data.orglist, result.data.devicelist, orgid);
                    if (Dev.IsNull(rootdata.child)) rootdata.child = [];
                    var childdevice = Enumerable.From(result.data.devicelist).Where('s=>s.orgid=="' + orgid + '"').ToArray();
                    for (var i = 0; i < childdevice.length; i++) {
                        var currc = childdevice[i];
                        currc.name = currc.no;
                        currc.isdevice = true;
                        rootdata.child.push(currc);
                    }
                    rootdata.state = "open";
                    treecontrol.LoadData([rootdata]);
                }
            });
        }
        function converttreedata(data, devicelist, id) {
            if (Dev.IsNull(data) || data.length == 0 || Dev.IsNull(devicelist) || devicelist.length == 0) return;
            var rootData = Enumerable.From(data).Where('s=>s.parentid=="' + id + '"').ToArray();
            if (Dev.IsNull(rootData) || rootData.length == 0) return rootData;
            for (var i = 0; i < rootData.length; i++) {
                rootData[i].child = converttreedata(data, devicelist, rootData[i].id);
                var devicechild = Enumerable.From(devicelist).Where('s=>s.orgid=="' + rootData[i].id + '"').ToArray();
                if (Dev.IsNull(devicechild) && devicechild.length == 0) continue;
                for (var j = 0; j < devicechild.length; j++) {
                    var currc = devicechild[j];
                    currc.name = currc.no;
                    currc.isdevice = true;
                    rootData[i].child.push(currc);
                }
            }
            return rootData;
        }
        //初始列表
        function initDataGrid() {
            if (Dev.IsNull(dataGrid)) {
                var columns = [
                      { field: "no", width: 80, align: 'center', title: '车牌号', sortable: false },
                      { field: "uploadtime", width: 80, align: 'center', title: '上传时间', sortable: false, formatter: function (value, row, index) { return Dev.GetDateString(value); } },
                      { field: "torsion", width: 80, align: 'center', title: '扭矩百分比(%)', sortable: false },
                      { field: "fuel", width: 80, align: 'center', title: '燃油率(%)', sortable: false },
                      { field: "duration", width: 80, align: 'center', title: '运行小时数', sortable: false },
                      { field: "pedal", width: 80, align: 'center', title: '踏板位置', sortable: false },
                ];
                Dev.App.BottomPanel.SetIconCls("machine-carmanage");
                Dev.App.BottomPanel.SetTitle("车况列表");
                if (paramType == Dev.DeviceType.uav) {
                    columns = [
                    { field: "no", width: 80, align: 'center', title: '设备编号', sortable: false },
                    { field: "uploadtime", width: 80, align: 'center', title: '上传时间', sortable: false, formatter: function (value, row, index) { return Dev.GetDateString(value); } },
                    { field: "longitude", width: 80, align: 'center', title: '经度', sortable: false },
                    { field: "latitude", width: 80, align: 'center', title: '纬度', sortable: false },
                    { field: "speed", width: 80, align: 'center', title: '航速', sortable: false },
                    { field: "altitude", width: 80, align: 'center', title: '高程', sortable: false },
                    { field: "course", width: 80, align: 'center', title: '航向', sortable: false }
                    ];
                    Dev.App.BottomPanel.SetIconCls("uav-logo");
                    Dev.App.BottomPanel.SetTitle("无人机监测列表");
                }

                dataGrid = new Dev.UCDataGrid({
                    PageIndex: pageIndex, PageSize: pageSize, RowNumbers: false, ID: "engineGrid", pagequery: false, IsSizeSelect: true
                });
                Dev.App.BottomPanel.Header.css({ "background": "#14cdad", "color": "#fcfcfc", "font-weight": "bold" });

                Dev.App.BottomPanel.Add(dataGrid.Target);
                dataGrid.Layout(columns);
                Dev.App.BottomPanel.SetVisible(true);
                dataGrid.Target.bind("onSelectPage", function (s, e) {
                    pageIndex = e.index;//翻页
                    Dev.MapUtils.ClearFeature("tempGraphicLayer");
                    getenginedata();
                });
                dataGrid.Target.bind("onClickRow", function (s, e) {
                    //选中行
                    var id = e.Row.id;
                    if (Dev.IsNull(id)) return;
                    //高亮
                    highlight(e.Row);
                    //显示详细信息
                    var newtype = "AGRI_DEVICE";
                    if (paramType == Dev.DeviceType.uav) {
                        newtype = "AGRI_UAV";
                    }
                    Dev.App.RightPanel.Add(Dev.App.Root + "html/dev/enginedetail.html", { Type: newtype, ServerUrl: Dev.GetSystemUrlByRelID("Service") + "device/getbyfilter", PrimaryKey: "NO", KeyValue: e.Row, paramType: paramType });
                });
                dataGrid.Target.bind("onPageSizeChange", function (s, e) {
                    if (Dev.IsNull(e)) return;
                    pageIndex = 1;
                    pageSize = e;
                    Dev.MapUtils.ClearFeature("tempGraphicLayer");
                    getenginedata();
                });
                dataGrid.Resize(Dev.App.BottomPanel.Target.width(), Dev.App.BottomPanel.Target.outerHeight() - 26);
            }
        }

        function getenginedata() {
            Dev.App.RightPanel.Clear();
            Dev.App.RightPanel.SetVisible(false);
            //清除高亮
            //清除高亮
            if (!Dev.IsNull(listenKey)) {
                Dev.MapUtils.removePointKey(listenkeyId, dev.App.Map);
                listenKey = null;
            }
          //  if (!Dev.IsNull(listenKey)) Dev.App.Map.unByKey(listenKey);
            Dev.MapUtils.ClearFeature("tempGraphicLayer");
            // if (Dev.IsNull(selectdevice)) return;
            // var condition = "\"NO\"='" + selectdevice + "' Order By \"UPLOADTIME\" Desc";
            var condition = "1=1";
            if (!Dev.IsNull(selectdevice)) {
                condition += " AND \"NO\"='" + selectdevice + "'";
            }
            if (!Dev.IsNull(orgid)) {
                condition += " AND" + orgid;
            }
            condition += " Order By \"UPLOADTIME\" Desc";
            var url = "motor";
            if (paramType == Dev.DeviceType.uav) url = "uavSurvey";
            $.ajax({
                url: Dev.GetSystemUrlByRelID("Service") + "/" + url + "/getbyfilter/" + pageIndex + "/" + pageSize,
                type: "POST",
                contentType: 'application/json',
                data: condition,
                dataType: 'json',
                success: function (result) {
                    if (result.statusCode != 200) return;
                    if (result.data.dataSource.length == 0) flashDialog.Alert("暂未查询到数据!", "info");
                    if (Dev.IsNull(dataGrid)) initDataGrid();
                    dataGrid.Load(result.data.dataSource, result.data.pageInfo);
                    $('.datagrid-row', dataGrid.Target).css("height", "26px");
                    //   showpagefeatrue(result.data.dataSource);
                }
            });
        }
        function showpagefeatrue(data) {
            //清空图层fueature;
            Dev.MapUtils.ClearFeature("tempGraphicLayer");
            if (Dev.IsNull(data) || data.length == 0) return;
            var features = [];
            for (var i = 0; i < data.length; i++) {
                if (Dev.IsNull(data[i].longitude) || Dev.IsNull(data[i].latitude)) continue;
                var feature = new Dev.Feature(new Dev.geom.Point([parseFloat(data[i].longitude), parseFloat(data[i].latitude)]));
                if (paramType == Dev.DeviceType.uav) {
                    feature.setStyle(new Dev.style.Style({ image: new Dev.style.Icon({ src: Dev.App.Root + "image/uavtrack.png" }) }));
                } else {
                    feature.setStyle(new Dev.style.Style({ image: new Dev.style.Icon({ src: Dev.App.Root + "image/tractor.png" }) }));
                }

                features.push(feature);
            }
            var extend = Dev.getExtentByFeatures(features);
            if (!Dev.IsNull(extend)) {
                var points = [[extend[0], extend[1]], [extend[0], extend[3]], [extend[2], extend[3]], [extend[2], extend[1]], [extend[0], extend[1]]];
                var extendfeature = new Dev.Feature(new Dev.geom.Polygon([points]));
                Dev.setcountyposition(extendfeature);
                var mapproj = Dev.App.Map.getView().getProjection();
                if (mapproj.getCode() != Dev.App.Config.SystemMap.DataEPSG) extend = Dev.proj.transformExtent(extend, Dev.App.Config.SystemMap.DataEPSG, mapproj.getCode());
                Dev.App.Map.getView().fit(extend, Dev.App.Map.getSize());
            }
            Dev.MapUtils.AddFeatures(features);
        }
        var listenKey;
        function highlight(currdata) {
            Dev.MapUtils.ClearFeature("tempGraphicLayer");
            //  if (!Dev.IsNull(listenKey)) Dev.App.Map.unByKey(listenKey);
            if (!Dev.IsNull(listenKey)) {
                Dev.MapUtils.removePointKey(listenkeyId, dev.App.Map);
                listenKey = null;
            }
            if (Dev.IsNull(currdata.longitude) || Dev.IsNull(currdata.latitude)) return;
            var feature = new Dev.Feature(new Dev.geom.Point([parseFloat(currdata.longitude), parseFloat(currdata.latitude)]));
            feature.setId(currdata.id);
            listenKey = Dev.MapUtils.PointSymbolStyle1(feature, 1, "rgba(63, 85, 225, 1)", "rgba(63,85,225,0.5)", null, Dev.App.Map);
            listenkeyId = currdata.id;
            if (paramType == Dev.DeviceType.uav) {
                feature.setStyle(new Dev.style.Style({ image: new Dev.style.Icon({ src: Dev.App.Root + "image/uavtrack.png" }) }));
            } else {
                feature.setStyle(new Dev.style.Style({ image: new Dev.style.Icon({ src: Dev.App.Root + "image/tractor.png" }) }));
            }
            var features = [];
            features.push(feature.clone());
            Dev.MapUtils.AddFeatures(features);
            //Dev.justificationrange("features", features);
            var center = [parseFloat(currdata.longitude), parseFloat(currdata.latitude)];
            //转换坐标系
            var mapproj = Dev.App.Map.getView().getProjection();
            if (mapproj.getCode() != Dev.App.Config.SystemMap.DataEPSG)  center = Dev.proj.transform(center, Dev.App.Config.SystemMap.DataEPSG, mapproj.getCode());
            Dev.App.Map.getView().setCenter(center, Dev.App.Map.getSize());
            Dev.App.Map.getView().setZoom(16);
        }
        function resize() {
            if (!Dev.IsNull(treecontrol)) {
                treecontrol.SetHeight(Dev.App.LeftPanel.Height - 24);
                treecontrol.SetWidth(Dev.App.LeftPanel.Width + 15);
            }
        }
    </script>
    <style type="text/css">
        .content {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body style="height: 100%; width: 100%;">
    <div class="content"></div>
</body>
</html>
