<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>分布统计</title>
    <link rel="stylesheet" href="../../theme/default/easyui.css" />
    <link rel="stylesheet" type="text/css" href="../../theme/icon.css" />
    <link rel="stylesheet" type="text/css" href="../../css/app.css" />
    <link rel="stylesheet" type="text/css" href="../../css/main.css" />
    <link rel="stylesheet" type="text/css" href="../../css/icon.css" />
    <link type="text/css" href="../../css/dev.css" rel="stylesheet" />
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../js/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="../../js/linq.min.js"></script>
    <script type="text/javascript" src="../../js/data.util.js"></script>
    <script type="text/javascript" src="../../js/highcharts.js"></script>
    <script type="text/javascript" src="../../js/highcharts-more.js"></script>
    <script type="text/javascript" src="../../js/solid-gauge.js"></script>
    <script type="text/javascript" src="../../js/drilldown.js"></script>
    <script type="text/javascript" src="../../js/jquery.dev.control.js"></script>
    <script type="text/javascript" src="../../js/dev.ui.js"></script>
    <script type="text/javascript" src="../../js/guid.js"></script>
    <script type="text/javascript" src="../../js/highcharts-zh_CN.js"></script>
    <style type="text/css">
        .Button {
            background-color: #16dbbb;
            height: 27px;
            width: 60px;
            border: 1px solid #16dbbb;
            margin-top: 4px;
            display: inline-block;
            text-align: center;
            /*position: relative;*/
        }

            .Button:hover {
                background-color: #5227de;
                border: 1px solid #5227de;
                cursor: pointer;
            }

            .Button:active {
                background-color: #210097;
                border: 1px solid #210097;
                cursor: pointer;
            }

        .Title {
            width: 85px;
            text-align: right;
            line-height: 30px;
            height: 26px;
            display: inline-block;
            float: left;
            margin-top: 4px;
        }

            .Title .Icon {
                width: 16px;
                height: 16px;
                display: inline-block;
                margin-top: 7px;
                margin-right: 3px;
            }

            .Title .Text {
                display: inline-block;
                float: right;
                padding-right: 5px;
            }
    </style>
    <script type="text/javascript">
        var Dev = window.top.window.dev;
        var parent;
        var statData;
        var statWin;
        var drilldown = [];
        var orgid;
        var box;
        var viewChangedKey;
        var districtconfig = Dev.App.Config.Extend.StaticInfo.District;
        var districts;
        var legendsconfig = Dev.App.Config.Extend.StaticInfo.Legend;
        var legends, legendcontrol;
        var oldlever;
        var colorData;
        var condition;
        var dialog, flashDialog;
        var paramType;
        var uavtype = [];
        var uavcolor = ["#87CEFA", "#191970", "#FF8C00", "#8FBC8F", "#4169E1", "#008080", "#FF1493"];
        function WidgetCommunication(s) { //部件通讯
            parent = s.parent;
            if (!Dev.IsNull(s.param) && !Dev.IsNull(s.param.DeviceType)) paramType = s.param.DeviceType;
            Dev.App.BottomPanel.Header.css({ "background": "#14cdad", "color": "#fcfcfc", "font-weight": "bold" });
            Dev.App.BottomPanel.bind("onResize", function () {
                if (!Dev.IsNull(box)) box.SetSize({
                    Width: Dev.App.BottomPanel.Target.width(),
                    Height: (Dev.App.BottomPanel.Height - 28)
                });
            })
            $(window).resize(function () { resize(); })
            queryData();
            resize();
            /*按钮*/
            $(".Button").click(function () {
                var tag = $(this).attr("tag");
                if (tag == "count") queryData();
                else if (tag == "clear") {
                    searchClear();
                    queryData();
                }
                else if (tag == "stat") {
                    initStatWin();
                }
                else if (tag === "export") {
                    exportFile();
                }
            });
            getDistricts();//获取行政区划

            /*释放*/
            parent.one("onClosing", function () {
                if (!Dev.IsNull(viewChangedKey)) {
                    Dev.App.Map.getView().unByKey(viewChangedKey);
                    viewChangedKey = null;
                }
                Dev.App.BottomPanel.unbind("onResize");
                Dev.App.BottomPanel.SetHeight(262);
                Dev.App.BottomPanel.SetVisible(false);
                if (!Dev.IsNull(statWin)) {
                    statWin.unbind("onResize");
                    statWin.Close();
                    statWin.Destroy();
                    statWin = null;
                }
                if (!Dev.IsNull(box)) box = null;
                if (!Dev.IsNull(legendcontrol)) {
                    legendcontrol.SetVisible(false);
                    legendcontrol.Target.remove();
                    legendcontrol = null;
                }
                Dev.MapUtils.ClearFeature("tempGraphicLayer");
            });
            viewChangedKey = Dev.App.Map.getView().on("change:resolution", function (evt) {
                //获取当前的比例尺分辨率
                if (Dev.IsNull(statData)) return;
                if (Dev.IsNull(districts)) return;
                var lever = getlever();
                if (Dev.IsNull(lever) || oldlever == lever) return;
                oldlever = lever;
                getdata(statData, lever);
            });
            flashDialog = new Dev.Messager({ Height: 95, Width: 200, AutoShow: false, Type: "question", Timeout: 1500, ButtonVisible: false, AutoVisible: true, Effect: "normal" });
            dialog = new Dev.Messager({ AutoShow: false, Type: "question" });
            if (Dev.IsNull(paramType)) {
                $("#searchType").css("display", "none");
            }
            else {
                $("#searchDeviceType").css("display", "none");
                $(".Text", $("#searchType")).html(paramType == Dev.DeviceType.machine ? "农机类型" : "无人机类型");
                var temptype = (paramType == Dev.DeviceType.machine ? "MacType" : "UAVType");
                var bindtype = Dev.GetDicData([temptype]);
                if (!Dev.IsNull(bindtype) && bindtype.length > 0) {
                    uavtype = bindtype.concat();
                    var bt = bindtype.concat();         //不改变字典数据的副本
                    bt.unshift({ "data": "不限" }); //插入数组首部
                    var st = $("#Type", $("#searchType")).prop("$this");
                    st.SetData(bt);
                    st.Layout();
                }
            }
        }

        // 导出
        function exportFile() {
            Dev.exportExcelByUrl(Dev.GetSystemUrlByRelID("Service") + "device/export/" + orgid, condition);
        }

        /*查询*/
        function queryData() {
            orgid = Dev.cookie.user.orgid;//组织id
            condition = getcondition();
            $.ajax({
                url: Dev.GetSystemUrlByRelID("Service") + "device/countbyorgAndDevicetype/" + orgid,
                type: "POST",
                contentType: 'application/json',
                dataType: 'json',
                data: condition,
                success: function (result) {
                    if (result.statusCode != 200 || Dev.IsNull(result.data)) {
                        flashDialog.Alert("暂无该统计数据", "info");
                        return;
                    }
                    /*初始化数据列表*/
                    initData(fomatOther(result.data));
                    /*统计图数据*/
                    statData = fomatOther(result.data);
                    /*行政区数据*/
                    colorData = result.data;
                    if (Dev.IsNull(legendcontrol)) initlegend();
                    else legendcontrol.SetVisible(true);
                    /*获取当前行政区划*/
                    var lever = getlever();
                    if (Dev.IsNull(lever)) lever = "TOWN";
                    getdata(colorData, lever);
                    Dev.App.Map.getView().setZoom(4);
                    var curr_center = [104.2663955688479, 29.93828368186953];
                    var mapproj = Dev.App.Map.getView().getProjection();
                    if (mapproj.getCode() != Dev.App.Config.SystemMap.DataEPSG) curr_center = Dev.proj.transform(curr_center, Dev.App.Config.SystemMap.DataEPSG, mapproj.getCode());
                    Dev.App.Map.getView().setCenter(curr_center, Dev.App.Map.getSize());
                },
                error: function () {
                    flashDialog.Alert("网络异常，请重试！", "error");
                }
            });
        }

        /*将空key转换成“其他”*/
        function fomatOther(data) {
            for (var i = 0; i < data.length; i++) {
                $.each(data[i], function (key, val) {
                    if (val == "null") data[i][key] = "其他";
                });
            }
            return data;
        }

        /*获取查询条件*/
        function getcondition() {
            var con = "1=1";
            if (!Dev.IsNull(paramType)) {
                con += " AND \"DEVICETYPE\"='" + paramType + "'";
                var sdtype = $("#Type").prop("$this").GetValue();
                if (!Dev.IsNull(sdtype) && sdtype != "不限") { con += " AND \"TYPE\"='" + sdtype + "'"; }
                //  TYPE
            }
            else {
                var devicetype = $("#devicetype").prop("$this").GetValue();
                if (!Dev.IsNull(devicetype) && devicetype != "不限") { con += " AND \"DEVICETYPE\" = '" + devicetype + "'"; }
            }
            var time1 = $("#tasktime1").datebox("getValue");
            var time2 = $("#tasktime2").datebox("getValue");
            if (!Dev.IsNull(time1) && !Dev.IsNull(time2)) {
                var t1 = new Date(time1.replace(/-/g, "/"));
                var t2 = new Date(time2.replace(/-/g, "/"));
                if (t1.getTime() > t2.getTime()) {
                    var temp = time1;
                    time1 = time2;
                    time2 = temp;
                }
            }
            if (!Dev.IsNull(time1)) con += " AND \"CREATEDATE\">='" + time1 + " 00:00:00'";
            if (!Dev.IsNull(time2)) con += " AND \"CREATEDATE\"<='" + time2 + " 23:59:59'";
            //            if (!Dev.IsNull(orgFilter) && orgFilter.length > 0) con += " AND " + orgFilter;
            return con;
        }

        /*清空搜索条件*/
        function searchClear() {
            //清空选项框
            $("#devicetype").prop("$this").SetValue("");
            $("#Type").prop("$this").SetValue("");
            $("#tasktime1").datebox("setValue", "");
            $("#tasktime2").datebox("setValue", "");
        }

        //初始化数据列表
        function initData(data) {
           // data = [{ "type": "耕作机", "province": "黑龙江省", "city": "哈尔滨市", "county": "阿城区", "town": "亚沟街道办事处", "devicetype": "农机", "num": 2, "ratio": "15.38" }, { "type": "耕作机", "province": "黑龙江省", "city": "哈尔滨市", "county": "道外区", "town": "民主镇", "devicetype": "农机", "num": 2, "ratio": "15.38" }, { "type": "加工机", "province": "黑龙江省", "city": "哈尔滨市", "county": "道外区", "town": "民主镇", "devicetype": "农机", "num": 1, "ratio": "7.69" }]
            var gridDiv = $("#gridDiv");
            gridDiv.empty();//清空表格
            if (Dev.IsNull(data) || data.length == 0) return;
            //显示数据
            box = new Dev.Box({ HasBorder: false });
            box.Target.css({
                width: gridDiv.width() + "px",
                height: gridDiv.height() + "px"
            });
            box.Target.appendTo(gridDiv);
            var table;
            var devicetype = $("#devicetype").prop("$this").GetValue();
            if (Dev.IsNull(paramType) && (Dev.IsNull(devicetype) || devicetype === "不限")) {
                table = $('<table class="statInfo" cellspacing="0" cellpadding="0" width="100%"><tr><th>省</th><th>市</th><th>县</th><th>乡</th><th>设备类型</th><th>个数</th><th>比例</th></tr></table>');
            }
            else {
                table = $('<table class="statInfo" cellspacing="0" cellpadding="0" width="100%"><tr><th>省</th><th>市</th><th>县</th><th>乡</th><th>个数</th><th>比例</th></tr></table>');
            }
            //总行数
            var provincedata = Enumerable.From(data).GroupBy('s=>s.province').ToArray();
            var isprorow = false, iscityrow = false, iscountyrow = false, istownrow = false;
            for (var i = 0; i < provincedata.length; i++) {
                isprorow = true;
                var provincerowcount = provincedata[i].source.length;
                var provincename = provincedata[i].source[0].province;
                var citys = Enumerable.From(provincedata[i].source).GroupBy('s=>s.city').ToArray();
                for (var j = 0; j < citys.length; j++) {
                    iscityrow = true;
                    var cityrowcount = citys[j].source.length;
                    var cityname = citys[j].source[0].city;
                    var county = Enumerable.From(citys[j].source).GroupBy('s=>s.county').ToArray();
                    for (var k = 0; k < county.length; k++) {
                        iscountyrow = true;
                        var countyrowcount = county[k].source.length;
                        var countyname = county[k].source[0].county;
                        var town = Enumerable.From(county[k].source).GroupBy('s=>s.town').ToArray();

                        for (var l = 0; l < town.length; l++) {
                            istownrow = true;
                            var townrowcount = town[l].source.length;
                            if (townrowcount > 1) {
                                provincerowcount = cityrowcount = countyrowcount = townrowcount = 1;
                            }
                            var townname = town[l].source[0].town;
                            var tr = $('<tr></tr>').appendTo(table);
                            if (isprorow) {
                                tr.append($('<td rowspan="' + provincerowcount + '">' + (Dev.IsNull(provincename) ? "-" : provincename) + '</td>'));
                                isprorow = false;
                            }
                            if (iscityrow) {
                                tr.append($('<td rowspan="' + cityrowcount + '">' + (Dev.IsNull(cityname) ? "-" : cityname) + '</td>'));
                                iscityrow = false;
                            }
                            if (iscountyrow) {
                                tr.append($('<td rowspan="' + countyrowcount + '">' + (Dev.IsNull(countyname) ? "-" : countyname) + '</td>'));
                                iscountyrow = false;
                            }
                            if (istownrow) {
                                tr.append($('<td rowspan="' + townrowcount + '">' + (Dev.IsNull(townname) ? "-" : townname) + '</td>'));
                                istownrow = false;
                            }
                            if (Dev.IsNull(paramType) && (Dev.IsNull(devicetype) || devicetype === "不限")) {
                                tr.append($('<td>' + town[l].source[0].devicetype + '</td>'));
                            }
                            var num = Enumerable.From(town[l]).Sum('s=>parseFloat(s.num)');
                            var rationum = Enumerable.From(town[l]).Sum('s=>parseFloat(s.ratio)');
                            tr.append($('<td rowspan="' + townrowcount + '">' + num + '</td>'));
                            tr.append($('<td rowspan="' + townrowcount + '">' + rationum + '%</td>'));
                        }
                    }
                }
            }
            box.SetContent(table);
        }

        /*设置gridDiv大小*/
        function resize() {
            var height = $(window).outerHeight();
            var gridheight = height - 40;
            var gridwidth = $(window).outerWidth();
            $("#searchDiv").width(gridwidth);
            $("#gridDiv").height(gridheight).width(gridwidth);
            if (!Dev.IsNull(box)) box.SetSize({ Width: Dev.App.BottomPanel.Target.width(), Height: (Dev.App.BottomPanel.Height - 28) });
        }

        /*初始化统计图窗口*/
        function initStatWin() {
            //统计图
            if (Dev.IsNull(statData)) return;
            //弹出窗体
            if (Dev.IsNull(statWin)) {
                statWin = new Dev.Window({
                    ID: "distributedstat",
                    IconCls: 'icon-statistic',
                    Title: "分布统计图",
                    Parent: Dev.App.FillPanel.Target,
                    Maximizable: true,
                    Modal: true,
                    Draggable: true,
                    HAlign: 'center',
                    VAlign: 'center',
                    Resizable: false,
                    Content: initchartData(),
                    Height: 420,
                    Width: 650
                });
                statWin.bind("onResize", function (s, e) {
                    //改变统计图大小
                    var winheight = statWin.Height;
                    var winwidth = statWin.Width;
                    var chartdiv = $(".chartDiv", statWin.Target);
                    chartdiv.css({ "width": (winwidth - 2) + "px", "height": (winheight - 32) + "px" });
                    var chart = $("#chart", chartdiv);
                    if (Dev.IsNull(chart) || chart.length == 0) return;
                    if (!Dev.IsNull($(chart[0]).highcharts())) $(chart[0]).highcharts().setSize(winwidth - 2, winheight - 32, false);
                });
            }
            else {

                statWin.SetContent(initchartData());
                statWin.Open();
            }
        }

        /*初始化统计图数据*/
        function initchartData() {
            var chartdiv = $('<div class="chartDiv"></div>');
            drilldown = [];
            var chart = $('<div id="chart"></div>').appendTo(chartdiv);
            var seriesdata = Enumerable.From(statData).GroupBy('s=>s.province').ToArray();
            var series = [];
            for (var i = 0; i < uavtype.length; i++) {
                series[i] = { name: "省", data: [], type: "column", color: uavcolor[i] };
                for (var j = 0; j < seriesdata.length; j++) {
                    var typetatol = Enumerable.From(seriesdata[j]).GroupBy('s=>s.type').ToArray();
                    for (var k = 0; k < typetatol.length; k++) {
                        if (uavtype[i].data == typetatol[k].source[0].type) {
                            var num = Enumerable.From(typetatol[k]).Sum('s=>s.num');
                            series[i].data.push({ name: (Dev.IsNull(seriesdata[j].source[0].province) ? "其它" : seriesdata[j].source[0].province), y: num, tag: uavtype[i].data });
                        }
                    }
                    if (Dev.IsNull(series[i].data) || series[i].data.length < 1 || Dev.IsNull(series[i].data[j]))
                        series[i].data.push({ name: (Dev.IsNull(seriesdata[j].source[0].province) ? "其它" : seriesdata[j].source[0].province), y: 0, tag: uavtype[i].data });
                    if (i == 0) {
                        series[i].data[j].drilldown = "province" + j;
                        getdrilldown(seriesdata[j].source, "province", "province" + j);
                    }
                }
            }
            chart.highcharts({
                chart: {
                    events: {
                        drilldown: function (e) {
                            var c = this;
                            var drilldownid = e.point.drilldown;
                            var drilldownlineid = "line" + e.point.drilldown;
                            var newseries = Enumerable.From(drilldown).Where('s=>s.id=="' + drilldownid + '" || s.id=="' + drilldownlineid + '"').ToArray();
                            for (var i = 0; i < newseries.length; i++) c.addSingleSeriesAsDrilldown(e.point, newseries[i]);
                            c.applyDrilldown();
                            return false;
                        }
                    }
                },
                title: null,
                xAxis: {
                    type: 'category'
                },
                yAxis: [
                    {
                        title: { text: '个数(次)' }
                    }
                ],
                tooltip: {
                    headerFormat: '<span style="font-size:11px">{series.name}</span><br>',
                    pointFormat: '<span style="color:{point.color}">{point.tag}</span>: <b>{point.y}</b><br/>'
                },
                credits: { enabled: false },
                series: series,
                drilldown: {
                    //series: drilldown
                    series: []
                },
                legend: {
                    enabled: false
                }
            });
            return chartdiv;
        }

        /*钻取下层数据*/
        function getdrilldown(data, levername, id) {
            var groupname;
            var sname;
            if (levername == "province") {
                groupname = "city";
                sname = "市";
            }
            if (levername == "city") {
                groupname = "county";
                sname = "县";
            }
            if (levername == "county") {
                groupname = "town";
                sname = "乡";
            }
            if (levername == "town") {
                sname = "个数";
            }
            var currdata = [];
            var seriesdata = Enumerable.From(data).GroupBy('s=>s.' + groupname.toLowerCase()).ToArray();
            var drowdownname = "";
            if (groupname == "city") drilldownname = "county";
            if (groupname == "county") drilldownname = "town";
            if (groupname == "town") drilldownname = "townend";
            for (var i = 0; i < uavtype.length; i++) {
                currdata[i] = { name: sname, id: id, data: [], type: "column", color: uavcolor[i], tag: "个数" };
                drilldown.push(currdata[i]);
                for (var j = 0; j < seriesdata.length; j++) {
                    if (groupname != "town") {
                        var typetatol = Enumerable.From(seriesdata[j]).GroupBy('s=>s.type').ToArray();
                        for (var k = 0; k < typetatol.length; k++) {
                            if (uavtype[i].data == typetatol[k].source[0].type) {
                                var num = Enumerable.From(typetatol[k]).Sum('s=>s.num');
                                currdata[i].data.push({
                                    name: Dev.IsNull(seriesdata[j].source[0][groupname.toLowerCase()]) ? "其它" : seriesdata[j].source[0][groupname.toLowerCase()],
                                    y: num, tag: uavtype[i].data
                                });
                            }
                        }
                        if (Dev.IsNull(currdata[i].data) || currdata[i].data.length < 1 || Dev.IsNull(currdata[i].data[j]))
                            currdata[i].data.push({ name: Dev.IsNull(seriesdata[j].source[0][groupname.toLowerCase()]) ? "其它" : seriesdata[j].source[0][groupname.toLowerCase()], y: 0, tag: uavtype[i].data });
                        if (i == 0) {
                            currdata[i].data[j].drilldown = id + drilldownname + j;
                            getdrilldown(seriesdata[j].source, groupname, id + drilldownname + j);
                        }
                    }
                    else {
                        var typetatol = Enumerable.From(seriesdata[j]).GroupBy('s=>s.type').ToArray();
                        for (var k = 0; k < typetatol.length; k++) {
                            if (uavtype[i].data == typetatol[k].source[0].type) {
                                var num = Enumerable.From(typetatol[k]).Sum('s=>s.num');
                                currdata[i].data.push({
                                    name: seriesdata[j].source[0][groupname.toLowerCase()],
                                    y: num, tag: uavtype[i].data
                                });
                            }
                        }
                        if (Dev.IsNull(currdata[i].data) || currdata[i].data.length < 1)
                            currdata[i].data.push({ name: seriesdata[j].source[0][groupname.toLowerCase()], y: 0, tag: uavtype[i].data });
                    }
                }
            }
        }


        //初始化图例
        function initlegend() {
            legendcontrol = new Dev.UCLegend({ Left: 5 });
            legendcontrol.SetData(legends);
            legendcontrol.SetVisible(true);
        }

        //辅助函数
        function getlever() {//获取当前地图的比例尺对应的行政区划
            var lever;
            var resolution = Dev.MapUtils.GetScaleByResolution(Dev.App.Map.getView().getResolution(), Dev.App.Map);
            for (var i = 0; i < districts.length; i++) {
                var maxscale = null, minscale = null;
                if (!Dev.IsNull(districts[i].MaxScale)) maxscale = parseFloat(districts[i].MaxScale);
                if (!Dev.IsNull(districts[i].MinScale)) minscale = parseFloat(districts[i].MinScale);
                if (!Dev.IsNull(maxscale) && !Dev.IsNull(minscale) && resolution >= minscale && resolution <= maxscale) {
                    lever = districts[i].GroupField;
                    break;
                }
                if (!Dev.IsNull(minscale) && Dev.IsNull(maxscale) && resolution >= minscale) {
                    lever = districts[i].GroupField;
                    break;
                }
                if (!Dev.IsNull(maxscale) && Dev.IsNull(minscale) && resolution <= maxscale) {
                    lever = districts[i].GroupField;
                    break;
                }
            }
            return lever;
        }

        /*从配置文件获取行政区划*/
        function getDistricts() {
            //获取统计相关的配置文件
            if (!Dev.IsNull(districtconfig)) {
                if (Dev.IsNull(districtconfig.length)) districts = [Dev.ObjClone(districtconfig)];
                else districts = districtconfig.clone();
            }
            if (!Dev.IsNull(legendsconfig)) {
                if (Dev.IsNull(legendsconfig.length)) legends = [Dev.ObjClone(legendsconfig)];
                else legends = legendsconfig.clone();
            }
            legends = Enumerable.From(legends).Where('s=>s.Type=="distributed"').ToArray();//筛选distributed
        }

        //地图上渲染统计数据
        function getdata(data, lever) {
            Dev.MapUtils.ClearFeature("tempGraphicLayer");
            var newdata = [];
            for (var i = 0; i < data.length; i++) {
                /*过滤空值*/
                if (data[i].province == null || data[i].city == null || data[i].county == null || data[i].town == null) {
                    continue;
                }
                var tempdata = null;
                if (lever.toLowerCase() == "province") tempdata = Enumerable.From(newdata).Where('s=>s.province=="' + data[i].province + '"').FirstOrDefault();
                if (lever.toLowerCase() == "city") tempdata = Enumerable.From(newdata).Where('s=>s.province=="' + data[i].province + '" && s.city=="' + data[i].city + '"').FirstOrDefault();
                if (lever.toLowerCase() == "county") tempdata = Enumerable.From(newdata).Where('s=>s.province=="' + data[i].province + '" && s.city=="' + data[i].city + '" && s.county=="' + data[i].county + '"').FirstOrDefault();
                if (lever.toLowerCase() == "town") tempdata = Enumerable.From(newdata).Where('s=>s.province=="' + data[i].province + '" && s.city=="' + data[i].city + '" && s.county=="' + data[i].county + '" && s.town=="' + data[i].town + '"').FirstOrDefault();
                if (!Dev.IsNull(tempdata)) {
                    var index = Enumerable.From(newdata).IndexOf(tempdata);
                    newdata[index].data.push(data[i]);
                    continue;
                }
                var con = "";
                if (lever.toLowerCase() == "province") con = "PROVINCE='" + data[i].province + "'";
                if (lever.toLowerCase() == "city") con = "PROVINCE='" + data[i].province + "' AND CITY='" + data[i].city + "'";
                if (lever.toLowerCase() == "county") con = "PROVINCE='" + data[i].province + "' AND CITY='" + data[i].city + "' AND COUNTY='" + data[i].county + "'";
                if (lever.toLowerCase() == "town") con = "PROVINCE='" + data[i].province + "' AND CITY='" + data[i].city + "' AND COUNTY='" + data[i].county + "' AND TOWN='" + data[i].town + "'";
                var feature = Dev.getfeaturebylever(lever.toLowerCase(), con);
                if (Dev.IsNull(feature)) continue;
                newdata.push({
                    province: data[i].province,
                    city: data[i].city,
                    county: data[i].county,
                    town: data[i].town,
                    data: [data[i]],
                    feature: feature
                });
            }
            if (Dev.IsNull(newdata) || newdata.length == 0) return;
            var featrues = [];
            for (var i = 0; i < newdata.length; i++) {
                var currdatas = newdata[i].data;
                var num = Enumerable.From(currdatas).Sum('s=>s.num');
                //配置颜色
                var selectlegend;
                for (var j = 0; j < legends.length; j++) {
                    var maxvalue = null, minvalue = null;
                    if (!Dev.IsNull(legends[j].MinValue)) minvalue = parseFloat(legends[j].MinValue);
                    if (!Dev.IsNull(legends[j].MaxValue)) maxvalue = parseFloat(legends[j].MaxValue);
                    if (!Dev.IsNull(maxvalue) && Dev.IsNull(minvalue) && num <= maxvalue) {
                        selectlegend = legends[j];
                        break;
                    }
                    if (!Dev.IsNull(minvalue) && Dev.IsNull(maxvalue) && num > minvalue) {
                        selectlegend = legends[j];
                        break;
                    }
                    if (!Dev.IsNull(minvalue) && !Dev.IsNull(maxvalue) && num > minvalue && num <= maxvalue) {
                        selectlegend = legends[j];
                        break;
                    }
                }
                var style = new Dev.style.Style({
                    fill: new Dev.style.Fill({ color: selectlegend.Fill.Color }),
                    stroke: new Dev.style.Stroke({
                        color: selectlegend.Border.Color,
                        width: parseInt(selectlegend.Border.Width)
                    }),
                    text: new Dev.style.Text({
                        text: newdata[i][lever.toLowerCase()] + "(" + num + "个)",
                        font: "15px serif",
                        fill: new Dev.style.Fill({ color: [255, 255, 255, 1] }),
                    })
                });
                var style1 = new Dev.style.Style({
                    fill: new Dev.style.Fill({ color: selectlegend.Fill.Color }),
                    stroke: new Dev.style.Stroke({
                        color: selectlegend.Border.Color,
                        width: parseInt(selectlegend.Border.Width)
                    })
                });
                var currfeature = newdata[i].feature;
                var needfeature, maxarea = 0, index = 0;
                if (currfeature.length > 1) {
                    for (var m = 0; m < currfeature.length; m++) {
                        currfeature[m].setStyle(style1);
                        var area = currfeature[m].getGeometry().getArea();
                        if (area > maxarea) {
                            maxarea = area;
                            needfeature = currfeature[m];
                        }
                        featrues.push(currfeature[m]);
                    }
                    needfeature.setStyle(style);
                }
                else {
                    currfeature.setStyle(style);
                    featrues.push(currfeature);
                }
            }
            Dev.MapUtils.AddFeatures(featrues, "tempGraphicLayer", null, Dev.App.Map);
            //添加图例

        }

    </script>
</head>
<body style="height: 100%; width: 100%">
    <form id="export-form" style="display: none" method="post">
        <input name="condition" />
    </form>
    <div id="content" class="content">
        <div id="searchDiv" style="height: 38px; border-left: 1px solid #ddd; position: relative; min-width: 1100px;">
            <!--        &lt;!&ndash;统计方式:省市县&ndash;&gt;
            <div style="width: 300px; height: 35px; top: 0px; display: inline-block" >
                <div class="Title">
                    <span class="Text">统计方式</span>
                </div>
                <div style="width: 118px; height: 35px; line-height: 38px; float: left;">
                    <div id="countType" class="dev-combobox" style="width: 118px; display: inline-block; margin-top: 8px;"
                         opt='{"TextField":"data","ValueField":"id","TipInfo":"请选择统计方式","Data":[{"data":"国家","id":"COUNTRY"},{"data":"省","id":"PROVINCE"},{"data":"市","id":"CITY"},{"data":"县","id":"COUNTY"},{"data":"乡","id":"TOWN"}],"IsOverShow":true,"Padding":"0px","TextAlign":"left","BodyCSS": { "background-color": "transparent"}}'></div>
                </div>
            </div>-->

            <div id="searchDeviceType" style="height: 100%; width: 220px; margin-left: 4px; display: inline-block;">
                <div class="Title">
                    <div class="Icon icon-element"></div>
                    <span class="Text">设备类型</span>
                </div>
                <div style="width: 130px; height: 40px; line-height: 38px; float: left; margin-left: 5px;">
                    <div id="devicetype" class="dev-combobox" style="z-index: 2; width: 130px; margin-top: 8px;"
                        opt='{"TextField":"Text","ValueField":"Type","TipInfo":"请选择","Data":[{"Text":"不限","Type":"不限"},{"Text":"农机","Type":"农机"},{"Text":"无人机","Type":"无人机"}],"IsOverShow":true,"Padding":"0px","TextAlign":"left","BodyCSS": { "background-color": "transparent"}}'>
                    </div>
                </div>
            </div>
            <div id="searchType" style="height: 100%; width: 220px; margin-left: 4px; display: inline-block;">
                <div class="Title">
                    <div class="Icon icon-element"></div>
                    <span class="Text">农机类型</span>
                </div>
                <div style="width: 130px; height: 40px; line-height: 38px; float: left; margin-left: 5px;">
                    <div id="Type" class="dev-combobox" style="z-index: 2; width: 130px; margin-top: 8px;" opt='{"TextField":"data","ValueField":"data","TipInfo":"请选择","IsOverShow":true,"Padding":"0px","TextAlign":"left","BodyCSS": { "background-color": "transparent"}}'></div>
                </div>
            </div>

            <div style="height: 100%; width: 215px; margin-left: 4px; display: inline-block;">
                <div class="Title">
                    <div class="Icon icon-calendar"></div>
                    <span class="Text">创建时间</span>
                </div>
                <div style="width: 120px; height: 40px; line-height: 38px; display: inline-block; float: left; margin-left: 5px;">
                    <input id="tasktime1" class="easyui-datebox" data-options="width:120,height:24,editable:false" />
                </div>
            </div>
            <div style="height: 100%; width: 146px; margin-left: 4px; display: inline-block;">
                <div style="width: 12px; height: 40px; display: inline-block; line-height: 38px; text-align: center; float: left; margin-left: 2px;">
                    至
                </div>
                <div style="width: 120px; height: 40px; line-height: 38px; display: inline-block; margin-left: 12px; float: left;">
                    <input id="tasktime2" class="easyui-datebox"
                        data-options="width:120,height:24,editable:false,validType:'equaldDate[\'#tasktime1\']'" />
                </div>
            </div>
            <div style="width: 320px; height: 100%; float: right; display: inline-block;">
                <div class="Button" tag="count" style="margin-left: 10px;">
                    <div class="icon-statgraph"
                        style="height: 16px; width: 16px; margin-top: 5px; margin-left: 5px; display: inline-block; float: left;">
                    </div>
                    <span style="line-height: 28px; color: #fcfcfc; width: 40px; text-align: center; margin-left: 3px;">统&nbsp;计</span>
                </div>
                <div class="Button" tag="clear" style="margin-left: 4px;">
                    <div class="machine-reset"
                        style="height: 16px; width: 16px; margin-top: 5px; margin-left: 5px; display: inline-block; float: left;">
                    </div>
                    <span style="line-height: 28px; color: #fcfcfc; width: 40px; text-align: center; margin-left: 3px;">重&nbsp;置</span>
                </div>
                <div class="Button" tag="stat" style="margin-left: 4px;">
                    <div class="icon-statgraph"
                        style="height: 16px; width: 16px; margin-top: 5px; margin-left: 5px; display: inline-block; float: left;">
                    </div>
                    <span style="line-height: 28px; color: #fcfcfc; width: 40px; text-align: center; margin-left: 3px;">统计图</span>
                </div>
                <div class="Button" tag="export" style="margin-left: 4px;">
                    <div class="icon-export-white"
                        style="height: 16px; width: 16px; margin-top: 5px; margin-left: 5px; display: inline-block; float: left;">
                    </div>
                    <span style="line-height: 28px; color: #fcfcfc; width: 40px; text-align: center; margin-left: 3px;">导  出</span>
                </div>
            </div>
        </div>
        <div id="gridDiv" style="border-left: 1px solid #ddd; border-top: 1px solid #ddd;"></div>

    </div>

</body>
</html>
