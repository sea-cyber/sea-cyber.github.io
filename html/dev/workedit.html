<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>农机作业编辑</title>
    <link rel="stylesheet" href="../../theme/default/easyui.css" />
    <link rel="stylesheet" type="text/css" href="../../theme/icon.css" />
    <link rel="stylesheet" type="text/css" href="../../css/app.css" />
    <link rel="stylesheet" type="text/css" href="../../css/main.css" />
    <link rel="stylesheet" type="text/css" href="../../css/icon.css" />
    <link type="text/css" href="../../css/dev.css" rel="stylesheet" />
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../js/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="../../js/linq.min.js"></script>
    <script type="text/javascript" src="../../js/data.util.js"></script>
    <!--       <script type="text/javascript" src="../../js/jquery.dev.control.js"></script>-->
    <script type="text/javascript" src="../../js/dev.ui.js"></script>

    <!--    <script type="text/javascript" src="../../js/jquery.dev.js"></script>
    <script type="text/javascript" src="../../js/guid.js"></script>-->
    <style type="text/css">
        .content {
            width: 100%;
            height: 100%;
        }

            .content .tab {
                height: 66px;
                width: 100%;
                position: relative;
            }

                .content .tab .first {
                    position: absolute;
                    left: 0px;
                    top: 0px;
                    width: 50%;
                    height: calc(100% - 2px);
                    border-bottom: 2px solid #cacaca;
                }

                .content .tab .second {
                    position: absolute;
                    right: 0px;
                    top: 0px;
                    width: 50%;
                    height: calc(100% - 2px);
                    border-bottom: 2px solid #cacaca;
                }

                .content .tab .tab_select {
                    border-bottom: 2px solid #4855EE;
                }

                .content .tab .logo {
                    height: 26px;
                    width: 26px;
                    display: inline-block;
                    float: left;
                    margin-top: 20px;
                    margin-left: 60px;
                }

                .content .tab .logoText {
                    height: 26px;
                    display: inline-block;
                    margin-left: 6px;
                    line-height: 28px;
                    color: #cacaca;
                    font-weight: bold;
                    font-size: 16px;
                    margin-top: 20px;
                }

                .content .tab .logoText_select {
                    color: #4855EE;
                }

            .content .task, .content .route {
                width: 100%;
                height: calc(100% - 64px);
                position: relative;
            }

                .content .task .row, .content .route .row {
                    height: 30px;
                    width: calc(100% - 12px);
                    position: relative;
                    margin-top: 6px;
                }

                    .content .task .row:nth-child(1), .content .route .row:nth-child(1) {
                        margin-top: 5px;
                    }

                    .content .task .row .cell, .content .route .row .cell {
                        width: 50%;
                        height: 100%;
                        position: relative;
                        display: inline-block;
                        float: left;
                    }

                    .content .task .row .Title, .content .route .row .Title {
                        text-align: right;
                        padding-right: 8px;
                        width: 67px;
                    }

            .content .Button {
                width: 100px;
                position: absolute;
                right: 15px;
                top: 0px;
                height: 26px;
                background-color: #16dbbb;
                text-align: center;
                border: 1px solid #16dbbb;
            }

                .content .Button:hover {
                    background-color: #5227de;
                    border: 1px solid #5227de;
                    cursor: pointer;
                }

                .content .Button:active {
                    background-color: #210097;
                    border: 1px solid #210097;
                    cursor: pointer;
                }

            .content .Icon {
                border: 1px solid #95b8e7;
            }

                .content .Icon:hover {
                    background-color: #95b8e7;
                }

            .content .Iconunable {
                border: 1px solid #808080;
            }

                .content .Iconunable:hover {
                    background-color: #fff;
                }
    </style>
    <script type="text/javascript">
        var Dev = window.top.window.dev;
        var parent, updateid, orglist, waitbox;
        var comboTree, selectorgid;
        var xzqcombotree;
        var orgfilter;
        var mapclick;
        var isclick = false, drawflag;
        var selectblock_layer, fishnetserver;
        var flashDialog, placefeature, selectfishnetf;
        var newtrack, drawcontrol;
        var startpoint, endpoint;
        var isinit = true;//是否为初始加载内容
        function WidgetCommunication(s) {//部件通讯
            parent = s.parent;
            if (!Dev.IsNull(s.param)) {
                if (!Dev.IsNull(s.param.id)) updateid = s.param.id;
                if (!Dev.IsNull(s.param.selectorg)) orglist = s.param.selectorg;
            }
            Dev.App.MapPanel.Target.unbind("onMapRefresh")
            flashDialog = new Dev.Messager({ Height: 95, Width: 200, AutoShow: false, Type: "question", Timeout: 1500, ButtonVisible: false, AutoVisible: true, Effect: "normal" });
            initReceiveder();//初始化接受人
            $("#taskBeginTime").datetimebox({ width: $("#taskBeginTime").parent().width() - 1, height: 26 });//初始化开始时间
            $("#taskEndTime").datetimebox({ width: $("#taskEndTime").parent().width() - 1, height: 26 });//初始化结束时间
            $(".Button").click(function () {
                var tag = $(this).attr("tag");
                if (tag == "next" || tag == "last") { $("#errormsg1").html(""); $("#errormsg").html(""); changetab(tag); }
                if (tag == "save") save();
            });
            //路线规划界面初始化
            initroutexzq();//初始化作业区域
            initmachine();//初始化农机
            initfarm();//初始化农具
            initorgtree();//初始化组织机构
            init();
            parent.one("onClosing", function () {
                clear();
            });
            Dev.App.MapPanel.Target.bind("onMapRefresh", function () {
                if (!Dev.IsNull(Dev.App.Config.SystemMap.OldDisplayEPSG)) {
                    if (startpoint) startpoint = Dev.proj.transform(startpoint, Dev.App.Config.SystemMap.OldDisplayEPSG, Dev.App.Config.SystemMap.DisplayEPSG);
                    if (endpoint) endpoint = Dev.proj.transform(endpoint, Dev.App.Config.SystemMap.OldDisplayEPSG, Dev.App.Config.SystemMap.DisplayEPSG);
                }
            });
        }
        //初始化
        function init() {
            //任务类型数据
            var tasktypedic = Dev.GetDicData(["TaskSpec"]);
            if (!Dev.IsNull(tasktypedic) && tasktypedic.length > 0) {
                var task_control = $(".dev-combobox[name='type']").prop("$this");
                if (!Dev.IsNull(task_control)) task_control.SetData(tasktypedic);
            }
            mapclick = Dev.App.Map.on("singleclick", function (evt) { singlemapclick(evt); });
            $(".Icon").click(function () {
                var tag = $(this).attr("tag");
                if ($(this).hasClass("Iconunable")) return null;
                drawflag = tag;
                isclick = true;
                if (drawflag == "selectpalce") { Dev.App.MapPanel.MapDOM.css("cursor", "default"); Dev.drawstate = true; }
                if (drawflag == "addobstacle") addobstacle();
            });
            var serverinfos = Dev.getLayerbyValue(["fishnetlayer1"]);
            fishnetserver = Enumerable.From(serverinfos).Where('s=>s.Value=="fishnetlayer1"').FirstOrDefault();
            waitbox = new Dev.UCWaitBox(Dev.App.FillPanel.Target);
            var worktype_control = $(".dev-combobox[name='derection']").prop("$this").SetValue("shuttle");
            var workmode_control = $(".dev-combobox[name='startendpoint']").prop("$this");
            workmode_control.bind("onSelectChanged", function (s, e) {
                var isstate = false;
                Dev.MapUtils.RemoveFeatureLikeID("ppoint", "tempGraphicLayer", Dev.App.Map);
                if (e == "自定义" && !Dev.IsNull(placefeature)) {
                    isstate = true;
                    var geompoints = placefeature.getGeometry().getCoordinates();
                    var pointfeatures = [];
                    var plist = geompoints[0][0];
                    for (var i = 0; i < plist.length - 1; i++) {
                        var currfeature = new Dev.Feature(new Dev.geom.Point(geompoints[0][0][i]));
                        currfeature.setId("ppoint" + i);
                        pointfeatures.push(currfeature);
                    }
                    Dev.MapUtils.AddFeatures(pointfeatures, "tempGraphicLayer", null, Dev.App.Map, false);
                }
                iconset(isstate, "trackstart");
                iconset(isstate, "trackend");
            });
            workmode_control.SetValue("默认");
            $("#createline").click(function () { createline(); });
            if (!Dev.IsNull(updateid)) getdata_update();
        }

        //地图点击事件
        function singlemapclick(evt) {
            if (!isclick) return;
            isclick = false;
            if (drawflag == "selectpalce") { Dev.App.MapPanel.MapDOM.css("cursor", "url(" + Dev.App.Root + "image/hands.cur),auto"); Dev.drawstate = false; selectplace(evt); }//选择地块
            if (drawflag == "removeobstacle") removeobstacle(evt);//删除障碍点
            if (drawflag == "trackstart" || drawflag == "trackend") addstarorendpoint(evt);//添加起始点
        }

        //初始化组织树
        function initorgtree() {
            comboTree = new Dev.Combotree({
                Required: true, PopupHeight: 'auto', TipInfo: "请选择",
                MultiSelect: false, StateField: "State", ValueField: "id",
                TextField: "name", ChildrenField: "child", Height: 26, Border: "1px", Width: $("#treecomboDiv").width() - 1
            });

            $("#treecomboDiv").append(comboTree.Target);
            comboTree.bind("onSelectChanged", function (s, e) {
                var treenode = e;
                var orgids = [];
                orgids.push(e.id);
                selectorgid = e.id;
                var isleaf = comboTree.tree.IsLeaf(treenode);
                if (!isleaf) {
                    var allchilds = comboTree.tree.GetAllChildren(treenode);
                    for (var i = 0; i < allchilds.length; i++) {
                        orgids.push(allchilds[i].id);
                    }
                }
                orgfilter = " \"ORGID\" IN (";
                for (var i = 0; i < orgids.length; i++) orgfilter += "'" + orgids[i] + "',";
                orgfilter = orgfilter.substr(0, orgfilter.length - 1);
                orgfilter += ")";
                if (!Dev.IsNull(receivederControl)) { receivederIndex = 1; getreceivedata(); }
                if (!Dev.IsNull(machinecontrol)) { machineindex = 1; getmachinedata(); }
                if (!Dev.IsNull(framecontrol)) { farmeindex = 1; getframedata(); }
            });
            comboTree.Layout();
            if (!Dev.IsNull(orglist)) comboTree.SetData(orglist);
        }

        //初始化接收人
        var receivederControl, receivederIndex = 1, receivederSize = 5;
        function initReceiveder() {
            receivederControl = $("#receiveder");
            receivederControl.combogrid({
                idField: 'id', textField: 'name',
                columns: [[
                    { field: 'truename', title: '真实姓名', align: 'center', width: 70 },
                    { field: 'name', title: '登录名', align: 'center', width: 60 },
                    { field: 'phone', title: '电话', align: 'center', width: 80 },
                    { field: 'cano', title: 'CA证书', align: 'center', width: 50 }
                ]],
                width: $("#receiveder").width() - 1, height: 26, panelWidth: 290, panelHeight: 200, pagination: true, toolbar: $("#toobarRec"),
            });
            var page = receivederControl.combogrid("grid").datagrid("getPager");
            var parampage = {
                showPageList: false, showRefresh: false, pageNumber: receivederIndex, pageSize: receivederSize, onSelectPage: function (index, size) { receivederIndex = index; getreceivedata(); }
            };
            page.pagination(parampage);
            $("#recsearch", receivederControl.combogrid("panel")).click(function () { getreceivedata(); });
            $("#recreset", receivederControl.combogrid("panel")).click(function () { recievedatareset(); });
        }

        //查询接收人数据
        function getreceivedata() {
            var con = " 1=1 ";
            //接收人编号
            var receiveno_text = $('#PnoSearch', receivederControl.combogrid("panel")).prop("$this");
            var searchnokey = $.trim(receiveno_text.GetValue());
            if (!Dev.IsNull(searchnokey)) con += " AND  \"NO\" LIKE '%" + searchnokey + "%'";
            //接收人姓名
            var receivename_text = $('#PnameSearch', receivederControl.combogrid("panel")).prop("$this");
            var searchnamekey = $.trim(receivename_text.GetValue());
            if (!Dev.IsNull(searchnamekey)) con += " AND \"TRUENAME\" LIKE '%" + searchnamekey + "%'";
            //联系电话
            var receivephone_text = $('#PTypeSearch', receivederControl.combogrid("panel")).prop("$this");
            var searchphonekey = $.trim(receivephone_text.GetValue());
            if (!Dev.IsNull(searchphonekey)) con += " AND \"PHONE\" LIKE '%" + searchphonekey + "%'";
            //进行查询
            getdatabywhere("user", con);
        }

        //接收人查询重置
        function recievedatareset() {
            receivederIndex = 1;
            var receiveno_text = $('#PnoSearch', receivederControl.combogrid("panel")).prop("$this");
            receiveno_text.Clear();
            var receivename_text = $('#PnameSearch', receivederControl.combogrid("panel")).prop("$this");
            receivename_text.Clear();
            var receivephone_text = $('#PTypeSearch', receivederControl.combogrid("panel")).prop("$this");
            receivephone_text.Clear();
            //进行查询
            var con = "1=1";
            getdatabywhere("user", con);
        }

        //初始化作业区域
        function initroutexzq() {
            xzqcombotree = new Dev.Combotree({
                Required: true, PopupHeight: '250', TipInfo: "请选择",
                MultiSelect: false, StateField: "State", ValueField: "ID",
                TextField: "Text", ChildrenField: "Child", Height: 26, Border: "1px", Width: $("#routexzq").width() - 1,
                height: 26
            });
            //切换的时候进行
            $("#routexzq").append(xzqcombotree.Target);
            var xzqplace = Dev.GetTreeLayers("work", false); //作业地区
            xzqcombotree.SetData(xzqplace);
            xzqcombotree.bind("onSelectChanged", function (s, e) {
                var isf = xzqcombotree.tree.IsLeaf(e.$this.Target);//判断是否为叶子节点
                if (!isf) {
                    xzqcombotree.text.Clear();
                    if (e.$this.State == "open") {
                        if ($('.collapsed:hover', xzqcombotree.Target).length > 0) return;
                        xzqcombotree.tree.Collapse(e.$this.Target, false);
                    }
                    else {
                        if ($('.expanded:hover', xzqcombotree.Target).length > 0) return;
                        xzqcombotree.tree.Expand(e.$this.Target, false);
                    }
                }
                else {
                    //获取当前节点下的地块信息
                    iconset(false, "selectpalce");
                    var curr_blocks = Dev.getLayersByCode(e.$this.ID, "work");
                    addblockwms(curr_blocks[0]);
                    selectblock_layer = curr_blocks[0];
                }

            });
        }

        //初始化农机
        var machinecontrol, machineindex = 1, machinesize = 5;
        function initmachine() {
            machinecontrol = $("#machineno");
            machinecontrol.combogrid({
                idField: 'id', textField: 'no',
                columns: [[
                        { field: 'no', title: '车牌号', width: 80, align: 'center' },
                        { field: 'vendor', title: '厂商', align: 'center', width: 80 },
                        {
                            field: 'spec', title: '型号', align: 'center', width: 80, formatter: function (value, row, index) {
                                return row.spec;
                            }
                        },
                        { field: 'type', title: '类型', align: 'center', width: 80 },
                        { field: 'use', title: '用途', align: 'center', width: 80 }
                ]],
                width: $("#machineno").width() - 1, height: 26, panelWidth: 405, panelHeight: 221, pagination: true, toolbar: $("#toolbarMac"),
                onChange: function (newvalue, oldvalue) {
                    var linef = Dev.MapUtils.GetFeatureByID("trackerline");
                    if (!Dev.IsNull(linef)) Dev.MapUtils.RemoveFeature(linef, "tempGraphicLayer", Dev.App.Map);
                    $(".dev-textbox[name='route']").prop("$this").SetValue("");
                }
            });

            var machinepage = machinecontrol.combogrid("grid").datagrid("getPager");
            var parampage = { showPageList: false, showRefresh: false, pageNumber: machineindex, pageSize: machinesize, onSelectPage: function (index, size) { machineindex = index; getmachinedata(); } };
            machinepage.pagination(parampage);
            //农机品牌数据绑定
            var searchTbBrandControl = $('#macbrandSearch', machinecontrol.combogrid("panel")).prop("$this");
            var dicdata = Dev.GetDicData(["MacBrand", "MacType"]);
            var bindBrand = Enumerable.From(dicdata).Where('s=>s.type=="MacBrand"').ToArray();
            if (!Dev.IsNull(bindBrand) && bindBrand.length > 0) {
                bindBrand.unshift({ "data": "不限", "id": "0000000000", "parentid": bindBrand[0].parentid });
                searchTbBrandControl.SetData(bindBrand);
            }
            //农机类型数据绑定
            var searchTbTypeControl = $('#mactypeSearch', machinecontrol.combogrid("panel")).prop("$this");
            var bindType = Enumerable.From(dicdata).Where('s=>s.type=="MacType"').ToArray();    //   绑定字典数据
            if (!Dev.IsNull(bindType) && bindType.length > 0) {
                bindType.unshift({ "data": "不限", "id": "9999999999", "parentid": bindType[0].parentid }); //插入数组首部
                searchTbTypeControl.SetData(bindType);
            }
            var searchTbnoControl = $('#macnumSearch', machinecontrol.combogrid("panel")).prop("$this");
            $("#macsearch", machinecontrol.combogrid("panel")).click(function () { getmachinedata(); });
            $("#macreset", machinecontrol.combogrid("panel")).click(function () { machinedatareset(); });
        }

        //查询农机数据
        function getmachinedata() {
            var con = " 1=1 ";
            var searchbrandkey = $('#macbrandSearch', machinecontrol.combogrid("panel")).prop("$this").GetText(); //获取品牌
            if (!Dev.IsNull(searchbrandkey) && searchbrandkey != "不限") con += " AND  \"BRAND\" LIKE '%" + searchbrandkey + "%'";
            var searchtypekey = $('#mactypeSearch', machinecontrol.combogrid("panel")).prop("$this").GetText(); //获取类型
            if (!Dev.IsNull(searchtypekey) && searchtypekey != "不限") con += " AND  \"TYPE\" LIKE '%" + searchtypekey + "%'";
            var searchnokey = $('#macnumSearch', machinecontrol.combogrid("panel")).prop("$this").GetValue();//获取编号
            if (!Dev.IsNull(searchnokey)) con += " AND ( \"NO\"  LIKE '%" + searchnokey + "%'" + " OR " + "UPPER( \"NO\" )  LIKE " + "UPPER('%" + searchnokey + "%')" + " OR " + "LOWER( \"NO\" )  LIKE " + "LOWER('%" + searchnokey + "%'))";       //大小写不敏感
            con += " AND  \"DEVICETYPE\" = '农机'";
            getdatabywhere("machine", con);
        }

        //农机查询重置
        function machinedatareset() {
            var con = " 1=1 ";
            machineindex = 1;
            $('#macbrandSearch', machinecontrol.combogrid("panel")).prop("$this").SetValue("");
            $('#mactypeSearch', machinecontrol.combogrid("panel")).prop("$this").SetValue("");
            $('#macnumSearch', machinecontrol.combogrid("panel")).prop("$this").Clear();
            getdatabywhere("machine", con);
        }

        //初始化农具
        var framecontrol, farmeindex = 1, farmesize = 5;
        function initfarm() {
            var isadd = Dev.IsNull(updateid);
            framecontrol = $("#framnum");
            framecontrol.combogrid({
                idField: 'id', textField: 'farmname',
                columns: [[
                        { field: 'farmname', title: '名称', width: 80, align: 'center' },
                        { field: 'farmspec', title: '型号', align: 'center', width: 80 },
                        { field: 'vendor', title: '厂商', align: 'center', width: 80 },
                        { field: 'farmsize', title: '长度(m)', align: 'center', width: 80 },
                        { field: 'farmwidth', title: '宽度(m)', align: 'center', width: 80 }
                ]],
                width: $("#framnum").parent().width() - 1, height: 26, panelWidth: 402, panelHeight: 221, pagination: true, toolbar: $("#toolbarFarm"),
                onChange: function (newvalue, oldvalue) {
                    //切换农具,清空路线
                    var linef = Dev.MapUtils.GetFeatureByID("trackerline");
                    if (!Dev.IsNull(linef)) Dev.MapUtils.RemoveFeature(linef, "tempGraphicLayer", Dev.App.Map);
                    $(".dev-textbox[name='route']").prop("$this").SetValue("");
                }
            });
            var framepage = framecontrol.combogrid("grid").datagrid("getPager");
            var parampage;
            //新增 与 修改时候调用的 翻页模式不同
            if (isadd) parampage = { showPageList: false, showRefresh: false, pageNumber: farmeindex, pageSize: farmesize, onSelectPage: function (index, size) { farmeindex = index; getframedata(); } };
            else parampage = { showPageList: false, showRefresh: false, pageNumber: farmeindex, pageSize: farmesize, onSelectPage: function (index, size) { farmeindex = index; getframedata(); } };
            framepage.pagination(parampage);
            $("#farmsearch", framecontrol.combogrid("panel")).click(function () { getframedata(); });
            $("#farmreset", framecontrol.combogrid("panel")).click(function () { framedatareset(); });

        }

        //查询农具数据
        function getframedata() {
            var con = " 1=1 ";
            var searchnamekey = $('#fnameSearch', framecontrol.combogrid("panel")).prop("$this").GetValue();
            if (!Dev.IsNull(searchnamekey)) con += " AND  \"FARMNAME\" LIKE '%" + searchnamekey + "%'";
            var searchminsize = $('#fminlength', framecontrol.combogrid("panel")).prop("$this").GetValue();
            if (!Dev.IsNull(searchminsize)) searchTbFilterFarm += " AND  \"FARMSIZE\" >=" + parseFloat(searchminsize);
            var searchmaxsize = $('#fmaxlength', framecontrol.combogrid("panel")).prop("$this").GetValue();
            if (!Dev.IsNull(searchmaxsize)) searchTbFilterFarm += " AND  \"FARMSIZE\" < " + parseFloat(searchmaxsize);
            getdatabywhere("farme", con);
        }

        //农具数据重置
        function framedatareset() {
            var con = " 1=1 ";
            farmeindex = 1;
            $('#fnameSearch', framecontrol.combogrid("panel")).prop("$this").Clear();
            $('#fminlength', framecontrol.combogrid("panel")).prop("$this").Clear();
            $('#fmaxlength', framecontrol.combogrid("panel")).prop("$this").Clear();
            getdatabywhere("farme", con);
        }

        //根据类型和条件进行查询(接收人、农机、农具)
        function getdatabywhere(type, where) {
            if (Dev.IsNull(type)) return;
            var curr_control;
            var con = where;
            var url = Dev.GetSystemUrlByRelID("Service");
            if (Dev.IsNull(where)) con = " 1=1 ";
            //获取组织机构
            if (!Dev.IsNull(orgfilter)) con += " AND " + orgfilter
            if (type == "farme") {
                url += "farm/getbyfilter/" + farmeindex + "/" + farmesize;
                con += " ORDER BY \"CREATEDATE\" DESC";
                curr_control = framecontrol;
            }
            if (type == "machine") {
                url += "device/getbyfilter/" + machineindex + "/" + machinesize;
                con += " ORDER BY \"CREATEDATE\" DESC";
                curr_control = machinecontrol;
            }
            if (type == "user") {
                url += "user/getbyfilter/" + receivederIndex + "/" + receivederSize;
                curr_control = receivederControl;
            }
            if (Dev.IsNull(curr_control)) return;
            $.ajax({
                url: url,
                type: "POST",
                contentType: 'application/json',
                dataType: 'json',
                data: con,
                success: function (result) {
                    curr_control.combogrid("grid").datagrid("loadData", result.data.dataSource);
                    var page = curr_control.combogrid("grid").datagrid("getPager");
                    page.pagination('refresh', { total: result.data.pageInfo.totalCount, pageNumber: result.data.pageInfo.pageIndex });
                }
            });
        }
        //添加地块图层
        function addblockwms(layerinfo) {
            Dev.MapUtils.RemoveLayer("workblocklayer", Dev.App.Map);
            if (Dev.IsNull(layerinfo)) return;
            //  if (!Dev.IsNull(mapproj)) var mapproj = Dev.App.Map.getView().getProjection();
            var param = {
                Map: Dev.App.Map,
                ID: "workblocklayer",
                Url: Dev.GetSystemUrlByRelID(layerinfo.Url),
                Layers: layerinfo.TypeName,
                ServerType: layerinfo.ServerType,
                EPSG: Dev.App.Map.getView().getProjection().getCode()
            }
            if (!Dev.IsNull(layerinfo.SldLegend)) {
                param.Sldbody = Dev.GetSLDString(layerinfo.TypeName, Dev.LegendToRule(layerinfo.SldLegend));
            }
            if (!Dev.IsNull(layerinfo.Envelop)) {
                var arry = layerinfo.Envelop.split(',');
                param.Extent = [parseFloat(arry[0]), parseFloat(arry[1]), parseFloat(arry[2]), parseFloat(arry[3])];
            }
            Dev.MapLoad.AddWMSLayer(param);
            if (!Dev.IsNull(param.Extent)) {
                var mapproj = Dev.App.Map.getView().getProjection();
                var extent = param.Extent;
                if (mapproj.getCode() != Dev.App.Config.SystemMap.DataEPSG) extent = Dev.proj.transformExtent(extent, Dev.App.Config.SystemMap.DataEPSG, mapproj.getCode());
                if (!Dev.IsNull(extent)) Dev.App.Map.getView().fit(extent, Dev.App.Map.getSize());
            }

            iconset(true, "selectpalce");
            if (!isinit) {
                placefeature = undefined;
                $(".dev-textbox[name='route']").prop("$this").SetValue("");
            }
        }

        //选中地块
        function selectplace(evt) {
            $(".dev-textbox[name='route']").prop("$this").Clear();
            $(".dev-textbox[name='obstacle']").prop("$this").Clear();
            Dev.MapUtils.ClearFeature("tempGraphicLayer", Dev.App.Map);
            Dev.MapUtils.ClearFeature("tempDrawLayer", Dev.App.Map);
            startpoint = null;
            endpoint = null;
            //Dev.MapUtils.RemoveFeatureLikeID("trackstartpoint", "tempGraphicLayer", Dev.App.Map);
            //Dev.MapUtils.RemoveFeatureLikeID("trackendpoint", "tempGraphicLayer", Dev.App.Map)
            newtrack = null;
            if (Dev.IsNull(selectblock_layer)) return;
            var coordinate = evt.coordinate;
            //if (mapproj.getCode() != Dev.App.Config.SystemMap.DataEPSG) coordinate = Dev.proj.transform(coordinate, mapproj.getCode(), Dev.App.Config.SystemMap.DataEPSG);
            var result = Dev.PointerQuery({
                GeometryName: selectblock_layer.GeomField,
                PX: 2,
                Point: coordinate,
                Map: Dev.App.Map,
                Url: Dev.GetSystemUrlByRelID(selectblock_layer.WFSUrl),
                TypeName: selectblock_layer.TypeName
            });
            if (Dev.IsNull(result) || result.length == 0) {
                flashDialog.Alert("选中的位置暂无地块！", "warning");
                return;
            }
            placefeature = result[0].clone();
            placefeature.setId(placefeature.getProperties().gid);
            Dev.MapUtils.AddFeature(placefeature, "tempGraphicLayer");
            //如果为自定义类型,则可以选起始点
            var workmode = $(".dev-combobox[name='startendpoint']").prop("$this").GetValue();
            if (!Dev.IsNull(workmode) && workmode == "自定义") {
                var geompoints = placefeature.getGeometry().getCoordinates();
                var pointfeatures = [];
                var plist = geompoints[0][0];
                for (var i = 0; i < plist.length - 1; i++) {
                    var currfeature = new Dev.Feature(new Dev.geom.Point(geompoints[0][0][i]));
                    currfeature.setId("ppoint" + i);
                    pointfeatures.push(currfeature);
                }
                Dev.MapUtils.AddFeatures(pointfeatures, "tempGraphicLayer", null, Dev.App.Map, false);
                iconset(true, "trackstart");
                iconset(true, "trackend");
            }
            iconset(true, "addobstacle");
            iconset(true, "removeobstacle");
            if (workmode != "自定义") $("#createline").css({ "background-color": "#0099cc", "border": "1px solid #95b8e7" });
            getfishnetbyplace(evt);
        }

        //根据选中地块获取电子围栏
        function getfishnetbyplace(evt) {
            var fishresult = Dev.PointerQuery({
                GeometryName: fishnetserver.GeomField,
                PX: 2,
                Point: evt.coordinate,
                Map: Dev.App.Map,
                Async: true,
                Url: Dev.GetSystemUrlByRelID(fishnetserver.WFSUrl),
                TypeName: fishnetserver.TypeName
            });
            var fishdata = [];
            if (!Dev.IsNull(selectfishnetf)) {
                selectfishnetf = null;
                $(".dev-combobox[name='fishnet']").prop("$this").Clear();
            }
            if (!Dev.IsNull(fishresult) && fishresult.length > 0) {
                for (var i = 0; i < fishresult.length; i++) fishdata.push({ name: fishresult[i].getProperties().NAME, geomstr: getgeomstr(fishresult[i]), feature: fishresult[i] });
            }
            $(".dev-combobox[name='fishnet']").prop("$this").SetData(fishdata);
        }

        //添加障碍点
        function addobstacle() {
            Dev.MapUtils.ClearFeature("tempDrawLayer", Dev.App.Map);
            if (Dev.IsNull(drawcontrol)) {
                drawcontrol = new Dev.Draw({ Map: Dev.App.Map, Layer: Dev.MapUtils.GetLayer("tempDrawLayer", Dev.App.Map) });
                drawcontrol.Target.bind("onDrawCompleted", function (s, e) {
                    Dev.App.MapPanel.MapDOM.css("cursor", "url(" + Dev.App.Root + "image/hands.cur),auto");
                    Dev.drawstate = false;
                    newtrack = e;
                    e.setId(("obstacle" + new Date().getTime()));
                    var geomstr = e.getGeometry().getCoordinates();
                    geomstr = geomstr.join(",").replace(/,/g, " ");
                    $(".dev-textbox[name='obstacle']").prop("$this").SetValue(geomstr);
                    drawcontrol.Stop();
                    drawcontrol.Destroy();
                });
            } else {
                if (!Dev.IsNull(Dev.App.Config.SystemMap.OldDisplayEPSG) && Dev.App.Config.SystemMap.OldDisplayEPSG != Dev.App.Config.SystemMap.DisplayEPSG) {
                    drawcontrol.SetLayer(Dev.MapUtils.GetTempLayer("tempDrawLayer"));
                }
            }
            drawcontrol.Start("Polygon");
            Dev.App.MapPanel.MapDOM.css("cursor", "url(" + Dev.App.Root + "image/cursor_draw.cur),auto");
            Dev.drawstate = true;
        }

        //删除障碍点
        function removeobstacle(evt) {
            var pixel = Dev.App.Map.getPixelFromCoordinate(evt.coordinate);
            Dev.App.Map.forEachFeatureAtPixel(pixel, function (feature) {
                var fid = feature.getId().toString();
                if (!Dev.IsNull(fid) && fid.indexOf("obstacle") >= 0) {
                    Dev.MapUtils.RemoveFeature(feature, "tempDrawLayer", Dev.App.Map);
                    $(".dev-textbox[name='obstacle']").prop("$this").Clear();
                    newtrack = null;
                }
            });
        }

        //选择起始点
        function addstarorendpoint(evt) {
            if (Dev.IsNull(placefeature)) { flashDialog.Alert("请先选择作业地块！", "warn"); return; }
            var pixel = Dev.App.Map.getPixelFromCoordinate(evt.coordinate);
            var ppfeature;
            Dev.App.Map.forEachFeatureAtPixel(pixel, function (feature) {
                if (!Dev.IsNull(feature.getId())) {
                    if (feature.getId().toString().indexOf("ppoint") >= 0) ppfeature = feature;
                }
            });
            if (Dev.IsNull(ppfeature)) { flashDialog.Alert((drawflag == "" ? "起点" : "终点") + "请选择地块边界上的点！", "warn"); return; }
            var sepointf = ppfeature.clone();
            var sepointf = ppfeature.clone();
            var iconsrc = Dev.App.Root + "image/agri/workstart.png";
            if (drawflag == "trackstart") {
                startpoint = ppfeature.getGeometry().getCoordinates();
                Dev.MapUtils.RemoveFeatureLikeID("trackstartpoint", "tempGraphicLayer", Dev.App.Map);
                sepointf.setId("trackstartpoint");
            }
            if (drawflag == "trackend") {
                iconsrc = Dev.App.Root + "image/agri/workend.png";
                endpoint = ppfeature.getGeometry().getCoordinates();
                Dev.MapUtils.RemoveFeatureLikeID("trackendpoint", "tempGraphicLayer", Dev.App.Map)
                sepointf.setId("trackendpoint");
            }
            sepointf.setStyle(new Dev.style.Style({ image: new Dev.style.Icon({ src: iconsrc, anchor: [0.5, 1] }) }));
            Dev.MapUtils.AddFeature(sepointf, "tempGraphicLayer", Dev.App.Map, false);
            if (!Dev.IsNull(startpoint) && !Dev.IsNull(endpoint)) {//开始分析路线
                $("#createline").css({ "background-color": "#0099cc", "border": "1px solid #95b8e7" });
            }
        }

        //生成路线
        function createline() {
            waitbox.Show();
            if (Dev.IsNull(placefeature)) { flashDialog.Alert("请先选择作业地块！", "warn"); waitbox.Close(); return; }
            var ishaspoint = $(".dev-combobox[name='startendpoint']").prop("$this").GetValue();
            if (ishaspoint == "自定义" && (Dev.IsNull(startpoint) || Dev.IsNull(endpoint))) { flashDialog.Alert("请先选择起点和终点！", "warn"); waitbox.Close(); return; }
            //var selectmachineitem = machinecontrol.combogrid("grid").datagrid("getSelected");//作业农机
               var selectmachineitem = machinecontrol.combogrid("getText");
            if (Dev.IsNull(selectmachineitem)) { flashDialog.Alert("请选择作业农机！", "warn"); waitbox.Close(); return; }
           // var selectframitem = framecontrol.combogrid("grid").datagrid("getSelected");//作业农具
              var selectframitem = framecontrol.combogrid("getText");
            if (Dev.IsNull(selectframitem)) { flashDialog.Alert("请选择作业农具！", "warn"); waitbox.Close(); return; }
            //if (ishaspoint == "自定义" && (!Dev.IsNull(startpoint) || !Dev.IsNull(endpoint)) && (!Dev.IsNull(Dev.App.Config.SystemMap.OldDisplayEPSG) && (Dev.App.Config.SystemMap.OldDisplayEPSG != Dev.App.Config.SystemMap.DisplayEPSG))) {
            //    startpoint = Dev.proj.transform(startpoint, Dev.App.Config.SystemMap.OldDisplayEPSG, Dev.App.Config.SystemMap.DataEPSG);
            //    endpoint = Dev.proj.transform(endpoint, Dev.App.Config.SystemMap.OldDisplayEPSG, Dev.App.Config.SystemMap.DataEPSG);
            //}
            var parmdata = {};
            var derect = $(".dev-combobox[name='derection']").prop("$this").GetValue(); //作业方式
            var toolsize = Dev.IsNull(selectframitem.farmsize) ? 4 : parseFloat(selectframitem.farmsize);
            var machineno = (Dev.IsNull(selectmachineitem) || Dev.IsNull(selectmachineitem.mintrunradius)) ? 8 : parseFloat(selectmachineitem.mintrunradius);
            parmdata.boundPoint = "";//地块范围
            for (var i = 0; i < placefeature.getGeometry().getCoordinates()[0][0].length; i++) {
                var currpoint = placefeature.getGeometry().getCoordinates()[0][0][i];
                var mapproj = Dev.App.Map.getView().getProjection();
                if (mapproj.getCode() != Dev.App.Config.SystemMap.DataEPSG) currpoint = Dev.proj.transform(currpoint, mapproj.getCode(), Dev.App.Config.SystemMap.DataEPSG);
                parmdata.boundPoint += currpoint[1] + "," + currpoint[0] + ",";
            }
            parmdata.boundPoint = parmdata.boundPoint.substr(0, parmdata.boundPoint.length - 1);
            if (ishaspoint == "默认") {//不带AB点
                parmdata.Ax = 0;
                parmdata.Ay = 0;
                parmdata.Bx = 0;
                parmdata.By = 0;
                parmdata.direction = 0;//转向
            }
            else {//带AB点
                var temp_start = startpoint;
                var temp_end = endpoint;
                var mapproj = Dev.App.Map.getView().getProjection();
                if (mapproj.getCode() != Dev.App.Config.SystemMap.DataEPSG) {
                    temp_start = Dev.proj.transform(temp_start, mapproj.getCode(), Dev.App.Config.SystemMap.DataEPSG);
                    temp_end = Dev.proj.transform(temp_end, mapproj.getCode(), Dev.App.Config.SystemMap.DataEPSG);
                }
                parmdata.Ax = temp_start[1];//起点
                parmdata.Ay = temp_start[0];
                parmdata.Bx = temp_end[1];//终点
                parmdata.By = temp_end[0];
                parmdata.direction = 1;//转向
            }
            parmdata.w = toolsize;//幅宽
            parmdata.r = machineno;//最小转弯半径
            parmdata.type = derect;//作业类型
            parmdata.obstaclePoint = "";//障碍点
            if (!Dev.IsNull(newtrack)) {
                for (var i = 0; i < newtrack.getGeometry().getCoordinates()[0].length; i++) {
                    var currpoint = newtrack.getGeometry().getCoordinates()[0][i];
                    var mapproj = Dev.App.Map.getView().getProjection();
                    if (mapproj.getCode() != Dev.App.Config.SystemMap.DataEPSG) currpoint = Dev.proj.transform(currpoint, mapproj.getCode(), Dev.App.Config.SystemMap.DataEPSG);
                    parmdata.obstaclePoint += currpoint[1] + "," + currpoint[0] + ",";
                }
                parmdata.obstaclePoint = parmdata.obstaclePoint.substr(0, parmdata.obstaclePoint.length - 1);
            }
            var templinepoints = getlinepoint(parmdata);//获取路线点
            var linepoint = [];
            //路线经纬度位置转换
            for (var i = 0; i < templinepoints.length; i++) linepoint.push([templinepoints[i][1], templinepoints[i][0]]);
            var linef = Dev.MapUtils.GetFeatureByID("trackerline");
            if (!Dev.IsNull(linef)) Dev.MapUtils.RemoveFeature(linef, "tempGraphicLayer", Dev.App.Map);
            var linefeature = new Dev.Feature(new Dev.geom.LineString(linepoint));
            linefeature.setId("trackerline");
            Dev.MapUtils.AddFeature(linefeature, "tempGraphicLayer", Dev.App.Map);
            var linestr = linepoint.join(',').replace(/,/g, ' ');
            $(".dev-textbox[name='route']").prop("$this").SetValue(linestr)
            waitbox.Close();
        }

        //保存
        function save() {
            $("#errormsg1").html("");
            var isadd = Dev.IsNull(updateid);
            var model = {};
            //task
            model.name = $(".dev-textbox[name='name']").prop("$this").GetValue();//任务名称
            if (Dev.IsNull(model.name) || model.name.length == 0) { $("#errormsg1").html("任务名称不能为空!"); changetab("last"); return; }
            model.orgid = selectorgid;
            if (Dev.IsNull(selectorgid)) { $("#errormsg1").html("请选择组织机构!"); changetab("last"); return; }
            model.userid = receivederControl.combogrid("getValue");
            if (Dev.IsNull(model.userid)) { $("#errormsg1").html("请选择任务接收人!"); changetab("last"); return; }
            model.type = $(".dev-combobox[name='type']").prop("$this").GetValue();
            if (Dev.IsNull(model.type)) { $("#errormsg1").html("请选择任务类型!"); changetab("last"); return; }
            model.category = $(".dev-combobox[name='category']").prop("$this").GetValue();
            if (Dev.IsNull(model.category)) { $("#errormsg1").html("请选择任务类别!"); changetab("last"); return; }
            model.content = $(".dev-textbox[name='content']").prop("$this").GetValue();
            if (Dev.IsNull(model.content)) { $("#errormsg1").html("任务内容不能为空!"); changetab("last"); return; }
            var startime = $("#taskBeginTime").datetimebox("getValue");
            if (Dev.IsNull(startime)) { $("#errormsg1").html("请选择任务计划开始时间!"); changetab("last"); return; }
            model.starttime = new Date(startime.replace(/-/g, "/")).getTime();
            var endtime = $("#taskEndTime").datetimebox("getValue");
            if (Dev.IsNull(endtime)) { $("#errormsg1").html("请选择任务计划结束时间!"); changetab("last"); return; }
            model.endtime = new Date(endtime.replace(/-/g, "/")).getTime();
            if (model.starttime < (new Date().getTime() - 3600000)) { $("#errormsg1").html("计划开始时间必须大于当前时间!"); changetab("last"); return; }
            if (model.endtime < (new Date().getTime() - 3600000)) { $("#errormsg1").html("计划结束时间必须大于当前时间!"); changetab("last"); return; }
            if (model.starttime >= model.endtime) { $("#errormsg1").html("计划开始时间必须小于计划结束时间!"); changetab("last"); return; }
            //route
            $("#errormsg").html("");
            model.no = machinecontrol.combogrid("getText");
            if (Dev.IsNull(model.no)) { $("#errormsg").html("请选择作业农机"); return; }
            model.framid = framecontrol.combogrid("getValue");
            if (Dev.IsNull(model.framid)) { $("#errormsg").html("请选择作业农具"); return; }
            model.farmname = framecontrol.combogrid("getText");
            model.obstacle = $(".dev-textbox[name='obstacle']").prop("$this").GetValue();//障碍物
            if (Dev.IsNull(placefeature)) { $("#errormsg").html("请选择作业区域"); return; }
            var curr_county = Dev.getcountybyfeatrue(placefeature);
            if (!Dev.IsNull(curr_county)) {
                model.country = curr_county.getProperties().COUNTRY;
                model.province = curr_county.getProperties().PROVINCE;
                model.city = curr_county.getProperties().CITY;
                model.county = curr_county.getProperties().COUNTY;
            }
            if (isadd) model.area = parseFloat(formatArea(placefeature.getGeometry().getPolygons()[0]).toFixed(7));//地块面积
            model.fishnet = $(".dev-combobox[name='fishnet']").prop("$this").GetValue();//电子围栏
            model.region = getgeomstr(placefeature);//作业区域
            model.createdate = new Date(Dev.GetNowDateString().replace(/-/g, "/")).getTime();
            model.route = $(".dev-textbox[name='route']").prop("$this").GetValue();
            if (Dev.IsNull(model.route)) { $("#errormsg").html("请生成作业路线!"); return; }
            model.state = "待接收";
            var url = Dev.GetSystemUrlByRelID("Service") + "task/addTask";
            if (!isadd) {
                url = Dev.GetSystemUrlByRelID("Service") + "task/updateTask";
                model.id = updateid;;
            }
            $.ajax({
                url: url,
                type: "POST",
                contentType: 'application/json',
                dataType: 'json',
                data: JSON.stringify(model),
                success: function (result) {
                    //判断是否成功
                    if (result.statusCode != 200 || !result.data) {
                        flashDialog.Alert((isadd ? "新增失败!" : "修改失败!"), "warn");
                        return;
                    }
                    flashDialog.Alert((isadd ? "新增成功!" : "修改成功!"), "info");
                    parent.Close();
                }
            });
        }

        //查询修改记录
        function getdata_update() {
            if (Dev.IsNull(updateid)) return;
            var data;
            $.ajax({
                url: Dev.GetSystemUrlByRelID("Service") + "task/getbyfilter",
                type: "POST",
                contentType: 'application/json',
                dataType: 'json',
                data: "\"ID\"='" + updateid + "'",
                async: false,
                success: function (result) {
                    if (result.statusCode == 200 && !Dev.IsNull(result.data) && result.data.length > 0) data = result.data[0];
                },
                error: function (e) { dialog.Alert(msg.netout, "error"); loadError(); }
            });
            if (!Dev.IsNull(data)) loaddata(data);
            isinit = false;

        }

        //加载数据
        function loaddata(data) {
            //根据updateid查询数据
            if (Dev.IsNull(data)) return;
            var textcontrol = $('.dev-textbox');
            var combocontrol = $('.dev-combobox');
            if (!Dev.IsNull(comboTree)) comboTree.SetValueEx(data.orgid); //组织机构
            for (var i = 0; i < textcontrol.length; i++) {
                var tag = $(textcontrol[i]).attr("name");
                var currcontrol = $(textcontrol[i]).prop("$this");
                currcontrol.SetValue(data[tag]);
            }
            for (var i = 0; i < combocontrol.length; i++) {
                var tag = $(combocontrol[i]).attr("name");
                var currcontrol = $(combocontrol[i]).prop("$this");
                if (tag == "derection" || tag == "startendpoint") continue;
                currcontrol.SetValue(data[tag]);
            }
            $("#taskBeginTime").datetimebox("setValue", Dev.GetDateString(data.starttime));
            $("#taskEndTime").datetimebox("setValue", Dev.GetDateString(data.endtime));
            //作业行政区
            machinecontrol.combogrid("setValue", data.no);//农机
            framecontrol.combogrid("setValue", data.farmname);//农具
            receivederControl.combogrid("setValue", data.userid);//接收人
            $(".dev-textbox[name='route']").prop("$this").SetValue(data.route);//路线
            //获取地块
            if (!Dev.IsNull(data.region)) placefeature = getgeombygeomstr(data.region);
            xzqcombotree.tree.GetLeafs().each(function (o, i) {
                if (i.innerText == data.county)
                    xzqcombotree.SetSelectedItem(i, true);
            });
        }

        //编辑窗体中地图操作按钮的可点击状态设置
        function iconset(isenable, type) {
            if (Dev.IsNull(type)) return;
            var icons = $(".Icon[tag='" + type + "'");
            for (var i = 0; i < icons.length; i++) {
                if (isenable) $(icons[i]).removeClass("Iconunable").removeClass("task-" + type + "1").addClass("task-" + type);
                else $(icons[i]).addClass("Iconunable").addClass("task-" + type + "1").removeClass("task-" + type);
            }
        }

        //调用生成路线接口
        function getlinepoint(parmdata) {
            var points = [];
            var url = Dev.GetSystemUrlByBasicID("MachineTrackUrl");
            var rpoints = $.ajax({
                url: url + "hzy/executeSoFileNew1",
                type: "POST",
                data: parmdata,
                async: false,
                success: function (result) {
                    points = result.data;
                }
            });
            return points;
        }

        //界面释放
        function clear() {
            if (!Dev.IsNull(mapclick)) { Dev.App.Map.unByKey(mapclick); mapclick = null; }
            if (!Dev.IsNull(comboTree)) { comboTree.unbind("onSelectChanged"); comboTree = null; }
            if (!Dev.IsNull(receivederControl)) {
                receivederControl.combogrid("setValue", "");
                receivederControl.combogrid("hidePanel");
                receivederControl = null;
            }
            if (!Dev.IsNull(xzqcombotree)) { xzqcombotree.unbind("onSelectChanged"); xzqcombotree = null; }
            if (!Dev.IsNull(machinecontrol)) {
                machinecontrol.combogrid("setValue", "");
                machinecontrol.combogrid("hidePanel");
                machinecontrol = null;
            };
            if (!Dev.IsNull(framecontrol)) {
                framecontrol.combogrid("setValue", "");
                framecontrol.combogrid("hidePanel");
                framecontrol = null;
            }
            Dev.MapUtils.RemoveLayer("workblocklayer", Dev.App.Map);
            Dev.MapUtils.ClearFeature("tempGraphicLayer", Dev.App.Map);
            if (!Dev.IsNull(drawcontrol)) {
                drawcontrol.Stop();
                drawcontrol.Destroy();
                drawcontrol = null;
            }
            Dev.MapUtils.ClearFeature("tempDrawLayer", Dev.App.Map);

        }

        //信息tab切换
        function changetab(tab) {
            if (Dev.IsNull(tab)) return;
            if (tab == "next") {
                parent.SetSize(519, 410);
                $(".task").css("display", "none");
                $(".first").removeClass("tab_select");
                $(".logo", $(".first")).css("background-image", "url(" + Dev.App.Root + "image/agri/taskfirst2.png)");
                $(".logoText", $(".first")).removeClass("logoText_select");

                $(".route").css("display", "block");
                $(".second").addClass("tab_select");
                $(".logo", $(".second")).css("background-image", "url(" + Dev.App.Root + "image/agri/tasksecond1.png)");
                $(".logoText", $(".second")).addClass("logoText_select");
            }
            if (tab == "last") {
                parent.SetSize(519, 370);
                $(".task").css("display", "block");
                $(".first").addClass("tab_select");
                $(".logo", $(".first")).css("background-image", "url(" + Dev.App.Root + "image/agri/taskfirst1.png)");
                $(".logoText", $(".first")).addClass("logoText_select");

                $(".route").css("display", "none");
                $(".second").removeClass("tab_select");
                $(".logo", $(".second")).css("background-image", "url(" + Dev.App.Root + "image/agri/tasksecond2.png)");
                $(".logoText", $(".second")).removeClass("logoText_select");
            }
        }

        //获取地块面积
        function formatArea(polygon) {
            var wgs84Sphere = new Dev.Sphere(6378137);
            var sourceProj = Dev.App.Map.getView().getProjection();
            var geom = (polygon.clone().transform(sourceProj, 'EPSG:4326'));/** @type {ol.geom.Polygon} */
            var coordinates = geom.getLinearRing(0).getCoordinates();
            var area = Math.abs(wgs84Sphere.geodesicArea(coordinates));
            var output = (Math.round(area / 1000000 * 100) / 100) * 1500;
            return output;
        };

        //根据元素获取点串
        function getgeomstr(feature) {
            var geomstr = "";
            if (Dev.IsNull(feature)) return geomstr;
            var geom = feature.getGeometry();
            if (Dev.IsNull(geom)) return geomstr;
            var coors = geom.getCoordinates();
            geomstr = coors.join(' ').replace(/,/g, " ");
            return geomstr;
        }

        //根据坐标点获取地块
        function getgeombygeomstr(geomstr) {
            var temparry = geomstr.split(' ');
            var points = [];
            for (var i = 0; i < temparry.length - 1; i = i + 2) {
                points.push([parseFloat(temparry[i]), parseFloat(temparry[i + 1])]);
            }
            var feature = new Dev.Feature(new Dev.geom.Polygon([points]));
            return feature;
        }

    </script>
</head>
<body>
    <div class="content">
        <div class="tab">
            <div class="first tab_select">
                <div class="logo" style="background-image: url(../../image/agri/taskfirst1.png)"></div>
                <div class="logoText logoText_select">任务基本信息</div>
            </div>
            <div class="second">
                <div class="logo" style="background-image: url(../../image/agri/tasksecond2.png)"></div>
                <div class="logoText">规划农机作业路线</div>
            </div>
        </div>
        <div class="task">
            <div class="row">
                <div class="cell" style="width: 100%;">
                    <div class="dev-textbox" name="name" style="z-index: 3; width: calc(100% - 1px); margin-top: 5px;" opt='{"MaxLength":25,"Required":true,"Height":26,"TipInfo":"25位以内","HeaderCSS":{"padding":"0px","width":"75px"},"IsOverShow":true,"Padding":"0px 5px","TextAlign":"left","BodyCSS": { "background-color": "transparent" },"Title":"<div class=\"Title\"><span>任务名称</span></div>"}'></div>
                </div>
            </div>
            <div class="row">
                <div class="cell">
                    <div style="display: inline-block; width: 67px; height: 26px; line-height: 26px; float: left; margin-top: 4px; text-align: right; padding-right: 8px;" opt='{"Required":true,"Readonly":true}'><span>选择组织</span></div>
                    <div id="treecomboDiv" style="height: 26px; width: calc(100% - 75px); margin-top: 5px; display: block; float: left;">
                    </div>
                </div>
                <div class="cell">
                    <div style="width: 67px; height: 26px; line-height: 26px; text-align: right; margin-top: 4px; padding-right: 8px; float: left">
                        接收人
                    </div>
                    <div style="width: calc(100% - 75px); height: 28px; line-height: 30px; display: inline-block; float: left; margin-top: 3px; position: relative;">
                        <div id="receiveder" data-options="editable:false"></div>
                    </div>
                    <div style="z-index: 1; position: relative; height: 10px; width: 10px; top: -22px; left: 220px; color: red; line-height: 10px; font-size: 14px;">*</div>
                </div>
            </div>
            <div class="row">
                <div class="cell">
                    <div class="dev-combobox" name="type" style="z-index: 3; width: calc(100% - 1px); margin-top: 5px;" byname="任务类型" opt='{ "PopupHeight":"auto","Height":26,"Required":true,"TextField":"data","ValueField":"data","TipInfo":"请选择","HeaderCSS":{"padding":"0px","width":"75px"},"IsOverShow":true,"Padding":"0px 5px","TextAlign":"left","BodyCSS": { "background-color": "transparent" },"Title":"<div class=\"Title\"><span>任务类型</span></div>"}'></div>
                </div>
                <div class="cell">
                    <div class="dev-combobox" name="category" style="z-index: 3; width: calc(100% - 1px); margin-top: 5px;" byname="任务类别" opt='{"Required":true,"Height":26,"TipInfo":"请选择","HeaderCSS":{"padding":"0px","width":"75px"},"Data":["计划任务","调度任务"],"IsOverShow":true,"Padding":"0px 5px","TextAlign":"left","BodyCSS": { "background-color": "transparent" },"Title":"<div class=\"Title\"><span>任务类别</span></div>"}'></div>
                </div>
            </div>
            <div class="row" style="height: 65px;">
                <div class="cell" style="width: 100%">
                    <div class="dev-textbox" name="content" style="z-index: 2; width: calc(100% - 1px); height: 60px; margin-top: 5px;" byname="任务内容" opt='{"MaxLength":120, "Required":true,"TipInfo":"请输入任务内容(最大长度120位)","Type":"multi-text","HeaderCSS":{"padding":"0px","width":"75px"},"IsOverShow":true,"Padding":"5px","Title":"<div class=\"Title\">任务内容</div>"}'></div>
                </div>
            </div>
            <div class="row">
                <div class="cell">
                    <div style="display: inline-block; width: 67px; height: 26px; line-height: 26px; float: left; margin-top: 4px; text-align: right; padding-right: 8px;"><span>开始时间</span></div>
                    <div style="width: calc(100% - 75px); height: 30px; line-height: 30px; display: inline-block; float: left; margin-top: 2px; position: relative;">
                        <input id="taskBeginTime" data-options="editable:false" />
                    </div>
                </div>
                <div class="cell">
                    <div style="display: inline-block; width: 67px; height: 26px; line-height: 26px; float: left; margin-top: 4px; text-align: right; padding-right: 8px;"><span>结束时间</span></div>
                    <div style="width: calc(100% - 75px); height: 30px; line-height: 30px; display: inline-block; float: left; margin-top: 2px;">
                        <input id="taskEndTime" data-options="editable:false" />
                    </div>
                </div>
            </div>
            <div style="width: 100%; height: 45px; position: relative; margin-top: 15px;">
                <div id="errormsg1" style="line-height: 45px; height: 100%; width: calc(100% - 115px); margin-left: 15px; color: red;"></div>
                <div class="Button" tag="next">
                    <span style="line-height: 26px; color: #fcfcfc;">下一步</span>
                </div>

            </div>
        </div>
        <div class="route">
            <div class="row">
                <div class="cell" style="width: 100%;">
                    <div style="display: inline-block; width: 67px; height: 26px; line-height: 26px; float: left; margin-top: 4px; text-align: right; padding-right: 8px;" opt='{"Required":true,"Readonly":true}'><span>作业地区</span></div>
                    <div id="routexzq" style="height: 26px; width: calc(100% - 75px); margin-top: 5px; display: block; float: left;">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="cell">
                    <div style="width: 67px; height: 26px; line-height: 26px; text-align: right; margin-top: 4px; padding-right: 8px; float: left"><span>农机</span></div>
                    <div style="width: calc(100% - 75px); height: 28px; line-height: 28px; display: inline-block; float: left; margin-top: 4px; position: relative;">
                        <div id="machineno" data-options="editable:false"></div>
                        <div style="position: absolute; height: 10px; width: 10px; top: 12px; right: 20px; color: red; line-height: 10px; font-size: 14px;">*</div>
                    </div>
                </div>
                <div class="cell">
                    <div style="width: 67px; height: 26px; line-height: 26px; text-align: right; margin-top: 4px; padding-right: 8px; float: left"><span>农具名称</span></div>
                    <div style="width: calc(100% - 75px); height: 28px; line-height: 28px; display: inline-block; float: left; margin-top: 4px; position: relative;">
                        <div id="framnum" data-options="editable:false"></div>
                        <div style="position: absolute; height: 10px; width: 10px; top: 12px; right: 20px; color: red; line-height: 10px; font-size: 14px;">*</div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="cell">
                    <div class="dev-combobox" name="derection" style="z-index: 5; width: calc(100% - 1px); margin-top: 5px;" opt='{"Required":true,"Data":[{ "id": "shuttle", "Text": "梭行作业" }, { "id": "skip", "Text": "跳行作业" }],"TextField":"Text","ValueField":"id","Height":26,"TipInfo":"请选择","HeaderCSS":{"padding":"0px","width":"75px"},"IsOverShow":true,"Padding":"0px 5px","TextAlign":"left","BodyCSS": { "background-color": "transparent" },"Title":"<div class=\"Title\"><span>作业方式</span></div>"}'></div>
                </div>
                <div class="cell">
                    <div class="dev-combobox" name="startendpoint" style="z-index: 5; width: calc(100% - 1px); margin-top: 5px;" opt='{"Required":true,"Data":["默认","自定义"],"Height":26,"TipInfo":"请选择","HeaderCSS":{"padding":"0px","width":"75px"},"IsOverShow":true,"Padding":"0px 5px","TextAlign":"left","BodyCSS": { "background-color": "transparent" },"Title":"<div class=\"Title\"><span>作业模式</span></div>"}'></div>
                </div>
            </div>
            <div class="row">
                <div class="cell">
                    <div style="width: 67px; height: 26px; line-height: 26px; text-align: right; margin-top: 4px; padding-right: 8px; float: left"><span>地块选择</span></div>
                    <div style="width: calc(100% - 75px); height: 28px; line-height: 28px; display: inline-block; float: left; margin-top: 4px; position: relative;">
                        <div class="Icon Iconunable task-selectpalce1" tag="selectpalce" style="height: 24px; width: 23px; display: inline-block; margin-top: 1px; float: left;"></div>
                        <div style="display: inline-block; height: 24px; line-height: 24px; margin-top: 1px; color: #808080; font-size: 10px; margin-right: 5px; float: right;">请在地图上选取作业地块</div>
                        <div style="position: absolute; height: 10px; width: 10px; top: 10px; right: 0px; color: red; line-height: 10px; font-size: 14px;">*</div>
                    </div>
                </div>
                <div class="cell">
                    <div class="dev-combobox" name="fishnet" style="z-index: 3; width: calc(100% - 1px); margin-top: 5px;" opt='{"ValueField":"geomstr","TextField":"name","Height":26,"TipInfo":"请选择","HeaderCSS":{"padding":"0px","width":"75px"},"IsOverShow":true,"Padding":"0px 5px","TextAlign":"left","BodyCSS": { "background-color": "transparent" },"Title":"<div class=\"Title\"><span>电子围栏</span></div>"}'></div>
                </div>
            </div>
            <div class="row">
                <div class="cell" style="width: calc(100% - 60px)">
                    <div class="dev-textbox" name="obstacle" style="z-index: 2; width: 100%; margin-top: 5px;" opt='{"Readonly":true,"Height":26,"HeaderCSS":{"padding":"0px","width":"75px"},"IsOverShow":true,"Padding":"0px 5px","Title":"<div class=\"Title\">障碍物</div>","TipInfo":"使用右侧菜单在地图上点击添加/删除障碍物"}'></div>
                </div>
                <div class="Icon Iconunable task-addobstacle1" tag="addobstacle" style="height: 24px; width: 22px; display: inline-block; float: left; margin-top: 5px; margin-left: 5px;"></div>
                <div class="Icon Iconunable task-removeobstacle1" tag="removeobstacle" style="height: 24px; width: 22px; display: inline-block; float: left; margin-top: 5px; margin-left: 6px;"></div>
            </div>
            <div class="row" style="height: 65px;">
                <div style="height: 65px; width: calc(100% - 60px); display: inline-block; float: left; position: relative;">
                    <div class="dev-textbox" name="route" style="z-index: 2; width: 100%; height: 55px; margin-top: 5px;" opt='{"Required":true,"Readonly":true,"Type":"multi-text","HeaderCSS":{"padding":"0px","width":"75px"},"IsOverShow":"true","Padding":"5px","Title":"<div class=\"Title\">作业路线</div>"}'></div>
                </div>
                <div id="trackEdit" style="height: 56px; width: 23px; display: inline-block; float: left; margin-left: 5px; margin-top: 2px;">
                    <div class="Icon Iconunable task-trackstart1" tag="trackstart" style="height: 23px; width: 23px; margin-top: 3px;" title="起始点"></div>
                    <div class="Icon Iconunable task-trackend1" tag="trackend" style="height: 23px; width: 23px; margin-top: 5px;" title="截止点"></div>
                </div>
                <div id="createline" style="height: 53px; width: 23px; display: inline-block; margin-left: 5px; margin-top: 5px; float: left; background-color: #808080; border: 1px solid #808080; color: #fff; text-align: center; cursor: default;">生成路线</div>

            </div>
            <div style="width: 100%; height: 45px; position: relative; margin-top: 15px;">
                <div id="errormsg" style="line-height: 45px; height: 100%; width: calc(100% - 175px); margin-left: 15px; color: red;"></div>
                <div class="Button" tag="last" style="width: 80px; right: 105px;">
                    <span style="line-height: 26px; color: #fcfcfc;">上一步</span>
                </div>
                <div class="Button" tag="save" style="width: 80px; right: 15px;">
                    <span style="line-height: 26px; color: #fcfcfc;">保存</span>
                </div>
            </div>
        </div>
    </div>
    <div id="toobarRec" style="height: 35px; background-color: #fcfcfc">
        <div style="margin-top: 5px;">
            <div id="PnoSearch" class="dev-textbox" style="width: 60px; float: left; margin-left: 6px; display: inline-block;" opt='{"TipInfo":"输入编号"}'></div>
            <div id="PnameSearch" class="dev-textbox" style="width: 60px; float: left; margin-left: 4px; display: inline-block;" opt='{"TipInfo":"输入姓名"}'></div>
            <div id="PTypeSearch" class="dev-textbox" style="width: 60px; float: left; margin-left: 4px; display: inline-block;" opt='{"TipInfo":"联系电话"}'></div>
            <div style="width: 76px; height: 30px; display: inline-block; margin-left: 8px;">
                <div id="recsearch" style="cursor: pointer; height: 24px; width: 35px; display: inline-block; background-color: #03afd9; float: left; color: #fff; line-height: 24px; text-align: center;">查询</div>
                <div id="recreset" style="cursor: pointer; height: 24px; width: 35px; display: inline-block; background-color: #03afd9; margin-left: 6px; color: #fff; line-height: 24px; text-align: center;">重置</div>
            </div>
        </div>
    </div>
    <div id="toolbarMac" style="height: 35px; background-color: #fcfcfc">
        <div style="margin-top: 5px;">
            <div id="macnumSearch" class="dev-textbox" style="width: 95px; float: left; margin-left: 8px; display: inline-block;" opt='{"TipInfo":"请输入车牌号"}'></div>
            <div id="mactypeSearch" class="dev-combobox" style="width: 95px; float: left; margin-left: 8px; display: inline-block;" opt='{ "PopupHeight":"auto","TextField":"data","ValueField":"id","TipInfo":"选择车辆类型"}'></div>
            <div id="macbrandSearch" class="dev-combobox" style="width: 95px; float: left; margin-left: 8px; display: inline-block;" opt='{ "PopupHeight":"auto","TextField":"data","ValueField":"id","TipInfo":"选择车辆品牌"}'></div>
            <div style="width: 76px; height: 30px; display: inline-block; margin-left: 10px;">
                <div id="macsearch" style="cursor: pointer; height: 24px; width: 35px; display: inline-block; background-color: #03afd9; float: left; color: #fff; line-height: 24px; text-align: center;">查询</div>
                <div id="macreset" style="cursor: pointer; height: 24px; width: 35px; display: inline-block; background-color: #03afd9; margin-left: 6px; color: #fff; line-height: 24px; text-align: center;">重置</div>
            </div>
        </div>
    </div>
    <div id="toolbarFarm" style="height: 35px; background-color: #fcfcfc">
        <div style="margin-top: 5px;">
            <div id="fnameSearch" class="dev-textbox" style="width: 90px; float: left; margin-left: 6px; display: inline-block;" opt='{"TipInfo":"请输入农具名"}'></div>
            <div id="fminlength" class="dev-textbox" style="width: 90px; float: left; margin-left: 6px; display: inline-block;" opt='{"TipInfo":"最小长度(m)"}'></div>
            <span style="float: left; margin-top: 5px; margin-left: 6px">至</span>
            <div id="fmaxlength" class="dev-textbox" style="width: 90px; float: left; margin-left: 6px; display: inline-block;" opt='{"TipInfo":"最大长度(m)"}'></div>
            <div style="width: 76px; height: 30px; display: inline-block; margin-left: 8px;">
                <div id="farmsearch" style="cursor: pointer; height: 24px; width: 35px; display: inline-block; background-color: #03afd9; float: left; color: #fff; line-height: 24px; text-align: center;">查询</div>
                <div id="farmreset" style="cursor: pointer; height: 24px; width: 35px; display: inline-block; background-color: #03afd9; margin-left: 6px; color: #fff; line-height: 24px; text-align: center;">重置</div>
            </div>
        </div>
    </div>
</body>
</html>
