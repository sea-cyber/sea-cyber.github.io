<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
    <link rel="stylesheet" href="../../theme/default/easyui.css" />
    <link rel="stylesheet" type="text/css" href="../../theme/icon.css" />
    <link rel="stylesheet" type="text/css" href="../../css/app.css" />
    <link rel="stylesheet" type="text/css" href="../../css/main.css" />
    <link rel="stylesheet" type="text/css" href="../../css/icon.css" />
    <link type="text/css" href="../../css/dev.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="../../css/dev.css" />
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../js/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="../../js/linq.min.js"></script>
    <script type="text/javascript" src="../../js/data.util.js"></script>
    <script type="text/javascript" src="../../js/jquery.dev.control.js"></script>
    <script type="text/javascript" src="../../js/dev.ui.js"></script>
    <script type="text/javascript" src="../../js/dev.gis.js"></script>
    <script type="text/javascript" src="../../js/jquery.dev.js"></script>
    <style type="text/css">
    </style>
    <script type="text/javascript">
        var Dev = window.top.window.dev;
        var parent;
        var dataGrid;
        var pageIndex = 1, pageSize = 10;
        var arr ;
        var type, mtype, deviceCode;
        function WidgetCommunication(s) {//部件通讯
            parent = s.parent;
            type = s.param.Type;
            mtype = s.param.mType;
            if (mtype == "农机") deviceCode = 0;
            if (mtype == "无人机") deviceCode = 1;

            initDataGrid();
            resize();
        }
        function queryData() {
            $.ajax({
                //url: Dev.cookie.baseUri + "cautionfeedback/findbytype/" + type + "/" + pageIndex + "/" + pageSize + "?mtype=" + deviceCode,
                url: Dev.cookie.baseUri + "cautionfeedback/findbytype/" + type + "/" + pageIndex + "/" + pageSize + "?mtype=" + deviceCode,
                type: "get",
                contentType: 'application/json',
                success: function (result) {
                    dataGrid.Load(result.data.dataSource, result.data.pageInfo);
                },
                error: function (e) {
                    dialog.Alert(msg.netout, "error");
                }
            });
        }
        function initDataGrid() {
            var gridView = $.extend({}, $.fn.datagrid.defaults.view, {
                renderRow: function (target, fields, frozen, rowIndex, rowData) {
                    var col = [];
                    var id = rowData.id;
                    var id1 = id + "1";
                    var id2 = id + "2";
                    var id3 = id + "3";
                    var fkder = rowData.fkder;
                    var time = rowData.time;
                    var content = "反馈内容：" + (Dev.IsNull(rowData.content) ? " " : rowData.content);
                    var remark = "备    注    ：" + (Dev.IsNull(rowData.remark) ? " " : rowData.remark);
                    var realtime = Dev.GetDateString(time);
                    var img_arr =[];
                    if (!Dev.IsNull(rowData.extend1)) img_arr.push(rowData.extend1);
                    if (!Dev.IsNull(rowData.extend2)) img_arr.push(rowData.extend2);
                    if (!Dev.IsNull(rowData.extend3)) img_arr.push(rowData.extend3);
                   col.push('<td>');
                   col.push(' <div id="gridDiv" style="width:800px;height:224px;border-bottom:1px solid gray">');
                   //col.push('<div style="width:222px;height:222px;position:relative;float:left;"><div class="showImg" title="图片预览" style="position:absolute;width:80%;left:10%;height:80%;top:10%;background-repeat: no-repeat; background-position: center;background-image:url(' + Dev.App.Root + 'image/agri/nopic.png)"></div>' +
                   //    '<div style="height:24px;width:24px;position:absolute;left:-2px;top:50%;background-image:url(' + Dev.App.Root + 'image/agri/leftbtn.png);background-repeat: no-repeat;background-position: center;display:none;"></div>' +
                   //    '<div style="height:24px;width:24px;position:absolute;right:-2px;top:50%;background-image:url(' + Dev.App.Root + 'image/agri/rightbtn.png);background-repeat: no-repeat;background-position: center;display:none;"></div></div>');
                    //
                 
                   if (Dev.IsNull(img_arr) || img_arr.length == 0) {
                       col.push('<div style="width:222px;height:222px;position:relative;float:left;"><div class="showImg" title="图片预览" style="position:absolute;width:80%;left:10%;height:80%;top:10%;background-repeat: no-repeat; background-position: center;background-image:url(' + Dev.App.Root + 'image/agri/nopic.png);background-size: 100% 100%;"></div></div>');
                   } else if (img_arr.length == 1) {
                       col.push('<div style="width:222px;height:222px;position:relative;float:left;"><div class="showImg" title="图片预览" style="position:absolute;width:80%;left:10%;height:80%;top:10%;background-repeat: no-repeat; background-position: center;background-image:url(' + img_arr[0] + ');background-size: 100% 100%;"  onclick="picview(this);"  bg_file="' + img_arr[0] + '"  arr="' + img_arr + '"></div></div>');
                   } else if (img_arr.length>1) {
                       col.push('<div style="width:222px;height:222px;position:relative;float:left;"><div class="showImg" title="图片预览" style="position:absolute;width:80%;left:10%;height:80%;top:10%;background-repeat: no-repeat; background-position: center;background-image:url(' + img_arr[0] + ');background-size: 100% 100%;"  onclick="picview(this)"  bg_file="' + img_arr[0] + '"  arr="' + img_arr + '" ></div>' +
                          '<div style="height:24px;width:24px;position:absolute;left:-2px;top:50%;background-image:url(' + Dev.App.Root + 'image/agri/leftbtn.png);background-repeat: no-repeat;background-position: center;" onclick="showPreviImg(this)" arr="' + img_arr + '"></div>' +
                          '<div style="height:24px;width:24px;position:absolute;right:-2px;top:50%;background-image:url(' + Dev.App.Root + 'image/agri/rightbtn.png);background-repeat: no-repeat;background-position: center;" onclick="showNextImg(this)" arr="' + img_arr + '"></div></div>');
                   }
                    col.push(' <div id="content" style="width:558px;height:109px;float:left;padding-top:20px"><span style="font-size:12px">' + content + '</span> </div>');
                    col.push(' <div id="content" style="width:558px;height:50px;float:left;padding-top:10px"><span style="font-size:12px">' + remark + '</span> </div>');
                    col.push(' <div id="person" style="width:184px;height:23;float:left"><span style="font-size:12px;display:inline-block;margin-top:-24px">反馈人:' + fkder + '</span></div>');
                    col.push(' <div id="time" style="width:164px;height:23;float:left;margin-left:230px"> <span style="font-size:12px;display:inline-block;margin-top:-24px;margin-left:25px">' + realtime + '</span></div> ');
                    col.push('</div>');
                    col.push('</td>');
                    return col.join('');
                }
            });
            if (Dev.IsNull(dataGrid)) {
                dataGrid = new UCDataGrid(Dev, {
                    ID: "caseGrid",
                    View: gridView,
                    RowNumbers: false,
                    FitColumns: false,
                    ShowHeader: false,
                    PageIndex: pageIndex,
                    PageSize: pageSize,
                    pagequery: false
                });
                $("#container").append(dataGrid.Target);
                dataGrid.Layout([]);
                $(".datagrid-header", dataGrid.Target).css("border", "0px");
                dataGrid.Target.bind("onSelectPage", function (s, e) {
                    pageIndex = e.index;
                    queryData();
                    resize();
                });
            }
            queryData();
        }

        function resize() {
            var height = $(window).height();
            var gridheigth = height - 30;
            var width = $(window).width();
            $("#container").height(gridheigth);
            if (!Dev.IsNull(dataGrid)) {
                dataGrid.Resize(width, height);
            }
        }

        //上一张
        function showPreviImg(o) {
            var arr = $(o).attr("arr").split(",");
            var currfile = $(o).prevAll("div[class=showImg]").attr("bg_file");
            if (Dev.IsNull(currfile)) return;
            var index = Enumerable.From(arr).IndexOf(currfile);
            if (index <= 0) return;
            var showindex = index - 1;
            $(o).prevAll("div[class=showImg]").css({ "background-image": "url(" + arr[showindex] + ")" });
            $(o).prevAll("div[class=showImg]").attr("bg_file", arr[showindex]);
        }
        //下一张
        function showNextImg(o) {
            var arr = $(o).attr("arr").split(",");
            var currfile = $(o).prevAll("div[class=showImg]").attr("bg_file");
            if (Dev.IsNull(currfile)) return;
            var index = Enumerable.From(arr).IndexOf(currfile);
            if (index < 0 || index >= arr.length - 1) return;
            var showindex = index + 1;
            $(o).prevAll("div[class=showImg]").css({ "background-image": "url(" + arr[showindex] + ")" });
            $(o).prevAll("div[class=showImg]").attr("bg_file", arr[showindex]);
        }

        //图片查看
        function picview(o) {
            var arr = $(o).attr("arr").split(",");
            var currfile = $(o).attr("bg_file");
            var index = Enumerable.From(arr).IndexOf(currfile);
            Dev.PreViewPics(arr, index);
        }

    </script>
</head>
<body style="width: 100%; height: 200%;">
    <div id="container" style="width: 100%; height: 200%; padding-top: -30px">
    </div>
</body>
</html>
