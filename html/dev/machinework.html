<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>农机作业</title>
    <link rel="stylesheet" href="../../theme/default/easyui.css" />
    <link rel="stylesheet" type="text/css" href="../../theme/icon.css" />
    <link rel="stylesheet" type="text/css" href="../../css/app.css" />
    <link rel="stylesheet" type="text/css" href="../../css/main.css" />
    <link rel="stylesheet" type="text/css" href="../../css/icon.css" />
    <link type="text/css" href="../../css/dev.css" rel="stylesheet" />
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../js/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="../../js/linq.min.js"></script>
    <script type="text/javascript" src="../../js/data.util.js"></script>
    <script type="text/javascript" src="../../js/jquery.dev.control.js"></script>
    <script type="text/javascript" src="../../js/dev.ui.js"></script>
    <style type="text/css">
        .content {
            height: 100%;
            width: 100%;
            position: relative;
        }

        .Title {
            width: 75px;
            text-align: right;
            line-height: 40px;
            height: 40px;
            display: inline-block;
            float: left;
        }

            .Title .Icon {
                width: 16px;
                height: 16px;
                display: inline-block;
                float: left;
                margin-left: 2px;
                margin-top: 11px;
            }

            .Title .Text {
                display: inline-block;
                text-align: left;
                margin-left: 0px;
                width: 51px;
            }

        .content .SearchDiv {
            width: 200px;
            height: 38px;
            display: inline-block;
            margin-left: 0px;
            margin-right: 0px;
            float: left;
        }

        .content .Button {
            width: 70px;
            height: 26px;
            float: left;
            margin-top: 5px;
            background-color: #16dbbb;
            /*border-radius: 5px;*/
            text-align: center;
            border: 1px solid #16dbbb;
            display: inline-block;
        }

            .content .Button:hover {
                background-color: #5227de;
                border: 1px solid #5227de;
                cursor: pointer;
            }

            .content .Button:active {
                background-color: #210097;
                border: 1px solid #210097;
                cursor: pointer;
            }

        .content .ButtonDisable {
            background-color: #808080;
            color: #000;
            border: 1px solid #808080;
        }

            .content .ButtonDisable:hover {
                background-color: #808080;
                color: #000;
                border: 1px solid #808080;
            }

        .datagrid-row {
            height: 28px;
        }

        .pagination-info {
            float: right;
            margin: 0 6px 0 0;
            padding: 0;
            margin-right: 17px;
            height: 30px;
            line-height: 30px;
            font-size: 12px;
        }

        .datagrid .datagrid-pager {
            display: block;
            margin: 0;
            border-width: 1px 0 0 0;
            border-style: solid;
        }
    </style>
    <script type="text/javascript">
        var Dev = window.top.window.dev;
        var dataGrid, pageIndex = 1, pageSize = 5;
        var treeControl, parent;
        var orgFilter, updateid, editWin;
        var waitbox, dialog, flashDialog;
        var detailWin;
        function WidgetCommunication(s) { // 部件通讯
            parent = s.parent;
            Dev.App.BottomPanel.Header.css({ "background": "#14cdad", "color": "#fcfcfc", "font-weight": "bold" });
            Dev.App.BottomPanel.SetIconCls("data-folder");
            $(window).resize(function () { resize(); });
            initGrid(); //初始化组织树
            inittree(); //初始化列表
            //数据查询
            resize();
            $(".Button").click(function () {
                var tag = $(this).attr("tag");
                if (tag == "add") editdata();
                if (tag == "search") { pageIndex = 1; queryData(); }
                if (tag == "clear") { searchClear(); queryData(); }
            });
            dialog = new Dev.Messager({ AutoShow: false, Type: "question" });
            flashDialog = new Dev.Messager({ Height: 95, Width: 200, AutoShow: false, Type: "question", Timeout: 1500, ButtonVisible: false, AutoVisible: true, Effect: "normal" });
            parent.one("onClosing", function () {
                if (!Dev.IsNull(editWin)) {
                    editWin.unbind("onClosing");
                    editWin.Close();
                    editWin.Destroy();
                    editWin = null;
                }

                if (!Dev.IsNull(detailWin)) {
                    detailWin.unbind("onClosing");
                    detailWin.Close();
                    detailWin.Destroy();
                    detailWin = null;
                }
            });
        }

        //初始化农机作业列表
        function initGrid() {
            if (Dev.IsNull(dataGrid)) {
                $("#gridDiv").empty();
                var columns = [
                  { field: "name", width: 80, align: 'center', title: '任务名称', sortable: false },
                  { field: "type", width: 60, align: 'center', title: '任务类型', sortable: false },
                  { field: "no", width: 80, align: 'center', title: '车牌号', sortable: false },
                  { field: "farmname", width: 80, align: 'center', title: '农具名称', sortable: false },
                  { field: "state", width: 80, align: 'center', title: '任务状态', sortable: false },
                  { field: "starttime", width: 80, align: 'center', title: '计划开始时间', sortable: false, formatter: function (value, row, index) { return Dev.GetDateString(value); } },
                  { field: "endtime", width: 80, align: 'center', title: '计划结束时间', sortable: false, formatter: function (value, row, index) { return Dev.GetDateString(value); } },
                  {
                      field: "_oprate", width: 50, align: 'center', title: '操作', sortable: false, formatter: function (value, row, index) {
                          var str = '';
                          if (row.state == "待接收") str += '<a href="javascript:void(0)"  title="修改" style="color:blue;" onclick="update(\'' + row.id + '\',\'' + index + '\')"><img src="../../image/agri/update.png"/></a>&nbsp;';
                          else str += '<a href="javascript:void(0)"  title="不可修改" style="color:blue;"><img src="../../image/agri/unupdate.png"/></a>&nbsp;';
                          str += '<a href="javascript:void(0)" style="color:blue;margin-left:6px;" onclick="detailInfo(\'' + row.id + '\')" title="详细信息"><img src="../../image/agri/cartype.png"/></a>&nbsp;';
                          if (row.state == "待接收" || row.state == "已完成") str += '<a href="javascript:void(0)" title="删除" style="color:blue;margin-left:6px;" onclick="deleteinfo(\'' + row.id + '\')"><img src="../../image/agri/delete.png"/></a>';
                          else str += '<a href="javascript:void(0)" title="不可删除" style="color:blue;margin-left:6px;"><img src="../../image/agri/undelete.png"/></a>';
                          return str;
                      }
                  }
                ];
                dataGrid = new UCDataGrid(Dev, {
                    PageIndex: pageIndex, PageSize: pageSize, RowNumbers: false, ID: "trackGrid", pagequery: false, IsSizeSelect: true
                });
                $("#gridDiv").append(dataGrid.Target);
                dataGrid.Layout(columns);
                dataGrid.Target.bind("onSelectPage", function (s, e) {
                    pageIndex = e.index;
                    queryData();
                });
                dataGrid.Target.bind("onClickRow", function (s, e) {
                    Dev.MapUtils.ClearFeature("tempGraphicLayer", Dev.App.Map);
                    var c_row = e.Row;
                    var row = getrowbyid(c_row.id);
                    if (Dev.IsNull(row)) return;
                    var line = new Dev.Feature(new Dev.geom.LineString(convertpoints(row.route)));
                    Dev.MapUtils.AddFeature(line, "tempGraphicLayer", Dev.App.Map);
                    //居中放大
                    Dev.App.Map.getView().setZoom(16);
                    var extent = line.getGeometry().getExtent();
                    Dev.App.Map.getView().centerOn([((extent[0] + extent[2]) / 2), ((extent[1] + extent[3]) / 2)], Dev.App.Map.getSize(), [Dev.App.Map.getSize()[0] / 2, Dev.App.Map.getSize()[1] / 2]);
                    //var obstacles = convertobpoints(row.obstacle);
                    //if (!Dev.IsNull(obstacles) && obstacles.length > 0) {
                    //    var obspoints = [];
                    //    for (var i = 0; i < obstacles.length; i++) {
                    //        var obsf = new Dev.Feature(new Dev.geom.Point(obstacles[i]));
                    //        obsf.setStyle(new Dev.style.Style({ image: new Dev.style.Icon({ src: Dev.App.Root + "image/agri/mapobstacle.png" }) }));
                    //        obspoints.push(obsf);
                    //    }
                    //    Dev.MapUtils.AddFeatures(obspoints, "tempGraphicLayer", Dev.App.Map);
                    //}
                    //电子围栏
                    if (!Dev.IsNull(row.fishnet)) {
                        var fishnetf = new Dev.Feature(new Dev.geom.Polygon([convertpoints(row.fishnet)]));
                        fishnetf.setStyle(framestyle);
                        Dev.MapUtils.AddFeature(fishnetf, "tempGraphicLayer", Dev.App.Map);
                    }
                });
                dataGrid.Target.bind("onPageSizeChange", function (s, e) {
                    if (Dev.IsNull(e)) return;
                    pageIndex = 1;
                    pageSize = e;
                    queryData();
                });
            }
        }

        //初始化组织树
        function inittree() {
            treeControl = $('.dev-tree').prop("$this");
            treeControl.bind("onSelectChanged", function (s, e) {
                searchClear();
                var treenode = e;
                orgids = [];
                var isleaf = treeControl.IsLeaf(treenode);
                orgFilter = " \"ORGID\" IN ('" + e.id + "',";
                selectorgid = e.id;
                orgids.push(e.id);
                if (!isleaf) {
                    var allchilds = treeControl.GetAllChildren(treenode);
                    for (var i = 0; i < allchilds.length; i++) {
                        orgFilter += "'" + allchilds[i].id + "',";
                        orgids.push(allchilds[i].id);
                    }
                }
                orgFilter = orgFilter.substr(0, orgFilter.length - 1);
                orgFilter += ")";
                if (!Dev.IsNull(editWin)) editWin.Close();
                if (!Dev.IsNull(dataGrid)) queryData();
            });
            var orgid = Dev.cookie.user.orgid;
            $.ajax({
                url: Dev.GetSystemUrlByRelID("Service") + "organize/gettreebyid/" + orgid + "?" + new Date().getTime(),
                type: "GET",
                contentType: 'application/json',
                dataType: 'json',
                async: false,
                success: function (result) {
                    var treedata = Dev.ConvertTreeData(result.data, orgid);
                    treeControl.LoadData(treedata);
                    if (treedata.length > 0) treeControl.SetSelectNode(treeControl.GetRoots()[0]);
                }
            });
        }

        //查询列表
        function queryData() {
            Dev.MapUtils.ClearFeature("tempGraphicLayer", Dev.App.Map);
            pagerows = [];
            var con = getcondition();
            con += " ORDER BY \"CREATEDATE\" DESC";
            $.ajax({
                url: Dev.GetSystemUrlByRelID("Service") + "task/getByFilterSql/" + pageIndex + "/" + pageSize,
                type: "POST",
                contentType: 'application/json',
                dataType: 'json',
                data: con,
                success: function (result) {
                    if (result.statusCode != 200 || Dev.IsNull(result.data)) { loadError(); return; }
                    dataGrid.Load(result.data.dataSource, result.data.pageInfo);
                    resize();
                },
                error: function (e) { dialog.Alert(msg.netout, "error"); loadError(); }
            });
        }

        //修改
        function update(id, index) {
            if (Dev.IsNull(id)) return;
            editdata(id);
        }
       
        //列表新增或者修改
        function editdata(id) {
            updateid = id;
            if (!Dev.IsNull(editWin)) editWin.Close();
            showmodal(true);
            var selectnode = treeControl.GetSelectNode();
            editWin = new Dev.Window({
                ID: "editWin",
                IconCls: 'icon-detailinfo',
                Title: Dev.IsNull(updateid) ? "作业新增" : "作业编辑",
                Parent: Dev.App.FillPanel.Target,
                Maximizable: false,
                Modal: false,
                Draggable: true,
                HAlign: 'center',
                VAlign: 'center',
                Resizable: false,
                Url: Dev.App.Root + "html/dev/workedit.html",
                Height: 370,
                Width: 519,
                Parameters: { id: updateid, selectorg: selectnode[0].$this }
            });
            editWin.one("onClosed", function () {
                showmodal(false);
                editWin.Destroy();
                editWin = null;
                pageIndex = 1;
                queryData();
            });
        }

        //删除
        function deleteinfo(id) {
            if (Dev.IsNull(id)) return null;
            dialog.Confirm('确定删除所选记录吗？', function (r) {
                if (!r) return;
                $.ajax({
                    type: "GET",
                    url: Dev.GetSystemUrlByRelID("Service") + "task/deleteTaskById/" + id,
                    success: function (re) {
                        if (!re.statusCode == 200) { flashDialog.Alert("删除失败!", "info"); return; };
                        flashDialog.Alert("删除成功!", "info")
                        pageIndex = 1;
                        queryData();
                    },
                    error: function (msg) {
                        flashDialog.Alert("删除失败!", "info")
                    }
                });
            });
        }

        //显示详细信息
        function detailInfo(id) {
            if (!Dev.IsNull(detailWin)) detailWin.Close();
            showmodal(true);
            detailWin = new Dev.Window({
                ID: 'detailWin',
                IconCls: 'icon-detailinfo',
                Title: "作业详细",
                Parent: Dev.App.FillPanel.Target,
                Maximizable: false,
                Modal: false,
                Draggable: true,
                HAlign: 'center',
                VAlign: 'center',
                Resizable: false,
                Url: Dev.App.Root + "html/dev/workdetail.html",
                Height: 500,
                Width: 517,
                Parameters: { id: id }
            });
            detailWin.bind("onClosing", function () {
                showmodal(false);
                detailWin.Destroy();
                detailWin = null;
            });
        }

        //辅助函数
        function getrowbyid(id) {
            if (Dev.IsNull(id)) return;
            var data = Enumerable.From(pagerows).Where('s=>s.id=="' + id + '"').FirstOrDefault();
            if (Dev.IsNull(data)) {
                $.ajax({
                    url: Dev.GetSystemUrlByRelID("Service") + "task/getbyfilter",
                    type: "POST",
                    contentType: 'application/json',
                    dataType: 'json',
                    data: "\"ID\"='" + id + "'",
                    async: false,
                    success: function (result) {
                        if (result.statusCode == 200 && !Dev.IsNull(result.data) && result.data.length > 0) data = result.data[0];
                    },
                    error: function (e) { dialog.Alert(msg.netout, "error"); loadError(); }
                });
                pagerows.push(data);
            }
            return data;
        }//获取某条记录

        function getcondition() {
            var con = "1=1";
            var taskname = $("#taskname").prop("$this").GetValue();
            if (!Dev.IsNull(taskname)) con += " AND ( \"NAME\"  LIKE '%" + $.trim(taskname) + "%'" + " OR " + "UPPER( \"NAME\" )  LIKE " + "UPPER('%" + $.trim(taskname) + "%')" + " OR " + "LOWER( \"NAME\" )  LIKE " + "LOWER('%" + $.trim(taskname) + "%'))";
            var machinenum = $("#machineNum").prop("$this").GetValue();
            if (!Dev.IsNull(machinenum)) con += " AND ( \"NO\"  LIKE '%" + $.trim(machinenum) + "%'" + " OR " + "UPPER( \"NO\" )  LIKE " + "UPPER('%" + $.trim(machinenum) + "%')" + " OR " + "LOWER( \"NO\" )  LIKE " + "LOWER('%" + $.trim(machinenum) + "%'))";
            var tasktype = $("#tasktype").prop("$this").GetText();
            if (!Dev.IsNull(tasktype) && tasktype != "不限") con += " AND \"TYPE\"='" + tasktype + "'";
            var time1 = $("#tasktime1").datebox("getValue");
            var time2 = $("#tasktime2").datebox("getValue");
            if (!Dev.IsNull(time1) && !Dev.IsNull(time2)) {
                var t1 = new Date(time1.replace(/-/g, "/"));
                var t2 = new Date(time2.replace(/-/g, "/"));
                if (t1.getTime() > t2.getTime()) {
                    var temp = time1;
                    time1 = time2;
                    time2 = temp;
                }
            }
            if (!Dev.IsNull(time1)) con += " AND \"STARTTIME\">='" + time1 + " 00:00:00'";
            if (!Dev.IsNull(time2)) con += " AND \"STARTTIME\"<='" + time2 + " 23:59:59'";
            if (!Dev.IsNull(orgFilter) && orgFilter.length > 0) con += " AND " + orgFilter;
            return con;
        }//获取查询条件

        function searchClear() {
            pageIndex = 1;
            var tasknamectrl = $("#taskname").prop("$this");
            var machinecontrol = $("#machineNum").prop("$this");
            var statecontrol = $("#tasktype").prop("$this");
            if (!Dev.IsNull(tasknamectrl)) tasknamectrl.Clear();
            if (!Dev.IsNull(machinecontrol)) machinecontrol.Clear();
            if (!Dev.IsNull(statecontrol)) statecontrol.SetValue("");
            $("#tasktime1").datebox("setValue", "");
            $("#tasktime2").datebox("setValue", "");
        }//初始化查询控件

        function convertpoints(pointstr) {
            var points = [];
            if (Dev.IsNull(pointstr)) return points;
            var nums = $.trim(pointstr).split(' ');
            var pointcount = nums.length / 2;
            for (var i = 0; i < pointcount; i++) points.push([parseFloat(nums[2 * i]), parseFloat(nums[2 * i + 1])]);
            return points;
        }//将表中图形串转换成为对应的数据

        function showmodal(isshow) {
            if (Dev.IsNull(isshow)) return;
            $("#shade").css("display", (isshow ? "block" : "none"));
        }//显示遮罩

        function resize() {
            // Dev.App.BottomPanel.SetHeight(262);
            var height = $(window).outerHeight();
            var gridheight = height - 40;
            var gridwidth = $(window).outerWidth() * 0.80 - 2;
            if (gridwidth < 1305) {
                gridwidth = 1305;
                gridheight = parseFloat(gridheight) - 16;
            }
            $("#searchDiv").width(gridwidth);
            $("#gridDiv").height(gridheight).width(gridwidth);
            if (!Dev.IsNull(dataGrid)) dataGrid.Resize(gridwidth, gridheight);
            $("#treediv").height(height - 26);
        }//窗体大小变化

    </script>
</head>
<body>
    <div id="shade" style="width: 100%; height: 100%; position: absolute; z-index: 10; display: none; background: rgba(255,255,255,0.3)"></div>
    <div id="content" class="content">
        <div style="height: 100%; width: 20%; position: absolute;">
            <!--<div style="height: 26px; line-height: 26px; width: 100%; background-color: #ddd;"><span style="margin-left: 15px; color: #0099cc; line-height: 26px; letter-spacing: 3px; font-size: 12px;">组织机构</span></div>-->
            <div id="treediv" style="width: 100%; height: 100%;">
                <div class="dev-tree" opt='{"ValueField":"id","TextField":"name","ChildrenField":"child","Height":220}'></div>
            </div>
        </div>
        <div style="height: 100%; width: 80%; position: absolute; left: 20%; overflow: auto; overflow-y: hidden">
            <div id="searchDiv" style="height: 38px; border-left: 1px solid #ddd; position: relative; min-width: 1305px;">
                <div style="height: 100%; width: 205px; margin-left: 10px; display: inline-block;">
                    <div class="Title" style="width: 80px">
                        <div class="Icon machine-carnum" style="margin-left: 7px"></div>
                        <span class="Text">任务名称</span>
                    </div>
                    <div style="width: 120px; height: 40px; line-height: 38px; float: left; margin-left: 5px;">
                        <div id="taskname" class="dev-textbox" style="z-index: 2; width: 120px; margin-top: 8px;" opt='{"TipInfo":"","IsOverShow":true,"Padding":"0px 5px","TextAlign":"left","BodyCSS": { "background-color": "transparent" }}'></div>
                    </div>
                </div>
                <div style="height: 100%; width: 200px; margin-left: 4px; display: inline-block;">
                    <div class="Title">
                        <div class="Icon icon-element"></div>
                        <span class="Text">任务类型</span>
                    </div>
                    <div style="width: 120px; height: 40px; line-height: 38px; float: left; margin-left: 5px;">
                        <div id="tasktype" class="dev-combobox" style="z-index: 2; width: 120px; margin-top: 8px;" opt='{ "PopupHeight":"auto","TextField":"data","ValueField":"id","TipInfo":"请选择","IsOverShow":true,"Padding":"0px 5px","TextAlign":"left","BodyCSS": { "background-color": "transparent" }}'></div>
                    </div>
                </div>
                <div style="height: 100%; width: 195px; margin-left: 4px; display: inline-block;">
                    <div class="Title" style="width: 65px">
                        <div class="Icon machine-carnum" style="margin-left: 2px"></div>
                        <span class="Text" style="width: 40px">车牌号</span>
                    </div>
                    <div style="width: 120px; height: 40px; line-height: 38px; float: left; margin-left: 5px;">
                        <div id="machineNum" class="dev-textbox" style="z-index: 2; width: 120px; margin-top: 8px;" opt='{"TipInfo":"","IsOverShow":true,"Padding":"0px 5px","TextAlign":"left","BodyCSS": { "background-color": "transparent" }}'></div>
                    </div>
                </div>
                <div style="height: 100%; width: 220px; margin-left: 4px; display: inline-block;">
                    <div class="Title" style="width: 95px">
                        <div class="Icon icon-calendar"></div>
                        <span class="Text" style="width: 75px">任务开始时间</span>
                    </div>
                    <div style="width: 120px; height: 40px; line-height: 38px; display: inline-block; float: left; margin-left: 5px;">
                        <input id="tasktime1" class="easyui-datebox" data-options="width:120,height:24,editable:false" />
                    </div>
                </div>
                <div style="height: 100%; width: 146px; margin-left: 4px; display: inline-block;">
                    <div style="width: 12px; height: 40px; display: inline-block; line-height: 38px; text-align: center; float: left; margin-left: 2px;">至</div>
                    <div style="width: 120px; height: 40px; line-height: 38px; display: inline-block; margin-left: 12px; float: left;">
                        <input id="tasktime2" class="easyui-datebox" data-options="width:120,height:24,editable:false,validType:'equaldDate[\'#tasktime1\']'" />
                    </div>
                </div>
                <div style="width: 240px; height: 100%; float: right; margin-right: 12px; display: inline-block;">
                    <div class="Button" tag="search" style="margin-left: 10px;">
                        <div class="machine-query" style="height: 16px; width: 16px; margin-top: 5px; margin-left: 5px; display: inline-block; float: left;"></div>
                        <span style="line-height: 28px; color: #fcfcfc; width: 40px; text-align: center; margin-left: 3px;">查&nbsp;询</span>
                    </div>
                    <div class="Button" tag="clear" style="margin-left: 4px;">
                        <div class="machine-reset" style="height: 16px; width: 16px; margin-top: 5px; margin-left: 5px; display: inline-block; float: left;"></div>
                        <span style="line-height: 28px; color: #fcfcfc; width: 40px; text-align: center; margin-left: 3px;">重&nbsp;置</span>
                    </div>
                    <div class="Button" tag="add" style="margin-left: 4px;">
                        <div class="machine-add" style="height: 16px; width: 16px; margin-top: 5px; margin-left: 5px; display: inline-block; float: left;"></div>
                        <span style="line-height: 28px; color: #fcfcfc; width: 40px; text-align: center; margin-left: 3px;">新&nbsp;增</span>
                    </div>
                </div>
            </div>
            <div id="gridDiv" style="border-left: 1px solid #ddd; border-top: 1px solid #ddd;"></div>
        </div>
    </div>
</body>
</html>
