<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>目录管理</title>
    <link rel="stylesheet" href="../../theme/default/easyui.css"/>
    <link rel="stylesheet" type="text/css" href="../../theme/icon.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/app.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/main.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/icon.css"/>
    <link type="text/css" href="../../css/dev.css" rel="stylesheet"/>
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../js/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="../../js/data.util.js"></script>
    <script type="text/javascript" src="../../js/dev.ui.js"></script>
    <style>
        .content {
            height: 100%;
            width: 100%;
            position: relative;
        }

        .Title {
            width: 75px;
            text-align: right;
            line-height: 38px;
            height: 38px;
            display: inline-block;
            float: left;
        }

        .Title .Icon {
            width: 16px;
            height: 16px;
            display: inline-block;
            margin-top: 11px;
        }

        .Title .Text {
            display: inline-block;
            float: right;
            /*width: 49px;*/
        }
        .content .SearchDiv {
            width: 210px;
            height: 40px;
            display: inline-block;
            margin-left: 0px;
            margin-right: 0px;
            float: left;
        }

        .Button {
            width: 70px;
            height: 23px;
            float: left;
            margin-top: 7px;
            background-color: #16dbbb;
            /*border-radius: 5px;*/
            text-align: center;
            border: 1px solid #16dbbb;
            display: inline-block;
            margin-left: 5px;
        }

        .Button:hover {
            background-color: #5227de;
            border: 1px solid #5227de;
            cursor: pointer;
        }

           .Button:active {
                background-color: #210097;
                border: 1px solid #210097;
                cursor: pointer;
            }

    </style>
</head>
<body>
<div id="content" style="width: 100%; height: 800px; background: #FFFFFF">
    <div id="searchDiv"
         style="height: 38px; border-bottom: 1px solid #ddd; min-width:350px;">
        <div style="height: 38px; position: absolute; left: 0px;">
            <div class="SearchDiv">
                <div id="file-name" class="dev-text" style="z-index: 2; width: 200px; display: inline-block;"
                     opt='{"TipInfo":"请输入关键字","HeaderCSS":{"padding":"0px","width":"75px"},"IsOverShow":true,"Padding":"0px","TextAlign":"left","BodyCSS": { "background-color": "transparent","margin-top":"6px","margin-left":"5px" },"Title":"<div class=\"Title\"><div class=\"Icon machine-name\" style=\"float:left;margin-left:3px\"></div><span class=\"Text\" style=\"width:50px\">数据名称</span></div>"}'>
                </div>
            </div>
        </div>
        <div style="width: 80px; height: 100%; position: absolute; right: 10px; z-index: 2; bottom: 2px">
            <div class="Button" tag="search">
                <div class="machine-query"
                     style="height: 16px; width: 16px; margin-top: 4px; margin-left: 4px; display: inline-block; float: left;">
                </div>
                <span style="line-height: 26px; color: #fcfcfc;">查&nbsp;询</span>
            </div>

        </div>
    </div>


    <div id="treediv" style="width: 100%; height: 700px;">
        <ul id="organizeTree" style="width: 100%;"></ul>
    </div>

</div>

<script type="text/javascript">
    var Dev = window.top.window.dev;
    var u = Dev.cookie.user;//获取用户的信息
    var parent;
    var baseUri = Dev.cookie.baseUri;
    var dataGrid;
    var searchDom;
    var msg;
    var selectNodeId;

    var iconCls = ["icon-department", "icon-unit", "icon-user"];
    $(window).resize(function () {
        Resize();
    });
    /**
     * 通讯部件
     */
    function WidgetCommunication(s) {
        parent = s.parent;
        //改变LeftPanel的头部背景色
        Dev.App.LeftPanel.SetIconCls("data-folder");
        Dev.App.LeftPanel.Header.css("background", "#14cdad");
        Dev.App.LeftPanel.SetVisible(true);
        searchDom = $("#file-name").prop("$this");
        $(".Button").click(function () {
            var tag = $(this).attr("tag");
            if (tag === "search") {
                catalogSearch();
            }
        });
        /**
         * 清除控件
         */
        parent.one("onClosing", function () {
            Dev.App.LeftPanel.unbind("onResize");
            Dev.App.BottomPanel.unbind("onResize");
            if (!Dev.IsNull(dataGrid)) {
                dataGrid.Target.unbind("onSelectPage");
                dataGrid = null;
            }
            Dev.App.BottomPanel.Clear();
            Dev.App.BottomPanel.SetVisible(false);
            Dev.App.BottomPanel.SetHeight(216);
            Dev.App.LeftPanel.SetVisible(false);
        });

    }

    /**
     * 自适应
     */
    function Resize() {
        var treePanel = $("#divtree");
        var h = treePanel.parent().height();
        treePanel.height(h - 64);
    }

    /**
     * 加载
     */
    $(window).ready(function () {
        Resize();
        msg = new Dev.Messager({AutoShow: false});
        initTreeData();
    });

    var orgFilter;
    /**
     * 初始化目录树
     */
    function initTreeData() {
        /* 初始化树 */
        var isLoad = true;
        $('#organizeTree').tree({
            method: "get",
            checkbox: false,
            url: baseUri + "catalog/gettree/" + u.orgid + "?" + new Date().getTime(),
            onSelect: function (node) {
                if (Dev.IsNull(node.id)) {
                    var n = $(this).tree('find', selectNodeId);
                    $(this).tree('expandTo', n.target);
                    $(this).tree("select", n.target);
                    return;
                }
                orgFilter = "";
                orgFilter = "\"CATALOGID\"  IN(";
                if (node.children.length > 0) {
                    for (var i = 0; i < node.children.length; i++) orgFilter += "'" + node.children[i].id + "',";
                    orgFilter = orgFilter.substr(0, orgFilter.length - 1);
                }
                else {
                    orgFilter +=  "'" + node.id + "'" ;
                }
                orgFilter += ")";
                if (node.id != selectNodeId) {
                    getFilesByFolder(node.id);
                }
            },
            onLoadSuccess: function () {
                $(this).tree('collapseAll');
                $("#organizeTree").find("li:eq(1)").find("div").addClass("tree-node-selected");
                var n = $("#organizeTree").tree("getSelected");
                $(this).tree('expandTo', n.target);
                if (n !== null) $("#organizeTree").tree("select", n.target);
            },
            loadFilter: function (data) {
                if (data == null || data.statusCode == 400) return;
                var result = data.data;
                getTreeData(result)

                if (isLoad) {
                    isLoad = false;
                    return [{
                        id: "",
                        text: "数据中心",
                        name: "数据中心",
                        state: "open",
                        children: result
                    }];
                } else {
                    return result;
                }
            },
            onContextMenu: function (e, node) {
                e.preventDefault();
                $(this).tree('select', node.target);
            }
        });
    }

    /**
     * 将data 转换成tree能解析的数据
     * @param data 获取的tree数据
     */
    function getTreeData(data) {
        for (var i = 0, len = data.length; i < len; i++) {
            data[i].text = data[i].name;
            if (data[i].children == null || data[i].children.length == 0) {
                data[i].iconCls = 'icon-dev-catalog';
            } else
                getTreeData(data[i].children);
        }
    }

    /**
     * 目录列表刷新按钮
     */
    /*$("#btnRefresh").click(function () {
        $('#organizeTree').tree('collapseAll');
        $("#btnCatalogSearch").textbox("setValue", "");
        $("#organizeTree").find("li:eq(1)").find("div").addClass("tree-node-selected");
        var n = $("#organizeTree").tree("getSelected");
        $("#organizeTree").tree("expandTo", n.target);
        if (n !== null) $("#organizeTree").tree("select", n.target);
    });*/

    /**
     * 初始化表格
     * @param id 目录id
     */
    function initDataGrid(id) {
        selectNodeId = id;
        Dev.App.BottomPanel.Header.css({ "background": "#14cdad", "color": "#fcfcfc", "font-weight": "bold" });
        Dev.App.BottomPanel.SetIconCls("data-file");
        Dev.App.BottomPanel.SetTitle("文件列表");
        Dev.App.BottomPanel.Add(Dev.App.Root + "html/datamanage/filerecord.html", { ID: id, FT: orgFilter });
        Dev.App.BottomPanel.SetHeight(252); //必须要在SetVisible 为true前设置
        Dev.App.BottomPanel.SetVisible(true);
    }


    /**
     * 通过 点击目录查询 datagrid
     * @param id 目录Id
     */
    function getFilesByFolder(id) {
        initDataGrid(id);
    }


    /**
     * 目录搜索
     */
    function catalogSearch() {
        var searchValue = searchDom.GetValue();
        $('#organizeTree').tree('search', searchValue);
    }

    /**
     * 1）扩展jquery easyui tree的节点检索方法。使用方法如下：
     * $("#treeId").tree("search", searchText);
     * 其中，treeId为easyui tree的根UL元素的ID，searchText为检索的文本。
     * 如果searchText为空或""，将恢复展示所有节点为正常状态
     */
    (function ($) {
        $.extend($.fn.tree.methods, {
            /**
             * 扩展easyui tree的搜索方法
             * @param jqTree easyui tree的根DOM节点(UL节点)的jQuery对象
             * @param searchText 检索的文本
             * this easyui tree的tree对象
             */
            search: function (jqTree, searchText) {
                //easyui tree的tree对象。可以通过tree.methodName(jqTree)方式调用easyui tree的方法
                var tree = this;
                var selectedNode = tree.getSelected(jqTree);
                //获取所有的树节点
                var nodeList = getAllNodes(jqTree, tree);

                //如果没有搜索条件，则展示所有树节点
                searchText = $.trim(searchText);
                if (searchText == "") {
                    for (var i = 0; i < nodeList.length; i++) {
                        $(".tree-node-targeted", nodeList[i].target).removeClass("tree-node-targeted");
                        $(nodeList[i].target).show();
                    }
                    //展开已选择的节点（如果之前选择了）
                    //var selectedNode = tree.getSelected(jqTree);
                    if (selectedNode) {
                        tree.expandTo(jqTree, selectedNode.target);
                    }
                    return;
                }

                //搜索匹配的节点并高亮显示
                var matchedNodeList = [];
                if (nodeList && nodeList.length > 0) {
                    var node = null;
                    for (var i = 0; i < nodeList.length; i++) {
                        node = nodeList[i];
                        if (isMatch(searchText, node.text)) {
                            matchedNodeList.push(node);
                        }
                    }

                    //隐藏所有节点
                    /*for (var i=0; i<nodeList.length; i++) {
                        $(".tree-node-targeted", nodeList[i].target).removeClass("tree-node-targeted");
                        $(nodeList[i].target).hide();
                    }*/

                    //折叠所有节点
                    tree.collapseAll(jqTree);
                    if (matchedNodeList.length == 0) {
                        tree.expandTo(jqTree, selectedNode.target);
                        return;
                    }

                    //展示所有匹配的节点以及父节点
                    for (var i = 0; i < matchedNodeList.length; i++) {
                        showMatchedNode(jqTree, tree, matchedNodeList[i]);
                    }
                    tree.select(jqTree, matchedNodeList[0].target);
                }
            },

            /**
             * 展示节点的子节点（子节点有可能在搜索的过程中被隐藏了）
             * @param node easyui tree节点
             */
            showChildren: function (jqTree, node) {
                //easyui tree的tree对象。可以通过tree.methodName(jqTree)方式调用easyui tree的方法
                var tree = this;

                //展示子节点
                if (!tree.isLeaf(jqTree, node.target)) {
                    var children = tree.getChildren(jqTree, node.target);
                    if (children && children.length > 0) {
                        for (var i = 0; i < children.length; i++) {
                            if ($(children[i].target).is(":hidden")) {
                                $(children[i].target).show();
                            }
                        }
                    }
                }
            },

            /**
             * 将滚动条滚动到指定的节点位置，使该节点可见（如果有滚动条才滚动，没有滚动条就不滚动）
             * @param param {
             *    treeContainer: easyui tree的容器（即存在滚动条的树容器）。如果为null，则取easyui tree的根UL节点的父节点。
             *    targetNode:  将要滚动到的easyui tree节点。如果targetNode为空，则默认滚动到当前已选中的节点，如果没有选中的节点，则不滚动
             * }
             */
            scrollTo: function (jqTree, param) {
                //easyui tree的tree对象。可以通过tree.methodName(jqTree)方式调用easyui tree的方法
                var tree = this;

                //如果node为空，则获取当前选中的node
                var targetNode = param && param.targetNode ? param.targetNode : tree.getSelected(jqTree);

                if (targetNode != null) {
                    //判断节点是否在可视区域
                    var root = tree.getRoot(jqTree);
                    var $targetNode = $(targetNode.target);
                    var container = param && param.treeContainer ? param.treeContainer : jqTree.parent();
                    var containerH = container.height();
                    var nodeOffsetHeight = $targetNode.offset().top - container.offset().top;
                    if (nodeOffsetHeight > (containerH - 30)) {
                        var scrollHeight = container.scrollTop() + nodeOffsetHeight - containerH + 30;
                        container.scrollTop(scrollHeight);
                    }
                }
            }
        });

        /**
         * 展示搜索匹配的节点
         */
        function showMatchedNode(jqTree, tree, node) {
            //展示所有父节点
            $(node.target).show();
            $(".tree-title", node.target).addClass("tree-node-targeted");
            var pNode = node;
            while ((pNode = tree.getParent(jqTree, pNode.target))) {
                $(pNode.target).show();
            }
            //展开到该节点
            tree.expandTo(jqTree, node.target);
            //tree.select(jqTree, node.target);
            //$("#organizeTree").tree("select", node.target);
            //如果是非叶子节点，需折叠该节点的所有子节点
            if (!tree.isLeaf(jqTree, node.target)) {
                tree.collapse(jqTree, node.target);
            }
        }

        /**
         * 判断searchText是否与targetText匹配
         * @param searchText 检索的文本
         * @param targetText 目标文本
         * @return boolean true-检索的文本与目标文本匹配；否则为false.
         */
        function isMatch(searchText, targetText) {
            return $.trim(targetText) != "" && targetText.indexOf(searchText) != -1;
        }

        /**
         * 获取easyui tree的所有node节点
         */
        function getAllNodes(jqTree, tree) {
            var allNodeList = jqTree.data("allNodeList");
            if (!allNodeList) {
                var roots = tree.getRoots(jqTree);
                allNodeList = getChildNodeList(jqTree, tree, roots);
                jqTree.data("allNodeList", allNodeList);
            }
            return allNodeList;
        }

        /**
         * 定义获取easyui tree的子节点的递归算法
         */
        function getChildNodeList(jqTree, tree, nodes) {
            var childNodeList = [];
            if (nodes && nodes.length > 0) {
                var node = null;
                for (var i = 0; i < nodes.length; i++) {
                    node = nodes[i];
                    childNodeList.push(node);
                    if (!tree.isLeaf(jqTree, node.target)) {
                        var children = tree.getChildren(jqTree, node.target);
                        childNodeList = childNodeList.concat(getChildNodeList(jqTree, tree, children));
                    }
                }
            }
            return childNodeList;
        }
    })(jQuery);
</script>
</body>
</html>