<!DOCTYPE html>
<html>
<head>
    <title>目录管理</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" type="text/css" href="../../theme/default/easyui.css" />
    <link rel="stylesheet" type="text/css" href="../../theme/icon.css" />
    <link rel="stylesheet" type="text/css" href="../../css/app.css" />
    <link rel="stylesheet" type="text/css" href="../../css/main.css" />
    <link rel="stylesheet" type="text/css" href="../../css/icon.css" />
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../js/jquery.form.js"></script>
    <script type="text/javascript" src="../../js/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="../../js/highcharts.js"></script>
    <script type="text/javascript" src="../../js/linq.min.js"></script>
    <script type="text/javascript" src="../../js/dev.ui.js"></script>
    <script type="text/javascript">
        dev = window.top.window.dev;
        var win = null;
        var ids = "";
        var data;
        var direcdatas = null;
        var selectnode = null;
        var updatemodel;
        var addLimit = true;
        var updateLimit = true;
        var deleteLimit = true;
        var pager;
        var gridpageindex = 1;
        var pagesize = 10;
        var currcondition;
        var charts;
        var options;
        var currentData = null;
        var statData;
        var dialog;
        var isinit;
        var serviceUrl;
        $(window).resize(function () { setCss(); });
        $(window).ready(function () {
            isinit = true;
            serviceUrl = dev.GetSystemUrlByRelID("Service");
            dialog = $.messager;
            dialog.defaults.height = 150;
            dialog.defaults.width = 250;
            /*左侧部分：目录相关*/
            $("#treetest").tree({
                onBeforeSelect: function (node) {
                    if (!dev.IsNull(selectnode) && selectnode.domId == node.domId) return;//去掉重复点击
                    selectnode = node;
                    contentchange(true);
                    search();
                },
                //菜单管理
                onContextMenu: function (e, node) {
                    e.preventDefault();
                    $("#treetest").tree('select', node.target);
                    var additem = $("#mm").menu('findItem', "新建");
                    var updateitem = $("#mm").menu('findItem', "修改");
                    var deleteitem = $("#mm").menu('findItem', "删除");
                    if (node.id === "root") {
                        if (!addLimit) return;
                        else {
                            $("#mm").menu("hideItem", updateitem.target);
                            $("#mm").menu("hideItem", deleteitem.target);
                        }
                    }
                    else {
                        $("#mm").menu("showItem", updateitem.target);
                        $("#mm").menu("showItem", deleteitem.target);
                    }
                    $("#mm").menu('show', { left: e.pageX, top: e.pageY });
                },
                onAfterEdit: function (node) {
                    if (updatemodel) {
                        if (node.text.length > 64) {
                            dialog.alert({ title: "提示", msg: "文件夹名称长度不超过64个！", icon: "warning" });
                            $("#treetest").tree('update', {
                                target: node.target,
                                text: updatemodel.name
                            });
                            return;
                        }
                        if (Isrepeat(node)) {
                            dialog.alert({ title: "提示", msg: "文件夹名称已存在，请重新输入！", icon: "warning" });
                            $("#treetest").tree('update', {
                                target: node.target,
                                text: updatemodel.name
                            });
                            return;
                        }

                        //判断是会否重
                        if (node.text === "") {
                            node.text = updatemodel.name;
                            $("#treetest").tree('beginEdit', node.target);
                            return;
                        }
                        updatemodel.name = node.text;
                        $.ajax({
                            type: "POST",
                            contentType: "application/json",
                            url: serviceUrl + "folder/update",
                            data: JSON.stringify(updatemodel),
                            success: function (data) {
                                //$("#treetest").tree('update', {
                                //    target: node.target,
                                //    text: updatemodel.name
                                //});
                                updatemodel = null;
                                //$("#treetest").tree("remove", node.target);
                                bindData();
                            }
                        });
                    }
                    else {
                        if (node.text.length > 64) {
                            dialog.alert({ title: "提示", msg: "文件夹名称长度不超过64个！", icon: "warning" });
                            $("#treetest").tree("remove", node.target);
                            return;
                        }
                        if (Isrepeat(node)) {
                            dialog.alert({ title: "提示", msg: "文件夹名称已存在，请重新输入！", icon: "warning" });
                            $("#treetest").tree("remove", node.target);
                            return;
                        }

                        if (node.text === "") node.text = defaultText(node);
                        //录入数据库
                        var model = {
                            name: node.text, storage: 10, filemaxsize: 1, filetype: "不限", createdate: new Date()
                        };
                        var parent = $("#treetest").tree("getParent", node.target);
                        if (parent.id !== "root") {
                            model.parentid = parent.id;
                        }
                        var url = serviceUrl + "folder/add";
                        $.ajax({
                            type: "POST",
                            contentType: "application/json",
                            url: url,
                            data: JSON.stringify(model),
                            success: function (data) {
                                if (data.statusCode == 200) {
                                    bindData();
                                }
                            },
                            error: function () { dialog.alert({ title: "提示", msg: "新增目录失败！", icon: "warning" }); }
                        });
                    }
                },
                onLoadSuccess: LoadSuccess,
                //双击修改文件夹名称
                onDblClick: function (node) {
                    if (direcdatas === null || node.id === "root") return;
                    $("#treetest").tree('cancelEdit', node.target);
                    if (direcdatas !== null) {
                        for (var i = 0; i < direcdatas.length; i++) {
                            if (direcdatas[i].id === node.id) {
                                updatemodel = direcdatas[i];
                                break;
                            }
                        }
                        if (updatemodel === null || updatemodel === undefined) return;
                        $("#treetest").tree('beginEdit', node.target);
                    }
                },
                onDrop: function (target, source, point) {
                    var node = $("#treetest").tree("getData", target);
                    var targetid = node.id;
                    if (targetid === undefined || targetid === "root") targetid = null;
                    //如何多拽下的子的不能重名
                    for (var i = 0; i < direcdatas.length; i++) {
                        if (direcdatas[i].parentid === targetid && direcdatas[i].name === source.text) {
                            bindData();
                            return;
                        }
                    }
                    var model;
                    for (var i = 0; i < direcdatas.length; i++) {
                        if (source.id === direcdatas[i].id) { model = direcdatas[i]; break; }
                    }
                    if (model === null) return;
                    model.parentid = targetid === null ? "" : targetid;
                    $.ajax({
                        type: "POST",
                        contentType: "application/json",
                        url: serviceUrl + "folder/update",
                        data: JSON.stringify(model),
                        success: function (json) {
                            bindData();
                        },
                        error: function () { bindData(); }
                    });
                }
            });

            initData();

            $("#divAdd").click(function () { add(); }); //目录新增
            $("#divRemove").click(function () { remove(); });//目录删除
            $("#divEdit").click(function () { edit(); });//目录修改
            // 权限设置
            if (!addLimit) $("#mm").menu("disableItem", ($("#mm").menu('findItem', "新建")).target);
            if (!updateLimit) $("#mm").menu("disableItem", ($("#mm").menu('findItem', "修改")).target);
            if (!deleteLimit) $("#mm").menu("disableItem", ($("#mm").menu('findItem', "删除")).target);

            /*右侧部分：文件相关*/
            pager = $('#grid').datagrid().datagrid('getPager').pagination
                ({
                    showPageList: false,
                    showRefresh: false,
                    pageSize: pagesize,
                    pageNumber: gridpageindex,
                    onSelectPage: function (index, size) {
                        searchByCondition(size, index, currcondition);
                    },
                });
            //查询【文件】
            $("#searchbtn").click(function () {
                contentchange(true);
                search();
            });
            //删除【文件】
            $("#deletebtn").click(function () {
                var checkRows = $("#grid").datagrid("getChecked");
                if (checkRows == null || checkRows.length === 0) {
                    dialog.alert({ title: "提示", msg: "请勾选要删除的文件！", icon: "warning" });
                    return;
                }

                dialog.confirm('确认', '确认删除所有选中文件？', function (r) {
                    if (!r) return;
                    filesdelete(checkRows);
                });
            });
            //上传【文件】
            $("#uploadbtn").click(function () { $("#devfile").click(); });
            //统计【文件】
            options = {
                chart: { renderTo: "container", type: 'line' },
                title: { text: '附件统计' },
                credits: { enabled: false },
                xAxis: { title: { text: null } },
                yAxis: [{ title: { text: '附件个数 (个)' } }, { title: { text: '大小(KB)' }, opposite: true }],
                plotOptions: {}
            };
            charts = new Highcharts.Chart(options);
            $("#staticbtn").click(function () { statclick(); });
            $("#selWay").combobox({ onSelect: function (record) { stat(); } });
            $("#selOpt").combobox({ onSelect: function (record) { stat(); } });
            //移动【文件】
            $("#movebtn").click(function () {
                var checkRows = $("#grid").datagrid("getChecked");
                if (checkRows == null || checkRows.length === 0) { dialog.alert({ title: "提示", msg: "请勾选要移动的的文件！", icon: "warning" }); return; }
                move(checkRows);
            });
        });
        //初始化布局
        function setCss() {
            var w = $(window).width(), h = $(window).height();
            if (w < 610) return;
            $("#treepanel,#center").css("height", h + "px");
            $("#center,#centertop").css("width", (w - 201) + "px");
            $("#treetest").css("height", (h - 38) + "px");
            $("#centerbottom,#centerStat").css({ width: (w - 201) + "px", height: (h - 71) + "px" });
            $("#centertop").children().css("width", (w - 211) + "px");
            $("#container").css("height", (h - 101) + "px");
            $("#mask").css({ width: w + "px", height: h + "px" });
        }
        //初始化相关数据【文件类型】
        function initData() {
            $.ajax({
                type: "POST",
                contentType: "application/json",
                url: serviceUrl + "dictionary/getbyfilter",
                data: "\"PARENTID\" ='filecode123'",
                success: function (json) {
                    if (dev.IsNull(json) || json.statusCode !== 200) return;
                    $("#filetype").combobox("loadData", json.data);
                },
                error: function (e) {
                    dialog.alert({ title: "提示", msg: "字典数据【文件类型】获取失败！", icon: "error" });
                }
            });

            bindData();
        }
        //获取所有目录数据【目录】
        function bindData() {
            $.ajax({
                type: "GET",
                contentType: "application/json",
                url: serviceUrl + "folder/getall",
                success: function (json) {
                    if (dev.IsNull(json) || json.statusCode !== 200) return;
                    direcdatas = json.data;
                    var treedata = convert(json.data);
                    var treeroot = { id: 'root', text: '附件' };
                    for (var i = 0; i < treedata.length; i++) {
                        if (treeroot.children) treeroot.children.push(treedata[i]);
                        else treeroot.children = [treedata[i]];
                    }

                    $("#treetest").tree('loadData', [treeroot]);
                    win = undefined;
                    var rootnode = $("#treetest").tree("find", "root");
                    $("#treetest").tree("select", rootnode.target);
                },
                error: function (e) {
                    dialog.alert({ title: "提示", msg: "目录数据获取失败！！", icon: "error" });
                }
            });
        }
        //构造树形结构数据【目录】
        function convert(datas) {
            var nodes = [];
            //寻找根节点
            $.each(datas, function (index) {
                var row = this;
                if (dev.IsNull(row.parentid) || !exists(datas, row.parentid)) {
                    nodes.push({
                        id: row.id, text: row.name, currpath: row.currpath,
                        filetype: row.filetype, filemaxsize: row.filemaxsize, storage: row.storage
                    });
                }
            });
            $.each(nodes, function (index) {
                var row = this;
                var parentid = row.id;
                getChild(nodes[index], datas);
            });
            return nodes;
        }
        function getChild(node, datas) {
            var id = node.id;
            for (var i = 0; i < datas.length; i++) {
                if (datas[i].parentid === id) {
                    var child = { id: datas[i].id, text: datas[i].name };
                    if (node.children) node.children.push(child);
                    else node.children = [child];
                    getChild(child, datas);
                }
            }
        }
        //判断是否为根节点
        function exists(datas, parentId) {
            for (var i = 0; i < datas.length; i++) { if (datas[i].id == parentId) return true; }
            return false;
        }
        function doSearch(value) {
            //直接过滤
            value = $.trim(value);
            filterData(value, direcdatas);
            var treedata = convert(data);
            var treeroot = { id: 'root', text: '附件' };
            for (var i = 0; i < treedata.length; i++) {
                if (treeroot.children) treeroot.children.push(treedata[i]);
                else treeroot.children = [treedata[i]];
            }
            $("#treetest").tree('loadData', [treeroot]);
        }
        //对目录数据进行过滤
        function filterData(condition, datas) {
            data = [];
            for (var i = 0; i < datas.length; i++) {
                var currdata = datas[i];
                if (currdata.name.indexOf(condition) >= 0) {
                    var isExist = Enumerable.From(data).Where("s=>s.name==='" + currdata.name + "'").ToArray();
                    if (!dev.IsNull(isExist) && isExist.length > 0) continue;
                    data.push(currdata);
                    getNodeChilds(currdata, datas);
                }
            }
        }
        //获取满足条件的节点及其子节点
        function getNodeChilds(node, datas) {
            $.each(datas, function () {
                var currdata = this;
                if (node.id === this.parentid) {
                    var ishave = false;
                    $.each(data, function () {
                        if (this.id === currdata.id) ishave = true;
                    });
                    if (!ishave) {
                        data.push(currdata);
                        getNodeChilds(currdata, datas);
                    }
                }
            });
        }
        //新增【目录】
        function add() {
            var id = 'New' + new Date().getTime();
            $("#treetest").tree("append", { parent: selectnode.target, data: [{ id: id, text: "新建文件夹" }] });
            var node = $("#treetest").tree('find', id);
            node.text = defaultText(node);
            $("#treetest").tree('beginEdit', node.target);
        }
        //修改【目录】
        function edit() {
            var currtNode = $('#treetest').tree('getSelected');
            var editmodel = null;
            if (currtNode !== null && currtNode !== undefined) {
                for (var i = 0; i < direcdatas.length; i++) {
                    if (direcdatas[i].id === currtNode.id) {
                        editmodel = direcdatas[i];
                        break;
                    }
                }
                var url = dev.App.Root + "html/accessory/directoryEdit.html?ID=" + currtNode.id;
                win = new dev.Window({
                    ID: "DirectoryEdit",
                    Title: "目录信息",
                    Parent: document.body,
                    Modal: true,
                    Draggable: true,
                    HAlign: 'center',
                    VAlign: 'center',
                    Height: 300,
                    Width: 340,
                    Url: url
                });
                win.Open();
                currtNode.attribute = editmodel
                win.EditNode = currtNode;
                win.bind('onClosing', function () {
                    if (win.IsEditSucceed !== true) return;
                    bindData();
                });
            }
        }

        function getNodes(node) {
            ids += "'" + node.id + "',";
            if (node.children) {
                var childs = node.children;
                $.each(childs, function () { getNodes(this); });
            }
        }
        //删除【目录】
        function remove() {
            var selectedNode = $('#treetest').tree('getSelected');
            if (selectedNode) {
                dialog.confirm('目录删除', '您确定想要删除所选目录吗？', function (r) {
                    if (!r) return;
                    //id = "";
                    //getNodes(selectedNode);
                    //condition = "\"ID\" in (" + ids.substring(0, ids.length - 1) + ")";
                    //$.ajax({
                    //    type: "GET",
                    //    contentType: "application/json",
                    //    url: serviceUrl + "folder/deletebyid/" + selectedNode.id,
                    //    success: function (result) {
                    //        bindData();
                    //    },
                    //    error: function () { dialog.alert({ title: "提示", msg: "服务请求失败！", icon: "error" }); }
                    //});
                    var ids = [{ id: selectedNode.id }];
                    $.ajax({
                        type: "post",
                        contentType: "application/json",
                        url: serviceUrl + "folder/deleteInfos",
                        data:JSON.stringify(ids),
                        success: function (result) {
                            bindData();
                        },
                        error: function () { dialog.alert({ title: "提示", msg: "服务请求失败！", icon: "error" }); }
                    });
                });
            }
        }
        //根据名称和父节点ID判断是否重名
        function Isrepeat(node) {
            var isrepeat = false;
            var parent = $("#treetest").tree('getParent', node.target);
            var nodes = null;
            if (parent === null) nodes = $("#treetest").tree("getRoots");
            else nodes = parent.children;
            if (nodes == null) return isrepeat;
            for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].id === node.id) continue;
                if (nodes[i].text === node.text) {
                    isrepeat = true;
                    break;
                }
            }
            return isrepeat;
        }
        //默认文件夹名
        function defaultText(node) {
            //根据获取的名称
            node.text = "新建文件夹";
            if (!Isrepeat(node)) return node.text;
            else {
                var text = "新建文件夹";
                for (var j = 1; j < 100; j++) {
                    node.text = text + j;
                    if (!Isrepeat(node)) { text = node.text; break; }
                }
                return text;
            }
        }

        //格式化datagrid控件 操作列
        function formatOper(val, row, index) {
            var filepath = row.path;
            if (row.name == undefined || row.name == null) row.name = "";
            var filename = row.name.replace(/%/g, "%25");//若文件名中有特殊字符%，需要进行转换
            return '<a href="#" onclick="fileview(' + index + ')">预览</a>&nbsp;&nbsp;<a href="' + serviceUrl + 'file/download?reluri=' + filepath + '&filename=' + filename + '">下载</a>&nbsp&nbsp<a href="#" onclick="rename(' + index + ');">重命名</a>&nbsp&nbsp<a href="#" onclick="filedelete(' + index + ')">删除</a>&nbsp&nbsp<a href="#" onclick="filemove(' + index + ')">移动</a>';
        }
        //格式化datagrid控件 图标列
        function formatIcon(val, row, index) {
            var extname = row.extname;
            var icon = '';
            switch (extname) {
                case ".doc": case ".docx":
                    icon = 'icon-doc20';
                    break;
                case ".xls": case ".xlsx":
                    icon = 'icon-xls20';
                    break;
                case ".pdf":
                    icon = 'icon-pdf20';
                    break;
                case ".gif": case ".jpg": case ".png": case ".bmp":
                    icon = 'icon-img20';
                    break;
                case ".ppt": case ".pptx":
                    icon = 'icon-ppt20';
                    break
                case ".txt":
                    icon = 'icon-txt20';
                    break
                default:
                    icon = "icon-def20";
                    break;
            }
            return ' <div title="' + row.type + '" class="' + icon + '" style="height: 20px; width: 20px; float: right;"></div>';
        }
        //格式化datagrid控件 文件大小列
        function formatFilesize(val, row, index) {
            return row.size == 0 ? '小于1' : row.size;
        }
        //统计界面与查询界面切换
        function contentchange(flag) {
            $("#centerbottom").css("display", (flag ? "block" : "none"));
            $("#centerStat").css("visibility", (flag ? "hidden" : "visible"));
        }
        //显示和隐藏进度条
        function progerssbar(ishidden) {
            if (ishidden) {
                $("#mask").hide();
                $("#p").hide();
            }
            else {
                $("#mask").show();
                $("#p").show();
            }
        }
        //设置底层节点的图标
        function LoadSuccess() {
            var children = $("#treetest").tree('getChildren');
            for (var i = 0; i < children.length; i++) {
                var tar = $(children[i].target).html();
                $(children[i].target).attr("title", children[i].text);
                $(children[i].target).html(tar.replace(/file/g, "folder"));
            }
        }
        //附件上传
        function filechange() {
            var files = $("#devfile")[0].files;
            if (files == null || files === undefined) {
                if ($("#devfile").val() !== "") files = [{ name: $("#devfile").val().substring($("#devfile").val().lastIndexOf('\\') + 1) }];
            }
            if (files === null || files === undefined) { dialog.alert({ title: "提示", msg: "请选择上传文件！", icon: "warning" }); refile(); return; }
            var id = selectnode.id, filetype = "不限";
            if (selectnode.filetype) {
                filetype = selectnode.filetype;
            }
            var fileExt = ".*";
            if (!dev.IsNull(filetype)) {
                switch (filetype) {
                    case "图片": fileExt = ".bmp,.png,.jpg,.jpeg,.gif"; break;
                    case "文档": fileExt = ".doc,.txt,.docx,.xls,.xlsx,.mpp,.ppt,.pptx,.pdf"; break;
                    case "音频": fileExt = ".mp3,.wav,.ogg"; break;
                    case "视频": fileExt = ".mp4,.ogv,.wmv"; break;
                    default: break;
                }
            }
            var filetypelist = fileExt.split(',');
            var namestring = " AND \"NAME\" IN (";
            for (var i = 0; i < files.length; i++) {
                var storgSize = dev.IsNull(selectnode.filemaxsize) ? 10 : selectnode.filemaxsize;
                if (files[i].size >= storgSize * 1024 * 1024) {
                    dialog.alert({ title: "提示", msg: "文件大小不允许超过该文件夹的文件最大值" + storgSize + "M!", icon: "warning" });
                    refile();
                    return;
                }

                if (selectnode.id !== "root") {
                    var totalsize = Enumerable.From(selectnode.fileInfo).Sum("$.size");
                    if (totalsize + files[i].size / 1024 > selectnode.storage * 1024) {
                        dialog.alert({ title: "提示", msg: "文件夹存储空间不足！", icon: "warning" });
                        refile();
                        return;
                    }
                }
                namestring += "'" + files[i].name + "',";
                if (fileExt === ".*") break;
                var filename = files[i].name;
                var exname = filename.substring(files[i].name.lastIndexOf('.'));
                if ($.inArray(exname, filetypelist) < 0) {
                    dialog.alert({ title: "提示", msg: "该文件夹中不允许添加" + exname + "类型的文件！", icon: "warning" });
                    refile();
                    return;
                }
            }

            var condition = "\"FOLDERID\" ='" + id + "'";
            if (id === "root") condition = " (\"FOLDERID\" IS NULL OR TRIM(\"FOLDERID\")='') ";
            namestring = namestring.substring(0, namestring.length - 1) + ")";
            condition += namestring;
            $.ajax({
                type: "POST",
                contentType: "application/json",
                url: serviceUrl + "file/getbyfilter",
                data: condition,
                success: function (json) {
                    if (dev.IsNull(json.data) || json.statusCode != 200) return;
                    if (json.data.length > 0) {
                        dialog.alert({ title: "提示", msg: "文件夹【" + selectnode.text + "】中已存在【" + files[i].name + "】文件！", icon: "warning" });
                        refile();
                        return;
                    }

                    progerssbar(false);
                    $("#p").progressbar({ value: "5" });
                    $("#fileForm").ajaxSubmit({
                        url: serviceUrl + "file/upload?reluri=",
                        type: "post",
                        dataType: "text",
                        success: function (data) {
                            data = dev.evalJSON(data);
                            if (data.statusCode !== 200) {
                                progerssbar(true);
                                dialog.alert({ title: "提示", msg: "上传失败！", icon: "warning" });
                                return;
                            }
                            $("#p").progressbar({ value: "35" });
                            var insertdata = [];
                            //for (var i = 0; i < data.FilesResult.length; i++) {
                            var model = {};
                            if (!dev.IsNull(id) && id !== "root") model.folderid = id;
                            model.name = data.data[0].byname;
                            model.type = data.data[0].type;
                            model.extname = data.data[0].extname;
                            model.size = data.data[0].size;
                            model.path = data.data[0].path;
                            model.uploader = dev.cookie.user.name;
                            model.createdate = new Date();
                            model.updatedate = new Date();
                            model.safe = "1";
                            insertdata.push(model);
                            //}
                            $("#p").progressbar({ value: "45" });
                            refile();                          //to reset the lable input
                            $.ajax({
                                type: "POST",
                                contentType: "application/json",
                                url: serviceUrl + "file/add",
                                data: JSON.stringify(model),
                                success: function (data) {
                                    $("#p").progressbar({ value: "89" });
                                    if (data.statusCode === 200) {
                                        $("#p").progressbar({ value: "100" });
                                        dialog.alert({ title: "提示", msg: "上传成功！", icon: "info" });
                                        searchByCondition(pagesize, gridpageindex, currcondition);
                                    }
                                    else dialog.alert({ title: "提示", msg: "上传失败！", icon: "warning" });
                                    progerssbar(true);
                                },
                                error: function () { progerssbar(true); dialog.alert({ title: "提示", msg: "文件新增服务失败！", icon: "error" }); }
                            });
                        },
                        error: function (error) {
                            progerssbar(true);
                            dialog.alert({ title: "提示", msg: "文件上传服务失败！", icon: "error" });
                            refile();
                        }

                    });
                },
                error: function () {
                    dialog.alert({ title: "提示", msg: "文件查询服务失败！", icon: "error" });
                    refile();
                }
            });
        }

        function refile() {
            $('#devfile').replaceWith(' <input id="devfile" type="file" name="devfile" accept=".*" multiple="multiple" onchange="filechange()" style="width: 54px; height: 25px; position: absolute; top: 3px; opacity: 0;" />');
        }
        //附件查询
        function search() {
            var startime = $.trim($("#startdate").datetimebox("getValue"));
            var endtime = $.trim($("#enddate").datetimebox("getValue"));
            if (startime != "") {
                var time = new Date(startime.replace(/-/, "/")).getYear();
                if (isNaN(time)) { $("#error").html("开始时间格式不对！"); return; }
            }
            if (endtime != "") {
                var time1 = new Date(endtime.replace(/-/, "/")).getYear();
                if (isNaN(time1)) { $("#error").html("截止时间格式不对！"); return; }
            }
            if (startime !== "" && endtime !== "" && startime > endtime) {
                $("#error").html("上传时间的查询条件不合理！");
                return;
            }
            $("#error").html("");
            var name = $.trim($("#filename").textbox("getText"));
            var type = $.trim($("#filetype").combobox("getText"));
            var person = $.trim($("#creator").textbox("getText"));
            var condition = " 1=1 ";
            if (name !== null && name !== '') condition += " AND \"NAME\" LIKE '%" + name + "%'";
            if (type !== null && type !== '' && type !== '不限') condition += " AND \"TYPE\" LIKE '%" + type + "%'";
            if (person !== null && person !== '') condition += " AND \"UPLOADER\" LIKE '%" + person + "%'";
            if (startime !== "") condition += " AND \"UPDATEDATE\">=TO_TIMESTAMP('" + startime + "','yyyy-mm-dd hh24:mi:ss')";
            if (endtime !== "") condition += " AND \"UPDATEDATE\"<=TO_TIMESTAMP('" + endtime + "','yyyy-mm-dd hh24:mi:ss')";

            if (selectnode !== null) {
                if (selectnode.id === "root") condition += " AND \"FOLDERID\" IS NULL OR TRIM(\"FOLDERID\")=''";
                else condition += " AND \"FOLDERID\"='" + selectnode.id + "'";
            }
            currcondition = condition;
            searchByCondition(pagesize, gridpageindex, condition);
        }
        function searchByCondition(pagesize, pageindex, conditon) {
            if (conditon == null || conditon === undefined || conditon === "") conditon = " 1=1 AND (\"FOLDERID\" IS NULL OR TRIM(\"FOLDERID\")='')";
            conditon += " ORDER BY \"UPDATEDATE\" DESC";

            var url = serviceUrl + "file/getbyfilter/" + pageindex + "/" + pagesize;
            $.ajax({
                type: "POST",
                contentType: "application/json",
                url: url,
                data: conditon,
                success: function (json) {
                    if (json.statusCode !== 200) return;
                    var data = json.data;
                    for (var i = 0; i < data.dataSource.length; i++) {
                        data.dataSource[i].cdate = dev.ShortDateToString("/Date(" + data.dataSource[i].createdate + "+0800)/");
                        data.dataSource[i].udate = dev.ShortDateToString("/Date(" + data.dataSource[i].updatedate + "+0800)/");
                        data.dataSource[i].issafe = data.dataSource[i].issafe === "true" ? "安全" : "不安全";
                    }
                    selectnode.fileInfo = data.dataSource;
                    $("#grid").datagrid('loadData', data.dataSource);
                    $("#grid").datagrid("loaded");
                    pager.pagination({ total: data.pageInfo.totalCount, pageNumber: data.pageInfo.pageIndex, displayMsg: "显示记录" + (((pageindex - 1) * pagesize) + 1) + "-" + (pageindex * pagesize) + ",共{total}条数据" });
                    if (win != null && win != undefined) {
                        win.Close();
                        //win.Destroy();
                        win = undefined;
                    }
                },
                error: function (e) {
                    $("#grid").datagrid("loaded");
                }
            });
        }
        //附件修改（重命名）
        function rename(index) {
            $("#grid").datagrid("selectRow", index);
            var model = $("#grid").datagrid("getSelected");
            $("#grid").datagrid("beginEdit", index);
            var edit = $("#grid").datagrid("getEditor", { index: index, field: 'name' });
            var oldvalue = edit.oldHtml;
            var exname = oldvalue.substring(oldvalue.lastIndexOf('.'));
            edit.target.val(oldvalue.substring(0, oldvalue.lastIndexOf('.')));
            var isupdate = false;
            $(edit.target).focus();
            $(edit.target).bind("focus", function () {
                $(edit.target)[0].selectionStart = edit.target.val().length;
            })
            edit.target.bind('blur', function () {
                if (isupdate) return;
                //首先获取当前值
                if (edit.target.val().trim() === "") {
                    edit.target.val(oldvalue);
                    isupdate = true;
                    $("#grid").datagrid("endEdit", index);
                    return;
                }
                var filename = edit.target.val() + exname;
                if (filename == oldvalue) {
                    edit.target.val(oldvalue);
                    isupdate = true;
                    $("#grid").datagrid("endEdit", index);
                    return;
                }
                model.name = filename;
                $.ajax({
                    type: "POST",
                    contentType: "application/json",
                    url: serviceUrl + "file/update",
                    data: JSON.stringify(model),
                    success: function (json) {
                        var title = "";
                        var blsuccess = json.statusCode == 200 && (json.data == model.id);
                        if (blsuccess) title = "修改成功！";
                        else title = "修改失败！";
                        dialog.alert({ title: "提示", msg: title, icon: "info" });
                        if (!blsuccess) edit.target.val(oldvalue);
                        else edit.target.val(model.name);
                        isupdate = true;
                        $("#grid").datagrid("endEdit", index);
                    },
                    error: function () {
                        dialog.alert({ title: "提示", msg: "服务失败！", icon: "error" });
                        isupdate = true;
                        $("#grid").datagrid("endEdit", index);
                    }
                });
            });
        }
        //附件统计
        function statclick() {
            statData = null;
            contentchange(false);
            var url = serviceUrl + "file/getbyfilter";
            $.ajax({
                type: "POST",
                contentType: "application/json",
                url: url,
                data: currcondition,
                success: function (json) {
                    if (json.statusCode !== 200) return;
                    statData = json.data;
                    stat();
                },
                error: function (e) {
                    dialog.alert({ title: "提示", msg: "统计服务失败！", icon: "error" });
                }
            });
        }
        function stat() {
            if (dev.IsNull(statData)) return;
            //原数据转换成统计所需数据
            for (var i = 0; i < statData.length; i++) {
                statData[i].udate = dev.ShortDateToString("/Date(" + statData[i].updatedate + "+0800)/");
            }
            var chartWay = $("#selWay").combobox("getValue");
            var chartOpt = $("#selOpt").combobox("getValue");
            var groupdata = Enumerable.From(statData).GroupBy("$." + chartWay).OrderBy("$." + chartWay).ToArray();
            var nData = { XAxis: [], Counts: [], Sizes: [] };
            for (var i = 0; i < groupdata.length; i++) {
                var count = Enumerable.From(groupdata[i].source).Count();
                var size = Enumerable.From(groupdata[i].source).Sum("$.size");
                nData.XAxis.push(groupdata[i].Key());
                nData.Counts.push(count);
                nData.Sizes.push(size);
            }

            //初始化统计图类型及数据
            var data1 = [], data2 = [];
            options.chart.type = chartOpt;  //类型
            if (chartOpt == "pie") options.plotOptions.pie = { allowPointSelect: true }
            charts = new Highcharts.Chart(options);

            if (charts.options.chart.type == "pie") {
                for (var i = 0; i < nData.XAxis.length; i++) {
                    data1.push({ name: nData.XAxis[i], y: nData.Counts[i] });
                    data2.push({ name: nData.XAxis[i], y: nData.Sizes[i] });
                }
                charts.addSeries({ name: "数量(个)", data: data1, size: '70%', dataLabels: { distance: -30 } }, true, true);
                charts.addSeries({ name: "大小（KB）", data: data2, size: '100%', innerSize: '80%' }, true, true);
            }
            else {
                if (!dev.IsNull(nData.XAxis)) charts.xAxis[0].setCategories(nData.XAxis);
                charts.addSeries({ name: '数量(个)', yAxis: 0, data: nData.Counts }, true, true);
                charts.addSeries({ name: '大小（KB）', yAxis: 1, data: nData.Sizes }, true, true);
            }
        }
        //附件删除
        function filedelete(index) {
            dialog.confirm('确认', '确认删除？', function (r) {
                if (!r) return;
                $("#grid").datagrid("selectRow", index);
                var model = $("#grid").datagrid("getSelected");
                filesdelete([model]);
            });
        }
        function filesdelete(models) {
            $.ajax({
                type: "POST",
                contentType: "application/json",
                url: serviceUrl + "file/deletes",
                data: JSON.stringify(models),
                success: function (json) {
                    if (json.statusCode == 200 && json.data == "true") {
                        dialog.alert({ title: "提示", msg: "删除成功！", icon: "info" });
                        searchByCondition(pagesize, gridpageindex, currcondition);
                    }
                    else {
                        dialog.alert({ title: "提示", msg: "删除失败！", icon: "warning" });
                    }
                },
                error: function () { dialog.alert({ title: "提示", msg: "删除请求失败！", icon: "error" }); }
            });
        }
        //多附件下载
        function download() {
            var checkRows = $("#grid").datagrid("getChecked");
            if (checkRows.length == 0) {
                dialog.alert({ title: "提示", msg: "请勾选要下载的文件！", icon: "warning" });
                return;
            }
        }
        //文件预览
        function fileview(index) {
            $("#grid").datagrid("selectRow", index);
            var previewWindow = null;
            var fileModel = $("#grid").datagrid("getSelected");
            var fileTypes = [".xls", ".xlsx", ".ppt", ".pptx", ".doc", ".docx"];
            if (fileTypes.indexOf(fileModel.extname) > -1) {
                var waitbox = new dev.UCWaitBox($(window.top.document.body));
                waitbox.Show();
                $.ajax({
                    type: "GET",
                    url: serviceUrl + "file/view?reluri=" + fileModel.path,
                    success: function (res) {
                        waitbox.Close();
                        if (res.statusCode == 200) {
                            var param = res.data;
                            previewWindow = new dev.Window({
                                ID: "filePreview",
                                Title: "附件信息",
                                Parent: window.top.document.body,
                                Maximizable: true,
                                Modal: true,
                                Draggable: true,
                                HAlign: 'center',
                                VAlign: 'center',
                                Resizable: true,
                                Height: 600,
                                Width: 1000,
                                Url: dev.App.Root + "html/preview.html?reluri=" + param
                            });
                        } else {
                            dialog.alert({ title: "提示", msg: "请求错误！", icon: "warning" });
                        }
                    },
                    error: function (res) {
                        waitbox.Close();
                        dialog.alert({ title: "提示", msg: "服务请求失败！", icon: "error" });
                    }
                });
            } else {
                previewWindow = new dev.Window({
                    ID: "filePreview",
                    Title: "附件信息",
                    Parent: window.top.document.body,
                    Maximizable: true,
                    Modal: true,
                    Draggable: true,
                    HAlign: 'center',
                    VAlign: 'center',
                    Resizable: true,
                    Height: 600,
                    Width: 1000,
                    Url: dev.App.Root + "html/preview.html?reluri=" + fileModel.path
                });
            }
        }
        //移动
        function filemove(index) {
            $("#grid").datagrid("selectRow", index);
            var model = $("#grid").datagrid("getSelected");
            move([model]);
        }
        function move(models) {
            var url = dev.App.Root + "html/accessory/filemove.html";
            win = new dev.Window({
                ID: "FileMove",
                Title: "选择存储位置",
                Parent: document.body,
                Modal: true,
                Draggable: true,
                HAlign: 'center',
                VAlign: 'center',
                Width: 390,
                Height: 300,
                Url: url
            });
            win.Open();

            win.Models = models;
            win.bind('onClosing', function () {
                if (win.IsMoveSucceed !== true) return;
                dialog.alert({ title: "提示", msg: "文件移动成功！", icon: "info" });
                searchByCondition(pagesize, gridpageindex, currcondition);
                win = undefined;
            });
        }
    </script>
</head>
<body style="background-color: white;">
    <div id="treepanel" style="position: absolute; left: 0px; width: 190px; padding: 5px;">
        <input id="searchbox" class="easyui-searchbox" data-options="prompt:'查找...',searcher:doSearch" style="width: 190px; height: 28px;" />
        <ul id="treetest" style="width: 190px" class="easyui-tree" data-options="animate:true,dnd:true,lines:true"></ul>
    </div>
    <div id="center" style="position: absolute; left: 200px; border-left: 1px solid #95B8E7;">
        <div id="centertop" style="position: absolute; height: 66px;">
            <table cellspacing="0" cellpadding="0" style="margin: 5px 0 0 5px; height: 66px; table-layout: fixed;">
                <tr style="height: 28px">
                    <td>
                        <input id="filename" class="easyui-textbox" data-options="buttonText:'文件名称',buttonAlign:'left'" style="width: 100%; height: 28px;" />
                    </td>
                    <td style="padding-left: 5px">
                        <input id="filetype" class="easyui-combobox" data-options="valueField:'data',textField:'data',editable:false,buttonText:'文件类型', buttonAlign: 'left',panelHeight: 'auto'" style="width: 100%; height: 28px;" />
                    </td>
                    <td style="padding-left: 5px">
                        <input id="creator" class="easyui-textbox" data-options="buttonText:'上传人',buttonAlign:'left'" style="width: 100%; height: 28px;" />
                    </td>
                </tr>
                <tr style="height: 38px">
                    <td>
                        <input id="startdate" class="easyui-datetimebox" data-options="buttonText:'起始时间',buttonAlign:'left'" style="width: 100%; height: 28px;" />
                    </td>
                    <td style="padding-left: 5px">
                        <input id="enddate" class="easyui-datetimebox" data-options="buttonText:'截止时间',buttonAlign:'left'" style="width: 100%; height: 28px;" />
                    </td>
                    <td style="text-align: right; padding-left: 5px">
                        <label id="error" style="height: 28px; color: red; font-size: 13px; text-align: center;"></label>
                        <a id="searchbtn" class="easyui-linkbutton" data-options="iconCls:'icon-search'" style="height: 28px;">查询</a>
                        <a id="staticbtn" class="easyui-linkbutton" data-options="iconCls:'icon-statistic'" style="height: 28px;">统计</a>
                    </td>
                </tr>
            </table>
        </div>
        <div id="centerStat" style="position: absolute; top: 71px; visibility: hidden; padding: 0 5px;">
            <select id="selWay" class="easyui-combobox" data-options="editable:false,panelHeight:'auto'" style="height: 24px;">
                <option value="type">按类型</option>
                <option value="udate">按日期</option>
            </select>
            <select id="selOpt" class="easyui-combobox" data-options="editable:false,panelHeight:'auto'" style="height: 24px;">
                <option value="line">折线图</option>
                <option value="column">条形图</option>
                <option value="pie">饼图</option>
            </select>
            <div id="container" style="margin-top: 5px;"></div>
        </div>
        <div id="centerbottom" style="position: absolute; top: 71px;">
            <table id="grid" class="easyui-datagrid" style="width: 100%; height: 100%;"
                data-options="border:0,singleSelect:true,checkOnSelect:false,selectOnCheck:false,fitColumns:true,animate:true,loadMsg:'请等待...',collapsible:false,toolbar:'#tb',pagination:true">
                <thead>
                    <tr>
                        <th data-options="field:'ck',checkbox:true,frozen:true"></th>
                        <th data-options="field:'icon',width:25,frozen:true,formatter:formatIcon"></th>
                        <th data-options="field:'name',width:200,editor:'validatebox',align:'left'">名称</th>
                        <th data-options="field:'size',width:70,align:'right',formatter:formatFilesize">大小(KB)</th>
                        <th data-options="field:'uploader',width:60">上传人</th>
                        <th data-options="field:'udate',width:100">上传时间</th>
                        <th data-options="field:'_operate',width:180,align:'center',formatter:formatOper">操作</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
    <div id="tb" style="padding: 2px 5px;">
        <a href="#" id="uploadbtn" class="easyui-linkbutton" data-options="iconCls:'icon-add'">上传</a>
        <form id="fileForm" name="fileForm" enctype="multipart/form-data" method="post" style="float: left;">
            <input id="devfile" type="file" name="devfile" accept=".*" multiple="multiple" onchange="filechange()" style="width: 54px; height: 25px; position: absolute; top: 3px; opacity: 0;" />
        </form>
        <!--  <a href="#" id="downloadbtn" class="easyui-linkbutton" data-options="plain:true">下载</a>-->
        <a href="#" id="deletebtn" class="easyui-linkbutton" data-options="iconCls:'icon-remove'">删除</a>
        <a href="#" id="movebtn" class="easyui-linkbutton" data-options="iconCls:'icon-back'">移动</a>
    </div>
    <div id="mm" class="easyui-menu" style="width: 100px;">
        <div id="divAdd" data-options="iconCls:'icon-add'">新建</div>
        <div id="divRemove" data-options="iconCls:'icon-remove'">删除</div>
        <div id="divEdit" data-options="iconCls:'icon-edit'">修改</div>
        <!-- <div class="menu-sep"></div>
        <div id="divUpload" data-options="iconCls:'icon-edit'">上传</div>-->
    </div>
    <div id="mask" style="display: none; width: 100%; height: 100%; position: absolute; background-color: black; opacity: 0.1; filter: alpha(opacity=10);"></div>
    <div id="p" class="easyui-progressbar" style="display: none; width: 400px; position: absolute;" data-options="value:0"></div>
    <script type="text/javascript">
        (function () { setCss(); }());
    </script>
</body>
</html>
