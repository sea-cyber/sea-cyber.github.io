<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>监测站管理</title>
    <link rel="stylesheet" href="../../theme/default/easyui.css" />
    <link rel="stylesheet" type="text/css" href="../../theme/icon.css" />
    <link rel="stylesheet" type="text/css" href="../../css/app.css" />
    <link rel="stylesheet" type="text/css" href="../../css/main.css" />
    <link rel="stylesheet" type="text/css" href="../../css/icon.css" />
    <link type="text/css" href="../../css/dev.css" rel="stylesheet" />
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../js/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="../../js/data.util.js"></script>
    <script type="text/javascript" src="../../js/linq.min.js"></script>
    <script type="text/javascript" src="../../js/guid.js"></script>
    <script type="text/javascript" src="../../js/jquery.dev.control.js"></script>
    <script type="text/javascript" src="../../js/highcharts.js"></script>
    <script type="text/javascript" src="../../js/highcharts-zh_CN.js"></script>
    <script type="text/javascript" src="../../js/highcharts-more.js"></script>
    <script type="text/javascript" src="../../js/dev.ui.js"></script>
    <style type="text/css">
        .content {
            height: 100%;
            width: 100%;
            position: relative;
        }

            .content .SearchDiv {
                width: 230px;
                height: 40px;
                display: inline-block;
                margin-left: 0px;
                margin-right: 0px;
                float: left;
            }

        .MachineEdit {
        }

            .MachineEdit .Row {
                width: 550px;
            }

                .MachineEdit .Row .Cell {
                    width: 275px;
                }

        .Title {
            width: 80px;
            text-align: right;
            line-height: 40px;
            height: 38px;
            display: inline-block;
            float: left;
        }

            .Title .Icon {
                width: 16px;
                height: 16px;
                display: inline-block;
                margin-top: 11px;
                margin-right: 3px;
            }

        .Title1 {
            width: 80px;
            text-align: right;
            line-height: 24px;
            height: 25px;
            display: inline-block;
            float: left;
        }

            .Title1 .Icon1 {
                width: 16px;
                height: 16px;
                display: inline-block;
                margin-top: 3px;
                margin-right: 3px;
            }

            .Title1 .Text {
                display: inline-block;
                float: right;
                /*width: 49px;*/
            }

        .Title .Text {
            display: inline-block;
            float: right;
            /*width: 49px;*/
        }

        .Button {
            width: 70px;
            height: 26px;
            float: left;
            margin-top: 7px;
            background-color: #16dbbb;
            /*border-radius: 5px;*/
            text-align: center;
            border: 1px solid #16dbbb;
            display: inline-block;
            margin-left: 5px;
        }

            .Button:hover {
                background-color: #5227de;
                border: 1px solid #5227de;
                cursor: pointer;
            }

            .Button:active {
                background-color: #210097;
                border: 1px solid #210097;
                cursor: pointer;
            }

        .datagrid-row {
            height: 28px;
        }
    </style>
    <script type="text/javascript">
        var Dev = window.top.window.dev;
        var left = Dev.App.LeftPanel, bottom = Dev.App.BottomPanel;
        var parent;
        var dataGrid, pageIndex = 1, pageSize = 5;
        var grade, contact, antenna, mtype, amstemplate;
        var isModify = false;
        var ajaxRequests = [];
        var Indepeid, alinoneno;
        var comboTree;
        var editWin, monitorWin;
        var dialog, flashDialog;
        var updateid;
        var orgFilter;
        var isposition = false, singleclick;
        var nodeType = { province: '省', city: '市', county: '县', town: '乡' };//根据type判断级联
        var selectedRow;
        var xzqControl;

        //部件通讯
        function WidgetCommunication(s) {
            parent = s.parent;
            flashDialog = new Dev.Messager({ Height: 95, Width: 200, AutoShow: false, Type: "question", Timeout: 1500, ButtonVisible: false, AutoVisible: true, Effect: "normal" });
            dialog = new Dev.Messager({ AutoShow: false, Type: "question" });
            //Dev.App.BottomPanel.SetHeight(262);
            Dev.App.BottomPanel.Header.css({ "background": "#14cdad", "color": "#fcfcfc", "font-weight": "bold" });
            Dev.App.BottomPanel.SetIconCls("ams-white");
            Dev.App.BottomPanel.SetTitle("监测站列表");
            Dev.App.BottomPanel.SetVisible(true);
            init();
            inittree();
            initDataGrid();
            bindData();
            $(window).resize(function () { resize(); });    //例如：对应 bottompanel出现
            resize();

            $(".Button").click(function () {
                var tag = $(this).attr("tag");
                if (tag == "save") saveInfo();
                if (tag == "cancel") editWin.Close();
                if (tag == "search") {
                    pageIndex = 1;
                    bindData();
                }
                if (tag == "clear") {
                    searchClear();
                    bindData();
                }
                if (tag == "deletes") deletes();
                if (tag == "add") {
                    updateid = "";
                    initEditWin();
                    $("#no", editWin.Target).prop("$this").SetReadOnly(false);
                    $("#sid", editWin.Target).prop("$this").SetReadOnly(false);            //新增时激活编辑
                }
            });
            singleclick = Dev.App.Map.on("singleclick", function (e) {
                if (!Dev.IsNull(pointkey)) {
                    Dev.MapUtils.removePointKey("amstationhighlight", dev.App.Map);
                    pointkey = null;
                }
                if (!isposition || Dev.IsNull(editWin)) return;
                isposition = false;
                Dev.position = false;//控制鼠标样式
                Dev.MapUtils.ClearFeature("tempGraphicLayer");
                var temp_coordinate = e.coordinate;
                var mapproj = Dev.App.Map.getView().getProjection();
                if (mapproj.getCode() != Dev.App.Config.SystemMap.DataEPSG) temp_coordinate = Dev.proj.transform(temp_coordinate, mapproj.getCode(), Dev.App.Config.SystemMap.DataEPSG);

                $(".dev-numberbox[name='longitude']", editWin.Target).prop("$this").SetValue(temp_coordinate[0]);
                $(".dev-numberbox[name='latitude']", editWin.Target).prop("$this").SetValue(temp_coordinate[1]);
                creatpointf(e.coordinate);
            });
            parent.one("onClosing", function () {
                Dev.App.BottomPanel.unbind("onResize");
                Dev.App.BottomPanel.SetHeight(262);
                if (!Dev.IsNull(dataGrid)) {
                    dataGrid.Target.unbind("onSelectPage");
                    dataGrid.Target.unbind("onClickRow");
                    dataGrid = null;
                }
                if (!Dev.IsNull(editWin)) {
                    editWin.unbind("onClosing");
                    editWin.Close();
                    editWin.Destroy();
                    editWin = null;
                }
                if (!Dev.IsNull(detailWin)) {
                    detailWin.Close();
                    detailWin.Destroy();
                    detailWin = null;
                }
                if (ajaxRequests.length > 0) {
                    for (var i = 0; i < ajaxRequests.length; i++) {
                        ajaxRequests[i].abort();
                        ajaxRequests.splice(i, 1);
                    }
                }
                //清空
                if (!Dev.IsNull(singleclick)) Dev.App.Map.unByKey(singleclick);
                if (!Dev.IsNull(pointkey)) {
                    Dev.MapUtils.removePointKey("amstationhighlight", dev.App.Map);
                    pointkey = null;
                }
                Dev.position = false;
                Dev.App.BottomPanel.SetVisible(false);
                Dev.MapUtils.ClearFeature("tempGraphicLayer");
                Dev.App.BottomPanel.Clear();
            });
        }
        function saveInfo() {
            var textcontrol = $(".dev-textbox", $(".MachineEdit", Dev.App.FillPanel.Target));
            var numbercontrol = $('.dev-numberbox', $(".MachineEdit", Dev.App.FillPanel.Target));
            var comboboxcontrol = $(".dev-combobox", $(".MachineEdit", Dev.App.FillPanel.Target));
            var model = {};
            var checkV = "";    //监测类型
            $("input[name='mtype']:checked", $(".MachineEdit", Dev.App.FillPanel.Target)).each(function (i) {//把所有被选中的复选框的值存入数组
                checkV += $(this).val() + "-";
            });
            model["type"] = checkV.substring(0, checkV.length - 1);
            var effectivedate = $("#effectivedate", $(".MachineEdit", Dev.App.FillPanel.Target)).datetimebox("getValue");

            model.effectivedate = (!Dev.IsNull(effectivedate)) ? new Date(effectivedate.replace(/-/g, "/")).getTime() : effectivedate;
            $("#errorlog", $(".MachineEdit", Dev.App.FillPanel.Target)).html("");
            for (var i = 0; i < textcontrol.length; i++) {
                var tag = $(textcontrol[i]).attr("name");
                var value = $(textcontrol[i]).prop("$this").GetValue().trim();
                model[tag] = value;
            }
            for (var i = 0; i < numbercontrol.length; i++) {
                var tag = $(numbercontrol[i]).attr("name");
                var value = $(numbercontrol[i]).prop("$this").GetValue().trim();
                model[tag] = value;
            }
            for (var i = 0; i < comboboxcontrol.length; i++) {
                var tag = $(comboboxcontrol[i]).attr("name");
                var value = $(comboboxcontrol[i]).prop("$this").GetValue();       //获取combobox选定值
                //if (tag == "template") {
                //    value = $(comboboxcontrol[i]).prop("$this").GetValue();
                //}
                model[tag] = value;
            }
            model.orgid = comboTree.GetValue();     //根据Select选项获取orgid
            model.allinoneno = Indepeid;
            model.indepeid = alinoneno;
            var pathMethod;
            var mydate = new Date(Dev.GetNowDateString().replace(/-/g, "/")).getTime();
            var isUnique = true;    //是否唯一标志
            if (!isModify) {
                model.id = Guid.NewGuid().ToString("N");
                pathMethod = "insertAmstation";
                model["createdate"] = mydate;
            }
            else {
                model.id = updateid;  //如果是修改，需要获取旧的id（主键信息）
                pathMethod = "updateAmstation";
                model["updatedate"] = mydate;
            }   //区别新增还是更新
            var isok = verify(model);            //简单长度与非空验证
            if (!isok) return;
            //根据经纬度获取省市县乡
            var positionf = new Dev.Feature(new Dev.geom.Point([parseFloat(model.longitude), parseFloat(model.latitude)]));
            var placedata = Dev.getplacedata(positionf);
            if (!Dev.IsNull(placedata)) {
                if (!Dev.IsNull(placedata.country)) model.country = placedata.country;
                if (!Dev.IsNull(placedata.province)) model.province = placedata.province;
                if (!Dev.IsNull(placedata.city)) model.city = placedata.city;
                if (!Dev.IsNull(placedata.county)) model.county = placedata.county;
                if (!Dev.IsNull(placedata.town)) model.town = placedata.town;
            }
            $.ajax({
                type: "POST",
                data: JSON.stringify(model),
                contentType: "application/json",
                url: Dev.GetSystemUrlByRelID("Service") + "amstation/" + pathMethod,
                success: function (result) {
                    if (!result.statusCode == 200 || model.length == 0) return;
                    if (result.data == "监测站编号已存在" || result.data == "监测站序列号已存在")
                    { $("#errorlog", $(".MachineEdit", Dev.App.FillPanel.Target)).html(result.data); return; }
                    editWin.Close();
                    flashDialog.Alert((pathMethod == "insertAmstation" ? "新增成功!" : "修改成功!"), "info");
                },
                error: function (msg) {
                    if (pathMethod == "insertAmstation") flashDialog.Alert("新增失败!", "info")
                    else flashDialog.Alert("修改失败!", "info");
                }
            });
        }
        function update(id, index) {
            isModify = true;
            dataGrid.DataGrid.datagrid("selectRow", index);
            selectedRow = dataGrid.DataGrid.datagrid("getSelected");
            updateid = selectedRow.id;
            initEditWin();
            loadData(selectedRow);
            $("#no", editWin.Target).prop("$this").SetReadOnly(true);
            $("#no", editWin.Target).prop("$this").SetDisabled(true);
            $("#sid", editWin.Target).prop("$this").SetReadOnly(true);            //新增时激活编辑
            $("#sid", editWin.Target).prop("$this").SetDisabled(true);

        }   //更新
        function deleteinfo(index) {
            dataGrid.DataGrid.datagrid("selectRow", index);
            var row = dataGrid.DataGrid.datagrid("getSelected");
            var curRowNo = dataGrid.DataGrid.datagrid("getData").total;       //获取已有的数据行数
            if (curRowNo == 1 && pageIndex != 1) pageIndex -= 1;                //删光则返回上一页
            if (Dev.IsNull(row)) return;
            dialog.Confirm('确定删除选中记录吗？', function (r) {
                if (!r) return;
                $.ajax({
                    type: "DELETE",
                    url: Dev.GetSystemUrlByRelID("Service") + "amstation/deleteAmstation?no=" + encodeURIComponent(row.no),
                    success: function (result) {
                        if (!result.statusCode == 200) return;
                        flashDialog.Alert("删除成功！", "info");
                        bindData();
                    },
                    error: function () {
                        flashDialog.Alert("网络异常，请重试！", "error");
                    }
                });
            }, "question");
        }  //删除
        function deletes() {
            var rows = dataGrid.DataGrid.datagrid("getChecked");
            var curRowNo = dataGrid.DataGrid.datagrid("getData").total;       //获取已有的数据行数
            if (curRowNo == rows.length && pageIndex != 1) pageIndex -= 1;     //如果没删完，保持在本页，删完回到上一页。
            if (Dev.IsNull(rows) || rows.length == 0) {
                flashDialog.Alert("请选择需要删除的数据!", "info");
                return;
            }
            var nos = [];
            for (var i = 0, len = rows.length; i < len; i++) {
                nos.push(rows[i].no);
            }
            dialog.Confirm('确定删除所有勾选记录吗？', function (r) {
                if (!r) return;
                $.ajax({
                    type: "DELETE",
                    data: nos.join(","),
                    url: Dev.GetSystemUrlByRelID("Service") + "amstation/deleteAmstation?no=" + nos.join(","),
                    success: function (re) {
                        if (!re.statusCode == 200) return;
                        flashDialog.Alert("删除成功！", "info");
                        bindData();
                    },
                    error: function () {
                        flashDialog.Alert("网络异常，请重试！", "error");
                    }
                });
            }, "question");
        }        //批量删除

        function init() {
            flashDialog = new Dev.Messager({ Height: 95, Width: 200, AutoShow: false, Type: "question", Timeout: 1500, ButtonVisible: false, AutoVisible: true, Effect: "normal" });
            dialog = new Dev.Messager({ AutoShow: false, Type: "question" });
            var dicdatas = Dev.GetDicData(["Antenna", "ContactInter", "DGrade", "amsDataTemplate"]);
            antenna = Enumerable.From(dicdatas).Where('s=>s.type=="Antenna"').ToArray();
            contact = Enumerable.From(dicdatas).Where('s=>s.type=="ContactInter"').ToArray();
            grade = Enumerable.From(dicdatas).Where('s=>s.type=="DGrade"').ToArray();
            amstemplate = Enumerable.From(dicdatas).Where('s=>s.type=="amsDataTemplate"').ToArray();
            var td1 = grade.concat();
            td1.unshift({ "data": "不限", "id": 9999999999, "parentid": td1[0].parentid }); //插入数组首部
            $("#search-grade").prop("$this").SetData(td1);
            var td2 = contact.concat();
            td2.unshift({ "data": "不限", "id": 9999999999, "parentid": td2[0].parentid }); //插入数组首部
            $("#search-contact").prop("$this").SetData(td2);
        }        //初始化
        function initDataGrid() {
            if (Dev.IsNull(dataGrid)) {
                var columns = [
                    { field: "ck", width: 20, align: 'center', title: '勾选', sortable: false, checkbox: true },
                    {
                        field: "online", width: 15, align: 'center', title: '', sortable: false, formatter: function (value, row, index) {
                            var str = '<img src="../../image/agri/ams-gray.png"></img>';
                            if (!Dev.IsNull(row.status) && row.status == "在线") str = '<img src="../../image/agri/ams-blue.png"></img>';
                            return str;
                        }
                    },
                    { field: "no", width: 50, align: 'center', title: '设备编号', sortable: false },
                    { field: "guardgrade", width: 55, align: 'center', title: '防护等级', sortable: false },
                    { field: "voltage", width: 50, align: 'center', title: '供电电压(Kv)', sortable: false },
                    { field: "contact", width: 55, align: 'center', title: '通讯接口', sortable: false },
                    { field: "type", width: 60, align: 'center', title: '监测类型', sortable: false },
                    {
                        field: "createdate", width: 50, align: 'center', title: '创建时间', sortable: false,
                        formatter: function (value, row, index) {
                            return Dev.GetDateString(value);
                        }
                    },
                       {
                           field: "effectivedate", width: 80, align: 'center', title: '有效日期', sortable: false,
                           formatter: function (value, row, index) {
                               if (Dev.IsNull(value)) return "长期有效";
                               return Dev.GetDateString(value);
                           }
                       },
                    {
                        field: "_oprate",
                        width: 50,
                        align: 'center',
                        title: '操作',
                        sortable: false,
                        formatter: function (value, row, index) {
                            return '<a href="javascript:void(0)" style="color:blue;" title="修改" onclick="update(\'' + row.id + '\',\'' + index + '\')"><img src="../../image/agri/update.png"/></a>&nbsp;<a href="javascript:void(0)" style="color:blue;margin-left:6px;" onclick="detailInfo(\'' + row.id + '\')" title="详细信息"><img src="../../image/agri/cartype.png"/></a>&nbsp<a href="javascript:void(0)" style="color:blue;margin-left:6px;" onclick="deleteinfo(\'' + index + '\')" title="删除"><img src="../../image/agri/delete.png"/></a>';
                        }
                    }
                ];
                dataGrid = new UCDataGrid(Dev, {
                    PageIndex: pageIndex,
                    PageSize: pageSize,
                    RowNumbers: false,
                    ID: "aiofGrid",
                    pagequery: false,
                    IsSizeSelect: true
                });
                $("#gridDiv").append(dataGrid.Target);
                dataGrid.Layout(columns);
                dataGrid.Target.bind("onSelectPage", function (s, e) {
                    pageIndex = e.index;
                    bindData();
                });
                dataGrid.Target.bind("onClickRow", function (s, e) {
                    var row = e.Row;
                    highlight(row);
                });
                dataGrid.Target.bind("onPageSizeChange", function (s, e) {
                    if (Dev.IsNull(e)) return;
                    pageIndex = 1;
                    pageSize = e;
                    bindData();
                });
                dataGrid.Resize(Dev.App.BottomPanel.Target.width(), Dev.App.BottomPanel.Height - 26);
            }
        }

        var detailWin;
        function detailInfo(id) {
            if (Dev.IsNull(detailWin)) {
                detailWin = new Dev.Window({
                    ID: "detailwin",
                    IconCls: 'icon-detailinfo',
                    Title: "监测站详情",
                    Parent: Dev.App.FillPanel.Target,
                    Maximizable: false,
                    Modal: true,
                    Draggable: true,
                    HAlign: 'center',
                    VAlign: 'center',
                    Resizable: false,
                    Url: Dev.App.Root + "html/detailinfo/amsdetail.html",
                    Height: 325,
                    Width: 500,
                    Parameters: { id: id }
                });
            } else {
                detailWin.SetUrl(Dev.App.Root + "html/detailinfo/amsdetail.html");
                detailWin.Parameters = { id: id };
                detailWin.Open();
            }
        } //初始化详细信息页面

        function getCondition() {
            var condition = "1=1";
            var a1 = $("#search-no").prop("$this").GetValue().trim();
            var a2 = $("#search-grade").prop("$this").GetText();
            var a3 = $("#search-contact").prop("$this").GetText();
            if (!Dev.IsNull(a1)) condition += " AND ( \"NO\"  LIKE '%" + a1 + "%'" + " OR " + "UPPER( \"NO\" )  LIKE " + "UPPER('%" + a1 + "%')" + " OR " + "LOWER( \"NO\" )  LIKE " + "LOWER('%" + a1 + "%'))";
            if (!Dev.IsNull(a2) && a2 != "不限") condition += " AND \"GUARDGRADE\" LIKE '%" + a2 + "%'";
            if (!Dev.IsNull(a3) && a3 != "不限") condition += " AND \"CONTACT\" LIKE '%" + a3 + "'";
            if (!Dev.IsNull(Indepeid)) condition += " AND \"INDEPEID\"='" + alinoneno + "'";
            if (!Dev.IsNull(orgFilter)) condition += " AND  " + orgFilter;
            // 组织机构
            return condition;
        }  // 获取查询条件
        function initEditWin() {
            var isupdate = Dev.IsNull(updateid) ? false : true;
            if (!Dev.IsNull(comboTree)) comboTree.SetDisabled(false);
            var title = isupdate ? "监测站修改" : "监测站新增";
            var icon = isupdate ? "icon-featureupdate" : "machine-add";
            if (Dev.IsNull(editWin)) {
                editWin = new Dev.Window({
                    ID: "blockeditWin", IconCls: icon, Title: title,
                    Parent: Dev.App.FillPanel.Target,
                    Maximizable: false,
                    Modal: false,
                    Draggable: true,
                    HAlign: 'center',
                    VAlign: 'center',
                    Resizable: false,
                    Content: $("#add-div"),
                    Height: 433,
                    Width: 550
                });
                comboTree = new Dev.Combotree({
                    Required: true, PopupHeight: 'auto', TipInfo: "请选择",
                    MultiSelect: false, StateField: "State", ValueField: "id",
                    TextField: "name", ChildrenField: "child", Height: 24, Border: "1px", Width: 154
                });
                $("#treecomboDiv", $(".MachineEdit", Dev.App.FillPanel.Target)).append(comboTree.Target);
                comboTree.Layout();
                var selectnode = treeControl.GetSelectNode();
                comboTree.SetData(selectnode[0].$this);

                bindDic2Combo();
                $(".PositionBtn", editWin.Target).click(function () {
                    isposition = true;
                    Dev.position = true;
                    Dev.App.MapPanel.MapDOM.css("cursor", "url(image/location.cur),auto");
                });
                $("#effectivedate", $(".MachineEdit", Dev.App.FillPanel.Target)).datetimebox({
                    width: 154,
                    height: 25,
                    onChange: function (s) {
                        $("#dateclear", $(".MachineEdit", Dev.App.FillPanel.Target)).css("display", Dev.IsNull(s) ? "none" : "block");
                    }
                });
                editWin.bind("onClosing", function () {
                    isModify = false;
                    Dev.position = false;
                    editClear();
                    showmodal(false);
                    $("#errorMsg", editWin.Target).html("");
                    bindData();
                });
                $("#dateclear", $(".MachineEdit", Dev.App.FillPanel.Target)).click(function () {
                    $("#effectivedate", $(".MachineEdit", Dev.App.FillPanel.Target)).datetimebox("setValue", "");
                });
            }
            else {
                editWin.Open();
                editWin.SetTitle(title);
                editWin.SetIconCls(icon);
                var selectnode = treeControl.GetSelectNode();
                comboTree.SetData(selectnode[0].$this);
            }
            showmodal(true);
        }   //新增、修改窗体
        function bindDic2Combo() {
            var t1 = $("#amsgrade", editWin.Target).prop("$this");
            if (!Dev.IsNull(t1)) t1.SetData(grade);
            var t2 = $("#amscontact", editWin.Target).prop("$this");
            if (!Dev.IsNull(t2)) t2.SetData(contact);
            var t3 = $("#amsantenna", editWin.Target).prop("$this");
            if (!Dev.IsNull(t3)) t3.SetData(antenna);
            var t4 = $("#amstemplate", editWin.Target).prop("$this");
            if (!Dev.IsNull(t4)) t4.SetData(amstemplate);
        } //绑定下拉菜单 数据字典
        function bindData() {
            var ajaxrequest = $.ajax({
                type: "POST",
                data: getCondition(),
                contentType: "application/json;charset=UTF-8",
                url: Dev.cookie.baseUri + "amstation/findAmstationByPage/" + pageIndex + "/" + pageSize + "/" + Dev.cookie.user.orgid,
                success: function (response) {
                    if (Dev.IsNull(response) || response.statusCode != 200) {
                        loadError();
                        return;
                    }
                    dataGrid.Load(response.data.dataSource, response.data.pageInfo);
                    showpagedata(response.data.dataSource);
                    //highpage(response.data.dataSource);
                },
                error: function (e) {
                    loadError();
                }
            });
            ajaxRequests.push(ajaxrequest);
        }        //查询数据
        function verify(model) {
            var errorMsg = $("#errorlog", $(".MachineEdit", Dev.App.FillPanel.Target));
            errorMsg.html("");
            if (Dev.IsNull(model.no)) { errorMsg.html("设备编号不能为空！"); return false; }
            if (Dev.IsNull(model.orgid)) { errorMsg.html("所属组织不能为空！"); return false }
            if (Dev.IsNull(model.serialnumber)) { errorMsg.html("序列号不能为空！"); return false; }
            if (!Dev.IsNull(model.serialnumber.replace(/[^\u4e00-\u9fa5]/gi, ""))) { errorMsg.html("序列号不能为中文！"); return false; }
            if (Dev.IsNull(model.guardgrade)) { errorMsg.html("防护等级不能为空！"); return false }
            if (Dev.IsNull(model.voltage)) { errorMsg.html("供电电压不能为空！"); return false }
            var now = new Date();
            now = now.getTime();    //限制开始时间 不能早于当天，利用时间戳比较大小
            if (!Dev.IsNull(model.effectivedate) && model.effectivedate < now) { errorMsg.html("截止日期不能小于当前时间！"); return false; }
            if (Dev.IsNull(model.latitude) || Dev.IsNull(model.longitude)) { errorMsg.html("坐标信息不能为空！"); return false }
            if (model.no.length > 18) { errorMsg.html("一体机编号太长！"); return false; }
            if (model.voltage.length > 18) { errorMsg.html("一体机编号太长！"); return false; }
            if (model.serialnumber.length > 36) { errorMsg.html("序列号太长！"); return false; }
            if (model.remark.length > 120) { errorMsg.html("备注太长！"); return false; }
            return true;
        }   //验证函数

        //辅助函数
        function showpagedata(data) {
             if (!Dev.IsNull(pointkey)) {
                Dev.MapUtils.removePointKey("amstationhighlight", dev.App.Map);
                pointkey = null;
            }
            Dev.MapUtils.ClearFeature("tempGraphicLayer");
            if (Dev.IsNull(data) || data.length == 0) return;
            var features = [];
            for (var i = 0; i < data.length; i++) {
                var x = data[i].longitude;
                var y = data[i].latitude;
                if (!Dev.IsNullAll(data[i].rlongtitude)) x = data[i].rlongtitude;
                if (!Dev.IsNullAll(data[i].rlatitude)) y = data[i].rlatitude;
                var c_p = new Dev.Feature(new Dev.geom.Point([parseFloat(x), parseFloat(y)]));
                //添加样式
                var iconsrc = Dev.App.Root + "image/agri/ams-offline.png";
                if (data[i].status == "在线") iconsrc = Dev.App.Root + "image/agri/ams-online.png";
                c_p.setStyle(new Dev.style.Style({
                    fill: new Dev.style.Fill({ color: [236, 179, 73, 0.2] }),
                    image: new Dev.style.Icon({ src: iconsrc }),
                    text: new Dev.style.Text({ text: data[i].no, font: "15px serif", offsetX: 5, offsetY: -20, fill: new Dev.style.Fill({ color: [255, 255, 255, 1] }) })
                }));
                features.push(c_p);
            }
            var extend = Dev.getExtentByFeatures(features);
            var mapproj = Dev.App.Map.getView().getProjection();
            if (mapproj.getCode() != Dev.App.Config.SystemMap.DataEPSG) extend = Dev.proj.transformExtent(extend, Dev.App.Config.SystemMap.DataEPSG, mapproj.getCode());
            if (!Dev.IsNull(extend)) Dev.App.Map.getView().fit(extend, Dev.App.Map.getSize());
            Dev.MapUtils.ClearAndAddFeatures(features, "tempGraphicLayer");
        }
        var pointkey;
        function highlight(row) {
            if (!Dev.IsNull(pointkey)) {
                Dev.MapUtils.removePointKey("amstationhighlight", dev.App.Map);
                pointkey = null;
            }
            var x = row.longitude;
            var y = row.latitude;
            if (!Dev.IsNullAll(row.rlongtitude)) x = row.rlongtitude;
            if (!Dev.IsNullAll(row.rlatitude)) y = row.rlatitude;
            var feature = new Dev.Feature({
                id: "amstationhighlight",
                geometry: new Dev.geom.Point([parseFloat(x), parseFloat(y)])
            });
            feature.setId("amstationhighlight");
            pointkey = Dev.MapUtils.PointSymbolStyle1(feature, 1, "rgba(63, 85, 225, 1)", "rgba(63,85,225,0.5)", null, Dev.App.Map);
            var c_p = [parseFloat(x), parseFloat(y)];
            var mapproj = Dev.App.Map.getView().getProjection();
            if (mapproj.getCode() != Dev.App.Config.SystemMap.DataEPSG) c_p = Dev.proj.transform(c_p, Dev.App.Config.SystemMap.DataEPSG, mapproj.getCode());

            Dev.App.Map.getView().centerOn(c_p, Dev.App.Map.getSize(), [Dev.App.Map.getSize()[0] / 2, Dev.App.Map.getSize()[1] / 2]);
        }
        function searchClear() {
            pageIndex = 1;
            $("#search-no").prop("$this").SetValue("");
            $("#search-grade").prop("$this").SetText("");
            $("#search-contact").prop("$this").SetText("");
        } //清空搜索栏
        function editClear() {
            $("#errorlog", editWin.Target).html("");
            var textcontrol = $(".dev-textbox", $(".MachineEdit", Dev.App.FillPanel.Target));
            var numbercontrol = $(".dev-numberbox", $(".MachineEdit", Dev.App.FillPanel.Target));
            var comboboxcontrol = $(".dev-combobox", $(".MachineEdit", Dev.App.FillPanel.Target));
            $("input[name='mtype']", $(".MachineEdit", Dev.App.FillPanel.Target)).each(function (i) {
                $(this).prop('checked', false);
            });
            for (var i = 0; i < textcontrol.length; i++) {
                var currcontrol = $(textcontrol[i]).prop("$this");
                currcontrol.Clear();
                if (!Dev.IsNull(currcontrol.SetLengthTip)) currcontrol.SetLengthTip("");
            }
            for (var i = 0; i < numbercontrol.length; i++) {
                var currcontrol = $(numbercontrol[i]).prop("$this");
                currcontrol.Clear();
            }
            for (var i = 0; i < comboboxcontrol.length; i++) {
                var currcontrol = $(comboboxcontrol[i]).prop("$this");
                currcontrol.SetValue("");
            }
            $("#effectivedate", $(".MachineEdit", Dev.App.FillPanel.Target)).datetimebox("setValue", "");
            $("#effectivedate", $(".MachineEdit", Dev.App.FillPanel.Target)).datetimebox("hidePanel");

        }//清空编辑数据
        function loadData(model) {
            var textcontrol = $(".dev-textbox", $(".MachineEdit", Dev.App.FillPanel.Target));
            var numbercontrol = $('.dev-numberbox', $(".MachineEdit", Dev.App.FillPanel.Target));
            var comboboxcontrol = $(".dev-combobox", $(".MachineEdit", Dev.App.FillPanel.Target));
            var selectnode = treeControl.GetSelectNode();
            comboTree.SetData(selectnode[0].$this);
            if (!Dev.IsNull(model.orgid)) comboTree.SetValueEx(model.orgid);

            if (!Dev.IsNull(model.orgid)) {
                comboTree.SetValueEx(model.orgid);
                comboTree.SetDisabled(true);
            }
            if (!Dev.IsNull(model.effectivedate)) $("#effectivedate", $(".MachineEdit", Dev.App.FillPanel.Target)).datetimebox("setValue", Dev.GetDateString(model.effectivedate));

            // comboTree.SetReadOnly(false);// TODO: 组织机构要设为只读，一旦修改，原来一体机实监测数据表的数据要跟着迁移(当前是一个一体机一个监测数据表)
            $("input[name='mtype']", $(".MachineEdit", Dev.App.FillPanel.Target)).each(function (i) {//把所有被选中的复选框的值存入数组
                var str = model.type;
                var s = $(this).val();
                if (!Dev.IsNull(str) && str.indexOf(s) != -1) {
                    //1.6+的jQuery要用prop，尤其是checkBox的checked的属性的判断
                    $(this).prop("checked");
                    $(this).prop("disabled", false);
                    $(this).prop("checked", true);
                }
            });

            for (var i = 0; i < textcontrol.length; i++) {
                var tag = $(textcontrol[i]).attr("name");
                if (!Dev.IsNull(model[tag])) {
                    var currcontrol = $(textcontrol[i]).prop("$this");
                    currcontrol.SetValue(model[tag] == null ? "" : model[tag].trim());
                }
            }
            for (var i = 0; i < numbercontrol.length; i++) {
                var tag = $(numbercontrol[i]).attr("name");
                if (!Dev.IsNull(model[tag])) {
                    var currcontrol = $(numbercontrol[i]).prop("$this");
                    var value = model[tag];
                    if (Dev.IsNull(value)) value = 0;
                    currcontrol.SetValue(value);
                }
            }
            for (var i = 0; i < comboboxcontrol.length; i++) {
                var tag = $(comboboxcontrol[i]).attr("name");
                if (!Dev.IsNull(model[tag])) {
                    var currcontrol = $(comboboxcontrol[i]).prop("$this");
                    currcontrol.SetValue(model[tag]);        //combobox
                }
            }

            $("")

            //添加经纬度位置
            if (!Dev.IsNull(model.longitude) && !Dev.IsNull(model.latitude)) creatpointf([parseFloat(model.longitude), parseFloat(model.latitude)]);
        }
        function loadError() {
            //dataGrid.Load([], { totalCount: 0, pageIndex: pageIndex, pageSize: pageSize, pageCount: 0 });
        }
        function creatpointf(point) {
            if (Dev.IsNull(point)) return;
            var positionf = new Dev.Feature(new Dev.geom.Point(point));
            var style = new Dev.style.Style({ image: new Dev.style.Icon({ anchor: [0.5, 1], src: Dev.App.Root + "image/maptool/location.png" }) })
            positionf.setStyle(style);
            Dev.MapUtils.AddFeature(positionf, "tempGraphicLayer", Dev.App.Map,false);
        }      //构建定位元素
        function showmodal(isshow) {
            if (Dev.IsNull(isshow)) return;
            $("#shade").css("display", (isshow ? "block" : "none"));
        }
        function resize() {
            var height = $(window).outerHeight();
            var gridheight = height - 40;
            var gridwidth = parseInt($(window).width() * 0.8) - 2;
            if (gridwidth < 1050) {
                gridwidth = 1050;
                gridheight = parseInt(gridheight) - 16;
            }
            $("#searchDiv").width(gridwidth);
            $("#gridDiv").height(gridheight).width(gridwidth);
            if (!Dev.IsNull(dataGrid)) dataGrid.Resize(gridwidth, gridheight);
        }
        //获取选中树节点信息
        function inittree() {
            treeControl = $('.dev-tree').prop("$this");
            treeControl.bind("onSelectChanged", function (s, e) {
                searchClear();
                var treenode = e;
                var isleaf = treeControl.IsLeaf(treenode);
                orgids = [];
                orgids.push(e.id);
                if (!isleaf) {
                    var allchilds = treeControl.GetAllChildren(treenode);
                    for (var i = 0; i < allchilds.length; i++) orgids.push(allchilds[i].id);
                }
                orgFilter = "";
                if (Dev.IsNull(orgids) || orgids.length == 0) return;
                orgFilter = "\"ORGID\"  IN(";
                for (var i = 0; i < orgids.length; i++) orgFilter += "'" + orgids[i] + "',";
                orgFilter = orgFilter.substr(0, orgFilter.length - 1);
                orgFilter += ")";
                bindData();
            });
            treeControl.bind("onClick", function (s, e) { flashDialog.Alert("hello") })
            var orgid = Dev.cookie.user.orgid;
            $.ajax({
                url: Dev.GetSystemUrlByRelID("Service") + "organize/gettreebyid/" + orgid + "?" + new Date().getTime(),
                type: "Get",
                contentType: 'application/json',
                dataType: 'json',
                success: function (result) {
                    treeData = Dev.ConvertTreeData(result.data, orgid);
                    treeControl.LoadData(treeData);
                    if (treeData.length > 0) treeControl.SetSelectNode(treeControl.GetRoots()[0]);
                }
            });
            bindData();
        }
    </script>
</head>
<body>
    <div id="shade" style="width: 100%; height: 100%; position: absolute; z-index: 1000; display: none; background: rgba(255,255,255,0.3)"></div>
    <div id="content" class="content">
        <div style="height: 100%; width: 20%; position: absolute;">
            <div id="treediv" style="width: 100%; height: 100%;">
                <div class="dev-tree"
                    opt='{"ValueField":"id","TextField":"name","ChildrenField":"child","Height":220}'>
                </div>
            </div>
        </div>
        <div style="height: 100%; width: 80%; left: 20%; position: absolute; overflow: auto; overflow-y: hidden">
            <div id="searchDiv" style="height: 38px; width: 100%; border-left: 1px solid #ddd; position: relative; min-width: 1050px;">
                <div style="height: 38px; position: absolute; left: 0px;">
                    <div class="SearchDiv" style="margin-left: 11px; width: 241px">
                        <div id="search-no" class="dev-text" style="z-index: 2; width: 210px; display: inline-block;"
                            opt='{"TipInfo":"","HeaderCSS":{"padding":"0px","width":"75px"},"IsOverShow":true,"Padding":"0px 5px","TextAlign":"left","BodyCSS": { "background-color": "transparent","margin-top":"8px","margin-left":"13px" },"Title":"<div class=\"Title\"><div class=\"Icon machine-carnum\"></div><span class=\"Text\" style=\"width:55px\">设备编号</span></div>"}'>
                        </div>
                    </div>
                    <div class="SearchDiv">
                        <div id="search-grade" class="dev-combobox"
                            style="z-index: 2; width: 220px; display: inline-block; margin-top: 8px"
                            opt='{"TipInfo":"请选择","TextField":"data","ValueField":"id","HeaderCSS":{"padding":"0px 5px","width":"83px", "text-align": "RIGHT"},"IsOverShow":true,"Padding":"0px 5px","TextAlign":"left","BodyCSS": { "background-color": "transparent"},"Title":"<div class=\"Title1\"><div class=\"Icon1 machine-name\"></div><span class=\"Text\" style=\"width:55px\">防护等级</span></div>"}'>
                        </div>
                    </div>
                    <div class="SearchDiv">
                        <div id="search-contact" class="dev-combobox"
                            style="z-index: 2; width: 220px; display: inline-block; margin-top: 8px"
                            opt='{"TipInfo":"请选择","TextField":"data","ValueField":"id","HeaderCSS":{"padding":"0px 5px","width":"83px", "text-align": "RIGHT"},"IsOverShow":true,"Padding":"0px 5px","TextAlign":"left","BodyCSS": { "background-color": "transparent"},"Title":"<div class=\"Title1\"><div class=\"Icon1 icon-element\"></div><span class=\"Text\" style=\"width:55px\">通讯接口</span></div>"}'>
                        </div>
                    </div>
                </div>
                <div style="width: 320px; height: 100%; position: absolute; right: 11px; z-index: 2; bottom: 2px">
                    <div class="Button noselect" tag="search">
                        <div class="machine-query"
                            style="height: 16px; width: 16px; margin-top: 4px; margin-left: 4px; display: inline-block; float: left;">
                        </div>
                        <span style="line-height: 26px; color: #fcfcfc;">查&nbsp;询</span>
                    </div>
                    <div class="Button noselect" tag="clear">
                        <div class="machine-reset"
                            style="height: 16px; width: 16px; margin-top: 4px; margin-left: 4px; display: inline-block; float: left;">
                        </div>
                        <span style="line-height: 26px; color: #fcfcfc;">重&nbsp;置</span>
                    </div>
                    <div class="Button noselect" tag="add">
                        <div class="machine-add"
                            style="height: 16px; width: 16px; margin-top: 4px; margin-left: 4px; display: inline-block; float: left;">
                        </div>
                        <span style="line-height: 26px; color: #fcfcfc;">新&nbsp;增</span>
                    </div>
                    <div class="Button noselect" tag="deletes" style="width: 75px;">
                        <div class="machine-deletes"
                            style="height: 16px; width: 16px; margin-top: 4px; margin-left: 5px; display: inline-block; float: left;">
                        </div>
                        <span style="line-height: 28px; color: #fcfcfc;">批量删除</span>
                    </div>
                </div>
            </div>
            <div id="gridDiv" style="width: 100%; border-left: 1px solid #ddd; border-top: 1px solid #ddd;"></div>
        </div>
    </div>
    <div id="add-div" class="MachineEdit " style="height: 350px; width: 550px">
        <div class="Row">
            <div class="Cell" style="width: 275px;">
                <div id="no" class="dev-textbox" name="no" style="width: 239px; height: 24px; margin-top: 6px;" opt='{"MaxLength":18,"Required":true, "TipInfo":"18位以内","HeaderCSS":{"padding":"0px","width":"85px"},"IsOverShow":true,"Padding":"0px 5px","Title":"<div class=\"Title\"><span>设备编号</span></div>"}'></div>
            </div>
            <div class="Cell" style="width: 275px;">
                <div style="width: 80px; height: 100%; line-height: 35px; text-align: right; padding-right: 5px; float: left">所属组织</div>
                <div id="treecomboDiv" style="height: 24px; width: 154px; margin-top: 5px; display: block; float: left;">
                </div>
            </div>

        </div>
        <div class="Row">
            <div class="Cell" style="width: 275px;">
                <div id="sid" class="dev-textbox" name="serialnumber" style="width: 239px; height: 24px; margin-top: 6px;" opt='{"MaxLength":36,"Required":true, "TipInfo":"36位以内","Precision":0,  "HeaderCSS":{"padding":"0px","width":"85px"},"Padding":"0px 5px","Title":"<div class=\"Title\"><span>序列号</div>"}'></div>
            </div>
            <div class="Cell" style="width: 275px;">
                <div class="dev-combobox" id="amsgrade" name="guardgrade" style="width: 239px; height: 24px; margin-top: 6px;" opt='{ "PopupHeight":"auto","TextField":"data","ValueField":"data1","TipInfo":"请选择","Required":true, "HeaderCSS":{"padding":"0px","width":"85px"},"IsOverShow":true,"Padding":"0px 5px","Title":"<div class=\"Title\"><span>防护等级</span></div>"}'></div>
            </div>
        </div>
        <div class="Row">
            <div class="Cell" style="width: 275px;">
                <div class="dev-combobox" id="amstemplate" name="template" style="width: 239px; height: 24px; margin-top: 6px;" opt='{ "PopupHeight":"auto","TextField":"data","ValueField":"data1","TipInfo":"请选择","Required":true, "HeaderCSS":{"padding":"0px","width":"85px"},"IsOverShow":true,"Padding":"0px 5px","Title":"<div class=\"Title\"><span>类型模板</span></div>"}'></div>
            </div>
            <div class="Cell" style="width: 275px;">
                <div style="width: 80px; height: 100%; line-height: 35px; text-align: right; padding-right: 5px; float: left">
                    有效日期
                </div>
                <div style="width: 150px; height: 100%; line-height: 38px; line-height: 32px; float: left; margin-top: 0px; position: relative;">
                    <input id="effectivedate" data-options="editable:false" />
                    <div id="dateclear" style="height: 16px; width: 16px; color: #ff0000; position: absolute; right: 10px; top: 2px; display: none; cursor: default;">×</div>
                </div>

            </div>
        </div>


        <div class="Row">
            <div class="Cell" style="width: 275px;">
                <div class="dev-numberbox" name="longitude" style="width: 239px; height: 24px; margin-top: 6px;" opt='{"MaxLength":15,"Required":true,"Precision":12,"Min":0,"Max":180,"HeaderCSS":{"padding":"0px","width":"85px"},"IsOverShow":true,"Padding":"0px 5px","Title":"<div class=\"Title\"><span>经度</span></div>"}'></div>
            </div>
            <div class="Cell" style="width: 209px;">
                <div class="dev-numberbox" name="latitude" style="width: 209px; height: 24px; margin-top: 6px;" maxlength='36' opt='{"MaxLength":15,"Required":true,"Precision":12,"Min":0,"Max":90,"HeaderCSS":{"padding":"0px","width":"85px"},"IsOverShow":true,"Padding":"0px 5px","Title":"<div class=\"Title\"><span>纬度</span></div>"}'></div>
            </div>
            <div class="PositionBtn"></div>
        </div>
        <div class="Row">
            <div class="Cell" style="width: 275px;">
                <div class="dev-numberbox" name="voltage" style="width: 239px; height: 24px; margin-top: 6px;" opt='{"MaxLength":10,"Precision":0,"Min":0,"Required":true, "TipInfo":"10位以内","HeaderCSS":{"padding":"0px","width":"85px"},"IsOverShow":true,"Padding":"0px 5px","Title":"<div class=\"Title\"><span>供电电压(Kv)</span></div>"}'></div>
            </div>
            <div class="Cell" style="width: 275px;">
                <div class="dev-numberbox" name="altitude" style="width: 239px; height: 24px; margin-top: 6px;" opt='{"MaxLength":10,"Precision":3,"Min":0,"Required":true, "TipInfo":"10位以内","HeaderCSS":{"padding":"0px","width":"85px"},"IsOverShow":true,"Padding":"0px 5px","Title":"<div class=\"Title\"><span>高程(m)</span></div>"}'></div>
            </div>
        </div>


        <div class="Row" style="height: 60px;">
            <div class="Title1" style="float: left; display: inline-block; margin-top: 19px; margin-left: 31px;">监测类型</div>
            <div style="width: 400px; height: 24px; margin-top: 6px; margin-left: 91px">
                <input type="checkbox" class="options" name="mtype" value="空气温度" />空气温度
                <input type="checkbox" class="options" name="mtype" value="空气湿度" />空气湿度
		        <input type="checkbox" class="options" name="mtype" value="大气压力" />大气压力
		        <input type="checkbox" class="options" name="mtype" value="光照强度" />光照强度
		        <input type="checkbox" class="options" name="mtype" value="总辐射" />总辐射
            </div>
            <div style="width: 400px; height: 24px; margin-top: 4px; margin-left: 91px">
                <input type="checkbox" class="options" name="mtype" value="风速" />风速
		        <input type="checkbox" class="options" name="mtype" value="风向" />风向
		        <input type="checkbox" class="options" name="mtype" value="土壤温度" />土壤温度
		        <input type="checkbox" class="options" name="mtype" value="土壤湿度" />土壤湿度
		        <input type="checkbox" class="options" name="mtype" value="雨量" />雨量
		        <input type="checkbox" class="options" name="mtype" value="其他" />其他
            </div>
        </div>
        <div class="Row">
            <div class="Cell" style="width: 275px;">
                <div class="dev-combobox" id="amscontact" name="contact" style="width: 239px; height: 24px; margin-top: 6px;" opt='{ "PopupHeight":"auto","TextField":"data","ValueField":"data1","TipInfo":"请选择", "HeaderCSS":{"padding":"0px","width":"85px"},"IsOverShow":true,"Padding":"0px 5px","Title":"<div class=\"Title\"><span>通讯接口</span></div>"}'></div>
            </div>
            <div class="Cell" style="width: 275px;">
                <div class="dev-combobox" id="amsantenna" name="antenna" style="width: 239px; height: 24px; margin-top: 6px;" opt='{ "PopupHeight":"auto","TextField":"data","ValueField":"data1","TipInfo":"请选择","HeaderCSS":{"padding":"0px","width":"85px"},"IsOverShow":true,"Padding":"0px 5px","Title":"<div class=\"Title\"><span>天线接口</span></div>"}'></div>
            </div>
        </div>
        <div class="Row" style="height: 68px; width: 100%; border-bottom: 1px solid #ddd;">
            <div class="Cell" style="width: 275px;" style="height: 59px; width: 488px;">
                <div class="dev-textbox" name="remark" style="z-index: 2; width: 514px; height: 55px; margin-top: 6px;" maxlength='120' opt='{"MaxLength":120, "TipInfo":"256位以内","Type":"multi-text","HeaderCSS":{"padding":"0px","width":"85px"},"IsOverShow":true,"Padding":"5px","Title":"<div class=\"Title\">备注</div>"}'></div>
            </div>
        </div>
        <div id="errorlog" style="width: 250px; display: inline-block; float: left; margin-top: 20px; margin-left: 20px; color: red"></div>
        <div class="Submit" style="margin-right: 36px;">
            <div class="Button" tag="save">
                <span style="line-height: 26px; color: #fcfcfc;">保&nbsp;&nbsp;存</span>
            </div>
            <div class="Button" tag="cancel">
                <span style="line-height: 26px; color: #fcfcfc;">取&nbsp;&nbsp;消</span>
            </div>
        </div>
    </div>
</body>
</html>
